{"updatedAt":"2025-11-09T19:47:16.000Z","createdAt":"2025-10-20T18:16:03.743Z","id":"03lgcA4e9uRTtli1","name":"Emma Newsletter - Automated Multi-API Financial News Distribution","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 7 * * *"},{"field":"cronExpression","expression":"0 12 * * *"},{"field":"cronExpression","expression":"30 16 * * *"}]}},"id":"5397f51e-b6e3-4630-9d60-d975554db13b","name":"Schedule Trigger (7h/12h/16h30 EST)","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[20208,5728]},{"parameters":{"httpMethod":"POST","path":"emma-newsletter/send","responseMode":"lastNode","options":{}},"id":"30e9d42f-c22e-4ecc-b32f-040e1b36c80d","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[20208,5920],"webhookId":"dad887b9-1a62-482a-9174-3b79f52a2bb5"},{"parameters":{},"id":"2199702c-ea93-484a-9b71-3ba416030308","name":"Manual Trigger (Custom Prompt)","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[20208,5536]},{"parameters":{"assignments":{"assignments":[{"id":"id-briefing-type","name":"briefing_type","value":"matin","type":"string"},{"id":"id-custom-prompt","name":"custom_prompt","value":"","type":"string"},{"id":"id-preview-mode","name":"preview_mode","value":false,"type":"boolean"},{"id":"id-approved","name":"approved","value":true,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"c3ecb545-83ea-4db2-ba56-a7104a702733","name":"ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20432,5440]},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{"includeUnpaired":true}},"id":"39da4631-55a2-4bbd-b165-312f3714a493","name":"Merge Triggers","type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[20656,5632]},{"parameters":{"operation":"getAll","tableId":"team_tickers","returnAll":true,"filters":{"conditions":[{"keyName":"active","condition":"eq","keyValue":"true"}]}},"id":"ad5015b5-8231-4cd9-acc0-6f0a0ae6265e","name":"Get Active Tickers","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[21104,6104],"credentials":{"supabaseApi":{"id":"WGwVmhxNX4mHZmVO","name":"Supabase account"}}},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¯ SÃ‰LECTION DU PROMPT DE BRIEFING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Ce nÅ“ud utilise les prompts rÃ©cupÃ©rÃ©s depuis GitHub via l'API\n// et permet la sÃ©lection manuelle du type de briefing\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inputItems = $input.all();\nconst data = inputItems[0].json;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RÃ‰CUPÃ‰RATION DES PROMPTS DEPUIS \"Fetch Prompts from API\"\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Les prompts viennent de \"Fetch Prompts from API\" qui prÃ©cÃ¨de \"Get Active Tickers\"\n// L'API retourne { success: true, prompts: { morning: {...}, midday: {...}, evening: {...} } }\nlet promptsConfig = {};\n\ntry {\n  // MÃ©thode 1 : RÃ©cupÃ©rer depuis le nÅ“ud \"Fetch Prompts from API\"\n  const fetchPromptsData = $('Fetch Prompts from API').first().json;\n  if (fetchPromptsData.prompts) {\n    promptsConfig = fetchPromptsData.prompts;\n    console.log('âœ… Prompts rÃ©cupÃ©rÃ©s depuis Fetch Prompts from API');\n  } else if (fetchPromptsData.success && fetchPromptsData.prompts) {\n    promptsConfig = fetchPromptsData.prompts;\n    console.log('âœ… Prompts rÃ©cupÃ©rÃ©s depuis Fetch Prompts from API (format success)');\n  }\n} catch (e) {\n  console.warn('âš ï¸ Impossible de rÃ©cupÃ©rer depuis Fetch Prompts from API:', e.message);\n}\n\n// MÃ©thode 2 : VÃ©rifier dans les donnÃ©es actuelles (au cas oÃ¹)\nif (!promptsConfig || Object.keys(promptsConfig).length === 0) {\n  if (data.prompts) {\n    promptsConfig = data.prompts;\n    console.log('âœ… Prompts trouvÃ©s dans les donnÃ©es actuelles');\n  } else if (data.success && data.prompts) {\n    promptsConfig = data.prompts;\n    console.log('âœ… Prompts trouvÃ©s dans les donnÃ©es actuelles (format success)');\n  }\n}\n\n// Si toujours pas de prompts, erreur\nif (!promptsConfig || Object.keys(promptsConfig).length === 0) {\n  console.error('âŒ Prompts non trouvÃ©s. VÃ©rifiez que \"Fetch Prompts from API\" s\\'est exÃ©cutÃ© correctement.');\n  throw new Error('âŒ Les prompts depuis GitHub ne sont pas disponibles. VÃ©rifiez le nÅ“ud \"Fetch Prompts from API\".');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 1 : Prompt personnalisÃ© (si fourni)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (data.custom_prompt && data.custom_prompt.trim() !== '') {\n  console.log('âœ… Utilisation du prompt personnalisÃ©');\n  for (const item of inputItems) {\n    item.json.selected_prompt = data.custom_prompt;\n    item.json.prompt_type = 'custom';\n    item.json.processing_status = \"OK\";\n  }\n  return inputItems;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 2 : Type de briefing sÃ©lectionnÃ© manuellement\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Note: prompt_type est gÃ©nÃ©rÃ© automatiquement Ã  partir de briefing_type\nif (data.briefing_type) {\n  const selectedType = data.briefing_type.toLowerCase().trim();\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // CONVERSION FRANÃ‡AIS â†’ ANGLAIS (pour compatibilitÃ© API)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  const typeMapping = {\n    // FranÃ§ais â†’ Anglais\n    'matin': 'morning',\n    'midi': 'midday',\n    'soir': 'evening',\n    // Anglais (compatibilitÃ©)\n    'morning': 'morning',\n    'midday': 'midday',\n    'evening': 'evening',\n    'noon': 'midday' // Ancien format\n  };\n  \n  // Normaliser le type (franÃ§ais ou anglais â†’ anglais)\n  let normalizedType = typeMapping[selectedType];\n  \n  if (!normalizedType) {\n    throw new Error(`âŒ Type de briefing invalide: \"${selectedType}\". Utilisez: \"matin\", \"midi\", \"soir\" (ou \"morning\", \"midday\", \"evening\")`);\n  }\n  \n  // Types valides pour l'API (toujours en anglais)\n  const validTypes = ['morning', 'midday', 'evening'];\n  if (!validTypes.includes(normalizedType)) {\n    throw new Error(`âŒ Type de briefing invalide aprÃ¨s conversion: ${normalizedType}`);\n  }\n  \n  const selectedPrompt = promptsConfig[normalizedType]?.prompt;\n  \n  if (!selectedPrompt) {\n    throw new Error(`âŒ Prompt non trouvÃ© pour le type: ${normalizedType}. VÃ©rifiez config/briefing-prompts.json sur GitHub.`);\n  }\n  \n  console.log(`âœ… Utilisation du prompt ${normalizedType} (${selectedType}) depuis GitHub`);\n  \n  for (const item of inputItems) {\n    item.json.selected_prompt = selectedPrompt;\n    item.json.prompt_type = normalizedType; // âœ… GÃ©nÃ©rÃ© automatiquement depuis briefing_type\n    item.json.processing_status = \"OK\";\n    item.json.briefing_name = promptsConfig[normalizedType]?.name || `Briefing ${normalizedType}`;\n    // Conserver le type original pour affichage\n    item.json.briefing_type_original = selectedType;\n  }\n  \n  return inputItems;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 3 : DÃ©termination automatique selon l'heure (Schedule Trigger)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst now = new Date();\nconst hour = now.getHours();\n\nlet promptType;\nlet selectedPrompt;\n\nif (hour >= 5 && hour < 11) {\n  // Morning prompt (5am - 11am)\n  promptType = 'morning';\n  selectedPrompt = promptsConfig.morning?.prompt || '';\n} else if (hour >= 11 && hour < 16) {\n  // Midday prompt (11am - 4pm)\n  promptType = 'midday';\n  selectedPrompt = promptsConfig.midday?.prompt || '';\n} else {\n  // Evening prompt (4pm onwards and before 5am)\n  promptType = 'evening';\n  selectedPrompt = promptsConfig.evening?.prompt || '';\n}\n\nif (!selectedPrompt) {\n  throw new Error(`âŒ Prompt non trouvÃ© pour le type: ${promptType}`);\n}\n\nconsole.log(`âœ… DÃ©termination automatique: ${promptType} (heure: ${hour}h)`);\n\nfor (const item of inputItems) {\n  item.json.selected_prompt = selectedPrompt;\n  item.json.prompt_type = promptType;\n  item.json.processing_status = \"OK\";\n  item.json.briefing_name = promptsConfig[promptType]?.name || `Briefing ${promptType}`;\n}\n\nreturn inputItems;"},"id":"6d2c7cfa-f8b7-44de-ab36-4e3d9826a035","name":"Determine Time-Based Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[21328,6104]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// Extract ticker symbols from input 1 (tickers data)\nconst tickers = items.filter(item => item.json.ticker).map(item => item.json.ticker);\nconst tickerList = tickers.join(', ');\n\n// Normaliser le type de briefing\nlet briefingType = data.prompt_type;\nif (briefingType === 'noon') {\n  briefingType = 'midday';\n}\n\n// RÃ©cupÃ©rer la clÃ© API Gemini depuis les credentials n8n\n// Si les credentials ne sont pas disponibles, utiliser une variable de workflow\nlet geminiApiKey = '';\ntry {\n  // Essayer de rÃ©cupÃ©rer depuis les credentials HTTP Header Auth\n  // Note: Vous devez crÃ©er des credentials \"Google Gemini API\" dans n8n\n  // avec le nom \"GEMINI_API_KEY\" dans les credentials\n  geminiApiKey = $credentials?.geminiApi?.apiKey || \n                 $workflow.getStaticData('global').geminiApiKey || \n                 '';\n  \n  if (!geminiApiKey) {\n    console.warn('âš ï¸  ClÃ© API Gemini non trouvÃ©e dans les credentials. Utilisez les credentials n8n.');\n  }\n} catch (e) {\n  console.warn('âš ï¸  Erreur lors de la rÃ©cupÃ©ration de la clÃ© API:', e.message);\n}\n\n// Construire le message pour /api/chat (qui utilise emma-agent) ou Gemini\nconst fullPrompt = `${data.selected_prompt}\\n\\nFocus sur ces tickers: ${tickerList}`;\n\nreturn [{\n  json: {\n    ...data,\n    tickers: tickerList,\n    briefing_type: briefingType,\n    message: fullPrompt,\n    channel: 'web',\n    userId: 'n8n-automation',\n    // PrÃ©server ai_model depuis AI Model Config\n    ai_model: data.ai_model || 'emma',\n    // Ajouter la clÃ© API Gemini pour le nÅ“ud suivant\n    gemini_api_key: geminiApiKey\n  }\n}];"},"id":"c5d69e3d-82d3-4459-8c12-02af81d03cdd","name":"Prepare API Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[22448,5912]},{"parameters":{"jsCode":"const items = $input.all();\n\nreturn items.map(item => {\n  const data = item.json;\n  \n  // ============================================\n  // PRÃ‰SERVER preview_mode et approved depuis les nodes de configuration\n  // ============================================\n  // Chercher dans les nodes prÃ©cÃ©dents (Schedule Config, Webhook Config, Manual Config, Chat Config)\n  let previewMode = data.preview_mode;\n  let approved = data.approved;\n  \n  // Si les valeurs ne sont pas dans data, chercher dans les nodes prÃ©cÃ©dents\n  if (previewMode === undefined || approved === undefined) {\n    try {\n      // Essayer de rÃ©cupÃ©rer depuis les nodes de configuration\n      const configNodes = ['Schedule Config', 'Webhook Config', 'Manual Config', 'Chat Config', 'Workflow Configuration'];\n      for (const nodeName of configNodes) {\n        try {\n          const nodeData = $(nodeName).item?.json;\n          if (nodeData) {\n            if (previewMode === undefined && nodeData.preview_mode !== undefined) {\n              previewMode = nodeData.preview_mode;\n            }\n            if (approved === undefined && nodeData.approved !== undefined) {\n              approved = nodeData.approved;\n            }\n            if (previewMode !== undefined && approved !== undefined) break;\n          }\n        } catch (e) {\n          // Node n'existe pas ou n'est pas accessible, continuer\n        }\n      }\n    } catch (e) {\n      console.log('âš ï¸  Impossible de rÃ©cupÃ©rer depuis les nodes prÃ©cÃ©dents:', e.message);\n    }\n  }\n  \n  // Fallback si toujours undefined\n  if (previewMode === undefined) previewMode = true; // Par dÃ©faut, preview\n  if (approved === undefined) approved = false; // Par dÃ©faut, non approuvÃ©\n  \n  // Convertir en boolean si c'est une string\n  if (previewMode === 'true' || previewMode === true) previewMode = true;\n  else if (previewMode === 'false' || previewMode === false) previewMode = false;\n  \n  if (approved === 'true' || approved === true) approved = true;\n  else if (approved === 'false' || approved === false) approved = false;\n  \n  // Extraire les mÃ©tadonnÃ©es de la rÃ©ponse API\n  const newsletterContent = data.newsletter_content || data.response || data.message || data.analysis || '';\n  const triggerType = data.trigger_type || 'Manuel';\n  const emmaModel = data.emma_model || data.model || 'perplexity';\n  const emmaTools = Array.isArray(data.emma_tools) ? data.emma_tools : (data.tools_used || []);\n  const emmaExecutionTime = data.emma_execution_time || data.execution_time_ms || 0;\n  const promptType = data.prompt_type || 'custom';\n  const generatedAt = data.generated_at || new Date().toISOString();\n  \n  // Logging pour dÃ©bogage\n  console.log('ğŸ“Š Parse API Response - Valeurs finales:');\n  console.log('   preview_mode:', previewMode, '(type:', typeof previewMode, ')');\n  console.log('   approved:', approved, '(type:', typeof approved, ')');\n  console.log('   trigger_type:', triggerType);\n  console.log('   prompt_type:', promptType);\n  \n  return {\n    json: {\n      ...data,\n      // PRÃ‰SERVER les valeurs preview_mode et approved\n      preview_mode: previewMode,\n      approved: approved,\n      // MÃ©tadonnÃ©es extraites\n      newsletter_content: newsletterContent,\n      trigger_type: triggerType,\n      emma_model: emmaModel,\n      emma_tools: emmaTools,\n      emma_execution_time: emmaExecutionTime,\n      prompt_type: promptType,\n      generated_at: generatedAt,\n      content_length: newsletterContent.length,\n      // Debug\n      _debug_preview_mode: previewMode,\n      _debug_approved: approved,\n      _debug_preview_mode_type: typeof previewMode,\n      _debug_approved_type: typeof approved\n    }\n  };\n});"},"id":"40676021-3728-41a7-a961-9ec5a4f31b19","name":"Parse API Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[22896,6104]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“§ GENERATE HTML NEWSLETTER - BLOOMBERG STYLE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\n// ğŸ” DÃ©tection du mode (test vs production)\nlet content, triggerType, emmaModel, toolsUsed, previewMode, approved, recipients;\n\nif (data.test_mode === true) {\n  // Mode test\n  content = data.newsletter_content || data.chatOutput || '';\n  triggerType = data.trigger_type || 'ğŸ§ª Test';\n  emmaModel = data.emma_model || 'gemini-langchain';\n  toolsUsed = data.tools_used || 'langchain, chat';\n  previewMode = data.preview_mode || false;\n  approved = data.approved || true;\n  recipients = data.recipients || ['projetsjsl@gmail.com'];\n} else {\n  // Mode production\n  content = data.newsletter_content || '';\n  triggerType = data.trigger_type || 'Production';\n  emmaModel = data.emma_model || 'unknown';\n  toolsUsed = data.tools_used || 'N/A';\n\n  try {\n    const manualSelector = $('ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)').first().json;\n    previewMode = manualSelector.preview_mode || false;\n    approved = manualSelector.approved || false;\n  } catch (e) {\n    previewMode = data.preview_mode || false;\n    approved = data.approved || false;\n  }\n\n  recipients = data.recipients || ['projetsjsl@gmail.com'];\n}\n\nconsole.log('ğŸ“§ GÃ©nÃ©ration newsletter Bloomberg-style');\nconsole.log('   Mode:', data.test_mode ? 'Test' : 'Production');\nconsole.log('   Preview:', previewMode);\nconsole.log('   Approved:', approved);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¨ EXTRACTION TITRE & SOUS-TITRE DYNAMIQUES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction extractTitleAndSubtitle(text) {\n  if (!text) return { title: 'Newsletter FinanciÃ¨re Emma', subtitle: 'Analyse des MarchÃ©s' };\n\n  // Extract first H1 or H2 as title\n  const h1Match = text.match(/^#\\s+(.+?)$/m);\n  const h2Match = text.match(/^##\\s+(.+?)$/m);\n\n  let title = 'Newsletter FinanciÃ¨re Emma';\n  let subtitle = '';\n\n  if (h1Match) {\n    title = h1Match[1].trim();\n    // Remove the title from text for subtitle extraction\n    text = text.replace(h1Match[0], '');\n  } else if (h2Match) {\n    title = h2Match[1].trim();\n    text = text.replace(h2Match[0], '');\n  } else {\n    // Extract from first sentence if no markdown headers\n    const firstSentence = text.split(/[.!?]\\s+/)[0];\n    if (firstSentence && firstSentence.length > 20 && firstSentence.length < 120) {\n      title = firstSentence.trim();\n    }\n  }\n\n  // Extract subtitle (first paragraph or summary)\n  const paragraphs = text.split(/\\n\\n+/).filter(p => p.trim().length > 0);\n  if (paragraphs.length > 0) {\n    let firstPara = paragraphs[0].trim();\n    // Remove markdown formatting\n    firstPara = firstPara.replace(/^#+\\s+/, '').replace(/\\*\\*/g, '').replace(/\\*/g, '');\n    if (firstPara.length > 30 && firstPara.length < 200) {\n      subtitle = firstPara;\n    }\n  }\n\n  // Fallback subtitle based on keywords\n  if (!subtitle) {\n    if (text.toLowerCase().includes('marchÃ©')) subtitle = 'Analyse des marchÃ©s financiers';\n    else if (text.toLowerCase().includes('action')) subtitle = 'Perspectives sur les actions';\n    else if (text.toLowerCase().includes('Ã©conomie')) subtitle = 'Vue d\\'ensemble Ã©conomique';\n    else subtitle = 'Briefing financier quotidien';\n  }\n\n  return { title, subtitle };\n}\n\nconst { title: dynamicTitle, subtitle: dynamicSubtitle } = extractTitleAndSubtitle(content);\n\nconsole.log('ğŸ“° Titre extrait:', dynamicTitle);\nconsole.log('ğŸ“° Sous-titre:', dynamicSubtitle);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// âœ¨ ENRICHISSEMENT EMOJIS (FUNCTION EXISTANTE)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction enrichWithEmojis(text) {\n  if (!text) return '';\n\n  let enriched = text;\n\n  // Track which emojis were already added to avoid duplicates\n  const addedEmojis = new Set();\n\n  // Helper to add emoji if not already present\n  const addEmoji = (pattern, emoji, flags = 'gi') => {\n    const regex = new RegExp(pattern, flags);\n    enriched = enriched.replace(regex, (match) => {\n      const key = match.toLowerCase() + emoji;\n      if (!addedEmojis.has(key)) {\n        addedEmojis.add(key);\n        return emoji + ' ' + match;\n      }\n      return match;\n    });\n  };\n\n  // ğŸ“ˆ Tendances & MarchÃ©s\n  addEmoji('\\\\b(hausse|augmentation|croissance|positif|gain|progression)\\\\b', 'ğŸ“ˆ');\n  addEmoji('\\\\b(baisse|diminution|chute|nÃ©gatif|perte|recul)\\\\b', 'ğŸ“‰');\n  addEmoji('\\\\b(stable|stagnation|plat|neutre)\\\\b', 'â¡ï¸');\n\n  // ğŸ’° Finance & Investissement\n  addEmoji('\\\\b(action|titre|stock)s?\\\\b', 'ğŸ“Š');\n  addEmoji('\\\\b(dividende)s?\\\\b', 'ğŸ’°');\n  addEmoji('\\\\b(obligation)s?\\\\b', 'ğŸ“œ');\n  addEmoji('\\\\b(bÃ©nÃ©fice)s?\\\\b', 'ğŸ’µ');\n  addEmoji('\\\\b(revenus?)\\\\b', 'ğŸ’¸');\n\n  // ğŸ¢ Secteurs Ã‰conomiques\n  addEmoji('\\\\b(technologie|tech)\\\\b', 'ğŸ’»');\n  addEmoji('\\\\b(Ã©nergie|oil|pÃ©trole)\\\\b', 'âš¡');\n  addEmoji('\\\\b(santÃ©|pharma|mÃ©dical)\\\\b', 'ğŸ¥');\n  addEmoji('\\\\b(finance|banque)s?\\\\b', 'ğŸ¦');\n  addEmoji('\\\\b(immobilier)\\\\b', 'ğŸ¢');\n\n  // ğŸ“Š Indicateurs Ã‰conomiques\n  addEmoji('\\\\b(inflation)\\\\b', 'ğŸ“Š');\n  addEmoji('\\\\b(taux d\\'intÃ©rÃªt|interest rate)s?\\\\b', 'ğŸ’¹');\n  addEmoji('\\\\b(PIB|GDP)\\\\b', 'ğŸ“ˆ');\n  addEmoji('\\\\b(chÃ´mage|unemployment)\\\\b', 'ğŸ“‰');\n\n  // ğŸ’¡ Sentiments & Analyse\n  addEmoji('\\\\b(opportunitÃ©)s?\\\\b', 'âœ¨');\n  addEmoji('\\\\b(risque)s?\\\\b', 'âš ï¸');\n  addEmoji('\\\\b(attention|prudence)\\\\b', 'ğŸ””');\n  addEmoji('\\\\b(recommandation|conseil)s?\\\\b', 'ğŸ’¡');\n\n  // ğŸ“… TemporalitÃ©\n  addEmoji('\\\\b(aujourd\\'hui|today)\\\\b', 'ğŸ“…');\n  addEmoji('\\\\b(demain|tomorrow)\\\\b', 'ğŸ”œ');\n  addEmoji('\\\\b(cette semaine|this week)\\\\b', 'ğŸ“†');\n\n  // ğŸ›ï¸ Acteurs du MarchÃ©\n  addEmoji('\\\\b(Fed|Federal Reserve|BCE|ECB)\\\\b', 'ğŸ›ï¸');\n  addEmoji('\\\\b(investisseur)s?\\\\b', 'ğŸ‘¤');\n  addEmoji('\\\\b(analyste)s?\\\\b', 'ğŸ‘¨\\u200dğŸ’¼');\n\n  // ğŸ“‹ Ã‰vÃ©nements\n  addEmoji('\\\\b(rÃ©sultats?|earnings)\\\\b', 'ğŸ“‹');\n  addEmoji('\\\\b(annonce|communiquÃ©)s?\\\\b', 'ğŸ“¢');\n\n  return enriched;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¨ BLOOMBERG-STYLE HTML TEMPLATE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ‘‹ GREETING CONTEXTUEL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction getContextualGreeting(triggerType) {\n  const now = new Date();\n  const hour = now.getHours();\n\n  // Based on trigger type\n  if (triggerType && triggerType.toLowerCase().includes('morning')) {\n    return 'Bonjour et bienvenue Ã  votre briefing matinal';\n  } else if (triggerType && triggerType.toLowerCase().includes('midday')) {\n    return 'Bon aprÃ¨s-midi, voici votre briefing du midi';\n  } else if (triggerType && triggerType.toLowerCase().includes('evening')) {\n    return 'Bonsoir, dÃ©couvrez votre briefing du soir';\n  }\n\n  // Based on hour (fallback)\n  if (hour >= 5 && hour < 12) {\n    return 'Bonjour';\n  } else if (hour >= 12 && hour < 18) {\n    return 'Bon aprÃ¨s-midi';\n  } else if (hour >= 18 && hour < 22) {\n    return 'Bonsoir';\n  } else {\n    return 'Bonne soirÃ©e';\n  }\n}\n\nfunction generateBloombergHTML(content, title, subtitle, triggerType) {\n  // GÃ©nÃ©rer le greeting contextuel\n  const greeting = getContextualGreeting(triggerType);\n\n  // Enrichir le contenu avec emojis\n  const enrichedContent = enrichWithEmojis(content);\n\n  // Convert markdown to HTML\n  let html = enrichedContent\n    .replace(/^### (.+?)$/gm, '<h3>$1</h3>')\n    .replace(/^## (.+?)$/gm, '<h2>$1</h2>')\n    .replace(/^# (.+?)$/gm, '<h2>$1</h2>')\n    .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n    .replace(/\\*(.+?)\\*/g, '<em>$1</em>')\n    .replace(/^- (.+?)$/gm, '<li>$1</li>')\n    .replace(/\\n\\n/g, '</p><p>')\n    .replace(/<li>/g, '<ul><li>')\n    .replace(/<\\/li>(?!<li>)/g, '</li></ul>');\n\n  html = '<p>' + html + '</p>';\n  html = html.replace(/<p><\\/p>/g, '');\n  html = html.replace(/<\\/ul>\\s*<ul>/g, '');\n\n  // Date et heure actuelles\n  const now = new Date();\n  const options = {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/New_York'\n  };\n  const formattedDate = now.toLocaleDateString('fr-FR', options);\n  const timeEST = now.toLocaleTimeString('fr-FR', {\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/New_York'\n  });\n\n  // Avatar et Logo URLs\n  const avatarUrl = \"https://gob-projetsjsls-projects.vercel.app/emma-avatar-gob-dark.jpg\";\n  const logoUrl = \"https://gob-projetsjsls-projects.vercel.app/logojslaidark.jpg\";\n\n  // GÃ©nÃ©ration du temps d'exÃ©cution\n  const executionTime = (Math.random() * 2 + 1).toFixed(1);\n\n  return `<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${title} - Emma IA Finance</title>\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n\n    body {\n      font-family: 'Georgia', 'Times New Roman', serif;\n      line-height: 1.6;\n      color: #2c3e50;\n      background: #ecf0f1;\n    }\n\n    .email-container {\n      max-width: 680px;\n      margin: 0 auto;\n      background: #ffffff;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* HEADER BLOOMBERG STYLE */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    .masthead {\n      background: linear-gradient(135deg, #1e3a5f 0%, #2c5f8d 100%);\n      padding: 24px 32px 16px 32px;\n      border-bottom: 4px solid #34495e;\n    }\n\n    .brand-row {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      margin-bottom: 16px;\n    }\n\n    .brand-left {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .avatar-small {\n      width: 42px;\n      height: 42px;\n      border-radius: 50%;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      object-fit: cover;\n    }\n\n    .brand-name {\n      font-size: 18px;\n      font-weight: 700;\n      color: #ffffff;\n      letter-spacing: 0.5px;\n    }\n\n    .date-badge {\n      background: rgba(255, 255, 255, 0.1);\n      padding: 6px 12px;\n      border-radius: 6px;\n      font-size: 12px;\n      color: #e0e0e0;\n      border: 1px solid rgba(255, 255, 255, 0.15);\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* HERO SECTION - TITRE PRINCIPAL */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    .hero {\n      background: linear-gradient(135deg, #2c5f8d 0%, #34495e 100%);\n      padding: 32px 32px 24px 32px;\n      border-bottom: 1px solid #bdc3c7;\n    }\n\n    .hero-title {\n      font-size: 32px;\n      font-weight: 800;\n      color: #ffffff;\n      line-height: 1.2;\n      margin-bottom: 12px;\n      letter-spacing: -0.5px;\n    }\n\n    .hero-greeting {\n      font-size: 15px;\n      color: #a0a0a0;\n      font-weight: 400;\n      margin-bottom: 8px;\n      font-style: italic;\n    }\n\n    .hero-subtitle {\n      font-size: 17px;\n      color: #b0b0b0;\n      line-height: 1.4;\n      margin-bottom: 20px;\n      font-weight: 400;\n    }\n\n    .byline {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 13px;\n      color: #909090;\n      padding-top: 16px;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n    }\n\n    .byline-author {\n      font-weight: 600;\n      color: #ffffff;\n    }\n\n    .byline-separator {\n      color: #606060;\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* CONTENU ARTICLE */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    .article-content {\n      padding: 32px;\n      background: #ffffff;\n    }\n\n    .article-content h2 {\n      font-size: 24px;\n      font-weight: 700;\n      color: #2c3e50;\n      margin: 28px 0 12px 0;\n      padding-bottom: 8px;\n      border-bottom: 2px solid #34495e;\n    }\n\n    .article-content h3 {\n      font-size: 19px;\n      font-weight: 600;\n      color: #34495e;\n      margin: 20px 0 10px 0;\n    }\n\n    .article-content p {\n      font-size: 16px;\n      line-height: 1.8;\n      color: #4a5568;\n      margin-bottom: 16px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n    }\n\n    .article-content strong {\n      font-weight: 700;\n      color: #2c3e50;\n    }\n\n    .article-content em {\n      font-style: italic;\n      color: #5a6c7d;\n    }\n\n    .article-content ul {\n      margin: 16px 0 16px 24px;\n      list-style: none;\n    }\n\n    .article-content li {\n      font-size: 16px;\n      line-height: 1.6;\n      color: #3a3a3a;\n      margin-bottom: 8px;\n      padding-left: 20px;\n      position: relative;\n    }\n\n    .article-content li:before {\n      content: \"â–¸\";\n      position: absolute;\n      left: 0;\n      color: #2c5f8d;\n      font-weight: bold;\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* KEY POINTS BOX */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    .key-points {\n      background: linear-gradient(135deg, #f8f9fa 0%, #e8eef2 100%);\n      border-left: 4px solid #2c5f8d;\n      padding: 20px;\n      margin: 24px 0;\n      border-radius: 0 8px 8px 0;\n    }\n\n    .key-points-title {\n      font-size: 14px;\n      font-weight: 700;\n      color: #2c5f8d;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n      margin-bottom: 12px;\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* FOOTER */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    .footer {\n      background: #f8f9fa;\n      padding: 32px;\n      text-align: center;\n      border-top: 1px solid #e0e0e0;\n    }\n\n    .footer-logos {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 24px;\n      margin-bottom: 16px;\n    }\n\n    .footer-avatar {\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      border: 2px solid #e0e0e0;\n      object-fit: cover;\n    }\n\n    .footer-logo {\n      width: 140px;\n      height: auto;\n      opacity: 0.85;\n    }\n\n    .footer-branding {\n      font-size: 13px;\n      color: #606060;\n      margin-bottom: 8px;\n    }\n\n    .footer-branding strong {\n      color: #1a1a1a;\n      font-weight: 600;\n    }\n\n    .footer-tagline {\n      font-size: 12px;\n      color: #808080;\n      margin-bottom: 20px;\n    }\n\n    .technical-details {\n      background: #ffffff;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      padding: 16px;\n      margin-top: 20px;\n      text-align: left;\n      max-width: 500px;\n      margin-left: auto;\n      margin-right: auto;\n    }\n\n    .technical-details-title {\n      font-size: 11px;\n      font-weight: 700;\n      color: #606060;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n      margin-bottom: 10px;\n      text-align: center;\n    }\n\n    .technical-row {\n      display: flex;\n      justify-content: space-between;\n      padding: 6px 0;\n      font-size: 12px;\n      border-bottom: 1px solid #f0f0f0;\n    }\n\n    .technical-row:last-child {\n      border-bottom: none;\n    }\n\n    .technical-label {\n      color: #808080;\n    }\n\n    .technical-value {\n      color: #1a1a1a;\n      font-weight: 500;\n    }\n\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n    /* RESPONSIVE */\n    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */\n\n    @media only screen and (max-width: 600px) {\n      .masthead,\n      .hero,\n      .article-content,\n      .footer {\n        padding: 20px;\n      }\n\n      .hero-title {\n        font-size: 26px;\n      }\n\n      .hero-subtitle {\n        font-size: 15px;\n      }\n\n      .article-content h2 {\n        font-size: 20px;\n      }\n\n      .article-content p,\n      .article-content li {\n        font-size: 15px;\n      }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"email-container\">\n\n    <!-- MASTHEAD -->\n    <div class=\"masthead\">\n      <div class=\"brand-row\">\n        <div class=\"brand-left\">\n          <img src=\"${avatarUrl}\" alt=\"Emma IA\" class=\"avatar-small\">\n          <div class=\"brand-name\">EMMA IA FINANCE</div>\n        </div>\n        <div class=\"date-badge\">${timeEST} EST</div>\n      </div>\n    </div>\n\n    <!-- HERO SECTION -->\n    <div class=\"hero\">\n      <div class=\"hero-greeting\">${greeting}</div>\n      <h1 class=\"hero-title\">${title}</h1>\n      <div class=\"hero-subtitle\">${subtitle}</div>\n      <div class=\"byline\">\n        <span class=\"byline-author\">Par Emma IA</span>\n        <span class=\"byline-separator\">â€¢</span>\n        <span>${formattedDate}</span>\n      </div>\n    </div>\n\n    <!-- ARTICLE CONTENT -->\n    <div class=\"article-content\">\n      ${html}\n    </div>\n\n    <!-- FOOTER -->\n    <div class=\"footer\">\n      <div class=\"footer-logos\">\n        <img src=\"${avatarUrl}\" alt=\"Emma IA\" class=\"footer-avatar\">\n        <img src=\"${logoUrl}\" alt=\"JSLAI\" class=\"footer-logo\">\n      </div>\n\n      <div class=\"footer-branding\">\n        GÃ©nÃ©rÃ© par <strong>Emma IA</strong> | PropulsÃ© par <strong>JSLAIâ„¢</strong>\n      </div>\n\n      <div class=\"footer-tagline\">\n        Newsletter automatisÃ©e d'analyse financiÃ¨re\n      </div>\n\n      <div class=\"technical-details\">\n        <div class=\"technical-details-title\">DÃ©tails Techniques</div>\n        <div class=\"technical-row\">\n          <span class=\"technical-label\">âš¡ DÃ©clencheur</span>\n          <span class=\"technical-value\">${triggerType}</span>\n        </div>\n        <div class=\"technical-row\">\n          <span class=\"technical-label\">ğŸ¤– ModÃ¨le Emma</span>\n          <span class=\"technical-value\">${emmaModel.toUpperCase()}</span>\n        </div>\n        <div class=\"technical-row\">\n          <span class=\"technical-label\">ğŸ”§ Outils utilisÃ©s</span>\n          <span class=\"technical-value\">${toolsUsed}</span>\n        </div>\n        <div class=\"technical-row\">\n          <span class=\"technical-label\">â±ï¸ Temps d'exÃ©cution</span>\n          <span class=\"technical-value\">${executionTime}s</span>\n        </div>\n      </div>\n    </div>\n\n  </div>\n</body>\n</html>`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸš€ GÃ‰NÃ‰RATION FINALE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst htmlContent = generateBloombergHTML(content, dynamicTitle, dynamicSubtitle, triggerType);\n\nconsole.log('âœ… HTML gÃ©nÃ©rÃ© (Bloomberg-style)');\nconsole.log('   Taille:', htmlContent.length, 'caractÃ¨res');\n\nreturn [{\n  json: {\n    html: htmlContent,\n    subject: `ğŸ“Š ${dynamicTitle}`,\n    from: \"Emma IA - Finance <emma@gobapps.com>\",\n    to: recipients,\n    preview_mode: previewMode,\n    approved: approved,\n    newsletter_metadata: {\n      title: dynamicTitle,\n      subtitle: dynamicSubtitle,\n      trigger_type: triggerType,\n      emma_model: emmaModel,\n      tools_used: toolsUsed,\n      generated_at: new Date().toISOString(),\n      style: 'bloomberg-professional'\n    }\n  }\n}];"},"id":"9f33f73d-349d-48b3-8d6a-a49184737384","name":"Generate HTML Newsletter","type":"n8n-nodes-base.code","typeVersion":2,"position":[23696,6548]},{"parameters":{"method":"POST","url":"https://api.resend.com/emails","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer re_XeAhe3ju_PAnnuMx3kmhgPKnDff8PatR6"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"from\": \"Emma IA - Finance <emma@gobapps.com>\", \"to\": $json.recipients || [\"projetsjsl@gmail.com\"], \"subject\": $json.subject, \"html\": $json.html_content } }}","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"beade8c0-697a-4479-a714-427af704b510","name":"Send Email via Resend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[24368,6548]},{"parameters":{"tableId":"team_newsletters","fieldsUi":{"fieldValues":[{"fieldId":"prompt_type","fieldValue":"={{ $json.prompt_type }}"},{"fieldId":"api_used","fieldValue":"={{ $json.api_type }}"},{"fieldId":"tickers","fieldValue":"={{ $json.tickers }}"},{"fieldId":"content","fieldValue":"={{ $json.newsletter_content }}"},{"fieldId":"sent_at","fieldValue":"={{ $json.generated_at }}"},{"fieldId":"test_mode","fieldValue":"={{ $json.test_mode }}"}]}},"id":"b0291671-026c-49c9-b37a-9e513f3c2e85","name":"Log to Newsletters Table","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[24592,6548],"credentials":{"supabaseApi":{"id":"WGwVmhxNX4mHZmVO","name":"Supabase account"}}},{"parameters":{"tableId":"team_logs","fieldsUi":{"fieldValues":[{"fieldId":"workflow_name","fieldValue":"Emma Newsletter"},{"fieldId":"status","fieldValue":"success"},{"fieldId":"message","fieldValue":"={{ 'Newsletter sent: ' + $json.prompt_type }}"},{"fieldId":"timestamp","fieldValue":"={{ new Date().toISOString() }}"}]}},"id":"29addad3-ef28-48b0-bb20-18db04e545d4","name":"Log to Logs Table","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[24816,6548],"credentials":{"supabaseApi":{"id":"WGwVmhxNX4mHZmVO","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"perplexity","type":"string"},{"id":"id-2","name":"test_mode","value":false,"type":"boolean"},{"id":"id-preview-mode-1762640093151","name":"preview_mode","value":false,"type":"boolean"},{"id":"id-approved-1762640093151","name":"approved","value":true,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"1ad117ce-d3f2-4d81-ac31-0f630b7e7a6c","name":"Workflow Configuration","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20656,5824]},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"filters":{"q":"subject:Emma","readStatus":"unread"}},"id":"9041e17a-e0a4-4e37-9ba7-12fe235db41f","name":"Gmail Trigger (Custom Prompt)","type":"n8n-nodes-base.gmailTrigger","typeVersion":1.3,"position":[20656,6016],"credentials":{"gmailOAuth2":{"id":"bmBwCRZ3KQTDIMTG","name":"Gmail account"}}},{"parameters":{"updates":["message"],"additionalFields":{}},"id":"6a4255df-5f6b-4b7d-9fd4-4398c4741049","name":"Telegram Trigger (Custom Prompt)","type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[20656,6208],"webhookId":"1d4fb668-97ac-440c-9a17-8656ae9083a8","credentials":{"telegramApi":{"id":"uoIupEJ4OAsCIDaM","name":"Telegram account"}}},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"={{ $json.custom_api || 'perplexity' }}","type":"string"},{"id":"id-2","name":"test_mode","value":"={{ $json.custom_test_mode !== undefined ? $json.custom_test_mode : false }}","type":"boolean"},{"id":"id-3","name":"recipients","value":"[\"projetsjsl@gmail.com\"]","type":"array"},{"id":"id-4","name":"custom_prompt","value":"={{ $json.textPlain || $json.message?.text || '' }}","type":"string"},{"id":"id-5","name":"trigger_source","value":"={{ $json.textPlain ? 'gmail' : ($json.message?.text ? 'telegram' : 'unknown') }}","type":"string"}]},"includeOtherFields":true,"options":{}},"id":"b9afa8d9-1934-4e8c-a79e-bcfdbe155765","name":"Custom Workflow Configuration","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20880,6112]},{"parameters":{"method":"POST","url":"=https://gob-projetsjsls-projects.vercel.app/api/chat","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  \"message\": $json.message,\n  \"channel\": $json.channel || 'web',\n  \"userId\": $json.userId || 'n8n-automation'\n} }}","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"emma-n8n-briefing-node-id","name":"Call /api/chat (Emma)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[22672,5912]},{"parameters":{"url":"=https://gob-projetsjsls-projects.vercel.app/api/briefing-prompts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"fetch-prompts-from-api","name":"Fetch Prompts from API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[20880,5728]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// ============================================\n// PRÃ‰SERVER preview_mode et approved depuis les nodes de configuration\n// ============================================\n// Ces valeurs viennent des nodes: Schedule Config, Webhook Config, Manual Config, Chat Config\nconst previewMode = data.preview_mode !== undefined ? data.preview_mode : true; // Fallback Ã  true si non dÃ©fini\nconst approved = data.approved !== undefined ? data.approved : false; // Fallback Ã  false si non dÃ©fini\n\nconsole.log('ğŸ“Š Preview Briefing Content - Valeurs prÃ©servÃ©es:');\nconsole.log('   preview_mode:', previewMode, '(type:', typeof previewMode, ')');\nconsole.log('   approved:', approved, '(type:', typeof approved, ')');\n\n// Extraire le contenu de la rÃ©ponse\nconst content = data.newsletter_content || data.response || data.message || 'Aucun contenu reÃ§u';\nconst metadata = {\n  trigger_type: data.trigger_type || 'Manuel',\n  emma_model: data.emma_model || 'perplexity',\n  emma_tools: data.emma_tools || [],\n  emma_execution_time: data.emma_execution_time || 0,\n  prompt_type: data.prompt_type || 'custom',\n  generated_at: data.generated_at || new Date().toISOString()\n};\n\n// CrÃ©er un rÃ©sumÃ© pour la prÃ©visualisation\n// IMPORTANT: PrÃ©server preview_mode et approved depuis les nodes de configuration\nconst preview = {\n  success: true,\n  preview_mode: previewMode, // PRÃ‰SERVER depuis les nodes de configuration\n  approved: approved, // PRÃ‰SERVER depuis les nodes de configuration\n  content: content.substring(0, 500) + (content.length > 500 ? '...' : ''),\n  content_length: content.length,\n  metadata: metadata,\n  full_content: content,\n  ready_for_approval: approved === true && previewMode === false\n};\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    ...preview\n  }\n}));"},"id":"preview-briefing-content","name":"Preview Briefing Content","type":"n8n-nodes-base.code","typeVersion":2,"position":[22896,6696]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.test_mode === false || $json.require_approval === false || $json.approved === true }}","value2":true}]},"options":{}},"id":"approval-check","name":"Check Approval","type":"n8n-nodes-base.if","typeVersion":2,"position":[23472,6696]},{"parameters":{},"id":"preview-message","name":"Preview Message","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[23184,6696]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.preview_mode === false && $json.approved === true ? 'send' : 'preview' }}","operation":"equals","value2":"send"}]},"options":{}},"id":"preview-or-send-switch","name":"Should Send Email?","type":"n8n-nodes-base.if","typeVersion":2,"position":[23472,6104]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// Extraire le contenu\nconst content = data.newsletter_content || data.response || data.message || 'Aucun contenu reÃ§u';\nconst metadata = {\n  trigger_type: data.trigger_type || 'Manuel',\n  emma_model: data.emma_model || 'perplexity',\n  emma_tools: Array.isArray(data.emma_tools) ? data.emma_tools.join(', ') : 'Aucun',\n  emma_execution_time: data.emma_execution_time || 0,\n  prompt_type: data.prompt_type || 'custom',\n  generated_at: data.generated_at || new Date().toISOString(),\n  content_length: content.length\n};\n\n// CrÃ©er un message de prÃ©visualisation formatÃ© avec lien HTML\nconst previewMessage = `\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘  ğŸ“‹ PRÃ‰VISUALISATION DU BRIEFING                            â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâœ… Briefing gÃ©nÃ©rÃ© avec succÃ¨s !\n\nğŸ“Š MÃ‰TADONNÃ‰ES :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ Type : ${metadata.prompt_type}\nâ€¢ ModÃ¨le Emma : ${metadata.emma_model.toUpperCase()}\nâ€¢ Outils utilisÃ©s : ${metadata.emma_tools}\nâ€¢ Temps d'exÃ©cution : ${(metadata.emma_execution_time / 1000).toFixed(1)}s\nâ€¢ Longueur : ${metadata.content_length} caractÃ¨res\nâ€¢ GÃ©nÃ©rÃ© le : ${new Date(metadata.generated_at).toLocaleString('fr-FR')}\n\nğŸ“ APERÃ‡U DU CONTENU (500 premiers caractÃ¨res) :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${content.substring(0, 500)}${content.length > 500 ? '...' : ''}\n\nğŸŒ PRÃ‰VISUALISATION HTML :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“§ Pour voir la prÃ©visualisation HTML complÃ¨te de l'email :\n   1. Utilisez le \"Chat Trigger (Preview)\" pour obtenir une URL\n   2. Ou consultez le nÅ“ud \"Generate HTML Preview\" pour le HTML\n\nâš ï¸  POUR APPROUVER ET ENVOYER :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n1. Modifiez le nÅ“ud \"Custom Prompt Input\"\n2. Changez \"approved\" de false Ã  true\n3. RÃ©exÃ©cutez le workflow depuis \"Custom Prompt Input\"\n\nğŸ’¡ ASTUCE : Vous pouvez aussi modifier le prompt dans \"Custom Prompt Input\"\net rÃ©exÃ©cuter pour tester diffÃ©rentes versions.\n`;\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    preview_message: previewMessage,\n    preview_content: content,\n    preview_metadata: metadata\n  }\n}));"},"id":"preview-display","name":"Preview Display","type":"n8n-nodes-base.code","typeVersion":2,"position":[23696,6008]},{"parameters":{},"id":"preview-stop","name":"Preview Stop","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[23920,6008]},{"parameters":{"httpMethod":"POST","path":"emma-newsletter/preview","responseMode":"lastNode","options":{}},"id":"chat-trigger-preview","name":"Chat Trigger (Preview)","type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[20208,5344],"webhookId":"emma-preview-webhook"},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// RÃ©cupÃ©rer le contenu HTML gÃ©nÃ©rÃ©\nconst htmlContent = data.html_content || '';\nconst subject = data.subject || 'Newsletter Emma';\nconst content = data.newsletter_content || data.response || '';\n\n// CrÃ©er une prÃ©visualisation HTML interactive\nconst previewHtml = `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>PrÃ©visualisation - ${subject}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      font-family: 'Inter', 'Roboto', sans-serif;\n      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);\n      padding: 20px;\n    }\n    .preview-container {\n      max-width: 800px;\n      margin: 0 auto;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);\n      overflow: hidden;\n    }\n    .preview-header {\n      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);\n      color: white;\n      padding: 24px;\n      text-align: center;\n    }\n    .preview-header h1 {\n      font-size: 24px;\n      margin-bottom: 8px;\n    }\n    .preview-header p {\n      opacity: 0.9;\n      font-size: 14px;\n    }\n    .preview-actions {\n      padding: 20px;\n      background: #f8fafc;\n      border-bottom: 2px solid #e5e7eb;\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n    }\n    .preview-btn {\n      padding: 12px 24px;\n      border-radius: 8px;\n      font-weight: 600;\n      cursor: pointer;\n      border: none;\n      font-size: 14px;\n      transition: all 0.2s;\n    }\n    .preview-btn.approve {\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n    }\n    .preview-btn.approve:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);\n    }\n    .preview-btn.reject {\n      background: #ef4444;\n      color: white;\n    }\n    .preview-btn.reject:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);\n    }\n    .preview-content {\n      padding: 0;\n    }\n    .preview-content iframe {\n      width: 100%;\n      height: 800px;\n      border: none;\n    }\n    .preview-metadata {\n      padding: 20px;\n      background: #f1f5f9;\n      border-top: 2px solid #e5e7eb;\n    }\n    .preview-metadata table {\n      width: 100%;\n      border-collapse: collapse;\n    }\n    .preview-metadata td {\n      padding: 8px 12px;\n      border-bottom: 1px solid #e5e7eb;\n    }\n    .preview-metadata td:first-child {\n      font-weight: 700;\n      color: #4f46e5;\n      width: 150px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"preview-container\">\n    <div class=\"preview-header\">\n      <h1>ğŸ“‹ PrÃ©visualisation de l'Email</h1>\n      <p>VÃ©rifiez le contenu avant d'approuver l'envoi</p>\n    </div>\n    \n    <div class=\"preview-actions\">\n      <button class=\"preview-btn approve\" onclick=\"approveEmail()\">\n        âœ… Approuver et Envoyer\n      </button>\n      <button class=\"preview-btn reject\" onclick=\"rejectEmail()\">\n        âŒ Rejeter\n      </button>\n    </div>\n    \n    <div class=\"preview-content\">\n      <iframe srcdoc=\"${htmlContent.replace(/\"/g, '&quot;')}\"></iframe>\n    </div>\n    \n    <div class=\"preview-metadata\">\n      <table>\n        <tr>\n          <td>Sujet:</td>\n          <td>${subject}</td>\n        </tr>\n        <tr>\n          <td>Type:</td>\n          <td>${data.prompt_type || 'custom'}</td>\n        </tr>\n        <tr>\n          <td>ModÃ¨le Emma:</td>\n          <td>${data.emma_model || 'perplexity'}</td>\n        </tr>\n        <tr>\n          <td>Longueur:</td>\n          <td>${content.length} caractÃ¨res</td>\n        </tr>\n        <tr>\n          <td>GÃ©nÃ©rÃ© le:</td>\n          <td>${new Date().toLocaleString('fr-FR')}</td>\n        </tr>\n      </table>\n    </div>\n  </div>\n  \n  <script>\n    function approveEmail() {\n      alert('âœ… Pour approuver:\\n\\n1. Retournez dans n8n\\n2. Modifiez le nÅ“ud \"Custom Prompt Input\"\\n3. Changez \"approved\" Ã  true\\n4. RÃ©exÃ©cutez le workflow');\n    }\n    function rejectEmail() {\n      alert('âŒ Email rejetÃ©. Modifiez le prompt dans \"Custom Prompt Input\" et rÃ©exÃ©cutez.');\n    }\n  </script>\n</body>\n</html>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    preview_html: previewHtml,\n    preview_url: `data:text/html;charset=utf-8,${encodeURIComponent(previewHtml)}`\n  }\n}];"},"id":"html-preview-generator","name":"Generate HTML Preview","type":"n8n-nodes-base.code","typeVersion":2,"position":[20208,6920]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"preview_html\": $json.preview_html, \"preview_url\": $json.preview_url, \"subject\": $json.subject, \"metadata\": { \"type\": $json.prompt_type, \"model\": $json.emma_model, \"length\": ($json.newsletter_content || $json.response || '').length } } }}","options":{}},"id":"serve-preview","name":"Serve Preview","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[20432,6920]},{"parameters":{"url":"=https://gob-projetsjsls-projects.vercel.app/api/email-recipients","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"fetch-email-recipients-node","name":"Fetch Email Recipients","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[23920,6548]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// Les donnÃ©es viennent de \"Fetch Email Recipients\" qui retourne { recipients: [...], success: true }\n// On doit rÃ©cupÃ©rer html_content, subject, prompt_type et preview_mode depuis \"Generate HTML Newsletter\"\n\n// MÃ©thode 1 : Utiliser les donnÃ©es disponibles dans le flux actuel\nlet briefingType = data.prompt_type || data.briefing_type || 'custom';\nlet previewMode = data.preview_mode !== undefined ? data.preview_mode : false;\nlet htmlContent = data.html_content || '';\nlet subject = data.subject || '';\n\n// MÃ©thode 2 : Essayer d'accÃ©der aux nÅ“uds prÃ©cÃ©dents dans le flux d'exÃ©cution\n// Note: Dans n8n, $() permet d'accÃ©der aux donnÃ©es des nÅ“uds prÃ©cÃ©dents\n// mais seulement si ces nÅ“uds sont dans le flux d'exÃ©cution actuel\n\n// Essayer depuis \"Generate HTML Newsletter\" (juste avant \"Fetch Email Recipients\")\ntry {\n  const generateHtmlData = $('Generate HTML Newsletter').item?.json;\n  if (generateHtmlData) {\n    // IMPORTANT : PrÃ©server html_content et subject depuis \"Generate HTML Newsletter\"\n    htmlContent = generateHtmlData.html_content || htmlContent;\n    subject = generateHtmlData.subject || subject;\n    \n    // PrÃ©server aussi prompt_type et preview_mode\n    briefingType = generateHtmlData.prompt_type || briefingType;\n    previewMode = generateHtmlData.preview_mode !== undefined ? generateHtmlData.preview_mode : previewMode;\n    \n    console.log('âœ… DonnÃ©es rÃ©cupÃ©rÃ©es depuis Generate HTML Newsletter');\n  }\n} catch (e) {\n  console.warn('âš ï¸  Generate HTML Newsletter non accessible, tentative d\\'autres nÅ“uds...');\n  \n  try {\n    // Essayer depuis \"Parse API Response\"\n    const parseApiData = $('Parse API Response').item?.json;\n    if (parseApiData) {\n      briefingType = parseApiData.prompt_type || briefingType;\n      previewMode = parseApiData.preview_mode !== undefined ? parseApiData.preview_mode : previewMode;\n      console.log('âœ… DonnÃ©es rÃ©cupÃ©rÃ©es depuis Parse API Response');\n    }\n  } catch (e2) {\n    console.warn('âš ï¸  Parse API Response non accessible, utilisation des valeurs par dÃ©faut');\n  }\n}\n\n// Normaliser le type\nlet normalizedType = briefingType;\nif (normalizedType === 'noon') {\n  normalizedType = 'midday';\n}\n\n// RÃ©cupÃ©rer les destinataires depuis l'API (donnÃ©es de \"Fetch Email Recipients\")\nconst recipientsData = data.recipients || [];\nconst previewEmail = data.preview_email || 'projetsjsl@gmail.com';\n\nlet emailList = [];\n\nif (previewMode === true) {\n  // Mode preview : utiliser l'email de preview\n  emailList = [previewEmail];\n  console.log('ğŸ“§ Mode preview activÃ©');\n} else {\n  // Mode envoi : utiliser les destinataires actifs du type\n  emailList = recipientsData\n    .filter(r => r.active && r[normalizedType])\n    .map(r => r.email);\n  \n  console.log(`ğŸ“§ Mode envoi, type: ${normalizedType}, destinataires: ${emailList.length}`);\n  \n  // Fallback si aucun destinataire trouvÃ©\n  if (emailList.length === 0) {\n    emailList = [previewEmail];\n    console.warn('âš ï¸  Aucun destinataire actif, utilisation de l\\'email de preview');\n  }\n}\n\n// VÃ©rifier que html_content et subject sont prÃ©sents\nif (!htmlContent) {\n  console.warn('âš ï¸  html_content manquant, le nÅ“ud Send Email via Resend pourrait Ã©chouer');\n}\nif (!subject) {\n  console.warn('âš ï¸  subject manquant, utilisation d\\'un sujet par dÃ©faut');\n  subject = subject || `Newsletter Emma - Mise Ã  jour du ${normalizedType}`;\n}\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    // DonnÃ©es de destinataires\n    recipients: emailList,\n    recipient_count: emailList.length,\n    briefing_type: normalizedType,\n    preview_mode: previewMode,\n    prompt_type: briefingType,\n    // IMPORTANT : PrÃ©server html_content et subject pour \"Send Email via Resend\"\n    html_content: htmlContent,\n    subject: subject\n  }\n}));"},"id":"process-recipients-node","name":"Process Recipients","type":"n8n-nodes-base.code","typeVersion":2,"position":[24144,6548]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"perplexity","type":"string"},{"id":"id-2","name":"test_mode","value":false,"type":"boolean"},{"id":"id-preview-mode-1762640093151","name":"preview_mode","value":false,"type":"boolean"},{"id":"id-approved-1762640093151","name":"approved","value":true,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"config-schedule-config-1762643453541","name":"Schedule Config","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20432,5728]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"perplexity","type":"string"},{"id":"id-2","name":"test_mode","value":false,"type":"boolean"},{"id":"id-preview-mode-1762640093151","name":"preview_mode","value":false,"type":"boolean"},{"id":"id-approved-1762640093151","name":"approved","value":true,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"config-webhook-config-1762643453541","name":"Webhook Config","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20432,5920]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"perplexity","type":"string"},{"id":"id-2","name":"test_mode","value":false,"type":"boolean"},{"id":"id-preview-mode-1762640093151","name":"preview_mode","value":true,"type":"boolean"},{"id":"id-approved-1762640093151","name":"approved","value":false,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"config-manual-config-1762643453541","name":"Manual Config","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20432,6112]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"active_api","value":"perplexity","type":"string"},{"id":"id-2","name":"test_mode","value":false,"type":"boolean"},{"id":"id-preview-mode-1762640093151","name":"preview_mode","value":true,"type":"boolean"},{"id":"id-approved-1762640093151","name":"approved","value":false,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"id":"config-chat-config-1762643453541","name":"Chat Config","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[20432,6304]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\nconsole.log('ğŸ” DEBUG AVANT SWITCH:');\nconsole.log('   preview_mode:', data.preview_mode, '(type:', typeof data.preview_mode, ')');\nconsole.log('   approved:', data.approved, '(type:', typeof data.approved, ')');\nconsole.log('   Condition Preview:', data.preview_mode === true || data.approved !== true);\nconsole.log('   Condition Send:', data.preview_mode === false && data.approved === true);\n\nreturn items;"},"id":"debug-before-switch-node","name":"Debug Before Switch","type":"n8n-nodes-base.code","typeVersion":2,"position":[23184,6104]},{"parameters":{"method":"POST","url":"=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","authentication":"predefinedCredentialType","nodeCredentialType":"googlePalmApi","sendQuery":true,"queryParameters":{"parameters":[{"name":"key","value":"={{ $json.gemini_api_key }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": $json.message || $json.selected_prompt || \"GÃ©nÃ¨re un briefing financier matinal.\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"topK\": 40,\n    \"topP\": 0.95,\n    \"maxOutputTokens\": 2048\n  }\n} }}","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"call-gemini-api-node","name":"Call Gemini API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[22448,6104],"credentials":{"googlePalmApi":{"id":"0D5m3nEBknRtHnmZ","name":"Google Gemini(PaLM) Api account 3"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\n\n// La rÃ©ponse de Gemini a une structure diffÃ©rente\n// Structure Gemini: { candidates: [{ content: { parts: [{ text: \"...\" }] } }] }\nlet content = '';\nif (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {\n  content = data.candidates[0].content.parts.map(part => part.text).join('\\n');\n} else if (data.response) {\n  content = data.response;\n} else if (typeof data === 'string') {\n  content = data;\n}\n\n// Adapter au format attendu par Parse API Response\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    newsletter_content: content,\n    response: content,\n    message: content,\n    emma_model: 'gemini',\n    emma_tools: [],\n    emma_execution_time: 0,\n    trigger_type: item.json.trigger_type || 'Manuel',\n    prompt_type: item.json.prompt_type || 'custom',\n    generated_at: new Date().toISOString(),\n    // PrÃ©server preview_mode et approved\n    preview_mode: item.json.preview_mode,\n    approved: item.json.approved\n  }\n}));"},"id":"parse-gemini-response","name":"Parse Gemini Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[22672,6104]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¤– SÃ‰LECTEUR DE MODÃˆLE IA - MODIFIEZ ICI âš™ï¸\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// ğŸ‘‡ MODIFIEZ LA VALEUR CI-DESSOUS ğŸ‘‡\n//\nconst AI_MODEL = 'emma';\n//\n// Options disponibles:\n//   - 'emma'    â†’ Utilise Emma (Perplexity) via /api/chat\n//   - 'gemini'  â†’ Utilise Gemini directement\n//\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    ai_model: AI_MODEL,\n    _model_info: AI_MODEL === 'emma' \n      ? 'ğŸ¤– Emma (Perplexity) - Recherche web en temps rÃ©el' \n      : 'âœ¨ Gemini Direct - RÃ©ponse rapide'\n  }\n}));"},"id":"ai-model-config-dropdown","name":"âš™ï¸ AI Model Selector (Change AI_MODEL)","type":"n8n-nodes-base.code","typeVersion":2,"position":[21552,6104]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”‘ EXTRACTION DE LA CLÃ‰ API GEMINI DEPUIS LA RÃ‰PONSE VERCEL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// Ce nÅ“ud extrait la clÃ© API Gemini depuis la rÃ©ponse de l'endpoint Vercel\n//\n// âœ… Configuration automatique - Aucune action requise !\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\nlet geminiApiKey = '';\n\ntry {\n  // La rÃ©ponse de l'endpoint Vercel est dans $json\n  // Format: { apiKey: \"...\", configured: true, ... }\n  if (data.apiKey) {\n    geminiApiKey = data.apiKey;\n    console.log('âœ… ClÃ© API Gemini rÃ©cupÃ©rÃ©e depuis Vercel');\n  } else if (data.error) {\n    throw new Error(`Erreur Vercel: ${data.message || data.error}`);\n  } else {\n    // Fallback : essayer depuis les credentials n8n\n    geminiApiKey = $workflow.getStaticData('global').geminiApiKey || '';\n    \n    if (!geminiApiKey) {\n      throw new Error('ClÃ© API non trouvÃ©e. VÃ©rifiez que GEMINI_API_KEY est configurÃ©e dans Vercel.');\n    }\n    \n    console.log('âš ï¸  Utilisation de la clÃ© depuis les credentials n8n (fallback)');\n  }\n} catch (error) {\n  console.error('âŒ Erreur:', error.message);\n  throw new Error(`âŒ Impossible de rÃ©cupÃ©rer la clÃ© API Gemini: ${error.message}`);\n}\n\nif (!geminiApiKey) {\n  throw new Error('âŒ ClÃ© API Gemini vide');\n}\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    gemini_api_key: geminiApiKey\n  }\n}));"},"id":"gemini-api-key-node","name":"Get Gemini API Key","type":"n8n-nodes-base.code","typeVersion":2,"position":[22224,6104]},{"parameters":{"url":"=https://gob-projetsjsls-projects.vercel.app/api/gemini-key?full=true","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"fetch-gemini-api-key-node","name":"Fetch Gemini API Key from Vercel","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[22000,6104]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.ai_model }}","rightValue":"emma","operator":{"type":"string","operation":"equals"},"id":"e15020a5-785c-4bf2-be14-7a2a338e9c34"}],"combinator":"and"},"renameOutput":true,"outputKey":"Emma"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"602d5987-7966-46b0-bca6-1bc86f245316","leftValue":"={{ $json.ai_model }}","rightValue":"gemini","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Gemini"}]},"options":{}},"id":"6f67bbb2-07a7-46be-9b7a-1735ba3e3c5b","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[21776,6104]},{"parameters":{"options":{}},"id":"339cad82-0be3-4fbb-a420-f8e9a9d2f805","name":"When chat message received","type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.4,"position":[22672,6400],"webhookId":"9663354b-9871-49c0-aaee-3992c85a12ec"},{"parameters":{"batching":{}},"id":"90188c41-16ed-4cc6-bf45-b473e44872ee","name":"Basic LLM Chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[23120,6296]},{"parameters":{"options":{}},"id":"21c86760-5e53-4acd-b4a3-223a3b69c361","name":"Google Gemini Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[23192,6520],"credentials":{"googlePalmApi":{"id":"0D5m3nEBknRtHnmZ","name":"Google Gemini(PaLM) Api account 3"}}},{"parameters":{"jsCode":"// Test Email Prep Node\nconst items = $input.all();\nconst data = items[0].json;\nconsole.log(\"Test Email Prep - Formatting LLM output\");\n\nlet content = \"\";\nif (data.output) { content = data.output; }\nelse if (data.text) { content = data.text; }\nelse if (data.response) { content = data.response; }\nelse if (data.message) { content = data.message; }\nelse { content = \"No content found\"; }\n\nreturn [{\n  json: {\n    newsletter_content: content,\n    trigger_type: \"Test Chat\",\n    emma_model: \"gemini-langchain\",\n    emma_tools: [\"langchain\", \"chat\"],\n    emma_execution_time: 0,\n    prompt_type: \"test\",\n    tickers: \"\",\n    preview_mode: false,\n    approved: true,\n    test_mode: true,\n    recipients: [\"projetsjsl@gmail.com\"],\n    generated_at: new Date().toISOString()\n  }\n}];"},"id":"8346e806-18fc-4bc8-ad19-fc8c0e11bd5b","name":"Test Formated HTML Email to projetsjsl@gmail.com","type":"n8n-nodes-base.code","typeVersion":2,"position":[23472,6400]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ‡«ğŸ‡· INSTRUCTION FRANÃ‡AISE POUR LE LLM\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\n// Message original de l'utilisateur\nconst userMessage = data.chatInput || data.message || '';\n\n// Instruction systÃ¨me en franÃ§ais\nconst systemInstruction = `Tu es Emma, l'assistante financiÃ¨re IA de JSLAIâ„¢.\n\nLANGUE: RÃ©ponds TOUJOURS en FRANÃ‡AIS, sauf pour:\n- Les noms propres (entreprises, personnes, lieux)\n- Les citations directes\n- Les termes techniques standards (P/E ratio, ETF, etc.)\n\nSTYLE:\n- Analyse financiÃ¨re claire et professionnelle\n- Structure avec des paragraphes distincts\n- Utilise des donnÃ©es prÃ©cises\n- Ton accessible mais expert\n\nVoici la question de l'utilisateur:\n\n`;\n\n// Combiner l'instruction avec le message\nconst fullMessage = systemInstruction + userMessage;\n\nconsole.log('ğŸ‡«ğŸ‡· Instruction franÃ§aise ajoutÃ©e au message');\nconsole.log('   Longueur originale:', userMessage.length);\nconsole.log('   Longueur totale:', fullMessage.length);\n\nreturn [{\n  json: {\n    ...data,\n    chatInput: fullMessage\n  }\n}];"},"id":"add-french-instruction-node-id","name":"ğŸ‡«ğŸ‡· Add French Instruction","type":"n8n-nodes-base.code","typeVersion":2,"position":[22896,6400]}],"connections":{"Schedule Trigger (7h/12h/16h30 EST)":{"main":[[{"node":"Schedule Config","type":"main","index":0}]]},"Webhook Trigger":{"main":[[{"node":"Webhook Config","type":"main","index":0}]]},"Manual Trigger (Custom Prompt)":{"main":[[{"node":"ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)","type":"main","index":0}]]},"ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)":{"main":[[{"node":"Merge Triggers","type":"main","index":0}]]},"Merge Triggers":{"main":[[{"node":"Fetch Prompts from API","type":"main","index":0}]]},"Get Active Tickers":{"main":[[{"node":"Determine Time-Based Prompt","type":"main","index":0}]]},"Determine Time-Based Prompt":{"main":[[{"node":"âš™ï¸ AI Model Selector (Change AI_MODEL)","type":"main","index":0}]]},"Prepare API Request":{"main":[[{"node":"Call /api/chat (Emma)","type":"main","index":0}]]},"Parse API Response":{"main":[[{"node":"Debug Before Switch","type":"main","index":0}]]},"Generate HTML Newsletter":{"main":[[{"node":"Fetch Email Recipients","type":"main","index":0}]]},"Send Email via Resend":{"main":[[{"node":"Log to Newsletters Table","type":"main","index":0}]]},"Log to Newsletters Table":{"main":[[{"node":"Log to Logs Table","type":"main","index":0}]]},"Workflow Configuration":{"main":[[{"node":"Fetch Prompts from API","type":"main","index":0}]]},"Gmail Trigger (Custom Prompt)":{"main":[[{"node":"Custom Workflow Configuration","type":"main","index":0}]]},"Telegram Trigger (Custom Prompt)":{"main":[[{"node":"Custom Workflow Configuration","type":"main","index":0}]]},"Custom Workflow Configuration":{"main":[[{"node":"Get Active Tickers","type":"main","index":0}]]},"Call /api/chat (Emma)":{"main":[[{"node":"Parse API Response","type":"main","index":0}]]},"Fetch Prompts from API":{"main":[[{"node":"Get Active Tickers","type":"main","index":0}]]},"Preview Briefing Content":{"main":[[{"node":"Preview Message","type":"main","index":0}]]},"Preview Message":{"main":[[{"node":"Check Approval","type":"main","index":0}]]},"Check Approval":{"main":[[{"node":"Generate HTML Newsletter","type":"main","index":0}],[{"node":"Preview Message","type":"main","index":0}]]},"Preview Display":{"main":[[{"node":"Preview Stop","type":"main","index":0}]]},"Chat Trigger (Preview)":{"main":[[{"node":"ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)","type":"main","index":0}]]},"Generate HTML Preview":{"main":[[{"node":"Serve Preview","type":"main","index":0}]]},"Fetch Email Recipients":{"main":[[{"node":"Process Recipients","type":"main","index":0}]]},"Process Recipients":{"main":[[{"node":"Send Email via Resend","type":"main","index":0}]]},"Schedule Config":{"main":[[{"node":"Merge Triggers","type":"main","index":0}]]},"Webhook Config":{"main":[[{"node":"Merge Triggers","type":"main","index":0}]]},"Manual Config":{"main":[[{"node":"Merge Triggers","type":"main","index":0}]]},"Chat Config":{"main":[[{"node":"Merge Triggers","type":"main","index":0}]]},"Debug Before Switch":{"main":[[{"node":"Should Send Email?","type":"main","index":0}]]},"Should Send Email?":{"main":[[{"node":"Generate HTML Newsletter","type":"main","index":0}],[{"node":"Preview Display","type":"main","index":0}]]},"Call Gemini API":{"main":[[{"node":"Parse Gemini Response","type":"main","index":0}]]},"Parse Gemini Response":{"main":[[{"node":"Parse API Response","type":"main","index":0}]]},"âš™ï¸ AI Model Selector (Change AI_MODEL)":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Get Gemini API Key":{"main":[[{"node":"Call Gemini API","type":"main","index":0}]]},"Fetch Gemini API Key from Vercel":{"main":[[{"node":"Get Gemini API Key","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Prepare API Request","type":"main","index":0}],[{"node":"Fetch Gemini API Key from Vercel","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"When chat message received":{"main":[[{"node":"ğŸ‡«ğŸ‡· Add French Instruction","type":"main","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"Test Formated HTML Email to projetsjsl@gmail.com","type":"main","index":0}]]},"Test Formated HTML Email to projetsjsl@gmail.com":{"main":[[{"node":"Generate HTML Newsletter","type":"main","index":0}]]},"ğŸ‡«ğŸ‡· Add French Instruction":{"main":[[{"node":"Basic LLM Chain","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":"03lgcA4e9uRTtli1"},"staticData":{"node:Schedule Trigger (7h/12h/16h30 EST)":{"recurrenceRules":[]},"node:Gmail Trigger (Custom Prompt)":{"Gmail Trigger (Custom Prompt)":{"lastTimeChecked":1762532537,"possibleDuplicates":["19a5f2038b731938"]}}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Call /api/chat (Emma)":[{"json":{"success":true,"response":"Bonsoir n8n-automation,  \nVoici votre synthÃ¨se personnalisÃ©e de la sÃ©ance boursiÃ¨re du vendredi 7 novembre 2025, marquÃ©e par une volatilitÃ© sectorielle contrastÃ©e et des mouvements significatifs sur plusieurs titres phares de votre univers dâ€™investissement.\n\n---\n\n**1. Ouverture**  \nLa sÃ©ance sâ€™est ouverte sous le signe de lâ€™incertitude, avec des marchÃ©s oscillant entre prises de bÃ©nÃ©fices en dÃ©but de journÃ©e et rebonds techniques sur les valeurs technologiques et santÃ© en clÃ´ture. Les investisseurs restent attentifs aux prochaines publications et Ã  la trajectoire des taux.\n\n---\n\n**2. ClÃ´ture des marchÃ©s**  \n- **S&P 500** : -0,3% Ã  5 086 points.  \n- **Nasdaq** : +0,5% Ã  17 120 points, soutenu par la tech.  \n- **TSX (Canada)** : -0,4% Ã  21 780 points.  \nLes volumes de transactions sont restÃ©s dans la moyenne, avec une accÃ©lÃ©ration sur les bancaires et la tech en fin de sÃ©ance (source : FMP Fundamentals, Polygon).\n\n---\n\n**3. Secteurs performants**\n- **En hausse :**  \n   - **Technologie** (+1,2%) : Alphabet (GOOGL) et le segment IA tirent le secteur, portÃ©s par des rÃ©sultats supÃ©rieurs et des anticipations de croissance durable.\n   - **Ã‰nergie** (+1,1%) : Reprise des cours du pÃ©trole, bÃ©nÃ©fique pour les valeurs de services et dâ€™infrastructure.\n   - **SantÃ©** : Big pharma (JNJ, PFE) en rebond modÃ©rÃ©, rotation vers la qualitÃ© en pÃ©riode dâ€™incertitude macro.\n\n- **En baisse :**  \n   - **TÃ©lÃ©coms** : BCE, VZ et T pÃ©nalisÃ©s par la pression sur les marges et la concurrence accrue (-1,5%).\n   - **Banques canadiennes** : BNS, TD sous pression (-0,7% Ã  -1,1%), inquiÃ©tudes persistantes sur le crÃ©dit et la rentabilitÃ©.\n   - **Consommation discrÃ©tionnaire** : NKE, CVS affectÃ©s par la prudence des mÃ©nages.\n\n---\n\n**4. Tickers dâ€™Ã©quipe â€“ Bilan et analyse**\n- **GOOGL (Alphabet)** : +0,8% Ã  278,83$. P/E de 27,1x (vs secteur tech 28x), ROE trÃ¨s Ã©levÃ© Ã  35%. Marge nette impressionnante (32%), dette quasi nulle, moat technologique majeur, momentum IA solide.  \n- **BNS (Banque Scotia)** : -0,7% Ã  66,70$. P/E Ã  16,1x, ROE faible Ã  8,6%, payout ratio Ã©levÃ© (81%), dette/capitaux propres massive (5,8x). Pression sur la croissance et la qualitÃ© du crÃ©dit.  \n- **TD (Toronto Dominion)** : -1,1% Ã  80,90$. P/E attractif Ã  9,3x, ROE robuste Ã  17,2%, marge nette 17,8%. Mieux positionnÃ©e que BNS, mais secteur bancaire sous tension.  \n- **BCE (TÃ©lÃ©com)** : -1,5% Ã  23,19$. P/E Ã©levÃ© Ã  50,3x, marge nette faible Ã  2,5%, payout ratio surdimensionnÃ© (>500%), dette Ã©levÃ©e. DÃ©fensif mais risque sur la soutenabilitÃ© du dividende.  \n- **CNR (Core Natural Resources)** : Stable Ã  89,41$. P/E extrÃªme Ã  227x, ROE quasi nul (<1%), mais faible endettement. Le marchÃ© reste prudent sur la visibilitÃ© bÃ©nÃ©ficiaire.\n\n---\n\n**5. Ã‰vÃ©nements marquants**  \n- Alphabet profite dâ€™un nouvel engouement IA, plusieurs analystes anticipant une Â« croissance exponentielle Â» Ã  moyen terme.\n- Les banques canadiennes pÃ¢tissent dâ€™une montÃ©e des provisions et des craintes sur lâ€™immobilier commercial.\n- Les tÃ©lÃ©coms subissent une rÃ©vision Ã  la baisse des perspectives de marges et des avertissements de plusieurs opÃ©rateurs.\n\n---\n\n**6. Perspective demain**  \nÃ€ surveiller : rÃ©sultats de sociÃ©tÃ©s santÃ© (MDT, JNJ), discours de la Fed et chiffres dâ€™inflation US qui pourraient inflÃ©chir la courbe des taux. Les investisseurs seront attentifs Ã  la rÃ©silience des dividendes dans les tÃ©lÃ©coms et Ã  la qualitÃ© des actifs bancaires.\n\n---\n\n**7. Conseil Emma**  \nFace Ã  la volatilitÃ©, privilÃ©giez les valeurs Ã  moat dÃ©fensif, faible endettement et gÃ©nÃ©ration de cash-flow solide (GOOGL, TD). Limitez lâ€™exposition aux tÃ©lÃ©coms et aux banques Ã  faible rentabilitÃ© ou fort levier, en privilÃ©giant la sÃ©lectivitÃ© dans vos arbitrages.\n\n---\n\n**8. Fermeture**  \nMerci n8n-automation pour votre confiance. Je reste Ã  disposition pour approfondir lâ€™analyse de tout titre spÃ©cifique ou Ã©laborer une allocation sectorielle dÃ©taillÃ©e demain matin. Bonne soirÃ©e et Ã  demain pour un nouveau point marchÃ©.\n\n*Sources : FMP Fundamentals, FMP Ratios, Polygon, actualitÃ©s sectorielles au 9 novembre 2025.*","conversationId":"4c39bb0a-5adb-49e2-b77f-7ec22cc2437e","metadata":{"user_id":"2fc99cf6-3dd8-4129-82c9-73ee478abe12","name":"n8n-automation","conversation_id":"4c39bb0a-5adb-49e2-b77f-7ec22cc2437e","model":"perplexity","llmUsed":"perplexity","tools_used":["fmp-fundamentals","fmp-quote","fmp-ticker-news","fmp-ratios","fmp-key-metrics","fmp-ratings","earnings-calendar","polygon-stock-price"],"toolsUsed":["fmp-fundamentals","fmp-quote","fmp-ticker-news","fmp-ratios","fmp-key-metrics","fmp-ratings","earnings-calendar","polygon-stock-price"],"failedTools":["fmp-quote"],"confidence":0.685,"dataConfidence":0.52,"intent":"comparative_analysis","execution_time_ms":39903,"executionTimeMs":41625,"emmaExecutionTimeMs":39903,"channel":"web","messageCount":11}}}]},"versionId":"095eca0f-d6e4-48f7-a3c0-af2b840dd791","versionCounter":349,"triggerCount":5,"shared":[{"updatedAt":"2025-10-20T18:16:03.747Z","createdAt":"2025-10-20T18:16:03.747Z","role":"workflow:owner","workflowId":"03lgcA4e9uRTtli1","projectId":"qfcAzmlYYK6RvGCQ","project":{"updatedAt":"2025-09-24T01:26:58.771Z","createdAt":"2025-09-24T01:26:55.321Z","id":"qfcAzmlYYK6RvGCQ","name":"Projets JSL <projetsjsl@gmail.com>","type":"personal","icon":null,"description":null,"projectRelations":[{"updatedAt":"2025-09-24T01:26:55.322Z","createdAt":"2025-09-24T01:26:55.322Z","userId":"cf0c4ec1-d247-4b12-bc83-04a5c23649fb","projectId":"qfcAzmlYYK6RvGCQ","user":{"updatedAt":"2025-11-10T06:29:22.000Z","createdAt":"2025-09-24T01:26:53.819Z","id":"cf0c4ec1-d247-4b12-bc83-04a5c23649fb","email":"projetsjsl@gmail.com","firstName":"Projets","lastName":"JSL","personalizationAnswers":null,"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"userClaimedAiCredits":true,"firstSuccessfulWorkflowId":"03lgcA4e9uRTtli1","userActivatedAt":1760990286412,"npsSurvey":{"waitingForResponse":true,"ignoredCount":2,"lastShownAt":1762636703931}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2025-11-10","isPending":false}}]}}],"tags":[]}