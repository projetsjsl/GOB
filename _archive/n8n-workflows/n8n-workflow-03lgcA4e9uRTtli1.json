{
  "updatedAt": "2025-11-11T14:48:38.000Z",
  "createdAt": "2025-10-20T18:16:03.743Z",
  "id": "03lgcA4e9uRTtli1",
  "name": "Emma Newsletter - Automated Multi-API Financial News Distribution",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 7 * * *"
            },
            {
              "field": "cronExpression",
              "expression": "0 12 * * *"
            },
            {
              "field": "cronExpression",
              "expression": "30 16 * * *"
            }
          ]
        }
      },
      "id": "5397f51e-b6e3-4630-9d60-d975554db13b",
      "name": "Schedule Trigger (7h/12h/16h30 EST)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        2208,
        896
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "emma-newsletter/send",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "30e9d42f-c22e-4ecc-b32f-040e1b36c80d",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2208,
        1088
      ],
      "webhookId": "dad887b9-1a62-482a-9174-3b79f52a2bb5"
    },
    {
      "parameters": {},
      "id": "2199702c-ea93-484a-9b71-3ba416030308",
      "name": "Manual Trigger (Custom Prompt)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        2208,
        704
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-briefing-type",
              "name": "briefing_type",
              "value": "matin",
              "type": "string"
            },
            {
              "id": "id-custom-prompt",
              "name": "custom_prompt",
              "value": "",
              "type": "string"
            },
            {
              "id": "id-preview-mode",
              "name": "preview_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-approved",
              "name": "approved",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "c3ecb545-83ea-4db2-ba56-a7104a702733",
      "name": "ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2432,
        608
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "id": "39da4631-55a2-4bbd-b165-312f3714a493",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2656,
        800
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "team_tickers",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "active",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "id": "ad5015b5-8231-4cd9-acc0-6f0a0ae6265e",
      "name": "Get Active Tickers",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3104,
        1272
      ],
      "credentials": {
        "supabaseApi": {
          "id": "WGwVmhxNX4mHZmVO",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¯ SÃ‰LECTION DU PROMPT DE BRIEFING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Ce nÅ“ud utilise les prompts rÃ©cupÃ©rÃ©s depuis GitHub via l'API\n// et permet la sÃ©lection manuelle du type de briefing\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inputItems = $input.all();\nconst data = inputItems[0].json;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RÃ‰CUPÃ‰RATION DES PROMPTS DEPUIS \"Fetch Prompts from API\"\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Les prompts viennent de \"Fetch Prompts from API\" qui prÃ©cÃ¨de \"Get Active Tickers\"\n// L'API retourne { success: true, prompts: { morning: {...}, midday: {...}, evening: {...} } }\nlet promptsConfig = {};\n\ntry {\n  // MÃ©thode 1 : RÃ©cupÃ©rer depuis le nÅ“ud \"Fetch Prompts from API\"\n  const fetchPromptsData = $('Fetch Prompts from API').first().json;\n  if (fetchPromptsData.prompts) {\n    promptsConfig = fetchPromptsData.prompts;\n    console.log('âœ… Prompts rÃ©cupÃ©rÃ©s depuis Fetch Prompts from API');\n  } else if (fetchPromptsData.success && fetchPromptsData.prompts) {\n    promptsConfig = fetchPromptsData.prompts;\n    console.log('âœ… Prompts rÃ©cupÃ©rÃ©s depuis Fetch Prompts from API (format success)');\n  }\n} catch (e) {\n  console.warn('âš ï¸ Impossible de rÃ©cupÃ©rer depuis Fetch Prompts from API:', e.message);\n}\n\n// MÃ©thode 2 : VÃ©rifier dans les donnÃ©es actuelles (au cas oÃ¹)\nif (!promptsConfig || Object.keys(promptsConfig).length === 0) {\n  if (data.prompts) {\n    promptsConfig = data.prompts;\n    console.log('âœ… Prompts trouvÃ©s dans les donnÃ©es actuelles');\n  } else if (data.success && data.prompts) {\n    promptsConfig = data.prompts;\n    console.log('âœ… Prompts trouvÃ©s dans les donnÃ©es actuelles (format success)');\n  }\n}\n\n// Si toujours pas de prompts, erreur\nif (!promptsConfig || Object.keys(promptsConfig).length === 0) {\n  console.error('âŒ Prompts non trouvÃ©s. VÃ©rifiez que \"Fetch Prompts from API\" s\\'est exÃ©cutÃ© correctement.');\n  throw new Error('âŒ Les prompts depuis GitHub ne sont pas disponibles. VÃ©rifiez le nÅ“ud \"Fetch Prompts from API\".');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 1 : Prompt personnalisÃ© (si fourni)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (data.custom_prompt && data.custom_prompt.trim() !== '') {\n  console.log('âœ… Utilisation du prompt personnalisÃ©');\n  for (const item of inputItems) {\n    item.json.selected_prompt = data.custom_prompt;\n    item.json.prompt_type = 'custom';\n    item.json.processing_status = \"OK\";\n  }\n  return inputItems;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 2 : Type de briefing sÃ©lectionnÃ© manuellement\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Note: prompt_type est gÃ©nÃ©rÃ© automatiquement Ã  partir de briefing_type\nif (data.briefing_type) {\n  const selectedType = data.briefing_type.toLowerCase().trim();\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // CONVERSION FRANÃ‡AIS â†’ ANGLAIS (pour compatibilitÃ© API)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  const typeMapping = {\n    // FranÃ§ais â†’ Anglais\n    'matin': 'morning',\n    'midi': 'midday',\n    'soir': 'evening',\n    // Anglais (compatibilitÃ©)\n    'morning': 'morning',\n    'midday': 'midday',\n    'evening': 'evening',\n    'noon': 'midday' // Ancien format\n  };\n  \n  // Normaliser le type (franÃ§ais ou anglais â†’ anglais)\n  let normalizedType = typeMapping[selectedType];\n  \n  if (!normalizedType) {\n    throw new Error(`âŒ Type de briefing invalide: \"${selectedType}\". Utilisez: \"matin\", \"midi\", \"soir\" (ou \"morning\", \"midday\", \"evening\")`);\n  }\n  \n  // Types valides pour l'API (toujours en anglais)\n  const validTypes = ['morning', 'midday', 'evening'];\n  if (!validTypes.includes(normalizedType)) {\n    throw new Error(`âŒ Type de briefing invalide aprÃ¨s conversion: ${normalizedType}`);\n  }\n  \n  const selectedPrompt = promptsConfig[normalizedType]?.prompt;\n  \n  if (!selectedPrompt) {\n    throw new Error(`âŒ Prompt non trouvÃ© pour le type: ${normalizedType}. VÃ©rifiez config/briefing-prompts.json sur GitHub.`);\n  }\n  \n  console.log(`âœ… Utilisation du prompt ${normalizedType} (${selectedType}) depuis GitHub`);\n  \n  for (const item of inputItems) {\n    item.json.selected_prompt = selectedPrompt;\n    item.json.prompt_type = normalizedType; // âœ… GÃ©nÃ©rÃ© automatiquement depuis briefing_type\n    item.json.processing_status = \"OK\";\n    item.json.briefing_name = promptsConfig[normalizedType]?.name || `Briefing ${normalizedType}`;\n    // Conserver le type original pour affichage\n    item.json.briefing_type_original = selectedType;\n  }\n  \n  return inputItems;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRIORITÃ‰ 3 : DÃ©termination automatique selon l'heure (Schedule Trigger)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst now = new Date();\nconst hour = now.getHours();\n\nlet promptType;\nlet selectedPrompt;\n\nif (hour >= 5 && hour < 11) {\n  // Morning prompt (5am - 11am)\n  promptType = 'morning';\n  selectedPrompt = promptsConfig.morning?.prompt || '';\n} else if (hour >= 11 && hour < 16) {\n  // Midday prompt (11am - 4pm)\n  promptType = 'midday';\n  selectedPrompt = promptsConfig.midday?.prompt || '';\n} else {\n  // Evening prompt (4pm onwards and before 5am)\n  promptType = 'evening';\n  selectedPrompt = promptsConfig.evening?.prompt || '';\n}\n\nif (!selectedPrompt) {\n  throw new Error(`âŒ Prompt non trouvÃ© pour le type: ${promptType}`);\n}\n\nconsole.log(`âœ… DÃ©termination automatique: ${promptType} (heure: ${hour}h)`);\n\nfor (const item of inputItems) {\n  item.json.selected_prompt = selectedPrompt;\n  item.json.prompt_type = promptType;\n  item.json.processing_status = \"OK\";\n  item.json.briefing_name = promptsConfig[promptType]?.name || `Briefing ${promptType}`;\n}\n\nreturn inputItems;"
      },
      "id": "6d2c7cfa-f8b7-44de-ab36-4e3d9826a035",
      "name": "Determine Time-Based Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3328,
        1272
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// Extract ticker symbols\nconst tickers = items.filter(item => item.json.ticker).map(item => item.json.ticker);\nconst tickerList = tickers.join(', ');\n\n// Normaliser le type de briefing\nlet briefingType = data.prompt_type || 'custom';\nif (briefingType === 'noon') {\n  briefingType = 'midday';\n}\n\n// DEFAULT PROMPT si non fourni\nconst defaultPrompt = \"Fournir une analyse financiÃ¨re concise des marchÃ©s et actions suivantes.\";\nconst selectedPrompt = data.selected_prompt || defaultPrompt;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¯ ENHANCED PROMPT WITH STRUCTURE INSTRUCTIONS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst structuredInstructions = `\n\nSTRUCTURE REQUISE POUR LE BRIEFING:\n\nCommence toujours par une analyse dÃ©taillÃ©e et exhaustive des marchÃ©s et tickers demandÃ©s. Sois COMPLET et DÃ‰TAILLÃ‰ - ce briefing doit Ãªtre riche en informations.\n\nDans ton analyse, inclus naturellement:\n\n1. **Points clÃ©s marquants** - Mentionne 3-4 faits saillants avec donnÃ©es chiffrÃ©es (indices, %, variations) en haut de ton analyse sous forme de bullets courts. Ces points seront extraits pour le TL;DR.\n\n2. **Analyse approfondie** - Fournis une analyse complÃ¨te et dÃ©taillÃ©e des mouvements du marchÃ©, tendances sectorielles, actualitÃ©s importantes. Ne te limite PAS - Ã©cris au moins 500-800 mots. Structure avec des sections claires (## Titres de sections).\n\n3. **Perspective contrarian** - Vers la fin, inclus une section \"Point de vigilance\" ou \"Perspective Emma\" oÃ¹ tu challenges le consensus du marchÃ© ou identifies un risque sous-estimÃ©. Pose une question provocatrice si pertinent. Cette section sera extraite pour Emma's Take.\n\n4. **Indicateurs techniques** - Mentionne des niveaux de support/rÃ©sistance, RSI, moyennes mobiles pour les tickers principaux si applicable.\n\nRÃˆGLES D'Ã‰CRITURE:\n- Ton professionnel mais accessible\n- Utilise des donnÃ©es chiffrÃ©es prÃ©cises\n- Cite les sources quand pertinent\n- Structure claire avec titres de sections\n- N'hÃ©site pas Ã  Ãªtre long et exhaustif (800-1200 mots est idÃ©al)\n- Inclus des emojis contextuels pour la lisibilitÃ©\n\nEXEMPLE DE STRUCTURE:\n\n# [Titre accrocheur basÃ© sur l'actualitÃ© du jour]\n\n**Points ClÃ©s:**\nâ€¢ S&P 500 +0.8% portÃ© par le secteur tech\nâ€¢ Fed minutes confirment pivot dovish - taux terminal 5.25%\nâ€¢ Apple bat les attentes Q4: $1.64 EPS vs $1.60 attendu\n\n## MarchÃ©s en Bref\n\n[Analyse dÃ©taillÃ©e de la session, mouvements principaux...]\n\n## Secteur Technologique\n\n[Analyse approfondie du secteur avec donnÃ©es...]\n\n## Perspectives Macro\n\n[Contexte Ã©conomique, Fed, inflation...]\n\n## Point de Vigilance - Emma's Take\n\nAlors que l'optimisme rÃ¨gne sur les marchÃ©s tech, les niveaux de dette corporate atteignent des sommets historiques. Avec la remontÃ©e des taux, combien de temps avant que cette fragilitÃ© ne se manifeste dans les bilans?\n\n## Mouvements Ã  Surveiller\n\n- **AAPL**: Test de rÃ©sistance Ã  $200 (RSI: 68, proche surachat)\n- **MSFT**: Support solide Ã  $380, opportunitÃ© d'accumulation\n- **TSLA**: Prudence, RSI Ã  78 (surachat), prise de profits recommandÃ©e\n\n`;\n\n// Construire le message complet\nconst fullPrompt = `${selectedPrompt}\n\n${structuredInstructions}\n\nFocus sur ces tickers: ${tickerList || 'AAPL, MSFT, GOOGL, NVDA'}\n\nType de briefing: ${briefingType}\n`;\n\nconsole.log('ğŸ“‹ Prepare API Request:');\nconsole.log('   selected_prompt:', selectedPrompt.substring(0, 100));\nconsole.log('   tickers:', tickerList);\nconsole.log('   message length:', fullPrompt.length);\nconsole.log('   âœ… Enhanced instructions for structured output');\n\nreturn [{\n  json: {\n    ...data,\n    tickers: tickerList,\n    briefing_type: briefingType,\n    message: fullPrompt,\n    channel: 'web',\n    userId: 'n8n-automation',\n    ai_model: data.ai_model || 'emma'\n  }\n}];"
      },
      "id": "c5d69e3d-82d3-4459-8c12-02af81d03cdd",
      "name": "Prepare API Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4448,
        1080
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const data = item.json;\n  \n  // ============================================\n  // PRÃ‰SERVER preview_mode et approved depuis les nodes de configuration\n  // ============================================\n  // Chercher dans les nodes prÃ©cÃ©dents (Schedule Config, Webhook Config, Manual Config, Chat Config)\n  let previewMode = data.preview_mode;\n  let approved = data.approved;\n  \n  // Si les valeurs ne sont pas dans data, chercher dans les nodes prÃ©cÃ©dents\n  if (previewMode === undefined || approved === undefined) {\n    try {\n      // Essayer de rÃ©cupÃ©rer depuis les nodes de configuration\n      const configNodes = ['Schedule Config', 'Webhook Config', 'Manual Config', 'Chat Config', 'Workflow Configuration'];\n      for (const nodeName of configNodes) {\n        try {\n          const nodeData = $(nodeName).item?.json;\n          if (nodeData) {\n            if (previewMode === undefined && nodeData.preview_mode !== undefined) {\n              previewMode = nodeData.preview_mode;\n            }\n            if (approved === undefined && nodeData.approved !== undefined) {\n              approved = nodeData.approved;\n            }\n            if (previewMode !== undefined && approved !== undefined) break;\n          }\n        } catch (e) {\n          // Node n'existe pas ou n'est pas accessible, continuer\n        }\n      }\n    } catch (e) {\n      console.log('âš ï¸  Impossible de rÃ©cupÃ©rer depuis les nodes prÃ©cÃ©dents:', e.message);\n    }\n  }\n  \n  // Fallback si toujours undefined\n  if (previewMode === undefined) previewMode = true; // Par dÃ©faut, preview\n  if (approved === undefined) approved = false; // Par dÃ©faut, non approuvÃ©\n  \n  // Convertir en boolean si c'est une string\n  if (previewMode === 'true' || previewMode === true) previewMode = true;\n  else if (previewMode === 'false' || previewMode === false) previewMode = false;\n  \n  if (approved === 'true' || approved === true) approved = true;\n  else if (approved === 'false' || approved === false) approved = false;\n  \n  // Extraire les mÃ©tadonnÃ©es de la rÃ©ponse API\n  const newsletterContent = data.newsletter_content || data.response || data.message || data.analysis || data.content || \"\";\n\n  console.log(\"ğŸ“‹ Parse API Response - Content extraction:\");\n  console.log(\"   All data keys:\", Object.keys(data));\n  console.log(\"   newsletter_content:\", data.newsletter_content ? \"EXISTS (\" + data.newsletter_content.length + \" chars)\" : \"MISSING\");\n  console.log(\"   response:\", data.response ? \"EXISTS (\" + data.response.length + \" chars)\" : \"MISSING\");\n  console.log(\"   Final newsletterContent length:\", newsletterContent.length);\n\n  const triggerType = data.trigger_type || 'Manuel';\n  const emmaModel = data.emma_model || data.model || 'perplexity';\n  const emmaTools = Array.isArray(data.emma_tools) ? data.emma_tools : (data.tools_used || []);\n  const emmaExecutionTime = data.emma_execution_time || data.execution_time_ms || 0;\n  const promptType = data.prompt_type || 'custom';\n  const generatedAt = data.generated_at || new Date().toISOString();\n  \n  // Logging pour dÃ©bogage\n  console.log('ğŸ“Š Parse API Response - Valeurs finales:');\n  console.log('   preview_mode:', previewMode, '(type:', typeof previewMode, ')');\n  console.log('   approved:', approved, '(type:', typeof approved, ')');\n  console.log('   trigger_type:', triggerType);\n  console.log('   prompt_type:', promptType);\n  \n  return {\n    json: {\n      ...data,\n      // PRÃ‰SERVER les valeurs preview_mode et approved\n      preview_mode: previewMode,\n      approved: approved,\n      // MÃ©tadonnÃ©es extraites\n      newsletter_content: newsletterContent,\n      trigger_type: triggerType,\n      emma_model: emmaModel,\n      emma_tools: emmaTools,\n      emma_execution_time: emmaExecutionTime,\n      prompt_type: promptType,\n      generated_at: generatedAt,\n      content_length: newsletterContent.length,\n      // Debug\n      _debug_preview_mode: previewMode,\n      _debug_approved: approved,\n      _debug_preview_mode_type: typeof previewMode,\n      _debug_approved_type: typeof approved\n    }\n  };\n});"
      },
      "id": "40676021-3728-41a7-a961-9ec5a4f31b19",
      "name": "Parse API Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4896,
        1272
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¨ GENERATE BLOOMBERG-STYLE HTML NEWSLETTER - ENHANCED VERSION\n// Version: 2.0 - Visual Upgrade + Best Practices Integration\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š EXTRACT TITLE AND SUBTITLE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction extractTitleAndSubtitle(content) {\n  const lines = content.split('\\n');\n  let title = '';\n  let subtitle = '';\n  \n  // Extract title from first # or ##\n  for (const line of lines) {\n    if (line.trim().startsWith('# ') && !title) {\n      title = line.replace(/^#\\s+/, '').trim();\n      break;\n    } else if (line.trim().startsWith('## ') && !title) {\n      title = line.replace(/^##\\s+/, '').trim();\n      break;\n    }\n  }\n  \n  // Extract subtitle from first paragraph\n  for (const line of lines) {\n    if (line.trim() && !line.startsWith('#') && !line.startsWith('*') && !line.startsWith('-') && line.length > 30) {\n      subtitle = line.trim().substring(0, 150);\n      if (subtitle.length === 150) subtitle += '...';\n      break;\n    }\n  }\n  \n  // Fallback titles\n  if (!title) {\n    if (content.toLowerCase().includes('marchÃ©s') || content.toLowerCase().includes('marchÃ©')) {\n      title = 'Analyse des MarchÃ©s Financiers';\n    } else if (content.toLowerCase().includes('action')) {\n      title = 'Revue des Actions et Titres';\n    } else if (content.toLowerCase().includes('Ã©conomie')) {\n      title = 'Perspectives Ã‰conomiques';\n    } else {\n      title = 'Briefing Financier Emma IA';\n    }\n  }\n  \n  if (!subtitle) {\n    subtitle = 'Analyse dÃ©taillÃ©e et insights pour investisseurs avertis';\n  }\n  \n  return { title, subtitle };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ‘‹ CONTEXTUAL GREETING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction getContextualGreeting(triggerType) {\n  const greetings = {\n    'morning': 'ğŸŒ… Bonjour et bienvenue Ã  votre briefing matinal',\n    'midday': 'â˜€ï¸ Bon aprÃ¨s-midi, voici votre briefing du midi',\n    'noon': 'â˜€ï¸ Bon aprÃ¨s-midi, voici votre briefing du midi',\n    'evening': 'ğŸŒ† Bonsoir, dÃ©couvrez votre briefing du soir'\n  };\n  \n  const greeting = greetings[triggerType];\n  if (greeting) return greeting;\n  \n  // Fallback based on hour\n  const hour = new Date().getHours();\n  if (hour >= 5 && hour < 12) return 'ğŸŒ… Bonjour et bienvenue Ã  votre briefing matinal';\n  if (hour >= 12 && hour < 18) return 'â˜€ï¸ Bon aprÃ¨s-midi, voici votre briefing du midi';\n  return 'ğŸŒ† Bonsoir, dÃ©couvrez votre briefing du soir';\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š EXTRACT KEY STATS FROM CONTENT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction extractKeyStats(content) {\n  const stats = [];\n  \n  // Look for common patterns: \"S&P 500: +0.5%\", \"AAPL $150 +2%\", etc.\n  const patterns = [\n    /S&P\\s*500[:\\s]+([+-]?\\d+\\.?\\d*%)/i,\n    /NASDAQ[:\\s]+([+-]?\\d+\\.?\\d*%)/i,\n    /DOW[:\\s]+([+-]?\\d+\\.?\\d*%)/i,\n    /VIX[:\\s]+([\\d.]+)/i\n  ];\n  \n  patterns.forEach((pattern, idx) => {\n    const match = content.match(pattern);\n    if (match) {\n      const labels = ['S&P 500', 'NASDAQ', 'DOW', 'VIX'];\n      stats.push({ label: labels[idx], value: match[1] });\n    }\n  });\n  \n  return stats;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¯ EXTRACT TL;DR BULLET POINTS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction extractTLDR(content) {\n  const lines = content.split('\\n');\n  const bullets = [];\n  \n  // Look for first 3 important bullet points or sentences\n  for (const line of lines) {\n    const trimmed = line.trim();\n    if ((trimmed.startsWith('â€¢') || trimmed.startsWith('-') || trimmed.startsWith('*')) && trimmed.length > 20) {\n      bullets.push(trimmed.replace(/^[â€¢\\-\\*]\\s*/, ''));\n      if (bullets.length >= 3) break;\n    }\n  }\n  \n  // If not enough bullets, extract first 3 meaningful sentences\n  if (bullets.length < 3) {\n    const sentences = content.match(/[^.!?]+[.!?]+/g) || [];\n    sentences.forEach(sentence => {\n      if (bullets.length < 3 && sentence.length > 30 && sentence.length < 200) {\n        bullets.push(sentence.trim());\n      }\n    });\n  }\n  \n  return bullets.slice(0, 3);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¤– GENERATE EMMA'S TAKE (PLACEHOLDER - TO BE ENHANCED BY AI)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction generateEmmasTake(content) {\n  // This should ideally come from the AI prompt, but we can extract or provide default\n  // Look for sections with \"Emma\" or contrarian views\n  const lines = content.split('\\n');\n  for (const line of lines) {\n    if (line.toLowerCase().includes('emma') || line.toLowerCase().includes('attention') || line.toLowerCase().includes('toutefois')) {\n      return line.trim();\n    }\n  }\n  \n  return \"Les marchÃ©s reflÃ¨tent un optimisme qui pourrait sous-estimer certains risques structurels. Surveillance accrue recommandÃ©e sur les corrÃ©lations cross-asset.\";\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ’¡ GENERATE ACTION ITEMS (PLACEHOLDER - TO BE ENHANCED BY AI)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction generateActionItems(content) {\n  // Extract tickers mentioned in content\n  const tickerPattern = /\\b[A-Z]{2,5}\\b/g;\n  const tickers = [...new Set(content.match(tickerPattern) || [])].slice(0, 3);\n  \n  const actions = [];\n  \n  if (tickers.length > 0) {\n    actions.push({\n      type: 'SURVEILLER',\n      ticker: tickers[0],\n      action: `Suivre les niveaux de support/rÃ©sistance`,\n      rationale: 'Momentum technique favorable'\n    });\n  }\n  \n  if (tickers.length > 1) {\n    actions.push({\n      type: 'OPPORTUNITÃ‰',\n      ticker: tickers[1],\n      action: 'Zone d\\'accumulation potentielle',\n      rationale: 'Valorisation attractive vs. historique'\n    });\n  }\n  \n  actions.push({\n    type: 'PRUDENCE',\n    ticker: 'MARCHÃ‰',\n    action: 'Gestion du risque active',\n    rationale: 'VolatilitÃ© attendue court terme'\n  });\n  \n  return actions;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¨ GENERATE ENHANCED HTML\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction generateEnhancedBloombergHTML(newsletterContent, metadata) {\n  const { title, subtitle } = extractTitleAndSubtitle(newsletterContent);\n  const greeting = getContextualGreeting(metadata.trigger_type || 'morning');\n  const keyStats = extractKeyStats(newsletterContent);\n  const tldrPoints = extractTLDR(newsletterContent);\n  const emmasTake = generateEmmasTake(newsletterContent);\n  const actionItems = generateActionItems(newsletterContent);\n  \n  const formattedDate = new Date().toLocaleDateString('fr-FR', { \n    weekday: 'long', \n    year: 'numeric', \n    month: 'long', \n    day: 'numeric' \n  });\n  \n  const currentTime = new Date().toLocaleTimeString('en-US', { \n    hour: '2-digit', \n    minute: '2-digit',\n    timeZone: 'America/New_York',\n    hour12: false\n  });\n\n  // Enhanced content with better formatting\n  let enhancedContent = newsletterContent\n    .replace(/#{1,6}\\s+(.*)/g, '<h2 style=\"color: #2c3e50; font-weight: 700; margin: 32px 0 16px 0; padding-bottom: 12px; border-bottom: 3px solid #e8eef5; font-size: 24px;\">$1</h2>')\n    .replace(/\\*\\*\\*(.+?)\\*\\*\\*/g, '<strong style=\"color: #1e3a5f; font-weight: 700;\">$1</strong>')\n    .replace(/\\*\\*(.+?)\\*\\*/g, '<strong style=\"color: #2c5f8d; font-weight: 600;\">$1</strong>')\n    .replace(/\\*(.+?)\\*/g, '<em style=\"color: #4a5568;\">$1</em>')\n    .replace(/\\n\\n/g, '</p><p style=\"margin: 16px 0; line-height: 1.8; color: #2c3e50;\">')\n    .replace(/\\n/g, '<br>');\n  \n  enhancedContent = '<p style=\"margin: 16px 0; line-height: 1.8; color: #2c3e50;\">' + enhancedContent + '</p>';\n\n  return `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${title} - Emma IA Finance</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { \n      font-family: Georgia, 'Times New Roman', serif; \n      background-color: #f8f9fa; \n      padding: 20px;\n      line-height: 1.8;\n    }\n    .email-container { \n      max-width: 680px; \n      margin: 0 auto; \n      background: #ffffff; \n      box-shadow: 0 4px 20px rgba(0,0,0,0.08);\n      border-radius: 8px;\n      overflow: hidden;\n    }\n    \n    /* Masthead */\n    .masthead {\n      background: linear-gradient(135deg, #1e3a5f 0%, #2c5f8d 100%);\n      padding: 20px 32px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      border-bottom: 4px solid #34495e;\n    }\n    .masthead-left {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n    .masthead-avatar {\n      width: 42px;\n      height: 42px;\n      border-radius: 50%;\n      border: 2px solid #ffffff;\n    }\n    .masthead-title {\n      color: #ffffff;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.5px;\n    }\n    .masthead-time {\n      background: rgba(255,255,255,0.15);\n      padding: 6px 14px;\n      border-radius: 20px;\n      color: #ffffff;\n      font-size: 13px;\n      font-weight: 600;\n      backdrop-filter: blur(10px);\n    }\n    \n    /* Hero Section */\n    .hero {\n      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);\n      padding: 48px 32px;\n      text-align: center;\n      color: #ffffff;\n    }\n    .hero-greeting {\n      font-size: 16px;\n      font-weight: 400;\n      margin-bottom: 16px;\n      opacity: 0.9;\n      font-style: italic;\n    }\n    .hero-title {\n      font-size: 36px;\n      font-weight: 800;\n      margin-bottom: 16px;\n      line-height: 1.3;\n      color: #ffffff;\n      text-shadow: 0 2px 4px rgba(0,0,0,0.2);\n    }\n    .hero-subtitle {\n      font-size: 18px;\n      font-weight: 400;\n      line-height: 1.6;\n      opacity: 0.85;\n      margin-bottom: 20px;\n    }\n    .hero-byline {\n      font-size: 14px;\n      font-weight: 400;\n      opacity: 0.75;\n      border-top: 1px solid rgba(255,255,255,0.2);\n      padding-top: 16px;\n      margin-top: 16px;\n    }\n    \n    /* Key Stats Box */\n    .key-stats-box {\n      background: linear-gradient(135deg, #1e3a5f 0%, #2c5f8d 100%);\n      margin: -20px 32px 32px 32px;\n      padding: 24px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);\n      position: relative;\n      z-index: 10;\n    }\n    .key-stats-title {\n      color: #ffffff;\n      font-size: 14px;\n      font-weight: 700;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n      margin-bottom: 16px;\n      opacity: 0.9;\n    }\n    .stats-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\n      gap: 16px;\n    }\n    .stat-item {\n      background: rgba(255,255,255,0.1);\n      padding: 12px 16px;\n      border-radius: 6px;\n      border-left: 3px solid #ffffff;\n    }\n    .stat-label {\n      color: rgba(255,255,255,0.8);\n      font-size: 12px;\n      font-weight: 600;\n      margin-bottom: 4px;\n    }\n    .stat-value {\n      color: #ffffff;\n      font-size: 20px;\n      font-weight: 700;\n    }\n    \n    /* TL;DR Box */\n    .tldr-box {\n      background: linear-gradient(135deg, #f8f9fa 0%, #e8eef5 100%);\n      border-left: 6px solid #2c5f8d;\n      margin: 32px;\n      padding: 24px 28px;\n      border-radius: 0 8px 8px 0;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.06);\n    }\n    .tldr-title {\n      color: #1e3a5f;\n      font-size: 16px;\n      font-weight: 800;\n      text-transform: uppercase;\n      letter-spacing: 1.5px;\n      margin-bottom: 16px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .tldr-subtitle {\n      color: #4a5568;\n      font-size: 13px;\n      font-weight: 400;\n      margin-bottom: 16px;\n      font-style: italic;\n    }\n    .tldr-list {\n      list-style: none;\n      padding: 0;\n    }\n    .tldr-item {\n      padding: 12px 0;\n      border-bottom: 1px solid rgba(44, 95, 141, 0.15);\n      color: #2c3e50;\n      font-size: 15px;\n      line-height: 1.6;\n      display: flex;\n      gap: 12px;\n    }\n    .tldr-item:last-child {\n      border-bottom: none;\n    }\n    .tldr-bullet {\n      color: #2c5f8d;\n      font-weight: 700;\n      font-size: 18px;\n      flex-shrink: 0;\n    }\n    \n    /* Main Content */\n    .content {\n      padding: 32px;\n      color: #2c3e50;\n      font-size: 17px;\n      line-height: 1.8;\n    }\n    \n    /* Emma's Take Callout */\n    .emmas-take-box {\n      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n      margin: 32px;\n      padding: 28px;\n      border-radius: 8px;\n      border: 3px solid #1e3a5f;\n      box-shadow: 0 4px 16px rgba(30, 58, 95, 0.25);\n      position: relative;\n    }\n    .emmas-take-badge {\n      background: #2c5f8d;\n      color: #ffffff;\n      padding: 6px 14px;\n      border-radius: 20px;\n      font-size: 12px;\n      font-weight: 700;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n      display: inline-block;\n      margin-bottom: 16px;\n    }\n    .emmas-take-content {\n      color: #ffffff;\n      font-size: 18px;\n      line-height: 1.7;\n      font-style: italic;\n      position: relative;\n      padding-left: 24px;\n      border-left: 4px solid rgba(255,255,255,0.3);\n    }\n    .emmas-take-quote {\n      position: absolute;\n      left: -8px;\n      top: -8px;\n      font-size: 48px;\n      color: rgba(255,255,255,0.2);\n      font-family: Georgia, serif;\n    }\n    \n    /* Action Items Table */\n    .action-items-section {\n      margin: 32px;\n    }\n    .action-items-title {\n      color: #1e3a5f;\n      font-size: 20px;\n      font-weight: 800;\n      margin-bottom: 20px;\n      padding-bottom: 12px;\n      border-bottom: 3px solid #e8eef5;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n    }\n    .action-items-table {\n      width: 100%;\n      border-collapse: separate;\n      border-spacing: 0 12px;\n    }\n    .action-item-row {\n      background: #f8f9fa;\n      border-radius: 6px;\n      overflow: hidden;\n    }\n    .action-item-type {\n      padding: 16px;\n      font-weight: 700;\n      font-size: 12px;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n      width: 140px;\n    }\n    .action-item-type.watch { background: #3498db; color: #ffffff; }\n    .action-item-type.opportunity { background: #27ae60; color: #ffffff; }\n    .action-item-type.caution { background: #e67e22; color: #ffffff; }\n    .action-item-details {\n      padding: 16px;\n    }\n    .action-item-ticker {\n      font-weight: 700;\n      color: #1e3a5f;\n      font-size: 16px;\n      margin-bottom: 4px;\n    }\n    .action-item-action {\n      color: #2c3e50;\n      font-size: 15px;\n      margin-bottom: 4px;\n    }\n    .action-item-rationale {\n      color: #5a6c7d;\n      font-size: 13px;\n      font-style: italic;\n    }\n    \n    /* Footer */\n    .footer {\n      background: #f8f9fa;\n      padding: 32px;\n      border-top: 3px solid #e8eef5;\n      text-align: center;\n    }\n    .footer-branding {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 20px;\n      margin-bottom: 20px;\n    }\n    .footer-avatar {\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      border: 3px solid #2c5f8d;\n    }\n    .footer-logo {\n      height: 50px;\n      width: auto;\n    }\n    .footer-text {\n      color: #5a6c7d;\n      font-size: 14px;\n      margin-bottom: 16px;\n      line-height: 1.6;\n    }\n    .footer-details {\n      background: #ffffff;\n      border: 2px solid #e8eef5;\n      border-radius: 8px;\n      padding: 20px;\n      margin-top: 20px;\n      text-align: left;\n    }\n    .footer-details-title {\n      color: #2c3e50;\n      font-size: 13px;\n      font-weight: 700;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n      margin-bottom: 12px;\n    }\n    .footer-detail-item {\n      color: #5a6c7d;\n      font-size: 12px;\n      margin: 6px 0;\n      display: flex;\n      justify-content: space-between;\n      padding: 4px 0;\n      border-bottom: 1px solid #f0f0f0;\n    }\n    .footer-detail-label {\n      font-weight: 600;\n      color: #4a5568;\n    }\n    \n    /* Responsive */\n    @media only screen and (max-width: 600px) {\n      .email-container { border-radius: 0; }\n      .masthead, .hero, .content, .key-stats-box, .tldr-box, .emmas-take-box, .action-items-section, .footer {\n        padding: 20px;\n      }\n      .hero-title { font-size: 28px; }\n      .stats-grid { grid-template-columns: 1fr; }\n      .footer-branding { flex-direction: column; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"email-container\">\n    \n    <!-- Masthead -->\n    <div class=\"masthead\">\n      <div class=\"masthead-left\">\n        <img src=\"https://i.ibb.co/VYgymNZ/emma-avatar.png\" alt=\"Emma\" class=\"masthead-avatar\">\n        <div class=\"masthead-title\">EMMA IA FINANCE</div>\n      </div>\n      <div class=\"masthead-time\">${currentTime} EST</div>\n    </div>\n    \n    <!-- Hero Section -->\n    <div class=\"hero\">\n      <div class=\"hero-greeting\">${greeting}</div>\n      <h1 class=\"hero-title\">${title}</h1>\n      <div class=\"hero-subtitle\">${subtitle}</div>\n      <div class=\"hero-byline\">\n        Par <strong>Emma IA</strong> â€¢ ${formattedDate}\n      </div>\n    </div>\n    \n    ${keyStats.length > 0 ? `\n    <!-- Key Stats Box -->\n    <div class=\"key-stats-box\">\n      <div class=\"key-stats-title\">ğŸ“Š Indicateurs ClÃ©s</div>\n      <div class=\"stats-grid\">\n        ${keyStats.map(stat => `\n          <div class=\"stat-item\">\n            <div class=\"stat-label\">${stat.label}</div>\n            <div class=\"stat-value\">${stat.value}</div>\n          </div>\n        `).join('')}\n      </div>\n    </div>\n    ` : ''}\n    \n    ${tldrPoints.length > 0 ? `\n    <!-- TL;DR Box -->\n    <div class=\"tldr-box\">\n      <div class=\"tldr-title\">\n        ğŸ¯ L'ESSENTIEL\n      </div>\n      <div class=\"tldr-subtitle\">Les 3 points clÃ©s Ã  retenir - Lecture 30 secondes</div>\n      <ul class=\"tldr-list\">\n        ${tldrPoints.map(point => `\n          <li class=\"tldr-item\">\n            <span class=\"tldr-bullet\">â€¢</span>\n            <span>${point}</span>\n          </li>\n        `).join('')}\n      </ul>\n    </div>\n    ` : ''}\n    \n    <!-- Main Content -->\n    <div class=\"content\">\n      ${enhancedContent}\n    </div>\n    \n    <!-- Emma's Take -->\n    <div class=\"emmas-take-box\">\n      <span class=\"emmas-take-badge\">ğŸ¤– Emma's Take</span>\n      <div class=\"emmas-take-content\">\n        <span class=\"emmas-take-quote\">\"</span>\n        ${emmasTake}\n      </div>\n    </div>\n    \n    <!-- Action Items -->\n    <div class=\"action-items-section\">\n      <div class=\"action-items-title\">ğŸ’¡ Action Items</div>\n      <table class=\"action-items-table\">\n        ${actionItems.map(item => `\n          <tr class=\"action-item-row\">\n            <td class=\"action-item-type ${item.type.toLowerCase()}\">${item.type}</td>\n            <td class=\"action-item-details\">\n              <div class=\"action-item-ticker\">${item.ticker}</div>\n              <div class=\"action-item-action\">${item.action}</div>\n              <div class=\"action-item-rationale\">${item.rationale}</div>\n            </td>\n          </tr>\n        `).join('')}\n      </table>\n    </div>\n    \n    <!-- Footer -->\n    <div class=\"footer\">\n      <div class=\"footer-branding\">\n        <img src=\"https://i.ibb.co/VYgymNZ/emma-avatar.png\" alt=\"Emma\" class=\"footer-avatar\">\n        <img src=\"https://i.ibb.co/MRLqJyk/jslai-logo.png\" alt=\"JSLAI\" class=\"footer-logo\">\n      </div>\n      <p class=\"footer-text\">\n        <strong>GÃ©nÃ©rÃ© par Emma IA</strong> - Intelligence artificielle financiÃ¨re propulsÃ©e par <strong>JSLAIâ„¢</strong>\n      </p>\n      <div class=\"footer-details\">\n        <div class=\"footer-details-title\">ğŸ“‹ DÃ©tails Techniques</div>\n        <div class=\"footer-detail-item\">\n          <span class=\"footer-detail-label\">ModÃ¨le IA:</span>\n          <span>${metadata.emma_model || 'gemini-2.0-flash'}</span>\n        </div>\n        <div class=\"footer-detail-item\">\n          <span class=\"footer-detail-label\">Outils utilisÃ©s:</span>\n          <span>${(metadata.emma_tools || []).join(', ') || 'Analyse multi-sources'}</span>\n        </div>\n        <div class=\"footer-detail-item\">\n          <span class=\"footer-detail-label\">Temps d'exÃ©cution:</span>\n          <span>${metadata.emma_execution_time || 'N/A'}s</span>\n        </div>\n        <div class=\"footer-detail-item\">\n          <span class=\"footer-detail-label\">Type de briefing:</span>\n          <span>${metadata.prompt_type || metadata.trigger_type || 'custom'}</span>\n        </div>\n        ${metadata.tickers ? `\n        <div class=\"footer-detail-item\">\n          <span class=\"footer-detail-label\">Tickers analysÃ©s:</span>\n          <span>${metadata.tickers}</span>\n        </div>\n        ` : ''}\n      </div>\n    </div>\n    \n  </div>\n</body>\n</html>\n`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸš€ MAIN EXECUTION\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Get newsletter content\nlet content = data.newsletter_content || data.chatOutput || data.content || data.text || data.output || '';\n\nif (!content) {\n  console.log('âŒ No content found in input data');\n  console.log('Available keys:', Object.keys(data));\n  content = 'Contenu indisponible. Veuillez rÃ©essayer.';\n}\n\n// Prepare metadata\nconst metadata = {\n  trigger_type: data.trigger_type || data.prompt_type || 'morning',\n  emma_model: data.emma_model || 'gemini-2.0-flash',\n  emma_tools: data.emma_tools || [],\n  emma_execution_time: data.emma_execution_time || 0,\n  prompt_type: data.prompt_type || 'custom',\n  tickers: data.tickers || ''\n};\n\n// Generate HTML\nconst html = generateEnhancedBloombergHTML(content, metadata);\n\n// Prepare output\nconst output = {\n  html: html,\n  subject: `${extractTitleAndSubtitle(content).title} - Emma IA`,\n  from: 'emma@gobapps.com',\n  recipients: data.recipients || ['projetsjsl@gmail.com'],\n  ...data\n};\n\nconsole.log('âœ… Enhanced Bloomberg HTML generated');\nconsole.log('   Title:', extractTitleAndSubtitle(content).title);\nconsole.log('   TL;DR points:', extractTLDR(content).length);\nconsole.log('   Key stats:', extractKeyStats(content).length);\nconsole.log('   HTML length:', html.length, 'chars');\n\nreturn [{ json: output }];\n"
      },
      "id": "9f33f73d-349d-48b3-8d6a-a49184737384",
      "name": "Generate HTML Newsletter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5696,
        1716
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.resend.com/emails",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer re_XeAhe3ju_PAnnuMx3kmhgPKnDff8PatR6"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"from\": \"Emma IA - Finance <emma@gobapps.com>\", \"to\": $json.recipients || [\"projetsjsl@gmail.com\"], \"subject\": $json.subject, \"html\": $json.html } }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "beade8c0-697a-4479-a714-427af704b510",
      "name": "Send Email via Resend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6592,
        1716
      ]
    },
    {
      "parameters": {
        "tableId": "team_newsletters",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "prompt_type",
              "fieldValue": "={{ $json.prompt_type }}"
            },
            {
              "fieldId": "api_used",
              "fieldValue": "={{ $json.api_type }}"
            },
            {
              "fieldId": "tickers",
              "fieldValue": "={{ $json.tickers }}"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.newsletter_content }}"
            },
            {
              "fieldId": "sent_at",
              "fieldValue": "={{ $json.generated_at }}"
            },
            {
              "fieldId": "test_mode",
              "fieldValue": "={{ $json.test_mode }}"
            }
          ]
        }
      },
      "id": "b0291671-026c-49c9-b37a-9e513f3c2e85",
      "name": "Log to Newsletters Table",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6816,
        1716
      ],
      "credentials": {
        "supabaseApi": {
          "id": "WGwVmhxNX4mHZmVO",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "team_logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "workflow_name",
              "fieldValue": "Emma Newsletter"
            },
            {
              "fieldId": "status",
              "fieldValue": "success"
            },
            {
              "fieldId": "message",
              "fieldValue": "={{ 'Newsletter sent: ' + $json.prompt_type }}"
            },
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "id": "29addad3-ef28-48b0-bb20-18db04e545d4",
      "name": "Log to Logs Table",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7040,
        1716
      ],
      "credentials": {
        "supabaseApi": {
          "id": "WGwVmhxNX4mHZmVO",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "perplexity",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-preview-mode-1762640093151",
              "name": "preview_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-approved-1762640093151",
              "name": "approved",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "1ad117ce-d3f2-4d81-ac31-0f630b7e7a6c",
      "name": "Workflow Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2656,
        992
      ]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "q": "subject:Emma",
          "readStatus": "unread"
        }
      },
      "id": "9041e17a-e0a4-4e37-9ba7-12fe235db41f",
      "name": "Gmail Trigger (Custom Prompt)",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        2656,
        1184
      ],
      "credentials": {
        "gmailOAuth2": {
          "id": "bmBwCRZ3KQTDIMTG",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "6a4255df-5f6b-4b7d-9fd4-4398c4741049",
      "name": "Telegram Trigger (Custom Prompt)",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        2656,
        1376
      ],
      "webhookId": "1d4fb668-97ac-440c-9a17-8656ae9083a8",
      "credentials": {
        "telegramApi": {
          "id": "uoIupEJ4OAsCIDaM",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "={{ $json.custom_api || 'perplexity' }}",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": "={{ $json.custom_test_mode !== undefined ? $json.custom_test_mode : false }}",
              "type": "boolean"
            },
            {
              "id": "id-3",
              "name": "recipients",
              "value": "[\"projetsjsl@gmail.com\"]",
              "type": "array"
            },
            {
              "id": "id-4",
              "name": "custom_prompt",
              "value": "={{ $json.textPlain || $json.message?.text || '' }}",
              "type": "string"
            },
            {
              "id": "id-5",
              "name": "trigger_source",
              "value": "={{ $json.textPlain ? 'gmail' : ($json.message?.text ? 'telegram' : 'unknown') }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "b9afa8d9-1934-4e8c-a79e-bcfdbe155765",
      "name": "Custom Workflow Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2880,
        1280
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://gob-projetsjsls-projects.vercel.app/api/chat",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"message\": $json.message,\n  \"channel\": $json.channel || 'web',\n  \"userId\": $json.userId || 'n8n-automation'\n} }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "emma-n8n-briefing-node-id",
      "name": "Call /api/chat (Emma)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4672,
        1080
      ]
    },
    {
      "parameters": {
        "url": "=https://gob-projetsjsls-projects.vercel.app/api/briefing-prompts",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "fetch-prompts-from-api",
      "name": "Fetch Prompts from API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2880,
        896
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// ============================================\n// PRÃ‰SERVER preview_mode et approved depuis les nodes de configuration\n// ============================================\n// Ces valeurs viennent des nodes: Schedule Config, Webhook Config, Manual Config, Chat Config\nconst previewMode = data.preview_mode !== undefined ? data.preview_mode : true; // Fallback Ã  true si non dÃ©fini\nconst approved = data.approved !== undefined ? data.approved : false; // Fallback Ã  false si non dÃ©fini\n\nconsole.log('ğŸ“Š Preview Briefing Content - Valeurs prÃ©servÃ©es:');\nconsole.log('   preview_mode:', previewMode, '(type:', typeof previewMode, ')');\nconsole.log('   approved:', approved, '(type:', typeof approved, ')');\n\n// Extraire le contenu de la rÃ©ponse\nconst content = data.newsletter_content || data.response || data.message || 'Aucun contenu reÃ§u';\nconst metadata = {\n  trigger_type: data.trigger_type || 'Manuel',\n  emma_model: data.emma_model || 'perplexity',\n  emma_tools: data.emma_tools || [],\n  emma_execution_time: data.emma_execution_time || 0,\n  prompt_type: data.prompt_type || 'custom',\n  generated_at: data.generated_at || new Date().toISOString()\n};\n\n// CrÃ©er un rÃ©sumÃ© pour la prÃ©visualisation\n// IMPORTANT: PrÃ©server preview_mode et approved depuis les nodes de configuration\nconst preview = {\n  success: true,\n  preview_mode: previewMode, // PRÃ‰SERVER depuis les nodes de configuration\n  approved: approved, // PRÃ‰SERVER depuis les nodes de configuration\n  content: content.substring(0, 500) + (content.length > 500 ? '...' : ''),\n  content_length: content.length,\n  metadata: metadata,\n  full_content: content,\n  ready_for_approval: approved === true && previewMode === false\n};\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    ...preview\n  }\n}));"
      },
      "id": "preview-briefing-content",
      "name": "Preview Briefing Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4896,
        1864
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.test_mode === false || $json.require_approval === false || $json.approved === true }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "approval-check",
      "name": "Check Approval",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5472,
        1864
      ]
    },
    {
      "parameters": {},
      "id": "preview-message",
      "name": "Preview Message",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5184,
        1864
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.preview_mode === false && $json.approved === true ? 'send' : 'preview' }}",
              "operation": "equals",
              "value2": "send"
            }
          ]
        },
        "options": {}
      },
      "id": "preview-or-send-switch",
      "name": "Should Send Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5472,
        1272
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// Extraire le contenu\nconst content = data.newsletter_content || data.response || data.message || 'Aucun contenu reÃ§u';\nconst metadata = {\n  trigger_type: data.trigger_type || 'Manuel',\n  emma_model: data.emma_model || 'perplexity',\n  emma_tools: Array.isArray(data.emma_tools) ? data.emma_tools.join(', ') : 'Aucun',\n  emma_execution_time: data.emma_execution_time || 0,\n  prompt_type: data.prompt_type || 'custom',\n  generated_at: data.generated_at || new Date().toISOString(),\n  content_length: content.length\n};\n\n// CrÃ©er un message de prÃ©visualisation formatÃ© avec lien HTML\nconst previewMessage = `\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘  ğŸ“‹ PRÃ‰VISUALISATION DU BRIEFING                            â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâœ… Briefing gÃ©nÃ©rÃ© avec succÃ¨s !\n\nğŸ“Š MÃ‰TADONNÃ‰ES :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ Type : ${metadata.prompt_type}\nâ€¢ ModÃ¨le Emma : ${metadata.emma_model.toUpperCase()}\nâ€¢ Outils utilisÃ©s : ${metadata.emma_tools}\nâ€¢ Temps d'exÃ©cution : ${(metadata.emma_execution_time / 1000).toFixed(1)}s\nâ€¢ Longueur : ${metadata.content_length} caractÃ¨res\nâ€¢ GÃ©nÃ©rÃ© le : ${new Date(metadata.generated_at).toLocaleString('fr-FR')}\n\nğŸ“ APERÃ‡U DU CONTENU (500 premiers caractÃ¨res) :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${content.substring(0, 500)}${content.length > 500 ? '...' : ''}\n\nğŸŒ PRÃ‰VISUALISATION HTML :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“§ Pour voir la prÃ©visualisation HTML complÃ¨te de l'email :\n   1. Utilisez le \"Chat Trigger (Preview)\" pour obtenir une URL\n   2. Ou consultez le nÅ“ud \"Generate HTML Preview\" pour le HTML\n\nâš ï¸  POUR APPROUVER ET ENVOYER :\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n1. Modifiez le nÅ“ud \"Custom Prompt Input\"\n2. Changez \"approved\" de false Ã  true\n3. RÃ©exÃ©cutez le workflow depuis \"Custom Prompt Input\"\n\nğŸ’¡ ASTUCE : Vous pouvez aussi modifier le prompt dans \"Custom Prompt Input\"\net rÃ©exÃ©cuter pour tester diffÃ©rentes versions.\n`;\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    preview_message: previewMessage,\n    preview_content: content,\n    preview_metadata: metadata\n  }\n}));"
      },
      "id": "preview-display",
      "name": "Preview Display",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5696,
        1176
      ]
    },
    {
      "parameters": {},
      "id": "preview-stop",
      "name": "Preview Stop",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5920,
        1176
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "emma-newsletter/preview",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "chat-trigger-preview",
      "name": "Chat Trigger (Preview)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2208,
        512
      ],
      "webhookId": "emma-preview-webhook"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// RÃ©cupÃ©rer le contenu HTML gÃ©nÃ©rÃ©\nconst htmlContent = data.html_content || '';\nconst subject = data.subject || 'Newsletter Emma';\nconst content = data.newsletter_content || data.response || '';\n\n// CrÃ©er une prÃ©visualisation HTML interactive\nconst previewHtml = `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>PrÃ©visualisation - ${subject}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      font-family: 'Inter', 'Roboto', sans-serif;\n      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);\n      padding: 20px;\n    }\n    .preview-container {\n      max-width: 800px;\n      margin: 0 auto;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);\n      overflow: hidden;\n    }\n    .preview-header {\n      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);\n      color: white;\n      padding: 24px;\n      text-align: center;\n    }\n    .preview-header h1 {\n      font-size: 24px;\n      margin-bottom: 8px;\n    }\n    .preview-header p {\n      opacity: 0.9;\n      font-size: 14px;\n    }\n    .preview-actions {\n      padding: 20px;\n      background: #f8fafc;\n      border-bottom: 2px solid #e5e7eb;\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n    }\n    .preview-btn {\n      padding: 12px 24px;\n      border-radius: 8px;\n      font-weight: 600;\n      cursor: pointer;\n      border: none;\n      font-size: 14px;\n      transition: all 0.2s;\n    }\n    .preview-btn.approve {\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n    }\n    .preview-btn.approve:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);\n    }\n    .preview-btn.reject {\n      background: #ef4444;\n      color: white;\n    }\n    .preview-btn.reject:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);\n    }\n    .preview-content {\n      padding: 0;\n    }\n    .preview-content iframe {\n      width: 100%;\n      height: 800px;\n      border: none;\n    }\n    .preview-metadata {\n      padding: 20px;\n      background: #f1f5f9;\n      border-top: 2px solid #e5e7eb;\n    }\n    .preview-metadata table {\n      width: 100%;\n      border-collapse: collapse;\n    }\n    .preview-metadata td {\n      padding: 8px 12px;\n      border-bottom: 1px solid #e5e7eb;\n    }\n    .preview-metadata td:first-child {\n      font-weight: 700;\n      color: #4f46e5;\n      width: 150px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"preview-container\">\n    <div class=\"preview-header\">\n      <h1>ğŸ“‹ PrÃ©visualisation de l'Email</h1>\n      <p>VÃ©rifiez le contenu avant d'approuver l'envoi</p>\n    </div>\n    \n    <div class=\"preview-actions\">\n      <button class=\"preview-btn approve\" onclick=\"approveEmail()\">\n        âœ… Approuver et Envoyer\n      </button>\n      <button class=\"preview-btn reject\" onclick=\"rejectEmail()\">\n        âŒ Rejeter\n      </button>\n    </div>\n    \n    <div class=\"preview-content\">\n      <iframe srcdoc=\"${htmlContent.replace(/\"/g, '&quot;')}\"></iframe>\n    </div>\n    \n    <div class=\"preview-metadata\">\n      <table>\n        <tr>\n          <td>Sujet:</td>\n          <td>${subject}</td>\n        </tr>\n        <tr>\n          <td>Type:</td>\n          <td>${data.prompt_type || 'custom'}</td>\n        </tr>\n        <tr>\n          <td>ModÃ¨le Emma:</td>\n          <td>${data.emma_model || 'perplexity'}</td>\n        </tr>\n        <tr>\n          <td>Longueur:</td>\n          <td>${content.length} caractÃ¨res</td>\n        </tr>\n        <tr>\n          <td>GÃ©nÃ©rÃ© le:</td>\n          <td>${new Date().toLocaleString('fr-FR')}</td>\n        </tr>\n      </table>\n    </div>\n  </div>\n  \n  <script>\n    function approveEmail() {\n      alert('âœ… Pour approuver:\\n\\n1. Retournez dans n8n\\n2. Modifiez le nÅ“ud \"Custom Prompt Input\"\\n3. Changez \"approved\" Ã  true\\n4. RÃ©exÃ©cutez le workflow');\n    }\n    function rejectEmail() {\n      alert('âŒ Email rejetÃ©. Modifiez le prompt dans \"Custom Prompt Input\" et rÃ©exÃ©cutez.');\n    }\n  </script>\n</body>\n</html>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    preview_html: previewHtml,\n    preview_url: `data:text/html;charset=utf-8,${encodeURIComponent(previewHtml)}`\n  }\n}];"
      },
      "id": "html-preview-generator",
      "name": "Generate HTML Preview",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        2088
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"preview_html\": $json.preview_html, \"preview_url\": $json.preview_url, \"subject\": $json.subject, \"metadata\": { \"type\": $json.prompt_type, \"model\": $json.emma_model, \"length\": ($json.newsletter_content || $json.response || '').length } } }}",
        "options": {}
      },
      "id": "serve-preview",
      "name": "Serve Preview",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2432,
        2088
      ]
    },
    {
      "parameters": {
        "url": "=https://gob-projetsjsls-projects.vercel.app/api/email-recipients",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "fetch-email-recipients-node",
      "name": "Fetch Email Recipients",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5920,
        1716
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// Les donnÃ©es viennent de \"Fetch Email Recipients\" qui retourne { recipients: [...], success: true }\n// On doit rÃ©cupÃ©rer html_content, subject, prompt_type et preview_mode depuis \"Generate HTML Newsletter\"\n\n// MÃ©thode 1 : Utiliser les donnÃ©es disponibles dans le flux actuel\nlet briefingType = data.prompt_type || data.briefing_type || 'custom';\nlet previewMode = data.preview_mode !== undefined ? data.preview_mode : false;\nlet htmlContent = data.html || '';\nlet subject = data.subject || '';\n\n// MÃ©thode 2 : Essayer d'accÃ©der aux nÅ“uds prÃ©cÃ©dents dans le flux d'exÃ©cution\n// Note: Dans n8n, $() permet d'accÃ©der aux donnÃ©es des nÅ“uds prÃ©cÃ©dents\n// mais seulement si ces nÅ“uds sont dans le flux d'exÃ©cution actuel\n\n// Essayer depuis \"Generate HTML Newsletter\" (juste avant \"Fetch Email Recipients\")\ntry {\n  const generateHtmlData = $('Generate HTML Newsletter').item?.json;\n  if (generateHtmlData) {\n    // IMPORTANT : PrÃ©server html_content et subject depuis \"Generate HTML Newsletter\"\n    htmlContent = generateHtmlData.html || htmlContent;\n    subject = generateHtmlData.subject || subject;\n    \n    // PrÃ©server aussi prompt_type et preview_mode\n    briefingType = generateHtmlData.prompt_type || briefingType;\n    previewMode = generateHtmlData.preview_mode !== undefined ? generateHtmlData.preview_mode : previewMode;\n    \n    console.log('âœ… DonnÃ©es rÃ©cupÃ©rÃ©es depuis Generate HTML Newsletter');\n  }\n} catch (e) {\n  console.warn('âš ï¸  Generate HTML Newsletter non accessible, tentative d\\'autres nÅ“uds...');\n  \n  try {\n    // Essayer depuis \"Parse API Response\"\n    const parseApiData = $('Parse API Response').item?.json;\n    if (parseApiData) {\n      briefingType = parseApiData.prompt_type || briefingType;\n      previewMode = parseApiData.preview_mode !== undefined ? parseApiData.preview_mode : previewMode;\n      console.log('âœ… DonnÃ©es rÃ©cupÃ©rÃ©es depuis Parse API Response');\n    }\n  } catch (e2) {\n    console.warn('âš ï¸  Parse API Response non accessible, utilisation des valeurs par dÃ©faut');\n  }\n}\n\n// Normaliser le type\nlet normalizedType = briefingType;\nif (normalizedType === 'noon') {\n  normalizedType = 'midday';\n}\n\n// RÃ©cupÃ©rer les destinataires depuis l'API (donnÃ©es de \"Fetch Email Recipients\")\nconst recipientsData = data.recipients || [];\nconst previewEmail = data.preview_email || 'projetsjsl@gmail.com';\n\nlet emailList = [];\n\nif (previewMode === true) {\n  // Mode preview : utiliser l'email de preview\n  emailList = [previewEmail];\n  console.log('ğŸ“§ Mode preview activÃ©');\n} else {\n  // Mode envoi : utiliser les destinataires actifs du type\n  emailList = recipientsData\n    .filter(r => r.active && r[normalizedType])\n    .map(r => r.email);\n  \n  console.log(`ğŸ“§ Mode envoi, type: ${normalizedType}, destinataires: ${emailList.length}`);\n  \n  // Fallback si aucun destinataire trouvÃ©\n  if (emailList.length === 0) {\n    emailList = [previewEmail];\n    console.warn('âš ï¸  Aucun destinataire actif, utilisation de l\\'email de preview');\n  }\n}\n\n// VÃ©rifier que html_content et subject sont prÃ©sents\nif (!htmlContent) {\n  console.warn('âš ï¸  html_content manquant, le nÅ“ud Send Email via Resend pourrait Ã©chouer');\n}\nif (!subject) {\n  console.warn('âš ï¸  subject manquant, utilisation d\\'un sujet par dÃ©faut');\n  subject = subject || `Newsletter Emma - Mise Ã  jour du ${normalizedType}`;\n}\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    // DonnÃ©es de destinataires\n    recipients: emailList,\n    recipient_count: emailList.length,\n    briefing_type: normalizedType,\n    preview_mode: previewMode,\n    prompt_type: briefingType,\n    // IMPORTANT : PrÃ©server html_content et subject pour \"Send Email via Resend\"\n    html: htmlContent,\n    subject: subject\n  }\n}));"
      },
      "id": "process-recipients-node",
      "name": "Process Recipients",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6144,
        1716
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "perplexity",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-preview-mode-1762640093151",
              "name": "preview_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-approved-1762640093151",
              "name": "approved",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "config-schedule-config-1762643453541",
      "name": "Schedule Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2432,
        896
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "perplexity",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-preview-mode-1762640093151",
              "name": "preview_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-approved-1762640093151",
              "name": "approved",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "config-webhook-config-1762643453541",
      "name": "Webhook Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2432,
        1088
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "perplexity",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-preview-mode-1762640093151",
              "name": "preview_mode",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "id-approved-1762640093151",
              "name": "approved",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "config-manual-config-1762643453541",
      "name": "Manual Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2432,
        1280
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "active_api",
              "value": "perplexity",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "test_mode",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "id-preview-mode-1762640093151",
              "name": "preview_mode",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "id-approved-1762640093151",
              "name": "approved",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "config-chat-config-1762643453541",
      "name": "Chat Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2432,
        1472
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\nconsole.log('ğŸ” DEBUG AVANT SWITCH:');\nconsole.log('   preview_mode:', data.preview_mode, '(type:', typeof data.preview_mode, ')');\nconsole.log('   approved:', data.approved, '(type:', typeof data.approved, ')');\nconsole.log('   Condition Preview:', data.preview_mode === true || data.approved !== true);\nconsole.log('   Condition Send:', data.preview_mode === false && data.approved === true);\n\nreturn items;"
      },
      "id": "debug-before-switch-node",
      "name": "Debug Before Switch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5184,
        1272
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $json.gemini_api_key }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": $json.message || $json.selected_prompt || \"GÃ©nÃ¨re un briefing financier matinal.\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"topK\": 40,\n    \"topP\": 0.95,\n    \"maxOutputTokens\": 2048\n  }\n} }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "call-gemini-api-node",
      "name": "Call Gemini API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4448,
        1272
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "0D5m3nEBknRtHnmZ",
          "name": "Google Gemini(PaLM) Api account 3"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst data = items[0].json;\n\n// La rÃ©ponse de Gemini a une structure diffÃ©rente\n// Structure Gemini: { candidates: [{ content: { parts: [{ text: \"...\" }] } }] }\nlet content = '';\nif (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {\n  content = data.candidates[0].content.parts.map(part => part.text).join('\\n');\n} else if (data.response) {\n  content = data.response;\n} else if (typeof data === 'string') {\n  content = data;\n}\n\n// Adapter au format attendu par Parse API Response\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    newsletter_content: content,\n    response: content,\n    message: content,\n    emma_model: 'gemini',\n    emma_tools: [],\n    emma_execution_time: 0,\n    trigger_type: item.json.trigger_type || 'Manuel',\n    prompt_type: item.json.prompt_type || 'custom',\n    generated_at: new Date().toISOString(),\n    // PrÃ©server preview_mode et approved\n    preview_mode: item.json.preview_mode,\n    approved: item.json.approved\n  }\n}));"
      },
      "id": "parse-gemini-response",
      "name": "Parse Gemini Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4672,
        1272
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¤– SÃ‰LECTEUR DE MODÃˆLE IA - MODIFIEZ ICI âš™ï¸\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// ğŸ‘‡ MODIFIEZ LA VALEUR CI-DESSOUS ğŸ‘‡\n//\nconst AI_MODEL = 'emma';\n//\n// Options disponibles:\n//   - 'emma'    â†’ Utilise Emma (Perplexity) via /api/chat\n//   - 'gemini'  â†’ Utilise Gemini directement\n//\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    ai_model: AI_MODEL,\n    _model_info: AI_MODEL === 'emma' \n      ? 'ğŸ¤– Emma (Perplexity) - Recherche web en temps rÃ©el' \n      : 'âœ¨ Gemini Direct - RÃ©ponse rapide'\n  }\n}));"
      },
      "id": "ai-model-config-dropdown",
      "name": "âš™ï¸ AI Model Selector (Change AI_MODEL)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3552,
        1272
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”‘ EXTRACTION DE LA CLÃ‰ API GEMINI DEPUIS LA RÃ‰PONSE VERCEL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// Ce nÅ“ud extrait la clÃ© API Gemini depuis la rÃ©ponse de l'endpoint Vercel\n//\n// âœ… Configuration automatique - Aucune action requise !\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\nlet geminiApiKey = '';\n\ntry {\n  // La rÃ©ponse de l'endpoint Vercel est dans $json\n  // Format: { apiKey: \"...\", configured: true, ... }\n  if (data.apiKey) {\n    geminiApiKey = data.apiKey;\n    console.log('âœ… ClÃ© API Gemini rÃ©cupÃ©rÃ©e depuis Vercel');\n  } else if (data.error) {\n    throw new Error(`Erreur Vercel: ${data.message || data.error}`);\n  } else {\n    // Fallback : essayer depuis les credentials n8n\n    geminiApiKey = $workflow.getStaticData('global').geminiApiKey || '';\n    \n    if (!geminiApiKey) {\n      throw new Error('ClÃ© API non trouvÃ©e. VÃ©rifiez que GEMINI_API_KEY est configurÃ©e dans Vercel.');\n    }\n    \n    console.log('âš ï¸  Utilisation de la clÃ© depuis les credentials n8n (fallback)');\n  }\n} catch (error) {\n  console.error('âŒ Erreur:', error.message);\n  throw new Error(`âŒ Impossible de rÃ©cupÃ©rer la clÃ© API Gemini: ${error.message}`);\n}\n\nif (!geminiApiKey) {\n  throw new Error('âŒ ClÃ© API Gemini vide');\n}\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    gemini_api_key: geminiApiKey\n  }\n}));"
      },
      "id": "gemini-api-key-node",
      "name": "Get Gemini API Key",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4224,
        1272
      ]
    },
    {
      "parameters": {
        "url": "=https://gob-projetsjsls-projects.vercel.app/api/gemini-key?full=true",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "fetch-gemini-api-key-node",
      "name": "Fetch Gemini API Key from Vercel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4000,
        1272
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.ai_model }}",
                    "rightValue": "emma",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e15020a5-785c-4bf2-be14-7a2a338e9c34"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Emma"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "602d5987-7966-46b0-bca6-1bc86f245316",
                    "leftValue": "={{ $json.ai_model }}",
                    "rightValue": "gemini",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Gemini"
            }
          ]
        },
        "options": {}
      },
      "id": "6f67bbb2-07a7-46be-9b7a-1735ba3e3c5b",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        3776,
        1272
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "339cad82-0be3-4fbb-a420-f8e9a9d2f805",
      "name": "When chat message received",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        4672,
        1568
      ],
      "webhookId": "9663354b-9871-49c0-aaee-3992c85a12ec"
    },
    {
      "parameters": {
        "batching": {}
      },
      "id": "90188c41-16ed-4cc6-bf45-b473e44872ee",
      "name": "Basic LLM Chain",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        5120,
        1464
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "21c86760-5e53-4acd-b4a3-223a3b69c361",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        5192,
        1688
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "0D5m3nEBknRtHnmZ",
          "name": "Google Gemini(PaLM) Api account 3"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Test Email Prep Node - ENHANCED DEBUGGING\nconst items = $input.all();\nconst data = items[0].json;\n\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\nconsole.log(\"ğŸ“‹ Test Email Prep - Input Data:\");\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\nconsole.log(\"All keys:\", Object.keys(data));\nconsole.log(\"Full data:\", JSON.stringify(data, null, 2));\n\nlet content = \"\";\nif (data.output) {\n  content = data.output;\n  console.log(\"âœ… Content found in: data.output\");\n}\nelse if (data.text) {\n  content = data.text;\n  console.log(\"âœ… Content found in: data.text\");\n}\nelse if (data.response) {\n  content = data.response;\n  console.log(\"âœ… Content found in: data.response\");\n}\nelse if (data.message) {\n  content = data.message;\n  console.log(\"âœ… Content found in: data.message\");\n}\nelse {\n  content = \"No content found - available keys: \" + Object.keys(data).join(\", \");\n  console.log(\"âŒ Content NOT found!\");\n}\n\nconsole.log(\"ğŸ“ Content length:\", content.length);\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\n\nreturn [{\n  json: {\n    newsletter_content: content,\n    trigger_type: \"Test Chat\",\n    emma_model: \"gemini-langchain\",\n    emma_tools: [\"langchain\", \"chat\"],\n    emma_execution_time: 0,\n    prompt_type: \"test\",\n    tickers: \"\",\n    preview_mode: false,\n    approved: true,\n    test_mode: true,\n    recipients: [\"projetsjsl@gmail.com\"],\n    generated_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "8346e806-18fc-4bc8-ad19-fc8c0e11bd5b",
      "name": "Test Formated HTML Email to projetsjsl@gmail.com",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5472,
        1568
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ‡«ğŸ‡· INSTRUCTION FRANÃ‡AISE POUR LE LLM\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\n// Message original de l'utilisateur\nconst userMessage = data.chatInput || data.message || '';\n\n// Instruction systÃ¨me en franÃ§ais\nconst systemInstruction = `Tu es Emma, l'assistante financiÃ¨re IA de JSLAIâ„¢.\n\nLANGUE: RÃ©ponds TOUJOURS en FRANÃ‡AIS, sauf pour:\n- Les noms propres (entreprises, personnes, lieux)\n- Les citations directes\n- Les termes techniques standards (P/E ratio, ETF, etc.)\n\nSTYLE:\n- Analyse financiÃ¨re claire et professionnelle\n- Structure avec des paragraphes distincts\n- Utilise des donnÃ©es prÃ©cises\n- Ton accessible mais expert\n\nVoici la question de l'utilisateur:\n\n`;\n\n// Combiner l'instruction avec le message\nconst fullMessage = systemInstruction + userMessage;\n\nconsole.log('ğŸ‡«ğŸ‡· Instruction franÃ§aise ajoutÃ©e au message');\nconsole.log('   Longueur originale:', userMessage.length);\nconsole.log('   Longueur totale:', fullMessage.length);\n\nreturn [{\n  json: {\n    ...data,\n    chatInput: fullMessage\n  }\n}];"
      },
      "id": "add-french-instruction-node-id",
      "name": "ğŸ‡«ğŸ‡· Add French Instruction",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4896,
        1568
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ› DEBUG NODE - Voir EXACTEMENT ce qui arrive Ã  Send Email\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst data = items[0].json;\n\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\nconsole.log(\"ğŸ› DEBUG AVANT SEND EMAIL\");\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\nconsole.log(\"Toutes les clÃ©s disponibles:\", Object.keys(data));\nconsole.log(\"\");\n\n// VÃ©rifier CHAQUE champ important\nconst checks = {\n    'html': data.html,\n    'html_content': data.html_content,\n    'subject': data.subject,\n    'from': data.from,\n    'to': data.to,\n    'recipients': data.recipients\n};\n\nfor (const [key, value] of Object.entries(checks)) {\n    if (value !== undefined) {\n        const preview = typeof value === 'string' ? value.substring(0, 100) : JSON.stringify(value);\n        console.log(`âœ… ${key}: ${preview}...`);\n    } else {\n        console.log(`âŒ ${key}: MISSING`);\n    }\n}\n\nconsole.log(\"\");\nconsole.log(\"Type de data.html:\", typeof data.html);\nconsole.log(\"Longueur data.html:\", data.html ? data.html.length : 0);\nconsole.log(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\n\n// IMPORTANT: Retourner les donnÃ©es SANS MODIFICATION\nreturn items;\n"
      },
      "id": "debug-before-send-email",
      "name": "ğŸ› DEBUG Before Send Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6368,
        1716
      ]
    },
    {
      "name": "SMS Webhook Twilio",
      "id": "sms-webhook-prod",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        24400,
        5600
      ],
      "parameters": {
        "httpMethod": "POST",
        "path": "gob-sms-webhook",
        "options": {},
        "responseMode": "responseNode"
      },
      "webhookId": "gob-sms-twilio"
    },
    {
      "name": "SMS Webhook Test",
      "id": "sms-webhook-test",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        24400,
        5850
      ],
      "parameters": {
        "httpMethod": "POST",
        "path": "gob-sms-webhook-test",
        "options": {},
        "responseMode": "responseNode"
      },
      "webhookId": "gob-sms-test"
    },
    {
      "name": "SMS Extract Data",
      "id": "sms-extract-data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        24850,
        5725
      ],
      "parameters": {
        "values": {
          "string": [
            {
              "name": "from_phone",
              "value": "={{ $json.body.From }}"
            },
            {
              "name": "to_phone",
              "value": "={{ $json.body.To }}"
            },
            {
              "name": "message_body",
              "value": "={{ $json.body.Body }}"
            },
            {
              "name": "message_sid",
              "value": "={{ $json.body.MessageSid }}"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "name": "SMS Call Adapter",
      "id": "sms-call-adapter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        25300,
        5725
      ],
      "parameters": {
        "method": "POST",
        "url": "https://gobapps.com/api/adapters/sms",
        "authentication": "none",
        "options": {
          "response": {
            "response": {
              "responseFormat": "string"
            }
          }
        },
        "bodyParametersJson": "={{ JSON.stringify({\\n  From: $json.from_phone,\\n  To: $json.to_phone,\\n  Body: $json.message_body,\\n  MessageSid: $json.message_sid\\n}) }}"
      }
    },
    {
      "name": "SMS Respond",
      "id": "sms-respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        25750,
        5725
      ],
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.body || $json }}"
      }
    }
  ],
  "connections": {
    "Schedule Trigger (7h/12h/16h30 EST)": {
      "main": [
        [
          {
            "node": "Schedule Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Webhook Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger (Custom Prompt)": {
      "main": [
        [
          {
            "node": "ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Fetch Prompts from API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Tickers": {
      "main": [
        [
          {
            "node": "Determine Time-Based Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Time-Based Prompt": {
      "main": [
        [
          {
            "node": "âš™ï¸ AI Model Selector (Change AI_MODEL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request": {
      "main": [
        [
          {
            "node": "Call /api/chat (Emma)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse API Response": {
      "main": [
        [
          {
            "node": "Debug Before Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Newsletter": {
      "main": [
        [
          {
            "node": "Fetch Email Recipients",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email via Resend": {
      "main": [
        [
          {
            "node": "Log to Newsletters Table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Newsletters Table": {
      "main": [
        [
          {
            "node": "Log to Logs Table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Configuration": {
      "main": [
        [
          {
            "node": "Fetch Prompts from API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Trigger (Custom Prompt)": {
      "main": [
        [
          {
            "node": "Custom Workflow Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger (Custom Prompt)": {
      "main": [
        [
          {
            "node": "Custom Workflow Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Custom Workflow Configuration": {
      "main": [
        [
          {
            "node": "Get Active Tickers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call /api/chat (Emma)": {
      "main": [
        [
          {
            "node": "Parse API Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Prompts from API": {
      "main": [
        [
          {
            "node": "Get Active Tickers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preview Briefing Content": {
      "main": [
        [
          {
            "node": "Preview Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preview Message": {
      "main": [
        [
          {
            "node": "Check Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Approval": {
      "main": [
        [
          {
            "node": "Generate HTML Newsletter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preview Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preview Display": {
      "main": [
        [
          {
            "node": "Preview Stop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Trigger (Preview)": {
      "main": [
        [
          {
            "node": "ğŸ¯ Manual Briefing Selector (MODIFIEZ ICI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Preview": {
      "main": [
        [
          {
            "node": "Serve Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Email Recipients": {
      "main": [
        [
          {
            "node": "Process Recipients",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Recipients": {
      "main": [
        [
          {
            "node": "ğŸ› DEBUG Before Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Config": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Config": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Config": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Config": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Before Switch": {
      "main": [
        [
          {
            "node": "Should Send Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send Email?": {
      "main": [
        [
          {
            "node": "Generate HTML Newsletter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preview Display",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Gemini API": {
      "main": [
        [
          {
            "node": "Parse Gemini Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Gemini Response": {
      "main": [
        [
          {
            "node": "Parse API Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ AI Model Selector (Change AI_MODEL)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Gemini API Key": {
      "main": [
        [
          {
            "node": "Call Gemini API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Gemini API Key from Vercel": {
      "main": [
        [
          {
            "node": "Get Gemini API Key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Prepare API Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch Gemini API Key from Vercel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "ğŸ‡«ğŸ‡· Add French Instruction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Test Formated HTML Email to projetsjsl@gmail.com",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test Formated HTML Email to projetsjsl@gmail.com": {
      "main": [
        [
          {
            "node": "Generate HTML Newsletter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ‡«ğŸ‡· Add French Instruction": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ› DEBUG Before Send Email": {
      "main": [
        [
          {
            "node": "Send Email via Resend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMS Webhook Twilio": {
      "main": [
        [
          {
            "node": "SMS Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMS Webhook Test": {
      "main": [
        [
          {
            "node": "SMS Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMS Extract Data": {
      "main": [
        [
          {
            "node": "SMS Call Adapter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMS Call Adapter": {
      "main": [
        [
          {
            "node": "SMS Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "03lgcA4e9uRTtli1"
  },
  "staticData": {
    "node:Schedule Trigger (7h/12h/16h30 EST)": {
      "recurrenceRules": []
    },
    "node:Gmail Trigger (Custom Prompt)": {
      "Gmail Trigger (Custom Prompt)": {
        "lastTimeChecked": 1762532537,
        "possibleDuplicates": [
          "19a5f2038b731938"
        ]
      }
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Call /api/chat (Emma)": [
      {
        "json": {
          "success": true,
          "response": "Bonsoir n8n-automation,  \nVoici votre synthÃ¨se personnalisÃ©e de la sÃ©ance boursiÃ¨re du vendredi 7 novembre 2025, marquÃ©e par une volatilitÃ© sectorielle contrastÃ©e et des mouvements significatifs sur plusieurs titres phares de votre univers dâ€™investissement.\n\n---\n\n**1. Ouverture**  \nLa sÃ©ance sâ€™est ouverte sous le signe de lâ€™incertitude, avec des marchÃ©s oscillant entre prises de bÃ©nÃ©fices en dÃ©but de journÃ©e et rebonds techniques sur les valeurs technologiques et santÃ© en clÃ´ture. Les investisseurs restent attentifs aux prochaines publications et Ã  la trajectoire des taux.\n\n---\n\n**2. ClÃ´ture des marchÃ©s**  \n- **S&P 500** : -0,3% Ã  5 086 points.  \n- **Nasdaq** : +0,5% Ã  17 120 points, soutenu par la tech.  \n- **TSX (Canada)** : -0,4% Ã  21 780 points.  \nLes volumes de transactions sont restÃ©s dans la moyenne, avec une accÃ©lÃ©ration sur les bancaires et la tech en fin de sÃ©ance (source : FMP Fundamentals, Polygon).\n\n---\n\n**3. Secteurs performants**\n- **En hausse :**  \n   - **Technologie** (+1,2%) : Alphabet (GOOGL) et le segment IA tirent le secteur, portÃ©s par des rÃ©sultats supÃ©rieurs et des anticipations de croissance durable.\n   - **Ã‰nergie** (+1,1%) : Reprise des cours du pÃ©trole, bÃ©nÃ©fique pour les valeurs de services et dâ€™infrastructure.\n   - **SantÃ©** : Big pharma (JNJ, PFE) en rebond modÃ©rÃ©, rotation vers la qualitÃ© en pÃ©riode dâ€™incertitude macro.\n\n- **En baisse :**  \n   - **TÃ©lÃ©coms** : BCE, VZ et T pÃ©nalisÃ©s par la pression sur les marges et la concurrence accrue (-1,5%).\n   - **Banques canadiennes** : BNS, TD sous pression (-0,7% Ã  -1,1%), inquiÃ©tudes persistantes sur le crÃ©dit et la rentabilitÃ©.\n   - **Consommation discrÃ©tionnaire** : NKE, CVS affectÃ©s par la prudence des mÃ©nages.\n\n---\n\n**4. Tickers dâ€™Ã©quipe â€“ Bilan et analyse**\n- **GOOGL (Alphabet)** : +0,8% Ã  278,83$. P/E de 27,1x (vs secteur tech 28x), ROE trÃ¨s Ã©levÃ© Ã  35%. Marge nette impressionnante (32%), dette quasi nulle, moat technologique majeur, momentum IA solide.  \n- **BNS (Banque Scotia)** : -0,7% Ã  66,70$. P/E Ã  16,1x, ROE faible Ã  8,6%, payout ratio Ã©levÃ© (81%), dette/capitaux propres massive (5,8x). Pression sur la croissance et la qualitÃ© du crÃ©dit.  \n- **TD (Toronto Dominion)** : -1,1% Ã  80,90$. P/E attractif Ã  9,3x, ROE robuste Ã  17,2%, marge nette 17,8%. Mieux positionnÃ©e que BNS, mais secteur bancaire sous tension.  \n- **BCE (TÃ©lÃ©com)** : -1,5% Ã  23,19$. P/E Ã©levÃ© Ã  50,3x, marge nette faible Ã  2,5%, payout ratio surdimensionnÃ© (>500%), dette Ã©levÃ©e. DÃ©fensif mais risque sur la soutenabilitÃ© du dividende.  \n- **CNR (Core Natural Resources)** : Stable Ã  89,41$. P/E extrÃªme Ã  227x, ROE quasi nul (<1%), mais faible endettement. Le marchÃ© reste prudent sur la visibilitÃ© bÃ©nÃ©ficiaire.\n\n---\n\n**5. Ã‰vÃ©nements marquants**  \n- Alphabet profite dâ€™un nouvel engouement IA, plusieurs analystes anticipant une Â« croissance exponentielle Â» Ã  moyen terme.\n- Les banques canadiennes pÃ¢tissent dâ€™une montÃ©e des provisions et des craintes sur lâ€™immobilier commercial.\n- Les tÃ©lÃ©coms subissent une rÃ©vision Ã  la baisse des perspectives de marges et des avertissements de plusieurs opÃ©rateurs.\n\n---\n\n**6. Perspective demain**  \nÃ€ surveiller : rÃ©sultats de sociÃ©tÃ©s santÃ© (MDT, JNJ), discours de la Fed et chiffres dâ€™inflation US qui pourraient inflÃ©chir la courbe des taux. Les investisseurs seront attentifs Ã  la rÃ©silience des dividendes dans les tÃ©lÃ©coms et Ã  la qualitÃ© des actifs bancaires.\n\n---\n\n**7. Conseil Emma**  \nFace Ã  la volatilitÃ©, privilÃ©giez les valeurs Ã  moat dÃ©fensif, faible endettement et gÃ©nÃ©ration de cash-flow solide (GOOGL, TD). Limitez lâ€™exposition aux tÃ©lÃ©coms et aux banques Ã  faible rentabilitÃ© ou fort levier, en privilÃ©giant la sÃ©lectivitÃ© dans vos arbitrages.\n\n---\n\n**8. Fermeture**  \nMerci n8n-automation pour votre confiance. Je reste Ã  disposition pour approfondir lâ€™analyse de tout titre spÃ©cifique ou Ã©laborer une allocation sectorielle dÃ©taillÃ©e demain matin. Bonne soirÃ©e et Ã  demain pour un nouveau point marchÃ©.\n\n*Sources : FMP Fundamentals, FMP Ratios, Polygon, actualitÃ©s sectorielles au 9 novembre 2025.*",
          "conversationId": "4c39bb0a-5adb-49e2-b77f-7ec22cc2437e",
          "metadata": {
            "user_id": "2fc99cf6-3dd8-4129-82c9-73ee478abe12",
            "name": "n8n-automation",
            "conversation_id": "4c39bb0a-5adb-49e2-b77f-7ec22cc2437e",
            "model": "perplexity",
            "llmUsed": "perplexity",
            "tools_used": [
              "fmp-fundamentals",
              "fmp-quote",
              "fmp-ticker-news",
              "fmp-ratios",
              "fmp-key-metrics",
              "fmp-ratings",
              "earnings-calendar",
              "polygon-stock-price"
            ],
            "toolsUsed": [
              "fmp-fundamentals",
              "fmp-quote",
              "fmp-ticker-news",
              "fmp-ratios",
              "fmp-key-metrics",
              "fmp-ratings",
              "earnings-calendar",
              "polygon-stock-price"
            ],
            "failedTools": [
              "fmp-quote"
            ],
            "confidence": 0.685,
            "dataConfidence": 0.52,
            "intent": "comparative_analysis",
            "execution_time_ms": 39903,
            "executionTimeMs": 41625,
            "emmaExecutionTimeMs": 39903,
            "channel": "web",
            "messageCount": 11
          }
        }
      }
    ]
  },
  "versionId": "94567182-906a-4bc2-8a29-e8d84e8ffad1",
  "versionCounter": 358,
  "triggerCount": 5,
  "shared": [
    {
      "updatedAt": "2025-10-20T18:16:03.747Z",
      "createdAt": "2025-10-20T18:16:03.747Z",
      "role": "workflow:owner",
      "workflowId": "03lgcA4e9uRTtli1",
      "projectId": "qfcAzmlYYK6RvGCQ",
      "project": {
        "updatedAt": "2025-09-24T01:26:58.771Z",
        "createdAt": "2025-09-24T01:26:55.321Z",
        "id": "qfcAzmlYYK6RvGCQ",
        "name": "Projets JSL <projetsjsl@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-09-24T01:26:55.322Z",
            "createdAt": "2025-09-24T01:26:55.322Z",
            "userId": "cf0c4ec1-d247-4b12-bc83-04a5c23649fb",
            "projectId": "qfcAzmlYYK6RvGCQ",
            "user": {
              "updatedAt": "2025-11-11T05:47:39.000Z",
              "createdAt": "2025-09-24T01:26:53.819Z",
              "id": "cf0c4ec1-d247-4b12-bc83-04a5c23649fb",
              "email": "projetsjsl@gmail.com",
              "firstName": "Projets",
              "lastName": "JSL",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "userClaimedAiCredits": true,
                "firstSuccessfulWorkflowId": "03lgcA4e9uRTtli1",
                "userActivatedAt": 1760990286412,
                "npsSurvey": {
                  "waitingForResponse": true,
                  "ignoredCount": 2,
                  "lastShownAt": 1762636703931
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-11-11",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}