<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Workflow Builder - Emma Orchestrator</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/themes.css">
    <style>
        /* Workflow Canvas Styles */
        .workflow-canvas {
            background: linear-gradient(90deg, #f1f5f9 1px, transparent 1px),
                        linear-gradient(180deg, #f1f5f9 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 600px;
            position: relative;
        }
        
        .workflow-node {
            position: absolute;
            width: 240px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: move;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .workflow-node:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }
        
        .workflow-node.selected {
            ring: 3px;
            ring-color: #6366f1;
            box-shadow: 0 0 0 3px #6366f1, 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        .workflow-node.running {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .node-connector {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #6366f1;
            background: white;
            position: absolute;
            cursor: pointer;
            z-index: 10;
        }
        
        .node-connector.input {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .node-connector.output {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .node-connector:hover {
            background: #6366f1;
        }
        
        .connection-line {
            stroke: #6366f1;
            stroke-width: 2;
            fill: none;
            pointer-events: none;
        }
        
        /* Sidebar styles */
        .node-palette-item {
            transition: all 0.2s ease;
            cursor: grab;
        }
        
        .node-palette-item:active {
            cursor: grabbing;
        }
        
        .node-palette-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        /* Status indicators */
        .status-idle { background-color: #94a3b8; }
        .status-running { background-color: #f59e0b; animation: pulse 1s infinite; }
        .status-success { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
        
        /* Timeline */
        .execution-timeline {
            position: relative;
        }
        
        .execution-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 16px;
        }
        
        .timeline-dot {
            position: absolute;
            left: 12px;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
        <div class="max-w-full mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span>üîÑ</span> Workflow Builder
                </h1>
                <span class="px-3 py-1 bg-white/20 rounded-full text-sm">Emma Orchestrator</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="runWorkflow()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition">
                    <span>‚ñ∂Ô∏è</span> Run Workflow
                </button>
                <button onclick="saveWorkflow()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition">
                    <span>üíæ</span> Save
                </button>
                <a href="/emma-config.html" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition">
                    <span>‚öôÔ∏è</span> Config
                </a>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar: Node Palette & Workflows -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button onclick="showPaletteTab('nodes')" id="tabNodes" class="flex-1 px-4 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">
                    üì¶ Nodes
                </button>
                <button onclick="showPaletteTab('workflows')" id="tabWorkflows" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
                    üìã Workflows
                </button>
                <button onclick="showPaletteTab('history')" id="tabHistory" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
                    üìú History
                </button>
            </div>

            <!-- Nodes Palette -->
            <div id="paletteNodes" class="flex-1 overflow-y-auto p-4 space-y-3">
                <p class="text-xs text-gray-500 mb-3">Drag nodes to the canvas to build your workflow</p>
                
                <!-- Trigger Nodes -->
                <div class="mb-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Triggers</h3>
                    <div class="space-y-2">
                        <div class="node-palette-item p-3 bg-orange-50 border border-orange-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'schedule')"
                             data-type="schedule">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">‚è∞</span>
                                <div>
                                    <p class="font-medium text-sm text-orange-800">Schedule</p>
                                    <p class="text-xs text-orange-600">Cron-based trigger</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-blue-50 border border-blue-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'webhook')"
                             data-type="webhook">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üåê</span>
                                <div>
                                    <p class="font-medium text-sm text-blue-800">Webhook</p>
                                    <p class="text-xs text-blue-600">HTTP trigger</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-purple-50 border border-purple-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'manual')"
                             data-type="manual">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üëÜ</span>
                                <div>
                                    <p class="font-medium text-sm text-purple-800">Manual</p>
                                    <p class="text-xs text-purple-600">Click to trigger</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI/Orchestrator Nodes -->
                <div class="mb-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">AI / Personas</h3>
                    <div class="space-y-2">
                        <div class="node-palette-item p-3 bg-indigo-50 border border-indigo-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'emma-finance')"
                             data-type="emma-finance">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üìä</span>
                                <div>
                                    <p class="font-medium text-sm text-indigo-800">Emma Finance</p>
                                    <p class="text-xs text-indigo-600">Stock analysis</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-red-50 border border-red-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'emma-critic')"
                             data-type="emma-critic">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">‚öñÔ∏è</span>
                                <div>
                                    <p class="font-medium text-sm text-red-800">Emma Critic</p>
                                    <p class="text-xs text-red-600">Risk analysis</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-teal-50 border border-teal-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'emma-researcher')"
                             data-type="emma-researcher">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üî¨</span>
                                <div>
                                    <p class="font-medium text-sm text-teal-800">Emma Researcher</p>
                                    <p class="text-xs text-teal-600">Deep research</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-amber-50 border border-amber-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'emma-writer')"
                             data-type="emma-writer">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">‚úçÔ∏è</span>
                                <div>
                                    <p class="font-medium text-sm text-amber-800">Emma Writer</p>
                                    <p class="text-xs text-amber-600">Briefings & reports</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-cyan-50 border border-cyan-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'emma-geek')"
                             data-type="emma-geek">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üìà</span>
                                <div>
                                    <p class="font-medium text-sm text-cyan-800">Emma Geek</p>
                                    <p class="text-xs text-cyan-600">Technical analysis</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Nodes -->
                <div class="mb-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Data Sources</h3>
                    <div class="space-y-2">
                        <div class="node-palette-item p-3 bg-green-50 border border-green-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'fmp-api')"
                             data-type="fmp-api">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üíπ</span>
                                <div>
                                    <p class="font-medium text-sm text-green-800">FMP API</p>
                                    <p class="text-xs text-green-600">Market data</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-blue-50 border border-blue-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'news-api')"
                             data-type="news-api">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üì∞</span>
                                <div>
                                    <p class="font-medium text-sm text-blue-800">News API</p>
                                    <p class="text-xs text-blue-600">Financial news</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-purple-50 border border-purple-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'supabase')"
                             data-type="supabase">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üóÑÔ∏è</span>
                                <div>
                                    <p class="font-medium text-sm text-purple-800">Supabase</p>
                                    <p class="text-xs text-purple-600">Database</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Nodes -->
                <div class="mb-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Actions</h3>
                    <div class="space-y-2">
                        <div class="node-palette-item p-3 bg-pink-50 border border-pink-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'send-email')"
                             data-type="send-email">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üìß</span>
                                <div>
                                    <p class="font-medium text-sm text-pink-800">Send Email</p>
                                    <p class="text-xs text-pink-600">Via Resend</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-green-50 border border-green-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'send-sms')"
                             data-type="send-sms">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üì±</span>
                                <div>
                                    <p class="font-medium text-sm text-green-800">Send SMS</p>
                                    <p class="text-xs text-green-600">Via Twilio</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-yellow-50 border border-yellow-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'condition')"
                             data-type="condition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üîÄ</span>
                                <div>
                                    <p class="font-medium text-sm text-yellow-800">Condition</p>
                                    <p class="text-xs text-yellow-600">If/Then branch</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-palette-item p-3 bg-gray-50 border border-gray-200 rounded-lg" 
                             draggable="true" 
                             ondragstart="dragNode(event, 'transform')"
                             data-type="transform">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üîß</span>
                                <div>
                                    <p class="font-medium text-sm text-gray-800">Transform</p>
                                    <p class="text-xs text-gray-600">Data processing</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Workflows List -->
            <div id="paletteWorkflows" class="flex-1 overflow-y-auto p-4 hidden">
                <div id="workflowsList" class="space-y-2">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Execution History -->
            <div id="paletteHistory" class="flex-1 overflow-y-auto p-4 hidden">
                <div id="historyList" class="execution-timeline">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="flex-1 flex flex-col">
            <!-- Workflow Info Bar -->
            <div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <input type="text" id="workflowName" value="New Workflow" class="text-lg font-semibold bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded px-2">
                    <span id="workflowStatus" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">Draft</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <span id="nodeCount">0 nodes</span>
                    <span>‚Ä¢</span>
                    <span id="lastSaved">Not saved</span>
                </div>
            </div>

            <!-- Canvas -->
            <div class="flex-1 overflow-auto relative">
                <div id="workflowCanvas" 
                     class="workflow-canvas w-full h-full"
                     ondrop="dropNode(event)"
                     ondragover="allowDrop(event)">
                    <!-- SVG for connections -->
                    <svg id="connectionsSVG" class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 1;"></svg>
                    
                    <!-- Nodes will be placed here -->
                    <div id="nodesContainer" style="z-index: 2; position: relative;">
                        <!-- Initial placeholder -->
                        <div id="canvasPlaceholder" class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                                          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                                </svg>
                                <p class="text-lg font-medium">Drag nodes here to build your workflow</p>
                                <p class="text-sm mt-1">Connect nodes to create automation pipelines</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Node Properties -->
        <div id="propertiesPanel" class="w-96 bg-white border-l border-gray-200 flex flex-col hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                    <span id="selectedNodeIcon">‚öôÔ∏è</span>
                    <span id="selectedNodeTitle">Node Properties</span>
                </h3>
            </div>
            <div id="propertiesContent" class="flex-1 overflow-y-auto p-4">
                <!-- Dynamic properties form -->
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                <button onclick="deleteSelectedNode()" class="text-red-600 hover:text-red-800 text-sm font-medium">
                    üóëÔ∏è Delete Node
                </button>
                <button onclick="duplicateSelectedNode()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    üìã Duplicate
                </button>
            </div>
        </div>
    </div>

    <!-- Execution Console (Bottom) -->
    <div id="executionConsole" class="h-48 bg-gray-900 text-gray-100 border-t border-gray-700 hidden">
        <div class="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
            <h3 class="text-sm font-medium flex items-center gap-2">
                <span>üñ•Ô∏è</span> Execution Console
            </h3>
            <div class="flex items-center gap-2">
                <button onclick="clearConsole()" class="text-xs text-gray-400 hover:text-white">Clear</button>
                <button onclick="toggleConsole()" class="text-gray-400 hover:text-white">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="consoleOutput" class="p-4 font-mono text-xs overflow-y-auto h-36">
            <div class="text-gray-500">// Workflow execution logs will appear here</div>
        </div>
    </div>

    <script>
        // =========================================================
        // WORKFLOW BUILDER STATE
        // =========================================================
        const state = {
            nodes: new Map(),
            connections: [],
            selectedNode: null,
            nextNodeId: 1,
            isDragging: false,
            dragOffset: { x: 0, y: 0 },
            workflowId: null,
            workflowName: 'New Workflow'
        };

        // Node type configurations
        const nodeTypes = {
            // Triggers
            'schedule': { color: 'orange', icon: '‚è∞', title: 'Schedule', category: 'trigger' },
            'webhook': { color: 'blue', icon: 'üåê', title: 'Webhook', category: 'trigger' },
            'manual': { color: 'purple', icon: 'üëÜ', title: 'Manual Trigger', category: 'trigger' },
            
            // AI Personas
            'emma-finance': { color: 'indigo', icon: 'üìä', title: 'Emma Finance', category: 'ai' },
            'emma-critic': { color: 'red', icon: '‚öñÔ∏è', title: 'Emma Critic', category: 'ai' },
            'emma-researcher': { color: 'teal', icon: 'üî¨', title: 'Emma Researcher', category: 'ai' },
            'emma-writer': { color: 'amber', icon: '‚úçÔ∏è', title: 'Emma Writer', category: 'ai' },
            'emma-geek': { color: 'cyan', icon: 'üìà', title: 'Emma Geek', category: 'ai' },
            
            // Data Sources
            'fmp-api': { color: 'green', icon: 'üíπ', title: 'FMP API', category: 'data' },
            'news-api': { color: 'blue', icon: 'üì∞', title: 'News API', category: 'data' },
            'supabase': { color: 'purple', icon: 'üóÑÔ∏è', title: 'Supabase', category: 'data' },
            
            // Actions
            'send-email': { color: 'pink', icon: 'üìß', title: 'Send Email', category: 'action' },
            'send-sms': { color: 'green', icon: 'üì±', title: 'Send SMS', category: 'action' },
            'condition': { color: 'yellow', icon: 'üîÄ', title: 'Condition', category: 'logic' },
            'transform': { color: 'gray', icon: 'üîß', title: 'Transform', category: 'logic' }
        };

        // Color mappings for Tailwind
        const colorClasses = {
            'orange': { bg: 'bg-orange-500', light: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-800' },
            'blue': { bg: 'bg-blue-500', light: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800' },
            'purple': { bg: 'bg-purple-500', light: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-800' },
            'indigo': { bg: 'bg-indigo-500', light: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-800' },
            'red': { bg: 'bg-red-500', light: 'bg-red-50', border: 'border-red-200', text: 'text-red-800' },
            'teal': { bg: 'bg-teal-500', light: 'bg-teal-50', border: 'border-teal-200', text: 'text-teal-800' },
            'amber': { bg: 'bg-amber-500', light: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800' },
            'cyan': { bg: 'bg-cyan-500', light: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-800' },
            'green': { bg: 'bg-green-500', light: 'bg-green-50', border: 'border-green-200', text: 'text-green-800' },
            'pink': { bg: 'bg-pink-500', light: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-800' },
            'yellow': { bg: 'bg-yellow-500', light: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800' },
            'gray': { bg: 'bg-gray-500', light: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-800' }
        };

        // =========================================================
        // DRAG AND DROP
        // =========================================================
        function dragNode(event, type) {
            event.dataTransfer.setData('nodeType', type);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropNode(event) {
            event.preventDefault();
            const type = event.dataTransfer.getData('nodeType');
            if (!type) return;
            
            const canvas = document.getElementById('workflowCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left - 120; // Center the node
            const y = event.clientY - rect.top - 40;
            
            createNode(type, x, y);
            hidePlaceholder();
        }

        // =========================================================
        // NODE CREATION
        // =========================================================
        function createNode(type, x, y, id = null, data = {}) {
            const nodeId = id || `node_${state.nextNodeId++}`;
            const config = nodeTypes[type];
            if (!config) return null;
            
            const colors = colorClasses[config.color];
            
            const nodeEl = document.createElement('div');
            nodeEl.id = nodeId;
            nodeEl.className = `workflow-node ${colors.light} ${colors.border} border-2`;
            nodeEl.style.left = `${x}px`;
            nodeEl.style.top = `${y}px`;
            nodeEl.setAttribute('data-type', type);
            
            nodeEl.innerHTML = `
                <div class="${colors.bg} text-white px-3 py-2 rounded-t-lg flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${config.icon}</span>
                        <span class="font-medium text-sm">${config.title}</span>
                    </div>
                    <span class="status-indicator w-2 h-2 rounded-full status-idle"></span>
                </div>
                <div class="p-3">
                    <input type="text" 
                           class="w-full text-xs px-2 py-1 border rounded bg-white" 
                           placeholder="Enter message or configuration..."
                           value="${data.message || ''}"
                           onchange="updateNodeData('${nodeId}', 'message', this.value)">
                </div>
                ${config.category !== 'trigger' ? '<div class="node-connector input" data-connector="input"></div>' : ''}
                <div class="node-connector output" data-connector="output"></div>
            `;
            
            // Make draggable
            nodeEl.addEventListener('mousedown', (e) => startDragNode(e, nodeId));
            nodeEl.addEventListener('click', (e) => selectNode(nodeId, e));
            
            // Add connectors listeners
            const connectors = nodeEl.querySelectorAll('.node-connector');
            connectors.forEach(conn => {
                conn.addEventListener('mousedown', (e) => startConnection(e, nodeId, conn.dataset.connector));
            });
            
            document.getElementById('nodesContainer').appendChild(nodeEl);
            
            // Store node data
            state.nodes.set(nodeId, {
                id: nodeId,
                type,
                x,
                y,
                config,
                data: { message: '', ...data }
            });
            
            updateNodeCount();
            return nodeId;
        }

        function startDragNode(e, nodeId) {
            if (e.target.classList.contains('node-connector')) return;
            
            e.stopPropagation();
            state.isDragging = true;
            state.selectedNode = nodeId;
            
            const nodeEl = document.getElementById(nodeId);
            const rect = nodeEl.getBoundingClientRect();
            state.dragOffset.x = e.clientX - rect.left;
            state.dragOffset.y = e.clientY - rect.top;
            
            nodeEl.classList.add('selected');
            
            document.addEventListener('mousemove', dragNodeMove);
            document.addEventListener('mouseup', stopDragNode);
        }

        function dragNodeMove(e) {
            if (!state.isDragging || !state.selectedNode) return;
            
            const canvas = document.getElementById('workflowCanvas');
            const rect = canvas.getBoundingClientRect();
            const nodeEl = document.getElementById(state.selectedNode);
            
            const x = e.clientX - rect.left - state.dragOffset.x;
            const y = e.clientY - rect.top - state.dragOffset.y;
            
            nodeEl.style.left = `${Math.max(0, x)}px`;
            nodeEl.style.top = `${Math.max(0, y)}px`;
            
            // Update stored position
            const nodeData = state.nodes.get(state.selectedNode);
            if (nodeData) {
                nodeData.x = x;
                nodeData.y = y;
            }
            
            updateConnections();
        }

        function stopDragNode() {
            state.isDragging = false;
            document.removeEventListener('mousemove', dragNodeMove);
            document.removeEventListener('mouseup', stopDragNode);
        }

        // =========================================================
        // NODE SELECTION & PROPERTIES
        // =========================================================
        function selectNode(nodeId, event) {
            if (state.isDragging) return;
            event?.stopPropagation();
            
            // Deselect previous
            document.querySelectorAll('.workflow-node').forEach(n => n.classList.remove('selected'));
            
            const nodeEl = document.getElementById(nodeId);
            nodeEl.classList.add('selected');
            state.selectedNode = nodeId;
            
            showPropertiesPanel(nodeId);
        }

        function showPropertiesPanel(nodeId) {
            const panel = document.getElementById('propertiesPanel');
            const nodeData = state.nodes.get(nodeId);
            if (!nodeData) return;
            
            document.getElementById('selectedNodeIcon').textContent = nodeData.config.icon;
            document.getElementById('selectedNodeTitle').textContent = nodeData.config.title;
            
            const content = document.getElementById('propertiesContent');
            content.innerHTML = generatePropertiesForm(nodeData);
            
            panel.classList.remove('hidden');
        }

        function generatePropertiesForm(nodeData) {
            const { type, data, config } = nodeData;
            
            let html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Node ID</label>
                        <input type="text" value="${nodeData.id}" readonly class="w-full px-3 py-2 bg-gray-100 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <input type="text" value="${config.title}" readonly class="w-full px-3 py-2 bg-gray-100 border rounded text-sm">
                    </div>
            `;
            
            // Type-specific fields
            if (type === 'schedule') {
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cron Expression</label>
                        <input type="text" id="prop_cron" value="${data.cron || '0 6 * * 1-5'}" 
                               onchange="updateNodeData('${nodeData.id}', 'cron', this.value)"
                               class="w-full px-3 py-2 border rounded text-sm font-mono">
                        <p class="text-xs text-gray-500 mt-1">Example: 0 6 * * 1-5 (6 AM Mon-Fri)</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <p class="text-xs text-blue-800">
                            <strong>Quick presets:</strong><br>
                            Every hour: 0 * * * *<br>
                            Daily 6 AM: 0 6 * * *<br>
                            Mon-Fri 9 AM: 0 9 * * 1-5
                        </p>
                    </div>
                `;
            }
            
            if (type.startsWith('emma-')) {
                const persona = type.replace('emma-', '');
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prompt Message</label>
                        <textarea id="prop_message" rows="4" 
                                  onchange="updateNodeData('${nodeData.id}', 'message', this.value)"
                                  class="w-full px-3 py-2 border rounded text-sm"
                                  placeholder="Enter the message to send to Emma...">${data.message || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tickers (comma-separated)</label>
                        <input type="text" id="prop_tickers" value="${data.tickers || ''}"
                               onchange="updateNodeData('${nodeData.id}', 'tickers', this.value)"
                               class="w-full px-3 py-2 border rounded text-sm"
                               placeholder="AAPL, MSFT, GOOGL">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="prop_realtime" 
                               ${data.realtime ? 'checked' : ''}
                               onchange="updateNodeData('${nodeData.id}', 'realtime', this.checked)"
                               class="rounded text-indigo-600">
                        <label for="prop_realtime" class="text-sm text-gray-700">Require real-time data</label>
                    </div>
                `;
            }
            
            if (type === 'send-email') {
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Recipient Email</label>
                        <input type="email" id="prop_email" value="${data.email || ''}"
                               onchange="updateNodeData('${nodeData.id}', 'email', this.value)"
                               class="w-full px-3 py-2 border rounded text-sm"
                               placeholder="recipient@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                        <input type="text" id="prop_subject" value="${data.subject || ''}"
                               onchange="updateNodeData('${nodeData.id}', 'subject', this.value)"
                               class="w-full px-3 py-2 border rounded text-sm"
                               placeholder="Email subject">
                    </div>
                `;
            }
            
            if (type === 'send-sms') {
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="prop_phone" value="${data.phone || ''}"
                               onchange="updateNodeData('${nodeData.id}', 'phone', this.value)"
                               class="w-full px-3 py-2 border rounded text-sm"
                               placeholder="+1234567890">
                    </div>
                `;
            }
            
            if (type === 'condition') {
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                        <textarea id="prop_condition" rows="2"
                                  onchange="updateNodeData('${nodeData.id}', 'condition', this.value)"
                                  class="w-full px-3 py-2 border rounded text-sm font-mono"
                                  placeholder="data.value > 100">${data.condition || ''}</textarea>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function updateNodeData(nodeId, key, value) {
            const nodeData = state.nodes.get(nodeId);
            if (nodeData) {
                nodeData.data[key] = value;
            }
        }

        function deleteSelectedNode() {
            if (!state.selectedNode) return;
            
            const nodeEl = document.getElementById(state.selectedNode);
            if (nodeEl) nodeEl.remove();
            
            state.nodes.delete(state.selectedNode);
            state.connections = state.connections.filter(
                c => c.from !== state.selectedNode && c.to !== state.selectedNode
            );
            
            document.getElementById('propertiesPanel').classList.add('hidden');
            state.selectedNode = null;
            
            updateNodeCount();
            updateConnections();
        }

        function duplicateSelectedNode() {
            if (!state.selectedNode) return;
            
            const nodeData = state.nodes.get(state.selectedNode);
            if (nodeData) {
                createNode(nodeData.type, nodeData.x + 30, nodeData.y + 30, null, { ...nodeData.data });
            }
        }

        // =========================================================
        // CONNECTIONS
        // =========================================================
        function startConnection(e, nodeId, connectorType) {
            e.stopPropagation();
            // Simplified connection logic - in full version would be drag to connect
            console.log('Start connection from', nodeId, connectorType);
        }

        function updateConnections() {
            const svg = document.getElementById('connectionsSVG');
            svg.innerHTML = '';
            
            state.connections.forEach(conn => {
                const fromNode = document.getElementById(conn.from);
                const toNode = document.getElementById(conn.to);
                
                if (fromNode && toNode) {
                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();
                    const canvasRect = document.getElementById('workflowCanvas').getBoundingClientRect();
                    
                    const x1 = fromRect.right - canvasRect.left;
                    const y1 = fromRect.top + fromRect.height / 2 - canvasRect.top;
                    const x2 = toRect.left - canvasRect.left;
                    const y2 = toRect.top + toRect.height / 2 - canvasRect.top;
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const midX = (x1 + x2) / 2;
                    path.setAttribute('d', `M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}`);
                    path.classList.add('connection-line');
                    svg.appendChild(path);
                }
            });
        }

        // =========================================================
        // WORKFLOW EXECUTION
        // =========================================================
        async function runWorkflow() {
            if (state.nodes.size === 0) {
                alert('Add some nodes to the workflow first!');
                return;
            }
            
            showConsole();
            logToConsole('üöÄ Starting workflow execution...', 'info');
            
            // Find trigger nodes
            const triggerNodes = Array.from(state.nodes.values()).filter(
                n => nodeTypes[n.type].category === 'trigger'
            );
            
            if (triggerNodes.length === 0) {
                logToConsole('‚ö†Ô∏è No trigger node found. Add a trigger to start the workflow.', 'warn');
                return;
            }
            
            // Execute nodes in sequence (simplified)
            for (const [nodeId, nodeData] of state.nodes) {
                await executeNode(nodeId, nodeData);
            }
            
            logToConsole('‚úÖ Workflow execution complete!', 'success');
            
            // Add to history
            addToHistory({
                timestamp: new Date(),
                status: 'success',
                duration: 1234,
                nodes: state.nodes.size
            });
        }

        async function executeNode(nodeId, nodeData) {
            const nodeEl = document.getElementById(nodeId);
            const statusEl = nodeEl.querySelector('.status-indicator');
            
            // Set running status
            statusEl.classList.remove('status-idle', 'status-success', 'status-error');
            statusEl.classList.add('status-running');
            nodeEl.classList.add('running');
            
            logToConsole(`‚è≥ Executing: ${nodeData.config.title}`, 'info');
            
            try {
                // Simulate execution
                await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
                
                // For AI nodes, call the orchestrator
                if (nodeData.type.startsWith('emma-')) {
                    const persona = nodeData.type.replace('emma-', '');
                    logToConsole(`  üì° Calling orchestrator with persona: ${persona}`, 'info');
                    
                    // In real implementation:
                    // const result = await fetch('/api/orchestrator', {
                    //     method: 'POST',
                    //     body: JSON.stringify({ message: nodeData.data.message, persona })
                    // });
                    
                    logToConsole(`  ‚úì ${nodeData.config.title}: Response received`, 'success');
                }
                
                statusEl.classList.remove('status-running');
                statusEl.classList.add('status-success');
                nodeEl.classList.remove('running');
                
            } catch (error) {
                statusEl.classList.remove('status-running');
                statusEl.classList.add('status-error');
                nodeEl.classList.remove('running');
                logToConsole(`  ‚úó ${nodeData.config.title}: ${error.message}`, 'error');
            }
        }

        // =========================================================
        // UI HELPERS
        // =========================================================
        function showPaletteTab(tab) {
            document.querySelectorAll('[id^="palette"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab"]').forEach(el => {
                el.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
                el.classList.add('text-gray-500');
            });
            
            document.getElementById(`palette${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
            const tabEl = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            tabEl.classList.remove('text-gray-500');
            tabEl.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
        }

        function hidePlaceholder() {
            const placeholder = document.getElementById('canvasPlaceholder');
            if (placeholder) placeholder.style.display = 'none';
        }

        function updateNodeCount() {
            document.getElementById('nodeCount').textContent = `${state.nodes.size} nodes`;
        }

        function showConsole() {
            document.getElementById('executionConsole').classList.remove('hidden');
        }

        function toggleConsole() {
            document.getElementById('executionConsole').classList.toggle('hidden');
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = 
                '<div class="text-gray-500">// Console cleared</div>';
        }

        function logToConsole(message, type = 'info') {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                warn: 'text-yellow-400',
                error: 'text-red-400'
            };
            
            console.innerHTML += `
                <div class="${colors[type] || 'text-gray-300'}">
                    <span class="text-gray-500">[${timestamp}]</span> ${message}
                </div>
            `;
            console.scrollTop = console.scrollHeight;
        }

        function addToHistory(execution) {
            const historyList = document.getElementById('historyList');
            const statusClass = execution.status === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            historyList.innerHTML = `
                <div class="timeline-item">
                    <div class="timeline-dot ${statusClass}"></div>
                    <div class="bg-white rounded-lg p-3 shadow-sm border">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-sm">Workflow Run</span>
                            <span class="text-xs text-gray-500">${execution.timestamp.toLocaleTimeString()}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${execution.nodes} nodes ‚Ä¢ ${execution.duration}ms
                        </div>
                    </div>
                </div>
            ` + historyList.innerHTML;
        }

        // =========================================================
        // SAVE/LOAD WORKFLOWS
        // =========================================================
        async function saveWorkflow() {
            const workflowData = {
                id: state.workflowId || `wf_${Date.now()}`,
                name: document.getElementById('workflowName').value,
                nodes: Array.from(state.nodes.values()),
                connections: state.connections,
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage for now (would be Supabase in production)
            const workflows = JSON.parse(localStorage.getItem('workflows') || '[]');
            const existingIndex = workflows.findIndex(w => w.id === workflowData.id);
            
            if (existingIndex >= 0) {
                workflows[existingIndex] = workflowData;
            } else {
                workflows.push(workflowData);
            }
            
            localStorage.setItem('workflows', JSON.stringify(workflows));
            state.workflowId = workflowData.id;
            
            document.getElementById('lastSaved').textContent = `Saved ${new Date().toLocaleTimeString()}`;
            document.getElementById('workflowStatus').textContent = 'Saved';
            document.getElementById('workflowStatus').className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
            
            loadWorkflowsList();
            logToConsole(`üíæ Workflow saved: ${workflowData.name}`, 'success');
        }

        function loadWorkflowsList() {
            const workflows = JSON.parse(localStorage.getItem('workflows') || '[]');
            const list = document.getElementById('workflowsList');
            
            if (workflows.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No saved workflows</p>';
                return;
            }
            
            list.innerHTML = workflows.map(w => `
                <div class="p-3 bg-gray-50 rounded-lg border hover:bg-gray-100 cursor-pointer transition"
                     onclick="loadWorkflow('${w.id}')">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">${w.name}</span>
                        <span class="text-xs text-gray-500">${w.nodes.length} nodes</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        ${new Date(w.createdAt).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function loadWorkflow(workflowId) {
            const workflows = JSON.parse(localStorage.getItem('workflows') || '[]');
            const workflow = workflows.find(w => w.id === workflowId);
            
            if (!workflow) return;
            
            // Clear canvas
            document.getElementById('nodesContainer').innerHTML = '';
            state.nodes.clear();
            state.connections = [];
            state.nextNodeId = 1;
            
            // Load nodes
            workflow.nodes.forEach(node => {
                createNode(node.type, node.x, node.y, node.id, node.data);
            });
            
            state.connections = workflow.connections || [];
            state.workflowId = workflow.id;
            
            document.getElementById('workflowName').value = workflow.name;
            hidePlaceholder();
            updateConnections();
            
            logToConsole(`üìÇ Loaded workflow: ${workflow.name}`, 'info');
        }

        // =========================================================
        // INITIALIZATION
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkflowsList();
            
            // Click outside to deselect
            document.getElementById('workflowCanvas').addEventListener('click', (e) => {
                if (e.target.id === 'workflowCanvas' || e.target.id === 'nodesContainer') {
                    document.querySelectorAll('.workflow-node').forEach(n => n.classList.remove('selected'));
                    document.getElementById('propertiesPanel').classList.add('hidden');
                    state.selectedNode = null;
                }
            });
            
            console.log('üîÑ Workflow Builder initialized');
        });
    </script>
</body>
</html>
