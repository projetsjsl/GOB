<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma - D√©monstration</title>
    <link rel="stylesheet" href="emma-styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .demo-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .demo-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .demo-header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .demo-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .demo-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .demo-feature {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .demo-feature h3 {
            color: #1e293b;
            margin-bottom: 10px;
        }
        .demo-feature p {
            color: #64748b;
            line-height: 1.5;
        }
        .demo-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .demo-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .demo-btn-primary {
            background: #6366f1;
            color: white;
        }
        .demo-btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        .demo-btn-secondary {
            background: white;
            color: #6366f1;
            border: 2px solid #6366f1;
        }
        .demo-btn-secondary:hover {
            background: #6366f1;
            color: white;
            transform: translateY(-2px);
        }
        .demo-emma-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: 600px;
        }
        .demo-footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>ü§ñ Emma</h1>
            <p>Assistante Virtuelle en Analyse Financi√®re</p>
        </div>

        <div class="demo-features">
            <div class="demo-feature">
                <h3>üí¨ Chat Intelligent</h3>
                <p>Conversations naturelles avec l'IA Gemini pour des analyses financi√®res pr√©cises et personnalis√©es.</p>
            </div>
            <div class="demo-feature">
                <h3>‚öôÔ∏è Personnalisation</h3>
                <p>√âditez le prompt d'Emma pour adapter ses r√©ponses √† vos besoins sp√©cifiques et votre style.</p>
            </div>
            <div class="demo-feature">
                <h3>üé® Interface Moderne</h3>
                <p>Design √©l√©gant et responsive inspir√© des meilleures pratiques UX/UI pour une exp√©rience optimale.</p>
            </div>
            <div class="demo-feature">
                <h3>üîí S√©curis√©</h3>
                <p>Vos donn√©es restent priv√©es. La cl√© API est stock√©e localement et les conversations sont s√©curis√©es.</p>
            </div>
        </div>

        <div class="demo-actions">
            <button class="demo-btn demo-btn-primary" onclick="startDemo()">
                üöÄ D√©marrer la D√©monstration
            </button>
            <a href="emma-test.html" class="demo-btn demo-btn-secondary">
                üß™ Page de Test
            </a>
            <a href="beta-combined-dashboard.html" class="demo-btn demo-btn-secondary">
                üìä Dashboard Complet
            </a>
        </div>

        <div id="demo-emma-container" class="demo-emma-container" style="display: none;">
            <!-- L'interface Emma sera inject√©e ici -->
        </div>

        <div class="demo-footer">
            <p>Emma - Propuls√© par Google Gemini AI ‚Ä¢ D√©velopp√© pour GOB Apps</p>
        </div>
    </div>

    <script type="module">
        // Import des modules Emma
        import { EmmaChatInterface, EmmaPromptEditor, EmmaGeminiConfig } from './emma-ui-components.js';
        import { emmaGeminiService } from './emma-gemini-service.js';
        import { getFinancialProfile, updateFinancialPrompt, loadFinancialPrompt, resetFinancialPrompt } from './emma-financial-profile.js';

        // Variables globales
        window.demoMode = true;
        window.demoMessages = [
            "Bonjour Emma ! Peux-tu m'expliquer l'analyse financi√®re ?",
            "Quels sont les indicateurs cl√©s √† surveiller ?",
            "Comment interpr√©ter les ratios financiers ?",
            "Peux-tu m'aider avec l'√©valuation d'entreprise ?"
        ];
        window.currentDemoMessage = 0;

        // D√©marrer la d√©monstration
        window.startDemo = function() {
            const container = document.getElementById('demo-emma-container');
            container.style.display = 'block';
            container.innerHTML = EmmaChatInterface();
            
            // Attacher les √©v√©nements de d√©monstration
            attachDemoEvents();
            
            // D√©marrer la d√©monstration automatique
            startAutomaticDemo();
        };

        // Attacher les √©v√©nements de d√©monstration
        function attachDemoEvents() {
            const sendButton = document.getElementById('emma-send-input');
            const inputField = document.querySelector('.emma-input');
            
            if (sendButton && inputField) {
                sendButton.addEventListener('click', () => {
                    const message = inputField.value.trim();
                    if (message) {
                        sendDemoMessage(message);
                    }
                });
                
                inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const message = inputField.value.trim();
                        if (message) {
                            sendDemoMessage(message);
                        }
                    }
                });
            }

            // Bouton d'exemple
            const exampleButton = document.querySelector('.emma-send-button');
            if (exampleButton) {
                exampleButton.addEventListener('click', () => {
                    const randomMessage = window.demoMessages[Math.floor(Math.random() * window.demoMessages.length)];
                    inputField.value = randomMessage;
                });
            }
        }

        // Envoyer un message de d√©monstration
        async function sendDemoMessage(message) {
            const inputField = document.querySelector('.emma-input');
            if (inputField) {
                inputField.value = '';
            }

            // Ajouter le message utilisateur
            addDemoMessage('user', message);

            // Simuler la r√©ponse d'Emma
            setTimeout(() => {
                const response = generateDemoResponse(message);
                addDemoMessage('emma', response);
            }, 1500);
        }

        // Ajouter un message de d√©monstration
        function addDemoMessage(type, content) {
            const messagesContainer = document.querySelector('.emma-messages-container');
            if (!messagesContainer) return;

            const messageId = Date.now();
            const message = {
                id: messageId,
                type: type,
                content: content,
                timestamp: new Date().toLocaleTimeString('fr-FR')
            };

            // Cr√©er l'√©l√©ment HTML du message
            const messageElement = createDemoMessageElement(message);
            
            // Ajouter le message au conteneur
            messagesContainer.appendChild(messageElement);
            
            // Faire d√©filer vers le bas
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Cr√©er l'√©l√©ment HTML d'un message de d√©monstration
        function createDemoMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `emma-message ${message.type}`;
            messageDiv.id = `message-${message.id}`;

            if (message.type === 'user') {
                messageDiv.innerHTML = `
                    <div class="emma-message-content">
                        ${escapeHtml(message.content)}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="emma-message-avatar">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2MzY2RjEiLz4KPHBhdGggZD0iTTEwIDEwSDIyVjIySDEwVjEwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTEyIDEySDIwVjIwSDEyVjEyWiIgZmlsbD0iIzYzNjZGMTIiLz4KPC9zdmc+" alt="Emma" />
                    </div>
                    <div class="emma-message-content">
                        ${formatMessageContent(message.content)}
                    </div>
                `;
            }

            return messageDiv;
        }

        // Formater le contenu du message (rendu enrichi, fond inchang√©)
        function formatMessageContent(content) {
            const escapeH = (s) => {
                const div = document.createElement('div');
                div.textContent = s ?? '';
                return div.innerHTML;
            };

            // Prot√©ger les blocs de code
            const codeBlocks = [];
            let t = escapeH(content || '');
            t = t.replace(/```([\w-]*)\n([\s\S]*?)\n```/g, (_m, lang, code) => {
                const idx = codeBlocks.length;
                codeBlocks.push({ lang: (lang || '').trim(), code });
                return `@@CODE_BLOCK_${idx}@@`;
            });

            // Gras / italique basiques
            t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Code inline
            t = t.replace(/`([^`]+)`/g, '<code class="px-1 py-0.5 rounded bg-gray-800/10 text-[0.95em]">$1</code>');

            // Titres de section avec emoji
            t = t.replace(/^(üîç|üìå|üí°|‚ö†Ô∏è|‚úÖ|üîë|üìä|üí¨|üìà|üìâ|‚úâÔ∏è|üîó)\s*(?:\*\*(.+?)\*\*|([^\n]+))$/gm, (_m, emj, boldTitle, plainTitle) => {
                const title = boldTitle || plainTitle || '';
                return `<div class="mt-2 mb-1 font-semibold">${emj} ${title}</div>`;
            });

            // Titres Markdown
            t = t.replace(/^###\s+(.+)$/gm, '<div class="mt-2 mb-1 font-semibold">$1</div>');
            t = t.replace(/^##\s+(.+)$/gm, '<div class="mt-2 mb-1 font-semibold text-base">$1</div>');
            t = t.replace(/^#\s+(.+)$/gm, '<div class="mt-3 mb-1 font-bold text-lg">$1</div>');

            // Listes √† puces group√©es
            t = t.replace(/(?:^|\n)((?:[-‚Ä¢*]\s+.+(?:\n|$))+)/gm, (block) => {
                const items = block.trim().split(/\n/)
                    .filter(l => /^[-‚Ä¢*]\s+/.test(l))
                    .map(l => l.replace(/^[-‚Ä¢*]\s+/, ''))
                    .map(x => `<li>${x}</li>`)
                    .join('');
                return `\n<ul class="list-disc pl-5 space-y-1">${items}</ul>\n`;
            });

            // Listes num√©rot√©es group√©es
            t = t.replace(/(?:^|\n)((?:\d+\.\s+.+(?:\n|$))+)/gm, (block) => {
                const items = block.trim().split(/\n/)
                    .filter(l => /^\d+\.\s+/.test(l))
                    .map(l => l.replace(/^\d+\.\s+/, ''))
                    .map(x => `<li>${x}</li>`)
                    .join('');
                return `\n<ol class="list-decimal pl-5 space-y-1">${items}</ol>\n`;
            });

            // Citations et s√©parateurs
            t = t.replace(/^(>+)\s*(.+)$/gm, (_m, _arrows, quote) => `<blockquote class="border-l-4 pl-3 italic opacity-90">${quote}</blockquote>`);
            t = t.replace(/^\s*(?:---|___)\s*$/gm, '<hr class="my-3 opacity-50">');

            // Section Sources
            t = t.replace(/^\s*(?:üîó\s*)?Sources?\s*:\s*$/gim, '<div class="mt-2 mb-1 font-semibold">üîó Sources</div>');

            // Paragraphes et sauts de ligne
            t = t.replace(/\n\n/g, '</p><p class="mb-2">');
            t = t.replace(/\n/g, '<br>');

            // Linkification d'URLs
            t = t.replace(/((https?:\/\/|www\.)[\w.-]+(?:\/[\w\-._~:\/?#[\]@!$&'()*+,;=%]*)?)/g, (url) => {
                const href = url.startsWith('http') ? url : `http://${url}`;
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${url}</a>`;
            });

            // R√©insertion blocs de code
            t = t.replace(/@@CODE_BLOCK_(\d+)@@/g, (_m, idxStr) => {
                const idx = parseInt(idxStr, 10);
                const block = codeBlocks[idx];
                if (!block) return '';
                const langLabel = block.lang ? `<div class="text-xs opacity-70 mb-1">${block.lang}</div>` : '';
                const codeSafe = block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<div class="my-2"><div class="rounded-md border border-gray-200 bg-gray-50 p-3 overflow-auto">${langLabel}<pre class="m-0"><code>${codeSafe}</code></pre></div></div>`;
            });

            return `<div class="leading-relaxed text-sm">${t}</div>`;
        }

        // √âchapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // G√©n√©rer une r√©ponse de d√©monstration
        function generateDemoResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('bonjour') || lowerMessage.includes('salut')) {
                return `Bonjour ! Je suis Emma, votre assistante en analyse financi√®re. Je suis l√† pour vous aider avec vos questions sur l'analyse financi√®re, l'√©valuation d'entreprises, et l'interpr√©tation des donn√©es financi√®res.

Comment puis-je vous assister aujourd'hui ?`;
            }
            
            if (lowerMessage.includes('indicateur') || lowerMessage.includes('ratio')) {
                return `Les indicateurs financiers cl√©s √† surveiller incluent :

‚Ä¢ **Ratios de liquidit√©** : Mesurent la capacit√© √† honorer les dettes √† court terme
‚Ä¢ **Ratios de rentabilit√©** : ROI, ROE, marge nette
‚Ä¢ **Ratios d'endettement** : Dette/Equity, couverture des int√©r√™ts
‚Ä¢ **Ratios d'efficacit√©** : Rotation des stocks, d√©lais de recouvrement

Quel ratio vous int√©resse particuli√®rement ?`;
            }
            
            if (lowerMessage.includes('√©valuation') || lowerMessage.includes('valeur')) {
                return `L'√©valuation d'entreprise peut se faire par plusieurs m√©thodes :

‚Ä¢ **M√©thode des multiples** : P/E, EV/EBITDA, Price/Book
‚Ä¢ **DCF (Discounted Cash Flow)** : Actualisation des flux futurs
‚Ä¢ **Comparaison sectorielle** : Benchmark avec les pairs
‚Ä¢ **Valeur patrimoniale** : Actif net corrig√©

Quelle m√©thode souhaitez-vous explorer ?`;
            }
            
            if (lowerMessage.includes('analyse') || lowerMessage.includes('interpr√©ter')) {
                return `Pour une analyse financi√®re efficace :

1. **Analyse verticale** : Structure du bilan et compte de r√©sultat
2. **Analyse horizontale** : √âvolution dans le temps
3. **Analyse comparative** : Benchmark sectoriel
4. **Analyse des flux** : Tr√©sorerie et cash-flow

Voulez-vous que je d√©taille une de ces approches ?`;
            }
            
            return `C'est une excellente question ! En tant qu'assistante en analyse financi√®re, je peux vous aider avec :

‚Ä¢ L'interpr√©tation des √©tats financiers
‚Ä¢ Le calcul et l'analyse des ratios
‚Ä¢ L'√©valuation d'entreprises
‚Ä¢ L'analyse des tendances du march√©

Pouvez-vous √™tre plus sp√©cifique sur ce qui vous int√©resse ?`;
        }

        // D√©marrer la d√©monstration automatique
        function startAutomaticDemo() {
            setTimeout(() => {
                if (window.currentDemoMessage < window.demoMessages.length) {
                    const message = window.demoMessages[window.currentDemoMessage];
                    sendDemoMessage(message);
                    window.currentDemoMessage++;
                    
                    // Continuer la d√©monstration
                    setTimeout(startAutomaticDemo, 5000);
                }
            }, 2000);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé≠ Page de d√©monstration Emma charg√©e');
        });
    </script>
</body>
</html>
