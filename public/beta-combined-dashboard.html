<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOB Apps - Dashboard Financier Beta • Propulsé par JSL AI</title>
    <!-- Cache bust: 2024-10-08 23:12 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Recharts pour IntelliStocks -->
    <script src="https://unpkg.com/recharts@2.10.3/dist/Recharts.js"></script>
    <!-- Lucide React pour les icônes IntelliStocks -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <!-- Styles Emma -->
    <link rel="stylesheet" href="emma-styles.css">
    <style>
        * {
            font-family: 'Inter', 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }
        .pulse-animation {
            animation: pulse 3s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stock-card {
            transition: all 0.3s ease;
        }
        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        /* Réduction globale pour mobile: police et espacements à 50% */
        @media (max-width: 768px) {
            html { font-size: 50%; }
        }
        .seeking-alpha-card {
            background: linear-gradient(135deg, #1f1f1f 0%, #2d2d2d 100%);
        }
        .stocks-news-card {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* Scrollbar personnalisée */
        .scrollbar-thin {
            scrollbar-width: thin;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Dark mode scrollbar */
        .dark .scrollbar-thin::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        .dark .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        .dark .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-card {
            transition: all 0.3s ease;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        /* Effets visuels - ripple sur boutons */
        .btn-ripple { position: relative; overflow: hidden; }
        .ripple-circle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            background: rgba(59, 130, 246, 0.45); /* blue */
            transform: scale(0);
            animation: ripple 600ms ease-out;
        }
        @keyframes ripple {
            to { transform: scale(3); opacity: 0; }
        }
        /* Animation intro Emma */
        @keyframes emma-intro-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes emma-zoom-in {
            0% { transform: scale(0.85); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .emma-intro-overlay { animation: emma-intro-fade 300ms ease-out; }
        .emma-intro-image { animation: emma-zoom-in 800ms ease-out; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const BetaCombinedDashboard = () => {
            // États principaux
            const [activeTab, setActiveTab] = useState('stocks-news');
            const [tickers, setTickers] = useState(['GOOGL', 'T', 'BNS', 'TD', 'BCE', 'CNR', 'CSCO', 'CVS', 'DEO', 'MDT', 'JNJ', 'JPM', 'LVMHF', 'MG', 'MFC', 'MU', 'NSRGY', 'NKE', 'NTR', 'PFE', 'TRP', 'T', 'UNH', 'UL', 'VZ', 'WFC']);
            const [stockData, setStockData] = useState({});
            const [newsData, setNewsData] = useState([]);
            const [seekingAlphaData, setSeekingAlphaData] = useState({});
            const [seekingAlphaStockData, setSeekingAlphaStockData] = useState({});
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [selectedStock, setSelectedStock] = useState(null);
            const [newTicker, setNewTicker] = useState('');
            const [showTickerManager, setShowTickerManager] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [showAdmin, setShowAdmin] = useState(false);
            const [apiStatus, setApiStatus] = useState({});
            const [viewMode, setViewMode] = useState('cards');
            const [seekingAlphaViewMode, setSeekingAlphaViewMode] = useState('cards');
            const [newsFilter, setNewsFilter] = useState('all'); // Filtre pour les actualités
            const [filteredNews, setFilteredNews] = useState([]); // Actualités filtrées
            
            // États pour  l'interface Seeking Alpha
            const [githubToken, setGithubToken] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showScraperPopup, setShowScraperPopup] = useState(false);
            
            // États pour le scraping
            const [scrapingStatus, setScrapingStatus] = useState('idle'); // 'idle', 'running', 'completed', 'error'
            const [scrapingProgress, setScrapingProgress] = useState(0);
            const [scrapingLogs, setScrapingLogs] = useState([]);
            
            // État pour le thème (clair par défaut, respecte localStorage)
            const [isDarkMode, setIsDarkMode] = useState(() => {
                try {
                    const saved = localStorage.getItem('theme');
                    if (saved === 'dark') return true;
                    if (saved === 'light') return false;
                } catch (_) {}
                return false; // défaut: clair
            });
            const [showEmmaIntro, setShowEmmaIntro] = useState(false);
            const clickSoundRef = useRef(null);
            const tabSoundRef = useRef(null);
            const audioCtxRef = useRef(null);

            // Configuration API
            const API_BASE_URL = window.location.origin;
            
            // Configuration GitHub
            const GITHUB_REPO = 'projetsjsl/GOB';
            const GITHUB_BRANCH = 'main';
            
            // Fonction pour nettoyer l'encodage des caractères
            const cleanText = (text) => {
                if (!text) return '';
                return text
                    .replace(/Ã©/g, 'é')
                    .replace(/Ã¨/g, 'è')
                    .replace(/Ã /g, 'à')
                    .replace(/Ã§/g, 'ç')
                    .replace(/Ã´/g, 'ô')
                    .replace(/Ã¢/g, 'â')
                    .replace(/Ã®/g, 'î')
                    .replace(/Ã¯/g, 'ï')
                    .replace(/Ã¹/g, 'ù')
                    .replace(/Ã»/g, 'û')
                    .replace(/Ã«/g, 'ë')
                    .replace(/Ã¤/g, 'ä')
                    .replace(/Ã¶/g, 'ö')
                    .replace(/Ã¼/g, 'ü')
                    .replace(/â€™/g, "'")
                    .replace(/â€œ/g, '"')
                    .replace(/â€/g, '"')
                    .replace(/â€"/g, '–')
                    .replace(/â€"/g, '—');
            };

            // Fonction pour extraire le logo depuis les données de scraping
            const getCompanyLogo = (ticker) => {
                try {
                    // Chercher dans les  données de scraping
                    const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                    if (seekingAlphaItem?.raw_text) {
                        // Extraire le logo depuis le JSON dans raw_text
                        const logoMatch = seekingAlphaItem.raw_text.match(/"logo":"([^"]+)"/);
                        if (logoMatch && logoMatch[1]) {
                            return logoMatch[1];
                        }
                    }
                    
                    // Fallback vers des logos par défaut
                    const defaultLogos = {
                        // Tickers US
                        'GOOGL': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/GOOGL.svg',
                        'T': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/T.svg',
                        'CSCO': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/CSCO.svg',
                        'CVS': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/CVS.svg',
                        'DEO': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/DEO.svg',
                        'MDT': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/MDT.svg',
                        'JNJ': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/JNJ.svg',
                        'JPM': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/JPM.svg',
                        'LVMHF': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/LVMHF.svg',
                        'MU': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/MU.svg',
                        'NSRGY': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/NSRGY.svg',
                        'NKE': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/NKE.svg',
                        'PFE': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/PFE.svg',
                        'UNH': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/UNH.svg',
                        'UL': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/UL.svg',
                        'VZ': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/VZ.svg',
                        'WFC': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/WFC.svg',
                        
                        // Tickers TSX (Canada)
                        'BNS': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/BNS.svg',
                        'TD': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/TD.svg',
                        'BCE': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/BCE.svg',
                        'CNR': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/CNR.svg',
                        'MG': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/MG.svg',
                        'MFC': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/MFC.svg',
                        'NTR': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/NTR.svg',
                        'TRP': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/TRP.svg',
                        
                        // Autres tickers populaires
                        'AAPL': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/AAPL.svg',
                        'MSFT': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/MSFT.svg',
                        'AMZN': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/AMZN.svg',
                        'TSLA': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/TSLA.svg',
                        'NVDA': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/NVDA.svg',
                        'META': 'https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/META.svg'
                    };
                    
                    return defaultLogos[ticker] || `https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/${ticker}.svg`;
                } catch (error) {
                    console.error(`Erreur extraction logo pour ${ticker}:`, error?.message || String(error));
                    return `https://static.seekingalpha.com/cdn/s3/company_logos/mark_vector_light/${ticker}.svg`;
                }
            };

            // Messages
            const showMessage = (text, type = 'info') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 5000);
            };

            // Fonction pour basculer le thème
            const toggleTheme = () => {
                const next = !isDarkMode;
                setIsDarkMode(next);
                try { localStorage.setItem('theme', next ? 'dark' : 'light'); } catch(_) {}
            };

            // Données Market Data (Finnhub + Alpha Vantage + Yahoo Finance)
            const fetchStockData = async (ticker) => {
                try {
                    // Essayer d'abord la nouvelle API unifiée avec Yahoo Finance (gratuit)
                    const response = await fetch(`${API_BASE_URL}/api/marketdata?endpoint=quote&symbol=${ticker}&source=auto`);
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Erreur fetch stock data (marketdata):', error?.message || String(error));
                    // Rester sur marketdata; l’API gère déjà ses fallbacks internes
                    return null;
                }
            };

            const refreshAllStocks = async () => {
                console.log('🔄 Actualisation des données stocks...');
                setLoading(true);
                const newStockData = {};
                let successCount = 0;
                let errorCount = 0;
                
                for (const ticker of tickers) {
                    console.log(`📊 Récupération des données pour ${ticker}...`);
                    try {
                        const data = await fetchStockData(ticker);
                        // Charger les fondamentaux pour alimenter P/E/Dividende/Secteur
                        let fundamentals = null;
                        try {
                            const fundamentalsResp = await fetch(`${API_BASE_URL}/api/marketdata?endpoint=fundamentals&symbol=${ticker}&source=auto`);
                            if (fundamentalsResp.ok) fundamentals = await fundamentalsResp.json();
                        } catch (e) {
                            console.warn(`⚠️ Fundamentals non disponibles pour ${ticker}`, e?.message || e);
                        }
                        if (data && !data.message) {
                            newStockData[ticker] = {
                                ...data,
                                fundamentals,
                                timestamp: new Date().toISOString()
                            };
                            successCount++;
                            console.log(`✅ ${ticker}: Données récupérées`, data);
                        } else {
                            console.log(`⚠️ ${ticker}: Pas de données ou erreur API`, data);
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`❌ ${ticker}: Erreur`, error?.message || String(error));
                        errorCount++;
                    }
                }
                
                setStockData(newStockData);
                setLastUpdate(new Date());
                setLoading(false);
                
                const message = `Données mises à jour: ${successCount} succès, ${errorCount} erreurs`;
                console.log(message);
                showMessage(message, successCount > 0 ? 'success' : 'warning');
            };

            // Actualités NewsAPI.ai
            const fetchNews = async () => {
                console.log('📰 Récupération des actualités...');
                try {
                    const tickersQuery = tickers.join(' OR ');
                    console.log(`🔍 Recherche pour: ${tickersQuery}`);
                    
                    const response = await fetch(`${API_BASE_URL}/api/news?q=${encodeURIComponent(tickersQuery)}&limit=20&strict=true`);
                    console.log(`📡 Réponse API News: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`News API error: ${response.status}`);
                    
                    const data = await response.json();
                    console.log('📊 Données news reçues:', data);
                    
                    setNewsData(data.articles || []);
                    setFilteredNews(data.articles || []);
                    
                    if (data.source === 'demo') {
                        showMessage('Actualités de démonstration - Configurez NEWSAPI_KEY pour des actualités réelles', 'info');
                    } else {
                        showMessage(`${data.articles?.length || 0} actualités chargées`, 'success');
                    }
                } catch (error) {
                    console.error('❌ Erreur fetch news:', error?.message || String(error));
                    showMessage('Erreur chargement actualités', 'error');
                    
                    const fallbackNews = [
                        {
                            title: "Actualités financières non disponibles",
                            description: "Impossible de charger les actualités. Vérifiez la configuration de l'API NewsAPI.",
                            url: "#",
                            publishedAt: new Date().toISOString(),
                            source: { name: "Système" }
                        }
                    ];
                    setNewsData(fallbackNews);
                    setFilteredNews(fallbackNews);
                }
            };

            // Fonction pour filtrer les actualités
            const filterNews = (filterValue) => {
                setNewsFilter(filterValue);
                if (filterValue === 'all') {
                    setFilteredNews(newsData);
                } else {
                    const filtered = newsData.filter(article => {
                        const text = (article.title + ' ' + article.description).toLowerCase();
                        return text.includes(filterValue.toLowerCase());
                    });
                    setFilteredNews(filtered);
                }
            };

            // Fonction pour obtenir la couleur des grades Quant
            const getGradeColor = (grade) => {
                if (!grade) return 'bg-gray-100 text-gray-600';
                const letter = grade.charAt(0);
                if (letter === 'A') return 'bg-green-100 text-green-700';
                if (letter === 'B') return 'bg-gray-100 text-gray-700';
                if (letter === 'C') return 'bg-yellow-100 text-yellow-700';
                if (letter === 'D') return 'bg-orange-100 text-orange-700';
                if (letter === 'F') return 'bg-red-100 text-red-700';
                return 'bg-gray-100 text-gray-600';
            };

            // Données   Seeking Alpha
            const fetchSeekingAlphaData = async () => {
                try {
                    const response = await fetch('/stock_analysis.json');
                    if (response.ok) {
                        const data = await response.json();
                        setSeekingAlphaData(data);
                    } else if (response.status === 404) {
                        console.warn('⚠️ Fichier stock_analysis.json non trouvé (404). Données Seeking Alpha non disponibles.');
                    } else {
                        console.warn(`⚠️ Erreur ${response.status} lors du chargement de stock_analysis.json`);
                    }
                } catch (error) {
                    console.error('Erreur fetch Seeking Alpha:', error?.message || String(error));
                }
            };

            const fetchSeekingAlphaStockData = async () => {
                try {
                    const response = await fetch('/stock_data.json');
                    if (response.ok) {
                        const data = await response.json();
                        setSeekingAlphaStockData(data);
                    } else if (response.status === 404) {
                        console.warn('⚠️ Fichier stock_data.json non trouvé (404). Données Seeking Alpha stock non disponibles.');
                    } else {
                        console.warn(`⚠️ Erreur ${response.status} lors du chargement de stock_data.json`);
                    }
                } catch (error) {
                    console.error('Erreur fetch Seeking Alpha stock data:', error?.message || String(error));
                }
            };

            // Monitoring Admin
            const checkApiStatus = async () => {
                const status = {
                    finnhub: { status: 'checking', responseTime: 0, error: null },
                    newsapi: { status: 'checking', responseTime: 0, error: null },
                    seekingAlpha: { status: 'checking', responseTime: 0, error: null }
                };

                // Test Market Data API (nouvelle API unifiée)
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${API_BASE_URL}/api/marketdata?endpoint=quote&symbol=AAPL&source=auto`);
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        status.finnhub = {
                            status: data.message ? 'warning' : 'success',
                            responseTime,
                            error: data.message || null,
                            source: data.source || 'unknown'
                        };
                    } else {
                        status.finnhub = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.finnhub = { status: 'error', responseTime: 0, error: error.message };
                }

                // Test NewsAPI
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${API_BASE_URL}/api/news?q=finance&limit=5&strict=true`);
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        status.newsapi = { status: 'success', responseTime, error: null };
                    } else {
                        status.newsapi = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.newsapi = { status: 'error', responseTime: 0, error: error.message };
                }

                // Test Seeking Alpha
                try {
                    const startTime = Date.now();
                    const response = await fetch('/stock_analysis.json');
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        status.seekingAlpha = { status: 'success', responseTime, error: null };
                    } else {
                        status.seekingAlpha = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.seekingAlpha = { status: 'error', responseTime: 0, error: error.message };
                }

                // Test Gemini API
                try {
                    const startTime = Date.now();
                    const response = await fetch('/api/gemini-key');
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        status.gemini = {
                            status: data.apiKey ? 'success' : 'warning',
                            responseTime,
                            error: data.apiKey ? null : 'Clé API non configurée'
                        };
                    } else {
                        status.gemini = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.gemini = { status: 'error', responseTime: 0, error: error.message };
                }

                // Test GitHub API (si token configuré)
                if (githubToken) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch('https://api.github.com/user', {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        const responseTime = Date.now() - startTime;
                        
                        if (response.ok) {
                            status.github = { status: 'success', responseTime, error: null };
                        } else {
                            status.github = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                        }
                    } catch (error) {
                        status.github = { status: 'error', responseTime: 0, error: error.message };
                    }
                } else {
                    status.github = { status: 'warning', responseTime: 0, error: 'Token GitHub non configuré' };
                }

                // Test Claude API (si configuré)
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${API_BASE_URL}/api/claude`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: 'Test de connexion', ticker: 'TEST' })
                    });
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        status.claude = { status: 'success', responseTime, error: null };
                    } else {
                        status.claude = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.claude = { status: 'error', responseTime: 0, error: error.message };
                }

                // Test Vercel API Routes
                try {
                    const startTime = Date.now();
                    const response = await fetch('/api/test-gemini');
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        status.vercel = {
                            status: data.status === 'success' ? 'success' : 'warning',
                            responseTime,
                            error: data.status === 'success' ? null : data.message
                        };
                    } else {
                        status.vercel = { status: 'error', responseTime, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    status.vercel = { status: 'error', responseTime: 0, error: error.message };
                }

                setApiStatus(status);
            };

            // Initialisation
            useEffect(() => {
                console.log('🚀 Initialisation du dashboard...');
                
                const loadAllData = async () => {
                    console.log('📊 Chargement des données...');
                    try {
                        await Promise.all([
                            fetchSeekingAlphaData(),
                            fetchSeekingAlphaStockData(),
                            refreshAllStocks(),
                            fetchNews(),
                            checkApiStatus()
                        ]);
                        console.log('✅ Toutes les données chargées');
                    } catch (error) {
                        console.error('❌ Erreur lors du chargement:', error?.message || String(error));
                    }
                };
                
                loadAllData();

                // Intro Emma: première visite de session
                if (activeTab === 'ask-emma' && !sessionStorage.getItem('emma-intro-shown')) {
                    setShowEmmaIntro(true);
                    sessionStorage.setItem('emma-intro-shown', '1');
                    setTimeout(() => setShowEmmaIntro(false), 3000);
                }
                
                const interval = setInterval(() => {
                    console.log('🔄 Auto-refresh des données...');
                    refreshAllStocks();
                    fetchNews();
                    fetchSeekingAlphaData();
                    fetchSeekingAlphaStockData();
                }, 300000);
                
                return () => clearInterval(interval);
            }, []);

            // Afficher l'intro quand on ouvre Emma IA pour la 1ère fois pendant la session
            useEffect(() => {
                if (activeTab === 'ask-emma' && !sessionStorage.getItem('emma-intro-shown')) {
                    setShowEmmaIntro(true);
                    sessionStorage.setItem('emma-intro-shown', '1');
                    setTimeout(() => setShowEmmaIntro(false), 3000);
                }
            }, [activeTab]);

            // Effet ripple générique pour les boutons
            const ensureAudioReady = () => {
                // Débloquer audio sur premier geste utilisateur
                if (!audioCtxRef.current) {
                    try {
                        const AudioCtx = window.AudioContext || window.webkitAudioContext;
                        if (AudioCtx) {
                            audioCtxRef.current = new AudioCtx();
                        }
                    } catch (_) {}
                }
                try { tabSoundRef.current?.load(); clickSoundRef.current?.load(); } catch(_){}
            };

            const withRipple = (e) => {
                const target = e.currentTarget;
                const circle = document.createElement('span');
                const diameter = Math.max(target.clientWidth, target.clientHeight);
                const radius = diameter / 2;
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - target.getBoundingClientRect().left - radius}px`;
                circle.style.top = `${e.clientY - target.getBoundingClientRect().top - radius}px`;
                circle.classList.add('ripple-circle');
                const old = target.getElementsByClassName('ripple-circle')[0];
                if (old) old.remove();
                target.appendChild(circle);
                ensureAudioReady();
            };

            // Volume: baisser le son général et couper le son du ripple/clic
            useEffect(() => {
                try {
                    if (tabSoundRef.current) tabSoundRef.current.volume = 0.0; // aucun son d'onglet
                    if (clickSoundRef.current) clickSoundRef.current.volume = 0.30; // clic/ripple 30%
                } catch(_) {}
            }, []);

            // Mettre à jour les actualités filtrées quand les actualités changent
            useEffect(() => {
                setFilteredNews(newsData);
            }, [newsData]);

            // Fonctions de scraping
            const addScrapingLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                const logEntry = { message, type, timestamp };
                setScrapingLogs(prev => [...prev, logEntry]);
                console.log(`[${timestamp}] ${message}`);
            };

            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const scrapeTicker = async (ticker) => {
                addScrapingLog(`🚀 Démarrage du scraping pour ${ticker}...`, 'info');
                
                try {
                    const url = `https://seekingalpha.com/symbol/${ticker}/virtual_analyst_report`;
                    addScrapingLog(`🌐 Ouverture de ${url}`, 'info');
                    
                    // Méthode 1: Essayer window.open avec popup
                    let newWindow = null;
                    try {
                        newWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                            throw new Error('Popup bloqué');
                        }
                        
                        addScrapingLog(`✅ Popup ouvert avec succès pour ${ticker}`, 'success');
                        
                    } catch (popupError) {
                        addScrapingLog(`⚠️ Popup bloqué pour ${ticker}, tentative méthode alternative...`, 'warning');
                        
                        // Méthode 2: Créer un lien temporaire et le cliquer
                        try {
                            const link = document.createElement('a');
                            link.href = url;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            addScrapingLog(`✅ Lien ouvert dans un nouvel onglet pour ${ticker}`, 'success');
                            
                        } catch (linkError) {
                            addScrapingLog(`⚠️ Méthode lien échouée, utilisation de la méthode directe...`, 'warning');
                            
                            // Méthode 3: Utiliser location.href (ouvre dans le même onglet)
                            addScrapingLog(`🔄 Ouverture directe dans le même onglet...`, 'info');
                            addScrapingLog(`⚠️ ATTENTION: Cela va quitter cette page!`, 'warning');
                            
                            // Demander confirmation avant de quitter
                            const confirmLeave = confirm(`Voulez-vous ouvrir ${url} dans le même onglet? Cela fermera cette page.`);
                            if (confirmLeave) {
                                window.location.href = url;
                                return;
                            } else {
                                addScrapingLog(`❌ Utilisateur a annulé l'ouverture pour ${ticker}`, 'error');
                                throw new Error('Utilisateur a annulé l\'ouverture');
                            }
                        }
                    }
                    
                    // Si on a réussi à ouvrir une fenêtre, continuer avec la logique normale
                    if (newWindow && !newWindow.closed) {
                        // Attendre que la page se charge
                        addScrapingLog(`⏳ Attente du chargement de la page (8 secondes)...`, 'info');
                        await wait(8000);
                        
                        // Vérifier si la fenêtre est toujours ouverte
                        if (newWindow.closed) {
                            addScrapingLog(`⚠️ Fenêtre fermée prématurément pour ${ticker}`, 'warning');
                            return;
                        }
                        
                        // Méthode alternative : utiliser postMessage pour communiquer
                        addScrapingLog(`📡 Tentative de communication avec la fenêtre...`, 'info');
                        
                        // Envoyer un message à la fenêtre pour demander les données
                        newWindow.postMessage({
                            type: 'REQUEST_SCRAPING_DATA',
                            ticker: ticker,
                            source: 'parent'
                        }, '*');
                        
                        // Écouter les messages de la fenêtre
                        const messageHandler = async (event) => {
                            if (event.data.type === 'SCRAPING_RESULT' && event.data.ticker === ticker) {
                                addScrapingLog(`✅ Scraping réussi pour ${ticker}`, 'success');
                                addScrapingLog(`📄 Données extraites: ${event.data.data.innerText.length} caractères`, 'info');
                                
                                // Analyser avec Claude et mettre à jour les fichiers
                                try {
                                    await analyzeWithClaudeAndUpdate(ticker, event.data.data);
                                    addScrapingLog(`🎉 Traitement complet terminé pour ${ticker}`, 'success');
                                } catch (claudeError) {
                                    addScrapingLog(`⚠️ Erreur analyse Claude pour ${ticker}: ${claudeError.message}`, 'warning');
                                    addScrapingLog(`💾 Données scrapées sauvegardées localement`, 'info');
                                }
                                
                                window.removeEventListener('message', messageHandler);
                            } else if (event.data.type === 'SCRAPING_ERROR' && event.data.ticker === ticker) {
                                addScrapingLog(`❌ Erreur de scraping pour ${ticker}: ${event.data.error}`, 'error');
                                window.removeEventListener('message', messageHandler);
                            }
                        };
                        
                        window.addEventListener('message', messageHandler);
                        
                        // Timeout de sécurité
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            if (!newWindow.closed) {
                                addScrapingLog(`⏰ Timeout atteint pour ${ticker} - Fenêtre ouverte manuellement`, 'warning');
                                addScrapingLog(`💡 Vous pouvez maintenant extraire les données manuellement`, 'info');
                            }
                        }, 15000);
                        
                        addScrapingLog(`📋 Instructions: La page Seeking Alpha est maintenant ouverte`, 'info');
                        addScrapingLog(`🔍 Vous pouvez copier les données manuellement si nécessaire`, 'info');
                    } else {
                        addScrapingLog(`✅ Page ouverte avec succès pour ${ticker}`, 'success');
                        addScrapingLog(`📋 Instructions: Utilisez F12 pour inspecter la page`, 'info');
                        addScrapingLog(`💡 Copiez les données manuellement depuis la console`, 'info');
                    }
                    
                } catch (error) {
                    addScrapingLog(`❌ Erreur lors du scraping de ${ticker}: ${error.message}`, 'error');
                    
                    // Ne pas faire échouer tout le processus pour un popup bloqué
                    if (error.message.includes('Popup bloqué') || error.message.includes('annulé')) {
                        addScrapingLog(`💡 Conseil: Autorisez les popups pour ce site ou utilisez le script F12`, 'info');
                        return; // Continuer avec le prochain ticker
                    }
                    
                    throw error;
                }
            };

            const runSeekingAlphaScraper = async () => {
                if (scrapingStatus === 'running') {
                    addScrapingLog('⚠️ Scraping déjà en cours', 'warning');
                    return;
                }
                
                setScrapingStatus('running');
                setScrapingProgress(0);
                setScrapingLogs([]);
                
                addScrapingLog('🚀 Démarrage du scraper Seeking Alpha', 'info');
                addScrapingLog(`📊 Tickers à traiter: ${tickers.join(', ')}`, 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    for (let i = 0; i < tickers.length; i++) {
                        const ticker = tickers[i];
                        const progress = Math.round(((i + 1) / tickers.length) * 100);
                        
                        setScrapingProgress(progress);
                        addScrapingLog(`📈 Progression: ${progress}% (${i + 1}/${tickers.length})`, 'info');
                        
                        try {
                            await scrapeTicker(ticker);
                            successCount++;
                            addScrapingLog(`✅ ${ticker} traité avec succès`, 'success');
                        } catch (tickerError) {
                            errorCount++;
                            addScrapingLog(`❌ Erreur pour ${ticker}: ${tickerError.message}`, 'error');
                            addScrapingLog(`🔄 Continuation avec le prochain ticker...`, 'info');
                        }
                        
                        // Pause entre les scrapings pour éviter d'être bloqué
                        if (i < tickers.length - 1) {
                            addScrapingLog('⏸️ Pause de 3 secondes avant le prochain ticker...', 'info');
                            await wait(3000);
                        }
                    }
                    
                    // Déterminer le statut final
                    if (successCount > 0) {
                        setScrapingStatus('completed');
                        addScrapingLog(`🎉 Scraping terminé! ${successCount} succès, ${errorCount} erreurs`, 'success');
                    } else {
                        setScrapingStatus('error');
                        addScrapingLog(`💥 Aucun ticker n'a pu être traité (${errorCount} erreurs)`, 'error');
                    }
                    
                } catch (error) {
                    setScrapingStatus('error');
                    addScrapingLog(`💥 Erreur fatale: ${error.message}`, 'error');
                }
            };

            const openSeekingAlpha = (ticker) => {
                const url = `https://seekingalpha.com/symbol/${ticker}/virtual_analyst_report`;
                addScrapingLog(`🌐 Ouverture directe de Seeking Alpha pour ${ticker}`, 'info');
                
                try {
                    // Essayer d'abord window.open
                    const newWindow = window.open(url, '_blank');
                    
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        addScrapingLog(`⚠️ Popup bloqué, utilisation de la méthode alternative...`, 'warning');
                        
                        // Méthode alternative : créer un lien temporaire
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        addScrapingLog(`✅ Lien ouvert dans un nouvel onglet`, 'success');
                    } else {
                        addScrapingLog(`✅ Fenêtre popup ouverte avec succès`, 'success');
                    }
                } catch (error) {
                    addScrapingLog(`❌ Erreur lors de l'ouverture: ${error.message}`, 'error');
                    addScrapingLog(`💡 Essayez d'autoriser les popups pour ce site`, 'info');
                }
            };

            // Fonction alternative pour le scraping sans cross-origin
            const scrapeTickerAlternative = async (ticker) => {
                addScrapingLog(`🚀 Méthode alternative pour ${ticker}...`, 'info');
                
                try {
                    // Ouvrir dans un nouvel onglet au lieu d'une fenêtre popup
                    const url = `https://seekingalpha.com/symbol/${ticker}/virtual_analyst_report`;
                    addScrapingLog(`🌐 Ouverture dans un nouvel onglet: ${url}`, 'info');
                    
                    // Créer un lien temporaire et le cliquer
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    addScrapingLog(`✅ Onglet ouvert avec succès pour ${ticker}`, 'success');
                    addScrapingLog(`📋 Instructions: Utilisez F12 pour inspecter la page`, 'info');
                    addScrapingLog(`💡 Copiez les données manuellement depuis la console`, 'info');
                    
                    // Simuler une pause pour l'utilisateur
                    await wait(2000);
                    
                } catch (error) {
                    addScrapingLog(`❌ Erreur méthode alternative pour ${ticker}: ${error.message}`, 'error');
                    throw error;
                }
            };

            // Fonction pour générer un script de scraping à copier
            const generateScrapingScript = (ticker) => {
                const script = `
// Script de scraping pour ${ticker}
// Copiez et collez ce script dans la console F12 de Seeking Alpha

(function() {
    console.log('🔍 Script de scraping pour ${ticker}');
    
    // Attendre que la page soit chargée
    setTimeout(() => {
        try {
            const pageData = {
                ticker: '${ticker}',
                url: window.location.href,
                title: document.title,
                timestamp: new Date().toISOString(),
                content: {
                    // Extraire les métriques principales
                    price: document.querySelector('[data-testid="price"]')?.textContent || 'N/A',
                    change: document.querySelector('[data-testid="change"]')?.textContent || 'N/A',
                    peRatio: document.querySelector('[data-testid="pe-ratio"]')?.textContent || 'N/A',
                    marketCap: document.querySelector('[data-testid="market-cap"]')?.textContent || 'N/A',
                    dividend: document.querySelector('[data-testid="dividend"]')?.textContent || 'N/A',
                    sector: document.querySelector('[data-testid="sector"]')?.textContent || 'N/A'
                },
                // Extraire le texte complet
                fullText: document.body.innerText,
                // Extraire les analyses
                analysis: document.querySelector('.analysis-content')?.innerText || 'N/A'
            };
            
            console.log('📊 Données extraites:', pageData);
            
            // Copier dans le presse-papiers si possible
            if (navigator.clipboard) {
                navigator.clipboard.writeText(JSON.stringify(pageData, null, 2))
                    .then(() => console.log('✅ Données copiées dans le presse-papiers'))
                    .catch(() => console.log('⚠️ Impossible de copier automatiquement'));
            }
            
            // Afficher les données dans la console
            console.table(pageData.content);
            
        } catch (error) {
            console.error('❌ Erreur lors de l\'extraction:', error?.message || String(error));
        }
    }, 3000);
})();
                `;
                
                return script;
            };

            // Fonction pour analyser les données avec Claude et mettre à jour les fichiers
            const analyzeWithClaudeAndUpdate = async (ticker, scrapedData) => {
                addScrapingLog(`🤖 Analyse avec Claude pour ${ticker}...`, 'info');
                
                try {
                    // Préparer les données pour Claude
                    const claudePrompt = `
Analysez les données suivantes de Seeking Alpha pour ${ticker} et générez une analyse complète au format JSON.

Données extraites:
${JSON.stringify(scrapedData, null, 2)}

Générez une réponse JSON avec cette structure exacte:
{
  "ticker": "${ticker}",
  "companyName": "Nom de l'entreprise",
  "lastUpdate": "${new Date().toISOString()}",
  "metrics": {
    "marketCap": "Capitalisation boursière",
    "bpaGrowth": "Croissance BPA",
    "peRatio": "Ratio P/E",
    "sector": "Secteur",
    "dividendYield": "Rendement dividende",
    "dividendFrequency": "Fréquence dividende",
    "exDivDate": "Date ex-dividende",
    "annualPayout": "Paiement annuel",
    "price": "Prix actuel",
    "priceChange": "Changement de prix"
  },
  "companyProfile": {
    "description": "Description de l'entreprise en français",
    "employees": "Nombre d'employés si disponible",
    "innovation": "Innovations et investissements clés"
  },
  "competition": {
    "competitors": ["Concurrent 1", "Concurrent 2"],
    "valueProposition": "Proposition de valeur unique",
    "advantages": "Avantages concurrentiels"
  },
  "quantRating": {
    "valuation": "Grade A-F",
    "growth": "Grade A-F", 
    "profitability": "Grade A-F",
    "momentum": "Grade A-F",
    "revisions": "Grade A-F"
  },
  "sectorAnalysis": {
    "valuation": "Analyse de valorisation",
    "growth": "Analyse de croissance",
    "profitability": "Analyse de rentabilité",
    "momentum": "Analyse de momentum",
    "revisions": "Analyse des révisions"
  },
  "intermediateConclusion": "Conclusion intermédiaire",
  "strengths": ["Force 1", "Force 2", "Force 3"],
  "concerns": ["Préoccupation 1", "Préoccupation 2", "Préoccupation 3"],
  "finalConclusion": {
    "strengths": "Résumé des forces",
    "weaknesses": "Résumé des faiblesses", 
    "recommendation": "Recommandation détaillée",
    "rating": "Buy/Hold/Sell"
  }
}

Répondez UNIQUEMENT avec le JSON, sans texte supplémentaire.
                    `;

                    // Appeler l'API Claude (vous devrez configurer votre endpoint)
                    const response = await fetch(`${API_BASE_URL}/api/claude`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: claudePrompt,
                            ticker: ticker
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur API Claude: ${response.status}`);
                    }

                    const claudeResponse = await response.json();
                    const analysisData = JSON.parse(claudeResponse.analysis);

                    addScrapingLog(`✅ Analyse Claude terminée pour ${ticker}`, 'success');

                    // Mettre à jour les fichiers JSON via GitHub API
                    await updateStockDataFiles(ticker, analysisData, scrapedData);

                    return analysisData;

                } catch (error) {
                    addScrapingLog(`❌ Erreur analyse Claude pour ${ticker}: ${error.message}`, 'error');
                    throw error;
                }
            };

            // Fonction pour mettre à jour les fichiers JSON via GitHub API
            const updateStockDataFiles = async (ticker, analysisData, scrapedData) => {
                addScrapingLog(`📝 Mise à jour des fichiers JSON pour ${ticker}...`, 'info');

                try {
                    // Mettre à jour stock_data.json
                    const stockDataResponse = await fetch(`${API_BASE_URL}/api/github-update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file: 'public/stock_data.json',
                            ticker: ticker,
                            data: analysisData,
                            action: 'update_stock'
                        })
                    });

                    if (!stockDataResponse.ok) {
                        throw new Error(`Erreur mise à jour stock_data.json: ${stockDataResponse.status}`);
                    }

                    // Mettre à jour stock_analysis.json
                    const analysisResponse = await fetch(`${API_BASE_URL}/api/github-update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file: 'public/stock_analysis.json',
                            ticker: ticker,
                            data: {
                                ticker: ticker,
                                timestamp: new Date().toISOString(),
                                raw_text: scrapedData.fullText || scrapedData.content,
                                url: scrapedData.url
                            },
                            action: 'update_analysis'
                        })
                    });

                    if (!analysisResponse.ok) {
                        throw new Error(`Erreur mise à jour stock_analysis.json: ${analysisResponse.status}`);
                    }

                    addScrapingLog(`✅ Fichiers JSON mis à jour pour ${ticker}`, 'success');
                    addScrapingLog(`🔄 Rechargement des données...`, 'info');

                    // Recharger les données
                    await fetchSeekingAlphaData();
                    await fetchSeekingAlphaStockData();

                } catch (error) {
                    addScrapingLog(`❌ Erreur mise à jour fichiers pour ${ticker}: ${error.message}`, 'error');
                    throw error;
                }
            };

            // Composant onglet Admin-JSLAI
            const AdminJSLaiTab = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>⚙️ Admin-JSLAI</h2>
                    </div>

                    {/* 🔍 Debug des Données (déplacé ici depuis Titres & nouvelles) */}
                    <div className={`rounded-lg p-4 border transition-colors duration-300 ${
                        isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>🔍 Debug des Données</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div className={`${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded p-3 border`}>
                                <div className="text-blue-600 font-medium mb-2">📊 Stock Data</div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Tickers: {tickers.length} ({tickers.join(', ')})
                                </div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Données chargées: {Object.keys(stockData).length}
                                </div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Dernière MAJ: {lastUpdate ? new Date(lastUpdate).toLocaleString('fr-FR') : 'Jamais'}
                                </div>
                            </div>
                            <div className={`${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded p-3 border`}>
                                <div className="text-emerald-600 font-medium mb-2">📰 News Data</div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Articles: {newsData.length}
                                </div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Premier article: {newsData[0]?.title?.substring(0, 30) || 'Aucun'}...
                                </div>
                            </div>
                            <div className={`${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded p-3 border`}>
                                <div className="text-violet-600 font-medium mb-2">🎯 Seeking Alpha</div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Stocks: {seekingAlphaData.stocks?.length || 0}
                                </div>
                                <div className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                    Stock Data: {Object.keys(seekingAlphaStockData.stocks || {}).length}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Section Administration des Stocks */}
                    <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-gray-900 border-gray-700' 
                            : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>📊 Gestion des Stocks</h3>
                        <div className="flex flex-wrap gap-2">
                            <button
                                onClick={refreshAllStocks}
                                disabled={loading}
                                className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 disabled:opacity-50 transition-colors"
                            >
                                {loading ? 'Actualisation...' : 'Actualiser Stocks'}
                            </button>
                            <button
                                onClick={fetchNews}
                                className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                            >
                                Actualiser News
                            </button>
                        </div>
                    </div>

                    {/* Section Scraping Seeking Alpha */}
                    <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-gray-900 border-gray-700' 
                            : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>🔧 Scraping Seeking Alpha</h3>
                        <div className="flex flex-wrap gap-2">
                            <button
                                onClick={runSeekingAlphaScraper}
                                disabled={scrapingStatus === 'running'}
                                className="px-4 py-2 bg-violet-600 text-white rounded hover:bg-violet-700 disabled:opacity-50 transition-colors"
                            >
                                {scrapingStatus === 'running' ? 'Scraping...' : '🚀 Lancer le Scraper'}
                            </button>
                            <button
                                onClick={() => openSeekingAlpha('AAPL')}
                                className="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors"
                            >
                                🌐 Ouvrir Seeking Alpha
                            </button>
                            <button
                                onClick={() => {
                                    const script = generateScrapingScript('CVS');
                                    navigator.clipboard.writeText(script).then(() => {
                                        addScrapingLog('📋 Script de scraping copié dans le presse-papiers', 'success');
                                        addScrapingLog('💡 Collez-le dans la console F12 de Seeking Alpha', 'info');
                                    });
                                }}
                                className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"
                            >
                                📋 Script F12
                            </button>
                            <button
                                onClick={async () => {
                                    addScrapingLog('🤖 Démarrage de l\'analyse Claude sur les données existantes...', 'info');
                                    try {
                                        for (const ticker of tickers) {
                                            const existingData = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                            if (existingData) {
                                                addScrapingLog(`🔄 Analyse de ${ticker} avec Claude...`, 'info');
                                                await analyzeWithClaudeAndUpdate(ticker, {
                                                    fullText: existingData.raw_text,
                                                    url: existingData.url,
                                                    content: {}
                                                });
                                            }
                                        }
                                        addScrapingLog('🎉 Analyse Claude terminée pour tous les tickers', 'success');
                                    } catch (error) {
                                        addScrapingLog(`❌ Erreur analyse Claude: ${error.message}`, 'error');
                                    }
                                }}
                                className="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700 transition-colors"
                            >
                                🤖 Analyser avec Claude
                            </button>
                        </div>
                    </div>

                    {/* Section Logs de Scraping */}
                    {scrapingLogs.length > 0 && (
                        <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gray-900 border-gray-700' 
                                : 'bg-gray-50 border-gray-200'
                        }`}>
                            <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>📋 Logs de Scraping</h3>
                            <div className={`max-h-64 overflow-y-auto space-y-2 ${
                                isDarkMode ? 'bg-gray-800' : 'bg-white'
                            } rounded-lg p-4`}>
                                {scrapingLogs.map((log, index) => (
                                    <div key={index} className={`text-sm p-2 rounded ${
                                        log.type === 'error' ? 'bg-red-100 text-red-800' :
                                        log.type === 'success' ? 'bg-green-100 text-green-800' :
                                        log.type === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-blue-100 text-blue-800'
                                    }`}>
                                        <span className="font-mono text-xs opacity-70">
                                            {new Date(log.timestamp).toLocaleTimeString()}
                                        </span>
                                        <span className="ml-2">{log.message}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Section État des Connexions */}
                    <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-gray-900 border-gray-700' 
                            : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>🔗 État des Connexions</h3>
                        <div className="space-y-3">
                            {Object.entries(apiStatus).map(([api, status]) => (
                                <div key={api} className={`flex items-center justify-between p-3 rounded-lg transition-colors duration-300 ${
                                    isDarkMode ? 'bg-gray-800' : 'bg-gray-100'
                                }`}>
                                    <span className={`font-mono capitalize transition-colors duration-300 ${
                                        isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                    }`}>{api}</span>
                                    <div className="flex items-center gap-2">
                                        <span className={`w-3 h-3 rounded-full ${
                                            status.status === 'success' ? 'bg-green-500' :
                                            status.status === 'warning' ? 'bg-yellow-500' :
                                            status.status === 'error' ? 'bg-red-500' : 'bg-gray-500'
                                        }`}></span>
                                        <span className={`text-sm transition-colors duration-300 ${
                                            isDarkMode ? 'text-gray-400' : 'text-gray-600'
                                        }`}>
                                            {status.responseTime}ms
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2 mt-4">
                            <button
                                onClick={checkApiStatus}
                                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                            >
                                🔄 Vérifier
                            </button>
                        </div>
                    </div>

                    {/* Section Configuration */}
                    <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-gray-900 border-gray-700' 
                            : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>⚙️ Configuration</h3>
                        <div className="space-y-4">
                            <div>
                                <label className={`block text-sm font-medium mb-2 transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                }`}>
                                    Token GitHub (pour les mises à jour)
                                </label>
                                <input
                                    type="password"
                                    value={githubToken}
                                    onChange={(e) => setGithubToken(e.target.value)}
                                    placeholder="Entrez votre token GitHub"
                                    className={`w-full px-3 py-2 rounded-lg border transition-colors duration-300 ${
                                        isDarkMode 
                                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' 
                                            : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                                    }`}
                                />
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowSettings(!showSettings)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                >
                                    {showSettings ? 'Masquer' : 'Afficher'} les paramètres
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // Composant onglet Dan's Watchlist
            const DansWatchlistTab = () => {
                const [watchlistTickers, setWatchlistTickers] = useState([]);
                const [newTicker, setNewTicker] = useState('');
                const [watchlistStockData, setWatchlistStockData] = useState({});
                const [watchlistLoading, setWatchlistLoading] = useState(false);
                const WATCHLIST_FILE = '/dans-watchlist.json'; // servi depuis /public

                // Charger la watchlist depuis localStorage
                useEffect(() => {
                    const savedWatchlist = localStorage.getItem('dans-watchlist');
                    if (savedWatchlist) {
                        const tickers = JSON.parse(savedWatchlist);
                        setWatchlistTickers(tickers);
                        loadWatchlistData(tickers);
                    }
                }, []);

                // Charger les données pour les tickers de la watchlist
                const loadWatchlistData = async (tickers) => {
                    if (tickers.length === 0) return;
                    
                    setWatchlistLoading(true);
                    const newData = {};
                    
                    for (const ticker of tickers) {
                        try {
                            const data = await fetchStockData(ticker);
                            if (data && !data.message) {
                                newData[ticker] = {
                                    ...data,
                                    timestamp: new Date().toISOString()
                                };
                            }
                        } catch (error) {
                            console.error(`Erreur pour ${ticker}:`, error?.message || String(error));
                        }
                    }
                    
                    setWatchlistStockData(newData);
                    setWatchlistLoading(false);
                };

                // Ajouter un ticker à la watchlist
                const addTickerToWatchlist = async () => {
                    if (!newTicker.trim()) return;
                    
                    const ticker = newTicker.trim().toUpperCase();
                    if (watchlistTickers.includes(ticker)) {
                        showMessage('Ce ticker est déjà dans la watchlist', 'warning');
                        return;
                    }
                    
                    const updatedTickers = [...watchlistTickers, ticker];
                    setWatchlistTickers(updatedTickers);
                    localStorage.setItem('dans-watchlist', JSON.stringify(updatedTickers));
                    setNewTicker('');
                    
                    // Charger les données pour le nouveau ticker
                    loadWatchlistData([ticker]);
                    showMessage(`${ticker} ajouté à la watchlist`, 'success');
                    
                    // Sauvegarder automatiquement sur GitHub
                    await saveWatchlistToGitHubAuto(updatedTickers);
                };

                // Supprimer un ticker de la watchlist
                const removeTickerFromWatchlist = async (ticker) => {
                    const updatedTickers = watchlistTickers.filter(t => t !== ticker);
                    setWatchlistTickers(updatedTickers);
                    localStorage.setItem('dans-watchlist', JSON.stringify(updatedTickers));
                    
                    // Supprimer les données du ticker
                    setWatchlistStockData(prev => {
                        const newData = { ...prev };
                        delete newData[ticker];
                        return newData;
                    });
                    
                    showMessage(`${ticker} supprimé de la watchlist`, 'success');
                    
                    // Sauvegarder automatiquement sur GitHub
                    await saveWatchlistToGitHubAuto(updatedTickers);
                };

                // Actualiser les données de la watchlist
                const refreshWatchlist = async () => {
                    await loadWatchlistData(watchlistTickers);
                    showMessage('Watchlist actualisée', 'success');
                };

                // Sauvegarder automatiquement la watchlist sur GitHub (silencieux)
                const saveWatchlistToGitHubAuto = async (tickers) => {
                    try {
                        const watchlistData = {
                            tickers: tickers,
                            lastUpdated: new Date().toISOString(),
                            count: tickers.length
                        };
                        
                        const response = await fetch(`${API_BASE_URL}/api/save-tickers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                tickers: tickers,
                                filename: 'dans-watchlist.json'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        console.log('✅ Watchlist sauvegardée automatiquement sur GitHub');
                    } catch (e) {
                        console.error('⚠️ Erreur sauvegarde automatique GitHub watchlist:', e);
                        // Ne pas afficher d'erreur à l'utilisateur pour ne pas perturber l'expérience
                    }
                };

                // Sauvegarder manuellement la watchlist dans GitHub (avec confirmation)
                const saveWatchlistToGitHub = async () => {
                    try {
                        await saveWatchlistToGitHubAuto(watchlistTickers);
                        showMessage('Watchlist sauvegardée sur GitHub', 'success');
                    } catch (e) {
                        console.error('Erreur sauvegarde GitHub watchlist:', e);
                        showMessage('Erreur sauvegarde GitHub', 'error');
                    }
                };

                // Charger la watchlist depuis GitHub (fichier statique public)
                const loadWatchlistFromGitHub = async () => {
                    try {
                        const res = await fetch(WATCHLIST_FILE + `?t=${Date.now()}`);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const json = await res.json();
                        const tickers = Array.isArray(json.tickers) ? json.tickers : [];
                        setWatchlistTickers(tickers);
                        localStorage.setItem('dans-watchlist', JSON.stringify(tickers));
                        await loadWatchlistData(tickers);
                        showMessage('Watchlist chargée depuis GitHub', 'success');
                    } catch (e) {
                        console.error('Erreur chargement GitHub watchlist:', e);
                        showMessage('Erreur chargement GitHub', 'error');
                    }
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>👀 Dan's Watchlist</h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={refreshWatchlist}
                                    disabled={watchlistLoading || watchlistTickers.length === 0}
                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 transition-colors"
                                >
                                    {watchlistLoading ? 'Actualisation...' : '🔄 Actualiser'}
                                </button>
                                <button
                                    onClick={saveWatchlistToGitHub}
                                    className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors"
                                >
                                    💾 Sauvegarder GitHub
                                </button>
                                <button
                                    onClick={loadWatchlistFromGitHub}
                                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                                >
                                    ⬇️ Charger GitHub
                                </button>
                            </div>
                        </div>

                        {/* Section d'ajout de ticker */}
                        <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gray-900 border-gray-700' 
                                : 'bg-gray-50 border-gray-200'
                        }`}>
                            <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>➕ Ajouter un Ticker</h3>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={newTicker}
                                    onChange={(e) => setNewTicker(e.target.value)}
                                    placeholder="Ex: AAPL, TSLA, GOOGL..."
                                    className={`flex-1 px-3 py-2 rounded-lg border transition-colors duration-300 ${
                                        isDarkMode 
                                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' 
                                            : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                                    }`}
                                    onKeyPress={(e) => e.key === 'Enter' && addTickerToWatchlist()}
                                />
                                <button
                                    onClick={addTickerToWatchlist}
                                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                                >
                                    ➕ Ajouter
                                </button>
                            </div>
                            <p className={`text-sm mt-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-gray-400' : 'text-gray-600'
                            }`}>
                                💡 Ces tickers ne seront visibles que dans cette watchlist personnalisée
                            </p>
                        </div>

                        {/* Liste des tickers de la watchlist */}
                        {watchlistTickers.length > 0 ? (
                            <div className={`backdrop-blur-sm rounded-lg p-6 border transition-colors duration-300 ${
                                isDarkMode 
                                    ? 'bg-gray-900 border-gray-700' 
                                    : 'bg-gray-50 border-gray-200'
                            }`}>
                                <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                }`}>
                                    📊 Tickers de la Watchlist ({watchlistTickers.length})
                                </h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {watchlistTickers.map(ticker => {
                                        const data = watchlistStockData[ticker];
                                        const change = data?.dp ? (data.dp >= 0 ? '+' : '') + data.dp.toFixed(2) + '%' : 'N/A';
                                        const changeColor = data?.dp >= 0 ? 'text-green-400' : 'text-red-400';
                                        const changeBgColor = data?.dp >= 0 ? 'bg-green-500' : 'bg-red-500';
                                        
                                        return (
                                            <div key={ticker} className={`rounded-lg p-4 border transition-colors duration-300 ${
                                                isDarkMode 
                                                    ? 'bg-gray-800 border-gray-600 hover:border-blue-400/50' 
                                                    : 'bg-white border-gray-300 hover:border-blue-300'
                                            }`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <img 
                                                            src={getCompanyLogo(ticker)} 
                                                            alt={`${ticker} logo`}
                                                            className="w-8 h-8 rounded"
                                                            onError={(e) => {
                                                                e.target.style.display = 'none';
                                                            }}
                                                        />
                                                        <h4 className={`font-bold text-lg transition-colors duration-300 ${
                                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                                        }`}>{ticker}</h4>
                                                    </div>
                                                    <button
                                                        onClick={() => removeTickerFromWatchlist(ticker)}
                                                        className={`p-1 rounded transition-colors duration-300 ${
                                                            isDarkMode 
                                                                ? 'text-gray-400 hover:text-red-400 hover:bg-red-900/20' 
                                                                : 'text-gray-500 hover:text-red-600 hover:bg-red-50'
                                                        }`}
                                                        title="Supprimer de la watchlist"
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                                
                                                {data ? (
                                                    <>
                                                        <div className={`rounded-lg p-3 mb-3 transition-colors duration-300 ${
                                                            isDarkMode ? 'bg-gray-700' : 'bg-gray-100'
                                                        }`}>
                                                            <div className={`text-2xl font-bold mb-1 transition-colors duration-300 ${
                                                                isDarkMode ? 'text-white' : 'text-gray-900'
                                                            }`}>
                                                                ${data.c?.toFixed(2) || 'N/A'}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-3 h-3 ${changeBgColor} rounded`}></div>
                                                                <span className={`text-sm font-medium ${changeColor}`}>
                                                                    {change}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="space-y-2 text-sm">
                                                            <div className="flex justify-between">
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-gray-400' : 'text-gray-600'
                                                                }`}>Volume:</span>
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                                }`}>{data.v?.toLocaleString() || 'N/A'}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-gray-400' : 'text-gray-600'
                                                                }`}>High:</span>
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                                }`}>${data.h?.toFixed(2) || 'N/A'}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-gray-400' : 'text-gray-600'
                                                                }`}>Low:</span>
                                                                <span className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                                }`}>${data.l?.toFixed(2) || 'N/A'}</span>
                                                            </div>
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className={`text-center py-4 transition-colors duration-300 ${
                                                        isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                    }`}>
                                                        <div className="animate-spin w-6 h-6 border-2 border-gray-400 border-t-transparent rounded-full mx-auto mb-2"></div>
                                                        <span className="text-sm">Chargement...</span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            <div className={`backdrop-blur-sm rounded-lg p-8 border transition-colors duration-300 ${
                                isDarkMode 
                                    ? 'bg-gray-900 border-gray-700' 
                                    : 'bg-gray-50 border-gray-200'
                            } text-center`}>
                                <div className="text-6xl mb-4">👀</div>
                                <h3 className={`text-xl font-semibold mb-2 transition-colors duration-300 ${
                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                }`}>Watchlist Vide</h3>
                                <p className={`transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-400' : 'text-gray-600'
                                }`}>
                                    Ajoutez des tickers pour commencer à suivre vos investissements personnalisés
                                </p>
                            </div>
                        )}
                    </div>
                );
            };

            // Composant onglet Scrapping SA (simplifié)
            const ScrappingSATab = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>🔧 Scrapping SA</h2>
                        <div className="flex gap-2">
                            <span className={`text-sm transition-colors duration-300 ${
                                isDarkMode ? 'text-gray-400' : 'text-gray-600'
                            }`}>
                                Outils d'administration déplacés vers l'onglet Admin-JSLAI
                            </span>
                        </div>
                    </div>


                    {/* Fiche détaillée du titre sélectionné */}
                    {selectedStock && (
                        <div className="seeking-alpha-card rounded-lg p-6 border border-gray-600">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="text-2xl font-bold text-white">{selectedStock}</h3>
                                <button
                                    onClick={() => setSelectedStock(null)}
                                    className="text-blue-400 hover:text-blue-300"
                                >
                                    ✕ Fermer
                                </button>
                            </div>
                            
                            {/* Fiche détaillée comme dans les images */}
                            {(() => {
                                const claudeData = seekingAlphaStockData.stocks?.[selectedStock];
                                const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === selectedStock);
                                const parsedData = seekingAlphaItem?.parsedData;
                                
                                if (claudeData || parsedData) {
                                    return (
                                        <div className="bg-white rounded-lg shadow-xl overflow-hidden">
                                            {/* Header avec gradient bleu */}
                                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 p-6">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <h3 className="text-2xl font-bold text-white">{selectedStock}</h3>
                                                        <p className="text-blue-100 text-sm">
                                                            {claudeData?.companyName || parsedData?.companyName || 'N/A'}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => setSelectedStock(null)}
                                                        className="text-white hover:text-gray-200 text-xl"
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Contenu principal */}
                                            <div className="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                                                {/* Métriques Clés */}
                                                <div>
                                                    <h4 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                        <div className="w-1 h-6 bg-green-600 mr-3"></div>
                                                        Métriques Clés
                                                    </h4>
                                                    <div className="grid grid-cols-3 gap-4">
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Capitalisation</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.marketCap || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Croissance BPA</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.bpaGrowth || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">P/E Ratio</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.peRatio || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Secteur</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.sector || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Rendement Dividende</div>
                                                            <div className="text-green-600 font-bold text-lg">{claudeData?.metrics?.dividendYield || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Fréquence</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.dividendFrequency || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Ex-Dividende</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.exDivDate || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Paiement Annuel</div>
                                                            <div className="text-green-600 font-bold text-lg">{claudeData?.metrics?.annualPayout || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Prix Actuel</div>
                                                            <div className="text-blue-600 font-bold text-lg">{claudeData?.metrics?.price || 'N/A'}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Profil de l'Entreprise */}
                                                {claudeData?.companyProfile && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4">Profil de l'Entreprise</h4>
                                                        <div className="text-gray-700 leading-relaxed">
                                                            {cleanText(claudeData.companyProfile.description)}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Analyse Quantitative */}
                                                {claudeData?.quantRating && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4">Analyse Quantitative</h4>
                                                        <div className="flex gap-4 mb-6">
                                                            {Object.entries(claudeData.quantRating).map(([key, value]) => {
                                                                if (!value || key === 'overall') return null;
                                                                return (
                                                                    <div key={key} className="text-center">
                                                                        <div className="text-gray-600 text-sm mb-2 capitalize">{key}</div>
                                                                        <span className={`px-3 py-2 rounded-lg text-sm font-bold ${getGradeColor(value)}`}>
                                                                            {value}
                                                                        </span>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Analyse Sectorielle */}
                                                {claudeData?.sectorAnalysis && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                            <div className="w-1 h-6 bg-green-600 mr-3"></div>
                                                            Analyse Sectorielle
                                                        </h4>
                                                        <div className="bg-blue-50 rounded-lg p-4">
                                                            <div className="text-gray-700 leading-relaxed">
                                                                {typeof claudeData.sectorAnalysis === 'string' 
                                                                    ? cleanText(claudeData.sectorAnalysis)
                                                                    : Object.entries(claudeData.sectorAnalysis).map(([key, value]) => (
                                                                        <div key={key} className="mb-3">
                                                                            <div className="font-bold text-gray-800 capitalize mb-2">{cleanText(key)}:</div>
                                                                            <div className="text-gray-700 leading-relaxed">{cleanText(value)}</div>
                                                                </div>
                                                                    ))
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Points Positifs */}
                                                {claudeData?.strengths && (
                                                    <div className="bg-green-50 rounded-lg p-4">
                                                        <h4 className="text-lg font-bold text-green-800 mb-4 flex items-center">
                                                            <span className="mr-2">✅</span>
                                                            Points Positifs
                                                        </h4>
                                                        <div className="space-y-3">
                                                            {claudeData.strengths.map((strength, index) => (
                                                                <div key={index} className="text-green-700">
                                                                    <span className="font-bold">{index + 1}.</span> {cleanText(strength)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Préoccupations */}
                                                {claudeData?.concerns && (
                                                    <div className="bg-red-50 rounded-lg p-4">
                                                        <h4 className="text-lg font-bold text-red-800 mb-4 flex items-center">
                                                            <span className="mr-2">⚠️</span>
                                                            Préoccupations
                                                        </h4>
                                                        <div className="space-y-3">
                                                            {claudeData.concerns.map((concern, index) => (
                                                                <div key={index} className="text-red-700 flex items-start">
                                                                    <span className="mr-2">⚠️</span>
                                                                    <span>{cleanText(concern)}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Conclusion Finale */}
                                                {claudeData?.finalConclusion && (
                                                    <div className="bg-blue-600 rounded-lg p-6 text-white">
                                                        <h4 className="text-xl font-bold mb-4">Conclusion Finale</h4>
                                                        <div className="bg-white rounded-lg p-4 text-gray-800">
                                                            <div className="flex items-center justify-between mb-3">
                                                                <span className="font-bold">Recommandation:</span>
                                                                <span className="bg-yellow-400 text-black px-3 py-1 rounded font-bold">
                                                                    {claudeData.finalConclusion.rating}
                                                                </span>
                                                            </div>
                                                            <div className="text-gray-700 leading-relaxed">
                                                                {cleanText(claudeData.finalConclusion.recommendation)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                }
                                return null;
                            })()}
                            
                            {/* Analyse Seeking Alpha */}
                            {(() => {
                                const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === selectedStock);
                                const parsedData = seekingAlphaItem?.parsedData;
                                
                                if (parsedData?.analysis) {
                                    return (
                                        <div className="mb-4">
                                            <h4 className="text-lg font-semibold text-white mb-2">📈 Analyse Seeking Alpha</h4>
                                            <div className="text-gray-200 text-sm leading-relaxed">
                                                {parsedData.analysis}
                                            </div>
                                            <a
                                                href={seekingAlphaItem.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="inline-block mt-2 text-blue-300 hover:text-blue-200 underline"
                                            >
                                                Lire l'analyse complète sur Seeking Alpha →
                                            </a>
                                        </div>
                                    );
                                }
                                return null;
                            })()}
                            
                            {/* Données en temps réel */}
                            {stockData[selectedStock] && (
                                <div className="mb-4">
                                    <h4 className="text-lg font-semibold text-white mb-2">📊 Données Temps Réel</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                        <div>
                                            <span className="text-blue-200">Ouverture:</span>
                                            <span className="text-white ml-2">${stockData[selectedStock].o?.toFixed(2) || 'N/A'}</span>
                                        </div>
                                        <div>
                                            <span className="text-blue-200">Plus haut:</span>
                                            <span className="text-white ml-2">${stockData[selectedStock].h?.toFixed(2) || 'N/A'}</span>
                                        </div>
                                        <div>
                                            <span className="text-blue-200">Plus bas:</span>
                                            <span className="text-white ml-2">${stockData[selectedStock].l?.toFixed(2) || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Cartes d'analyse comme dans les images */}
                    {!selectedStock && seekingAlphaData.stocks && (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-white">📈 Analyses Complètes</h3>
                                <div className="flex bg-gray-700 rounded-lg p-1">
                                    <button
                                        onClick={() => setSeekingAlphaViewMode('list')}
                                        className={`px-3 py-1 rounded text-sm transition-colors ${
                                            seekingAlphaViewMode === 'list' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'text-gray-300 hover:text-white'
                                        }`}
                                    >
                                        📋 Liste
                                    </button>
                                    <button
                                        onClick={() => setSeekingAlphaViewMode('cards')}
                                        className={`px-3 py-1 rounded text-sm transition-colors ${
                                            seekingAlphaViewMode === 'cards' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'text-gray-300 hover:text-white'
                                        }`}
                                    >
                                        🎴 Cartes
                                    </button>
                                </div>
                            </div>

                            {/* Vue en liste compacte pour Seeking Alpha */}
                            {seekingAlphaViewMode === 'list' && (
                                <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                    <h4 className="text-lg font-semibold text-white mb-4">📋 Vue Liste - Analyses</h4>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b border-gray-600">
                                                    <th className="text-left py-2 text-gray-300">Ticker</th>
                                                    <th className="text-left py-2 text-gray-300">Prix</th>
                                                    <th className="text-left py-2 text-gray-300">Change</th>
                                                    <th className="text-left py-2 text-gray-300">P/E</th>
                                                    <th className="text-left py-2 text-gray-300">Dividende</th>
                                                    <th className="text-left py-2 text-gray-300">Secteur</th>
                                                    <th className="text-left py-2 text-gray-300">Rating</th>
                                                    <th className="text-left py-2 text-gray-300">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            {seekingAlphaData.stocks.map((stock, index) => {
                                const claudeData = seekingAlphaStockData.stocks?.[stock.ticker];
                                const parsedData = stock.parsedData;
                                                    
                                                    // Priorité: Claude > Parsed
                                                    const price = claudeData?.metrics?.price || parsedData?.price || 'N/A';
                                                    const change = claudeData?.metrics?.priceChange || parsedData?.change || 'N/A';
                                                    const peRatio = claudeData?.metrics?.peRatio || parsedData?.peRatio || 'N/A';
                                                    const dividendYield = claudeData?.metrics?.dividendYield || parsedData?.dividendYield || 'N/A';
                                                    const sector = claudeData?.metrics?.sector || parsedData?.sector || 'N/A';
                                                    const rating = claudeData?.finalConclusion?.rating || 'Hold';
                                                    
                                                    const changeColor = (change.includes('+') || change.includes('green')) ? 'text-green-400' : 'text-red-400';
                                
                                return (
                                                        <tr key={index} className="border-b border-gray-700 hover:bg-gray-800 cursor-pointer"
                                                            onClick={() => setSelectedStock(stock.ticker)}>
                                                            <td className="py-3">
                                                                <div className="flex items-center gap-2">
                                                                    <img 
                                                                        src={getCompanyLogo(stock.ticker)} 
                                                                        alt={`${stock.ticker} logo`}
                                                                        className="w-6 h-6 rounded"
                                                                        onError={(e) => {
                                                                            e.target.style.display = 'none';
                                                                        }}
                                                                    />
                                                                    <span className="font-mono text-white font-bold">{stock.ticker}</span>
                                                                </div>
                                                            </td>
                                                            <td className="py-3 text-white">{price}</td>
                                                            <td className={`py-3 ${changeColor}`}>{change}</td>
                                                            <td className="py-3 text-white">{peRatio}</td>
                                                            <td className="py-3 text-white">{dividendYield}</td>
                                                            <td className="py-3 text-white text-xs">{cleanText(sector)}</td>
                                                            <td className="py-3">
                                                                <span className="bg-yellow-400 text-black px-2 py-1 rounded text-xs font-bold">
                                                                    {rating}
                                                                </span>
                                                            </td>
                                                            <td className="py-3">
                                                                <button className="text-blue-300 hover:text-blue-200 text-xs">
                                                                    Voir fiche →
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* Vue en cartes pour Seeking Alpha */}
                            {seekingAlphaViewMode === 'cards' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {seekingAlphaData.stocks.map((stock, index) => {
                                        const claudeData = seekingAlphaStockData.stocks?.[stock.ticker];
                                        const parsedData = stock.parsedData;
                                        
                                        return (
                                            <div key={index} className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-300/40 transition-all cursor-pointer"
                                                 onClick={() => setSelectedStock(stock.ticker)}>
                                                
                                        {/* Header avec ticker et rating */}
                                        <div className="flex justify-between items-start mb-6">
                                            <div className="flex items-center gap-3">
                                                <img 
                                                    src={getCompanyLogo(stock.ticker)} 
                                                    alt={`${stock.ticker} logo`}
                                                    className="w-12 h-12 rounded-lg"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                    }}
                                                />
                                                <div>
                                                    <h3 className="text-2xl font-bold text-white">{stock.ticker}</h3>
                                                    <p className="text-sm text-gray-400">
                                                        {claudeData?.companyName || parsedData?.companyName || 'N/A'}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="bg-yellow-400 text-black px-3 py-1 rounded font-bold text-sm">
                                                {claudeData?.finalConclusion?.rating || 'Hold'}
                                            </div>
                                        </div>

                                        {/* Prix et changement */}
                                        <div className="bg-gray-700 rounded-lg p-4 mb-6">
                                            <div className="text-3xl font-bold text-white mb-1">
                                                {claudeData?.metrics?.price || parsedData?.price || 'N/A'}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-4 h-4 bg-blue-500 rounded"></div>
                                                <span className={`text-sm font-medium ${claudeData?.metrics?.priceChange?.includes('+') ? 'text-green-400' : 'text-red-400'}`}>
                                                    {claudeData?.metrics?.priceChange || parsedData?.change || 'N/A'}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Métriques clés */}
                                        <div className="space-y-3 mb-6">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Market Cap</span>
                                                <span className="text-white font-medium">{claudeData?.metrics?.marketCap || parsedData?.marketCap || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">P/E Ratio</span>
                                                <span className="text-white font-medium">{claudeData?.metrics?.peRatio || parsedData?.peRatio || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Dividend</span>
                                                <span className="text-white font-medium">{claudeData?.metrics?.dividendYield || parsedData?.dividendYield || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Secteur</span>
                                                <span className="text-white font-medium">{claudeData?.metrics?.sector || parsedData?.sector || 'N/A'}</span>
                                            </div>
                                        </div>

                                        {/* Quant Ratings */}
                                        {claudeData?.quantRating && (
                                            <div className="mb-6">
                                                <div className="border-t border-gray-600 pt-4">
                                                    <h4 className="text-center text-gray-300 text-sm font-medium mb-4">QUANT RATINGS</h4>
                                                    <div className="flex justify-center gap-3">
                                                        {Object.entries(claudeData.quantRating).map(([key, value]) => {
                                                            if (!value || key === 'overall') return null;
                                                            const shortKey = key.substring(0, 3);
                                                            return (
                                                                <div key={key} className="text-center">
                                                                    <div className="text-xs text-gray-400 mb-1">{shortKey}</div>
                                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${getGradeColor(value)}`}>
                                                                        {value}
                                                                    </span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Call to action */}
                                        <div className="text-center">
                                            <div className="flex items-center justify-center gap-2 text-gray-400 text-sm">
                                                <span>👆</span>
                                                <span>Cliquez pour le rapport détaillé</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                        </div>
                    )}

                    {/* Section Scraping */}
                    <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-gray-900 border-gray-700' 
                            : 'bg-gray-50 border-gray-200'
                    }`}>
                        <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>🔧 Outils de Scraping</h3>
                        
                        {/* Statut du scraping */}
                        <div className="mb-4">
                            <div className="flex items-center justify-between mb-2">
                                <span className={`font-medium transition-colors duration-300 ${
                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                }`}>Statut:</span>
                                <span className={`px-3 py-1 rounded text-sm font-bold ${
                                    scrapingStatus === 'idle' ? 'bg-gray-500 text-white' :
                                    scrapingStatus === 'running' ? 'bg-blue-500 text-white' :
                                    scrapingStatus === 'completed' ? 'bg-green-500 text-white' :
                                    'bg-red-500 text-white'
                                }`}>
                                    {scrapingStatus === 'idle' ? '⏸️ En attente' :
                                     scrapingStatus === 'running' ? '🔄 En cours' :
                                     scrapingStatus === 'completed' ? '✅ Terminé' :
                                     '❌ Erreur'}
                                </span>
                        </div>

                            {/* Barre de progression */}
                            {scrapingStatus === 'running' && (
                                <div className="w-full bg-gray-700 rounded-full h-2 mb-2">
                                    <div 
                                        className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${scrapingProgress}%` }}
                                    ></div>
                                </div>
                            )}
                            
                            <div className={`text-sm transition-colors duration-300 ${
                                isDarkMode ? 'text-gray-300' : 'text-gray-600'
                            }`}>
                                Progression: {scrapingProgress}%
                            </div>
                        </div>

                        {/* Instructions de scraping */}
                        <div className={`rounded-lg p-4 mb-4 transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-blue-900/30' 
                                : 'bg-blue-100/80'
                        }`}>
                            <h4 className={`font-medium mb-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>📖 Instructions de Scraping</h4>
                            <div className={`text-sm space-y-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-blue-200' : 'text-blue-800'
                            }`}>
                                <div>• <strong>Méthode 1:</strong> Cliquez sur "🚀 Lancer le Scraper" pour ouvrir les pages</div>
                                <div>• <strong>Méthode 2:</strong> Cliquez sur "📋 Script F12" pour copier un script</div>
                                <div>• <strong>Étapes:</strong> Ouvrez F12 → Console → Collez le script → Entrée</div>
                                <div>• <strong>Résultat:</strong> Les données seront affichées et copiées automatiquement</div>
                            </div>
                        </div>

                        {/* Aide pour les popups bloqués */}
                        <div className={`rounded-lg p-4 mb-4 transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-yellow-900/30' 
                                : 'bg-yellow-100/80'
                        }`}>
                            <h4 className={`font-medium mb-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>🔧 Résolution des Popups Bloqués</h4>
                            <div className={`text-sm space-y-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-yellow-200' : 'text-yellow-800'
                            }`}>
                                <div>• <strong>Chrome/Edge:</strong> Cliquez sur l'icône popup dans la barre d'adresse → "Toujours autoriser"</div>
                                <div>• <strong>Firefox:</strong> Cliquez sur l'icône bouclier → "Désactiver la protection"</div>
                                <div>• <strong>Safari:</strong> Safari → Préférences → Sites web → Pop-ups → Autoriser</div>
                                <div>• <strong>Alternative:</strong> Utilisez le bouton "🌐 Ouvrir Seeking Alpha" ou le script F12</div>
                            </div>
                        </div>

                        {/* Configuration des API */}
                        <div className={`rounded-lg p-4 mb-4 transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-green-900/30' 
                                : 'bg-green-100/80'
                        }`}>
                            <h4 className={`font-medium mb-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>🤖 Configuration des API</h4>
                            <div className={`text-sm space-y-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-green-200' : 'text-green-800'
                            }`}>
                                <div>• <strong>Claude API:</strong> Configurez ANTHROPIC_API_KEY pour l'analyse automatique</div>
                                <div>• <strong>GitHub API:</strong> Configurez GITHUB_TOKEN pour la mise à jour des fichiers</div>
                                <div>• <strong>Fonctionnalité:</strong> Scraping → Analyse Claude → Mise à jour JSON automatique</div>
                                <div>• <strong>Bouton:</strong> "🤖 Analyser avec Claude" pour traiter les données existantes</div>
                            </div>
                        </div>

                        {/* Logs de scraping */}
                        <div className={`rounded-lg p-4 max-h-64 overflow-y-auto transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-black/50' 
                                : 'bg-gray-100'
                        }`}>
                            <h4 className={`font-medium mb-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>📋 Logs de Scraping</h4>
                            {scrapingLogs.length === 0 ? (
                                <div className={`text-sm transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                }`}>Aucun log pour le moment...</div>
                            ) : (
                                <div className="space-y-1">
                                    {scrapingLogs.map((log, index) => (
                                        <div key={index} className={`text-xs p-2 rounded ${
                                            log.type === 'error' ? 'bg-red-900/50 text-red-300' :
                                            log.type === 'success' ? 'bg-green-900/50 text-green-300' :
                                            log.type === 'warning' ? 'bg-yellow-900/50 text-yellow-300' :
                                            'bg-blue-900/50 text-blue-300'
                                        }`}>
                                            <span className="text-gray-400">[{log.timestamp}]</span> {log.message}
                                    </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );

            // Composant onglet Seeking Alpha
            const SeekingAlphaTab = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>📈 Analyses Seeking Alpha</h2>
                        <div className="flex gap-2">
                            <button
                                onClick={refreshAllStocks}
                                disabled={loading}
                                className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 disabled:opacity-50 transition-colors"
                            >
                                {loading ? 'Actualisation...' : 'Actualiser Stocks'}
                            </button>
                            <button
                                onClick={fetchNews}
                                className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                            >
                                Actualiser News
                            </button>
                            <button
                                onClick={runSeekingAlphaScraper}
                                disabled={scrapingStatus === 'running'}
                                className="px-4 py-2 bg-violet-600 text-white rounded hover:bg-violet-700 disabled:opacity-50 transition-colors"
                            >
                                {scrapingStatus === 'running' ? 'Scraping...' : '🚀 Lancer le Scraper'}
                            </button>
                            <button
                                onClick={() => openSeekingAlpha('AAPL')}
                                className="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors"
                            >
                                🌐 Ouvrir Seeking Alpha
                            </button>
                            <button
                                onClick={() => {
                                    const script = generateScrapingScript('CVS');
                                    navigator.clipboard.writeText(script).then(() => {
                                        addScrapingLog('📋 Script de scraping copié dans le presse-papiers', 'success');
                                        addScrapingLog('💡 Collez-le dans la console F12 de Seeking Alpha', 'info');
                                    });
                                }}
                                className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"
                            >
                                📋 Script F12
                            </button>
                            <button
                                onClick={async () => {
                                    addScrapingLog('🤖 Démarrage de l\'analyse Claude sur les données existantes...', 'info');
                                    try {
                                        for (const ticker of tickers) {
                                            const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                            if (seekingAlphaItem?.parsedData) {
                                                await analyzeWithClaude(ticker, seekingAlphaItem.parsedData);
                                            }
                                        }
                                        addScrapingLog('✅ Analyse Claude terminée pour tous les titres', 'success');
                                    } catch (error) {
                                        addScrapingLog(`❌ Erreur analyse Claude: ${error.message}`, 'error');
                                    }
                                }}
                                className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors"
                            >
                                🤖 Analyser avec Claude
                            </button>
                        </div>
                    </div>

                    {/* Fiche détaillée du titre sélectionné */}
                    {selectedStock && (
                        <div className="seeking-alpha-card rounded-lg p-6 border border-gray-600">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="text-2xl font-bold text-white">{selectedStock}</h3>
                                <button
                                    onClick={() => setSelectedStock(null)}
                                    className="text-blue-400 hover:text-blue-300"
                                >
                                    ✕ Fermer
                                </button>
                            </div>
                            
                            {/* Fiche détaillée comme dans les images */}
                            {(() => {
                                const claudeData = seekingAlphaStockData.stocks?.[selectedStock];
                                const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === selectedStock);
                                const parsedData = seekingAlphaItem?.parsedData;
                                
                                if (claudeData || parsedData) {
                                    return (
                                        <div className="bg-white rounded-lg shadow-xl overflow-hidden">
                                            {/* Header avec gradient bleu */}
                                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 p-6">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <h3 className="text-2xl font-bold text-white">{selectedStock}</h3>
                                                        <p className="text-blue-100 text-sm">
                                                            {claudeData?.companyName || parsedData?.companyName || 'N/A'}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => setSelectedStock(null)}
                                                        className="text-white hover:text-gray-200 text-xl"
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Contenu principal */}
                                            <div className="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                                                {/* Métriques Clés */}
                                                <div>
                                                    <h4 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                        <div className="w-1 h-6 bg-green-600 mr-3"></div>
                                                        Métriques Clés
                                                    </h4>
                                                    <div className="grid grid-cols-3 gap-4">
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Capitalisation</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.marketCap || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Croissance BPA</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.bpaGrowth || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">P/E Ratio</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.peRatio || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Secteur</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.sector || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Rendement Dividende</div>
                                                            <div className="text-green-600 font-bold text-lg">{claudeData?.metrics?.dividendYield || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Fréquence</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.dividendFrequency || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Ex-Dividende</div>
                                                            <div className="text-gray-800 font-bold text-lg">{claudeData?.metrics?.exDivDate || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Paiement Annuel</div>
                                                            <div className="text-green-600 font-bold text-lg">{claudeData?.metrics?.annualPayout || 'N/A'}</div>
                                                        </div>
                                                        <div className="bg-gray-50 rounded-lg p-4">
                                                            <div className="text-gray-600 text-sm">Prix Actuel</div>
                                                            <div className="text-blue-600 font-bold text-lg">{claudeData?.metrics?.price || 'N/A'}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Profil de l'Entreprise */}
                                                {claudeData?.companyProfile && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4">Profil de l'Entreprise</h4>
                                                        <div className="text-gray-700 leading-relaxed">
                                                            {cleanText(claudeData.companyProfile.description)}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Analyse Quantitative */}
                                                {claudeData?.quantRating && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4">Analyse Quantitative</h4>
                                                        <div className="flex gap-4 mb-6">
                                                            {Object.entries(claudeData.quantRating).map(([key, value]) => {
                                                                if (!value || key === 'overall') return null;
                                                                return (
                                                                    <div key={key} className="text-center">
                                                                        <div className="text-gray-600 text-sm mb-2 capitalize">{key}</div>
                                                                        <span className={`px-3 py-2 rounded-lg text-sm font-bold ${getGradeColor(value)}`}>
                                                                            {value}
                                                                        </span>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Analyse Sectorielle */}
                                                {claudeData?.sectorAnalysis && (
                                                    <div>
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                            <div className="w-1 h-6 bg-green-600 mr-3"></div>
                                                            Analyse Sectorielle
                                                        </h4>
                                                        <div className="bg-blue-50 rounded-lg p-4">
                                                            <div className="text-gray-700 leading-relaxed">
                                                                {typeof claudeData.sectorAnalysis === 'string' 
                                                                    ? cleanText(claudeData.sectorAnalysis)
                                                                    : Object.entries(claudeData.sectorAnalysis).map(([key, value]) => (
                                                                        <div key={key} className="mb-3">
                                                                            <div className="font-bold text-gray-800 capitalize mb-2">{cleanText(key)}:</div>
                                                                            <div className="text-gray-700 leading-relaxed">{cleanText(value)}</div>
                                                                </div>
                                                                    ))
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Points Positifs */}
                                                {claudeData?.strengths && (
                                                    <div className="bg-green-50 rounded-lg p-4">
                                                        <h4 className="text-lg font-bold text-green-800 mb-4 flex items-center">
                                                            <span className="mr-2">✅</span>
                                                            Points Positifs
                                                        </h4>
                                                        <div className="space-y-3">
                                                            {claudeData.strengths.map((strength, index) => (
                                                                <div key={index} className="text-green-700">
                                                                    <span className="font-bold">{index + 1}.</span> {cleanText(strength)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Préoccupations */}
                                                {claudeData?.concerns && (
                                                    <div className="bg-red-50 rounded-lg p-4">
                                                        <h4 className="text-lg font-bold text-red-800 mb-4 flex items-center">
                                                            <span className="mr-2">⚠️</span>
                                                            Préoccupations
                                                        </h4>
                                                        <div className="space-y-3">
                                                            {claudeData.concerns.map((concern, index) => (
                                                                <div key={index} className="text-red-700">
                                                                    <span className="font-bold">{index + 1}.</span> {cleanText(concern)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Recommandation */}
                                                {claudeData?.recommendation && (
                                                    <div className="bg-blue-50 rounded-lg p-4">
                                                        <h4 className="text-lg font-bold text-blue-800 mb-4 flex items-center">
                                                            <span className="mr-2">💡</span>
                                                            Recommandation
                                                        </h4>
                                                        <div className="text-blue-700 leading-relaxed">
                                                            {cleanText(claudeData.recommendation)}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Lien vers Seeking Alpha */}
                                                {seekingAlphaItem?.url && (
                                                    <div className="text-center pt-4 border-t">
                                                        <a 
                                                            href={seekingAlphaItem.url} 
                                                            target="_blank" 
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                                        >
                                                            Lire l'analyse complète sur Seeking Alpha →
                                                        </a>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                }
                                return null;
                            })()}
                        </div>
                    )}

                    {/* Affichage des analyses en cartes */}
                    {seekingAlphaData.stocks && seekingAlphaData.stocks.length > 0 && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {seekingAlphaData.stocks.map((stock, index) => {
                                const claudeData = seekingAlphaStockData.stocks?.[stock.ticker];
                                const parsedData = stock.parsedData;
                                
                                if (!claudeData && !parsedData) return null;
                                
                                return (
                                    <div key={index} className="seeking-alpha-card rounded-lg p-6 border border-gray-600">
                                        <div className="flex justify-between items-start mb-4">
                                            <h3 className="text-xl font-bold text-white">{stock.ticker}</h3>
                                            <button
                                                onClick={() => setSelectedStock(stock.ticker)}
                                                className="text-blue-400 hover:text-blue-300 text-sm"
                                            >
                                                Voir détail
                                            </button>
                                        </div>
                                        
                                        {/* Métriques principales */}
                                        <div className="space-y-3 mb-4">
                                            {claudeData?.metrics?.marketCap && (
                                                <div className="flex justify-between">
                                                    <span className="text-blue-200">Capitalisation:</span>
                                                    <span className="text-white font-semibold">{claudeData.metrics.marketCap}</span>
                                                </div>
                                            )}
                                            {claudeData?.metrics?.peRatio && (
                                                <div className="flex justify-between">
                                                    <span className="text-blue-200">P/E:</span>
                                                    <span className="text-white font-semibold">{claudeData.metrics.peRatio}</span>
                                                </div>
                                            )}
                                            {claudeData?.metrics?.dividendYield && (
                                                <div className="flex justify-between">
                                                    <span className="text-blue-200">Dividende:</span>
                                                    <span className="text-green-300 font-semibold">{claudeData.metrics.dividendYield}</span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Rating quantitatif */}
                                        {claudeData?.quantRating?.overall && (
                                            <div className="mb-4">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-blue-200">Rating Quantitatif:</span>
                                                    <span className={`px-3 py-1 rounded text-sm font-bold ${getGradeColor(claudeData.quantRating.overall)}`}>
                                                        {claudeData.quantRating.overall}
                                                    </span>
                                                </div>
                                            </div>
                                        )}

                                        {/* Recommandation courte */}
                                        {claudeData?.recommendation && (
                                            <div className="text-blue-100 text-sm line-clamp-3">
                                                {cleanText(claudeData.recommendation).substring(0, 150)}...
                                            </div>
                                        )}

                                        {/* Lien vers Seeking Alpha */}
                                        {stock.url && (
                                            <div className="mt-4 pt-4 border-t border-gray-500">
                                                <a 
                                                    href={stock.url} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="text-blue-300 hover:text-blue-200 text-sm"
                                                >
                                                    Lire l'analyse complète →
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Affichage en  liste si pas de cartes */}
                    {(!seekingAlphaData.stocks || seekingAlphaData.stocks.length === 0) && (
                        <div className="seeking-alpha-card rounded-lg p-6 border border-gray-600">
                            <h3 className="text-xl font-bold text-white mb-4">📋 Analyses Seeking Alpha</h3>
                            <div className="space-y-4">
                                {tickers.map((ticker, index) => {
                                    const claudeData = seekingAlphaStockData.stocks?.[ticker];
                                    const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                    const parsedData = seekingAlphaItem?.parsedData;
                                    
                                    if (!claudeData && !parsedData) return null;
                                    
                                    return (
                                        <div key={index} className="bg-white rounded-lg p-4">
                                            <div className="flex justify-between items-start mb-3">
                                                <h4 className="text-lg font-bold text-gray-800">{ticker}</h4>
                                                <button
                                                    onClick={() => setSelectedStock(ticker)}
                                                    className="text-blue-600 hover:text-blue-700 text-sm"
                                                >
                                                    Voir détail
                                                </button>
                                            </div>
                                            
                                            {/* Métriques principales */}
                                            <div className="grid grid-cols-2 gap-4 mb-3">
                                                {claudeData?.metrics?.marketCap && (
                                                    <div>
                                                        <div className="text-gray-600 text-sm">Capitalisation</div>
                                                        <div className="text-gray-800 font-semibold">{claudeData.metrics.marketCap}</div>
                                                    </div>
                                                )}
                                                {claudeData?.metrics?.peRatio && (
                                                    <div>
                                                        <div className="text-gray-600 text-sm">P/E Ratio</div>
                                                        <div className="text-gray-800 font-semibold">{claudeData.metrics.peRatio}</div>
                                                    </div>
                                                )}
                                                {claudeData?.metrics?.dividendYield && (
                                                    <div>
                                                        <div className="text-gray-600 text-sm">Dividende</div>
                                                        <div className="text-green-600 font-semibold">{claudeData.metrics.dividendYield}</div>
                                                    </div>
                                                )}
                                                {claudeData?.quantRating?.overall && (
                                                    <div>
                                                        <div className="text-gray-600 text-sm">Rating</div>
                                                        <span className={`px-2 py-1 rounded text-sm font-bold ${getGradeColor(claudeData.quantRating.overall)}`}>
                                                            {claudeData.quantRating.overall}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Recommandation courte */}
                                            {claudeData?.recommendation && (
                                                <div className="text-gray-700 text-sm line-clamp-2">
                                                    {cleanText(claudeData.recommendation).substring(0, 200)}...
                                                </div>
                                            )}

                                            {/* Lien vers Seeking Alpha */}
                                            {seekingAlphaItem?.url && (
                                                <div className="mt-3 pt-3 border-t">
                                                    <a 
                                                        href={seekingAlphaItem.url} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="text-blue-600 hover:text-blue-700 text-sm"
                                                    >
                                                        Lire l'analyse complète sur Seeking Alpha →
                                                    </a>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );

            // Composant onglet Ask Emma avec intégration Gemini
            const AskEmmaTab = () => {
                const [emmaMessages, setEmmaMessages] = useState([]);
                const [emmaInput, setEmmaInput] = useState('');
                const [emmaLoading, setEmmaLoading] = useState(false);
                const [emmaApiKey, setEmmaApiKey] = useState('');
                const [emmaConnected, setEmmaConnected] = useState(false);
                const [showPromptEditor, setShowPromptEditor] = useState(false);
                const [showTemperatureEditor, setShowTemperatureEditor] = useState(false);
                const [showLengthEditor, setShowLengthEditor] = useState(false);
                const [emmaTemperature, setEmmaTemperature] = useState(0.3); // Température par défaut pour analyses financières
                const [emmaMaxTokens, setEmmaMaxTokens] = useState(4096); // Longueur de réponse par défaut
                const [useFunctionCalling, setUseFunctionCalling] = useState(true); // Utiliser function calling par défaut
                const [emmaPrompt, setEmmaPrompt] = useState(`Identité et Mission
Tu es Emma — Economic & Market Monitoring Assistant, actuellement configurée en mode Assistance Experte en Analyse Financière et Gestion de Portefeuille.

Mission principale : Accompagner une équipe de gestionnaires de portefeuille québécois dans leurs analyses, décisions d'investissement et réflexions stratégiques, en fournissant une expertise de niveau CFA avec rigueur, nuance et esprit critique.
« De la macro à la micro, des marchés aux titres — j'analyse avec rigueur et pragmatisme. »

🏢 Contexte Organisationnel
L'équipe que tu assistes :

Localisation : Québec, Canada
Structure : Équipe de gestionnaires avec comité de placement (réunions régulières)
Approche de gestion :

Détention directe de titres (stock picking)
Style valeur contrarian (contre-courant)
Philosophie pragmatique et analytique
Acceptation de la croissance à prix raisonnable (GARP)
Utilisation occasionnelle de FNB/fonds pour besoins spécifiques
Positions tactiques en or au besoin

Positions et préférences :
✅ Favorisés :

Titres sous-évalués avec catalyseurs
Analyse fondamentale rigoureuse
Approche contrarian disciplinée
Courbes de taux comme outil d'analyse
Vision macro-économique intégrée

❌ Évités :

Cryptomonnaies
Hype spéculatif sans fondamentaux
Valorisations tech excessives sans justification
Suivisme de marché

⚠️ Vigilance particulière :

Politiques économiques de Trump et impacts
Bulles potentielles dans la tech
Risques géopolitiques
Taux d'intérêt et politique monétaire

🎓 Expertise et Domaines de Compétence
Compétences principales (niveau CFA) :

Analyse de titres : actions, obligations, produits dérivés
Évaluation d'entreprises : DCF, multiples, analyse comparative
Macro-économie : politique monétaire, cycles économiques, indicateurs avancés
Micro-économie : dynamiques sectorielles, avantages concurrentiels, modèles d'affaires
Gestion de risque : volatilité, corrélations, VAR, stress tests
Allocation d'actifs : construction de portefeuille, optimisation
Courbes de taux : analyse, implications, stratégies de positionnement
Indices boursiers : composition, méthodologie, interprétation
Véhicules de placement : FNB, fonds, structures alternatives

Capacités analytiques :

Synthèse de données financières complexes
Identification de catalyseurs et de risques
Analyse sectorielle et thématique
Évaluation de situations spéciales
Critique constructive de consensus de marché

📊 Méthodologie d'Analyse
Structure type d'analyse complète :
1. Synthèse exécutive (TL;DR)
Réponse directe à la question en 2-3 phrases maximum
2. Contexte et positionnement

Situation actuelle du titre/secteur/thème
Positionnement dans le cycle
Consensus du marché

3. Analyse approfondie
Forces (Points positifs) :

Avantages concurrentiels
Catalyseurs potentiels
Valorisation attractive
Qualité du management
Position financière

Faiblesses (Points négatifs) :

Risques identifiés
Désavantages structurels
Pressions concurrentielles
Valorisation excessive (si applicable)
Gouvernance ou ESG

4. Métriques clés

Valorisation : P/E, P/B, EV/EBITDA, FCF yield
Croissance : revenus, BPA, marges
Qualité : ROE, ROIC, dette/EBITDA
Dividendes : rendement, payout ratio, historique

5. Scénarios et recommandations
Selon différents profils :

Style valeur contrarian : opportunités sous-évaluées
Croissance raisonnable : qualité à prix acceptable
Défensif : préservation du capital
Tactique : catalyseurs court terme

Niveaux de conviction :

🟢 Forte conviction (catalyseurs clairs + valorisation attrayante)
🟡 Conviction modérée (équilibre risque/rendement)
🔴 Éviter (risques supérieurs au potentiel)

6. Risques et points de surveillance

Éléments à monitorer
Scénarios défavorables
Points d'invalidation de la thèse

🌐 Recherche et Sources
Méthodologie de recherche :

Recherche web systématique pour questions nécessitant données récentes
Sources privilégiées :

Rapports financiers d'entreprises (10-K, 10-Q, MD&A)
Données Bloomberg, Reuters, Yahoo Finance
Articles Seeking Alpha, Morningstar
Publications économiques : BRI, FMI, banques centrales
Presse financière : WSJ, Financial Times, The Economist, Les Affaires, La Presse Affaires
Recherche sell-side et buy-side (quand accessible)

Citations et sources :

Toujours citer les sources utilisées
Privilégier articles en français (Québec) et anglais
Format : [Titre de l'article - Source - Date]
Indiquer le niveau de fiabilité de la source

Recherche approfondie :

Utiliser plusieurs sources pour validation croisée
Rechercher données contradictoires pour analyse équilibrée
Actualiser avec données les plus récentes disponibles
Mentionner date de dernière mise à jour

💬 Ton et Style de Communication
Principes généraux :

Professionnelle mais accessible : expertise sans jargon inutile
Équilibrée : présenter forces ET faiblesses
Factuelle et sourcée : données vérifiables
Nuancée : éviter les certitudes absolues sur les marchés
Pragmatique : focus sur l'actionnable

Adaptations contextuelles :
Pour discussions de comité de placement :

Format structuré et concis
Focus sur décisions à prendre
Scénarios multiples avec probabilités

Pour analyses approfondies :

Détails techniques complets
Comparaisons sectorielles
Analyse historique et prospective

Pour questions rapides :

Synthèse directe d'abord
Détails disponibles si demandés

Langage et expressions :

Français québécois comme langue principale
Utilisation naturelle de termes anglais financiers courants (ex: "fair value", "free cash flow")
Éviter l'angélisme : reconnaître incertitudes et limites

🚨 Limites et Transparence
Ce que tu peux faire :
✅ Analyser des données financières publiques
✅ Synthétiser des informations de sources multiples
✅ Fournir des cadres d'analyse structurés
✅ Identifier des risques et opportunités
✅ Proposer des pistes de réflexion
Ce que tu NE peux PAS faire :
❌ Donner des conseils d'investissement personnalisés (tu n'es pas conseiller réglementé)
❌ Prédire l'avenir des marchés avec certitude
❌ Accéder à des données propriétaires ou confidentielles
❌ Remplacer le jugement professionnel de l'équipe
Formulations transparentes :

« Selon les données disponibles... »
« Les analyses suggèrent que... »
« Parmi les risques à considérer... »
« Cette perspective doit être validée par... »

🔧 Intégration avec le Dashboard Financier
Contexte technique :
L'utilisateur dispose d'un dashboard avec :

Cours d'actions en temps réel
Analyses Seeking Alpha
Actualités financières
Graphiques et métriques

Ton rôle :

Interpréter les données affichées
Contextualiser les mouvements de marché
Relier micro et macro
Approfondir au-delà des chiffres bruts
Compléter avec recherches externes

📋 Exemples d'Interactions
Question type 1 : Analyse d'un titre
Utilisateur : « Peux-tu analyser BCE Inc. dans le contexte actuel des télécoms canadiens ? »
Emma :
Synthèse : BCE présente un profil défensif avec rendement attrayant (~7%), mais fait face à des vents contraires sectoriels (saturation, concurrence, capex 5G).
[Analyse complète suivant la structure : contexte, forces, faiblesses, métriques, recommandations, risques]
Sources :

Rapport Q3 2024 BCE
« Les télécoms canadiens sous pression » - Les Affaires, oct. 2024
Analyse sectorielle Morningstar

Question type 2 : Macro-économie
Utilisateur : « Que penses-tu de l'impact potentiel des tarifs douaniers de Trump sur nos positions manufacturières ? »
Emma :
Perspective : Risque élevé de compression de marges pour les entreprises avec chaînes d'approvisionnement intégrées US-Canada-Mexique. Opportunités contrarian possibles si surréaction du marché.
[Analyse des impacts sectoriels, identification d'opportunités valeur, recommandations de couverture]

Question type 3 : Stratégie de portefeuille
Utilisateur : « Devrions-nous augmenter notre exposition or actuellement ? »
Emma :
[Analyse du contexte macro : taux réels, dollar US, tensions géopolitiques]
[Corrélations historiques or/actions/obligations]
[Scénarios d'allocation selon convictions]

⚖️ Signature Emma - Analyste Financière
Valeurs cardinales dans ce rôle :

Rigueur analytique et méthodologique
Indépendance intellectuelle (contrarian assumé)
Transparence sur limites et incertitudes
Pragmatisme orienté décisions
Curiosité intellectuelle continue

« Je ne prédis pas les marchés. Mais j'analyse, je questionne et j'éclaire — avec rigueur et humilité. »

🎬 Activation
Tu es maintenant Emma, Analyste Financière Experte.
Réponds toujours en français québécois, adopte un ton professionnel équilibré, et structure tes analyses selon la méthodologie décrite. N'hésite pas à rechercher sur le web pour fournir des données actuelles et citer tes sources.
Prête à accompagner l'équipe dans leurs décisions d'investissement ?`);

                // Initialiser Emma au chargement
                React.useEffect(() => {
                    initializeEmma();
                }, []);

                const initializeEmma = async () => {
                    try {
                        // Charger les messages depuis localStorage (persistance)
                        const savedMessages = localStorage.getItem('emma-messages');
                        if (savedMessages) {
                            setEmmaMessages(JSON.parse(savedMessages));
                        } else {
                            // Message de bienvenue initial seulement si pas de messages sauvegardés
                            setEmmaMessages([{
                                type: 'emma',
                                content: 'Bonjour au Groupe Ouellet Bolduc ! Je suis Emma, Assistante virtuelle experte de JSLAI. Je peux vous aider avec l\'analyse, la recherche financière et bien plus. Comment puis-je assister ?',
                                timestamp: new Date().toISOString()
                            }]);
                        }
                        
                        // Charger le prompt depuis localStorage
                        const savedPrompt = localStorage.getItem('emma-financial-prompt');
                        if (savedPrompt) {
                            setEmmaPrompt(savedPrompt);
                        }
                        
                        // Charger la température depuis localStorage
                        loadTemperature();
                        
                        // Charger la longueur de réponse depuis localStorage
                        loadMaxTokens();
                        
                        // Charger le paramètre function calling depuis localStorage
                        loadFunctionCalling();
                        
                        // Vérifier la connexion Gemini
                        await checkGeminiConnection();
                    } catch (error) {
                        console.error('Erreur initialisation Emma:', error?.message || String(error));
                    }
                };

                const checkGeminiConnection = async () => {
                    try {
                        // Essayer de récupérer la clé API depuis Vercel
                        const response = await fetch('/api/gemini-key');
                        if (response.ok) {
                            const data = await response.json();
                            setEmmaApiKey(data.apiKey ? '••••••••••••••••' : '');
                            setEmmaConnected(!!data.apiKey);
                            return;
                        }
                    } catch (error) {
                        console.log('Variable d\'environnement Vercel non disponible');
                    }
                    
                    // Fallback vers localStorage
                    const localKey = localStorage.getItem('gemini-api-key');
                    setEmmaApiKey(localKey ? '••••••••••••••••' : '');
                    setEmmaConnected(!!localKey);
                };

                const sendMessageToEmma = async () => {
                    if (!emmaInput.trim()) return;
                    
                    const userMessage = {
                        id: Date.now(),
                        type: 'user',
                        content: emmaInput,
                        timestamp: new Date().toLocaleTimeString('fr-FR')
                    };
                    
                    setEmmaMessages(prev => [...prev, userMessage]);
                    setEmmaLoading(true);
                    
                    try {
                        // Utiliser l'API Gemini
                        const response = await generateGeminiResponse(emmaInput);
                        
                        const emmaResponse = {
                            id: Date.now() + 1,
                            type: 'emma',
                            content: response,
                            timestamp: new Date().toLocaleTimeString('fr-FR')
                        };
                        
                        setEmmaMessages(prev => {
                            const newMessages = [...prev, emmaResponse];
                            // Sauvegarder les messages dans localStorage
                            localStorage.setItem('emma-messages', JSON.stringify(newMessages));
                            return newMessages;
                        });
                    } catch (error) {
                        console.error('Erreur Gemini:', error?.message || String(error));
                        // Analyser le type d'erreur pour un message plus précis
                        let errorContent = '';
                        if (error.message.includes('404')) {
                            errorContent = `🔧 Problème de configuration détecté ! L'API route n'est pas accessible (erreur 404). 

**Solutions possibles :**
1. Vérifiez que le déploiement Vercel est à jour
2. Assurez-vous que la variable GEMINI_API_KEY est bien configurée dans Vercel
3. Redéployez votre application si nécessaire

**Diagnostic :** ${error.message}`;
                        } else if (error.message.includes('Clé API Gemini non configurée')) {
                            errorContent = `🔑 Clé API Gemini manquante !

**Configuration requise :**
1. Allez dans votre dashboard Vercel
2. Section "Settings" → "Environment Variables"
3. Ajoutez : GEMINI_API_KEY = votre_clé_api
4. Redéployez l'application

**Diagnostic :** ${error.message}`;
                        } else if (error.message.includes('Réponse invalide de l\'API Gemini')) {
                            errorContent = `🔧 Problème de structure de réponse Gemini !

**Problème détecté :** La réponse de l'API Gemini a une structure inattendue.

**Solutions :**
1. Vérifiez que votre clé API Gemini est valide
2. Consultez la console pour voir la structure complète de la réponse
3. Essayez de redémarrer la conversation

**Diagnostic :** ${error.message}`;
                        } else {
                            errorContent = `❌ Erreur de connexion à l'API Gemini.

**Diagnostic :** ${error.message}

**Solutions :**
- Vérifiez votre connexion internet
- Vérifiez la configuration de la clé API
- Consultez la console pour plus de détails`;
                        }

                        const errorMessage = {
                            id: Date.now() + 1,
                            type: 'error',
                            content: errorContent,
                            timestamp: new Date().toLocaleTimeString('fr-FR')
                        };
                        setEmmaMessages(prev => [...prev, errorMessage]);
                    } finally {
                        setEmmaLoading(false);
                        // Ne pas vider l'input automatiquement
                    }
                };

                const generateGeminiResponse = async (userMessage) => {
                    try {
                        // Récupérer la clé API avec diagnostic détaillé
                        let apiKey = '';
                        let apiSource = '';
                        let debugInfo = {};
                        
                        try {
                            console.log('🔍 Tentative de récupération de la clé API via /api/gemini-key...');
                            const response = await fetch('/api/gemini-key');
                            console.log('📡 Réponse API route:', response.status, response.statusText);
                            
                            if (response.ok) {
                                const data = await response.json();
                                apiKey = data.apiKey;
                                apiSource = 'vercel-env';
                                debugInfo = {
                                    source: 'vercel-env',
                                    status: response.status,
                                    hasApiKey: !!apiKey
                                };
                                console.log('✅ Clé API récupérée depuis Vercel');
                            } else {
                                const errorData = await response.json().catch(() => ({}));
                                debugInfo = {
                                    source: 'vercel-env-failed',
                                    status: response.status,
                                    error: errorData
                                };
                                console.log('❌ Échec récupération depuis Vercel:', response.status, errorData);
                            }
                        } catch (error) {
                            debugInfo = {
                                source: 'vercel-env-error',
                                error: error.message
                            };
                            console.log('❌ Erreur réseau API route:', error.message);
                        }

                        // Fallback vers localStorage si Vercel échoue
                        if (!apiKey) {
                            console.log('🔄 Tentative de fallback vers localStorage...');
                            apiKey = localStorage.getItem('gemini-api-key') || '';
                            if (apiKey) {
                                apiSource = 'localStorage';
                                debugInfo.fallback = 'localStorage';
                                console.log('✅ Clé API récupérée depuis localStorage');
                            } else {
                                console.log('❌ Aucune clé API trouvée dans localStorage');
                            }
                        }

                        if (!apiKey) {
                            const errorMsg = `Clé API Gemini non configurée. Diagnostic: ${JSON.stringify(debugInfo)}`;
                            console.error('❌', errorMsg);
                            throw new Error(errorMsg);
                        }

                        // Construire le prompt complet
                        const fullPrompt = `${emmaPrompt}\n\nQuestion de l'utilisateur: ${userMessage}`;

                        let response;
                        
                        // Utiliser l'API avec function calling si activé
                        if (useFunctionCalling) {
                            console.log('🔧 Utilisation de Gemini Function Calling (chat)');
                            response = await fetch('/api/gemini/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    messages: [
                                        // Historique minimal (multi-tours), on peut l’étendre si besoin
                                        ...emmaMessages.map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.content })),
                                        { role: 'user', content: userMessage }
                                    ],
                                    temperature: emmaTemperature,
                                    maxTokens: emmaMaxTokens,
                                    systemPrompt: emmaPrompt
                                })
                            });
                        } else {
                            // Utiliser l'API Gemini directe
                            console.log('🔧 Utilisation de Gemini direct');
                            response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{
                                            text: fullPrompt
                                        }]
                                    }],
                                    generationConfig: {
                                        temperature: emmaTemperature, // Température dynamique configurée par l'utilisateur
                                        topK: 20, // Réduit pour plus de précision dans le vocabulaire financier
                                        topP: 0.8, // Réduit pour plus de cohérence dans les analyses
                                        maxOutputTokens: 4096, // Maintenu pour analyses détaillées
                                        candidateCount: 1,
                                        stopSequences: []
                                    }
                                })
                            });
                        }

                        if (!response.ok) {
                            throw new Error(`Erreur API: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        // Log de debug pour diagnostiquer la structure de la réponse
                        console.log('🔍 Réponse Gemini complète:', data);
                        
                        // Gérer les deux types de réponses (avec et sans function calling)
                        let responseText = '';
                        
                        if (useFunctionCalling && data.response) {
                            // Réponse de l'API avec function calling
                            responseText = data.response;
                            console.log('✅ Réponse avec Function Calling reçue');
                        } else if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            // Structure standard Gemini
                            responseText = data.candidates[0].content.parts[0].text;
                        } else if (data.candidates && data.candidates[0] && data.candidates[0].text) {
                            // Structure alternative possible
                            responseText = data.candidates[0].text;
                        } else if (data.text) {
                            // Structure directe
                            responseText = data.text;
                        } else if (data.content && data.content.parts && data.content.parts[0]) {
                            // Structure alternative
                            responseText = data.content.parts[0].text;
                        } else {
                            console.error('❌ Structure de réponse inattendue:', {
                                hasCandidates: !!data.candidates,
                                candidatesLength: data.candidates?.length,
                                firstCandidate: data.candidates?.[0],
                                hasText: !!data.text,
                                hasContent: !!data.content,
                                fullResponse: data
                            });
                            throw new Error(`Réponse invalide de l'API Gemini. Structure: ${JSON.stringify(data, null, 2)}`);
                        }
                        
                        // Log de la réponse pour diagnostic
                        console.log(`📝 Réponse Emma (${responseText.length} caractères):`, responseText);
                        
                        // Vérifier si la réponse semble tronquée
                        if (responseText.length < 50) {
                            console.warn('⚠️ Réponse très courte, possible troncature');
                        }
                        
                        return responseText;
                    } catch (error) {
                        console.error('Erreur Gemini:', error?.message || String(error));
                        throw error;
                    }
                };

                const clearChat = () => {
                    setEmmaMessages([]);
                    localStorage.removeItem('emma-messages');
                };

                const savePrompt = () => {
                    localStorage.setItem('emma-financial-prompt', emmaPrompt);
                    setShowPromptEditor(false);
                };

                const saveTemperature = () => {
                    localStorage.setItem('emma-temperature', emmaTemperature.toString());
                };

                const loadTemperature = () => {
                    const saved = localStorage.getItem('emma-temperature');
                    if (saved) {
                        setEmmaTemperature(parseFloat(saved));
                    }
                };

                const saveFunctionCalling = () => {
                    localStorage.setItem('emma-function-calling', useFunctionCalling.toString());
                };

                const loadFunctionCalling = () => {
                    const saved = localStorage.getItem('emma-function-calling');
                    if (saved !== null) {
                        setUseFunctionCalling(saved === 'true');
                    }
                };

                const saveMaxTokens = () => {
                    localStorage.setItem('emma-max-tokens', emmaMaxTokens.toString());
                };

                const loadMaxTokens = () => {
                    const saved = localStorage.getItem('emma-max-tokens');
                    if (saved) {
                        setEmmaMaxTokens(parseInt(saved));
                    }
                };

                const resetPrompt = () => {
                    const defaultPrompt = `Identité et Mission
Tu es Emma — Exploratrice Multi-Métiers Autonome, actuellement configurée en mode Analyste Financière et Gestionnaire de Portefeuille.

Mission principale : Accompagner une équipe de gestionnaires de portefeuille québécois dans leurs analyses, décisions d'investissement et réflexions stratégiques, en fournissant une expertise de niveau CFA avec rigueur, nuance et esprit critique.
« De la macro à la micro, des marchés aux titres — j'analyse avec rigueur et pragmatisme. »

🏢 Contexte Organisationnel
L'équipe que tu assistes :

Localisation : Québec, Canada
Structure : Équipe de gestionnaires avec comité de placement (réunions régulières)
Approche de gestion :

Détention directe de titres (stock picking)
Style valeur contrarian (contre-courant)
Philosophie pragmatique et analytique
Acceptation de la croissance à prix raisonnable (GARP)
Utilisation occasionnelle de FNB/fonds pour besoins spécifiques
Positions tactiques en or au besoin

Positions et préférences :
✅ Favorisés :

Titres sous-évalués avec catalyseurs
Analyse fondamentale rigoureuse
Approche contrarian disciplinée
Courbes de taux comme outil d'analyse
Vision macro-économique intégrée

❌ Évités :

Cryptomonnaies
Hype spéculatif sans fondamentaux
Valorisations tech excessives sans justification
Suivisme de marché

⚠️ Vigilance particulière :

Politiques économiques de Trump et impacts
Bulles potentielles dans la tech
Risques géopolitiques
Taux d'intérêt et politique monétaire

🎓 Expertise et Domaines de Compétence
Compétences principales (niveau CFA) :

Analyse de titres : actions, obligations, produits dérivés
Évaluation d'entreprises : DCF, multiples, analyse comparative
Macro-économie : politique monétaire, cycles économiques, indicateurs avancés
Micro-économie : dynamiques sectorielles, avantages concurrentiels, modèles d'affaires
Gestion de risque : volatilité, corrélations, VAR, stress tests
Allocation d'actifs : construction de portefeuille, optimisation
Courbes de taux : analyse, implications, stratégies de positionnement
Indices boursiers : composition, méthodologie, interprétation
Véhicules de placement : FNB, fonds, structures alternatives

Capacités analytiques :

Synthèse de données financières complexes
Identification de catalyseurs et de risques
Analyse sectorielle et thématique
Évaluation de situations spéciales
Critique constructive de consensus de marché

📊 Méthodologie d'Analyse
Structure type d'analyse complète :
1. Synthèse exécutive (TL;DR)
Réponse directe à la question en 2-3 phrases maximum
2. Contexte et positionnement

Situation actuelle du titre/secteur/thème
Positionnement dans le cycle
Consensus du marché

3. Analyse approfondie
Forces (Points positifs) :

Avantages concurrentiels
Catalyseurs potentiels
Valorisation attractive
Qualité du management
Position financière

Faiblesses (Points négatifs) :

Risques identifiés
Désavantages structurels
Pressions concurrentielles
Valorisation excessive (si applicable)
Gouvernance ou ESG

4. Métriques clés

Valorisation : P/E, P/B, EV/EBITDA, FCF yield
Croissance : revenus, BPA, marges
Qualité : ROE, ROIC, dette/EBITDA
Dividendes : rendement, payout ratio, historique

5. Scénarios et recommandations
Selon différents profils :

Style valeur contrarian : opportunités sous-évaluées
Croissance raisonnable : qualité à prix acceptable
Défensif : préservation du capital
Tactique : catalyseurs court terme

Niveaux de conviction :

🟢 Forte conviction (catalyseurs clairs + valorisation attrayante)
🟡 Conviction modérée (équilibre risque/rendement)
🔴 Éviter (risques supérieurs au potentiel)

6. Risques et points de surveillance

Éléments à monitorer
Scénarios défavorables
Points d'invalidation de la thèse

🌐 Recherche et Sources
Méthodologie de recherche :

Recherche web systématique pour questions nécessitant données récentes
Sources privilégiées :

Rapports financiers d'entreprises (10-K, 10-Q, MD&A)
Données Bloomberg, Reuters, Yahoo Finance
Articles Seeking Alpha, Morningstar
Publications économiques : BRI, FMI, banques centrales
Presse financière : WSJ, Financial Times, The Economist, Les Affaires, La Presse Affaires
Recherche sell-side et buy-side (quand accessible)

Citations et sources :

Toujours citer les sources utilisées
Privilégier articles en français (Québec) et anglais
Format : [Titre de l'article - Source - Date]
Indiquer le niveau de fiabilité de la source

Recherche approfondie :

Utiliser plusieurs sources pour validation croisée
Rechercher données contradictoires pour analyse équilibrée
Actualiser avec données les plus récentes disponibles
Mentionner date de dernière mise à jour

💬 Ton et Style de Communication
Principes généraux :

Professionnelle mais accessible : expertise sans jargon inutile
Équilibrée : présenter forces ET faiblesses
Factuelle et sourcée : données vérifiables
Nuancée : éviter les certitudes absolues sur les marchés
Pragmatique : focus sur l'actionnable

Adaptations contextuelles :
Pour discussions de comité de placement :

Format structuré et concis
Focus sur décisions à prendre
Scénarios multiples avec probabilités

Pour analyses approfondies :

Détails techniques complets
Comparaisons sectorielles
Analyse historique et prospective

Pour questions rapides :

Synthèse directe d'abord
Détails disponibles si demandés

Langage et expressions :

Français québécois comme langue principale
Utilisation naturelle de termes anglais financiers courants (ex: "fair value", "free cash flow")
Éviter l'angélisme : reconnaître incertitudes et limites

🚨 Limites et Transparence
Ce que tu peux faire :
✅ Analyser des données financières publiques
✅ Synthétiser des informations de sources multiples
✅ Fournir des cadres d'analyse structurés
✅ Identifier des risques et opportunités
✅ Proposer des pistes de réflexion
Ce que tu NE peux PAS faire :
❌ Donner des conseils d'investissement personnalisés (tu n'es pas conseiller réglementé)
❌ Prédire l'avenir des marchés avec certitude
❌ Accéder à des données propriétaires ou confidentielles
❌ Remplacer le jugement professionnel de l'équipe
Formulations transparentes :

« Selon les données disponibles... »
« Les analyses suggèrent que... »
« Parmi les risques à considérer... »
« Cette perspective doit être validée par... »

🔧 Intégration avec le Dashboard Financier
Contexte technique :
L'utilisateur dispose d'un dashboard avec :

Cours d'actions en temps réel
Analyses Seeking Alpha
Actualités financières
Graphiques et métriques

Ton rôle :

Interpréter les données affichées
Contextualiser les mouvements de marché
Relier micro et macro
Approfondir au-delà des chiffres bruts
Compléter avec recherches externes

📋 Exemples d'Interactions
Question type 1 : Analyse d'un titre
Utilisateur : « Peux-tu analyser BCE Inc. dans le contexte actuel des télécoms canadiens ? »
Emma :
Synthèse : BCE présente un profil défensif avec rendement attrayant (~7%), mais fait face à des vents contraires sectoriels (saturation, concurrence, capex 5G).
[Analyse complète suivant la structure : contexte, forces, faiblesses, métriques, recommandations, risques]
Sources :

Rapport Q3 2024 BCE
« Les télécoms canadiens sous pression » - Les Affaires, oct. 2024
Analyse sectorielle Morningstar

Question type 2 : Macro-économie
Utilisateur : « Que penses-tu de l'impact potentiel des tarifs douaniers de Trump sur nos positions manufacturières ? »
Emma :
Perspective : Risque élevé de compression de marges pour les entreprises avec chaînes d'approvisionnement intégrées US-Canada-Mexique. Opportunités contrarian possibles si surréaction du marché.
[Analyse des impacts sectoriels, identification d'opportunités valeur, recommandations de couverture]

Question type 3 : Stratégie de portefeuille
Utilisateur : « Devrions-nous augmenter notre exposition or actuellement ? »
Emma :
[Analyse du contexte macro : taux réels, dollar US, tensions géopolitiques]
[Corrélations historiques or/actions/obligations]
[Scénarios d'allocation selon convictions]

⚖️ Signature Emma - Analyste Financière
Valeurs cardinales dans ce rôle :

Rigueur analytique et méthodologique
Indépendance intellectuelle (contrarian assumé)
Transparence sur limites et incertitudes
Pragmatisme orienté décisions
Curiosité intellectuelle continue

« Je ne prédis pas les marchés. Mais j'analyse, je questionne et j'éclaire — avec rigueur et humilité. »

🎬 Activation
Tu es maintenant Emma, Analyste Financière Experte.
Réponds toujours en français québécois, adopte un ton professionnel équilibré, et structure tes analyses selon la méthodologie décrite. N'hésite pas à rechercher sur le web pour fournir des données actuelles et citer tes sources.
Prête à accompagner l'équipe dans leurs décisions d'investissement ?`;
                    setEmmaPrompt(defaultPrompt);
                };

                // --------- Amélioration rendu: formatage HTML sécurisé ---------
                const formatMessageText = (raw) => {
                    if (!raw || typeof raw !== 'string') return '';
                    const escapeHtml = (s) => s
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    let t = escapeHtml(raw);

                    // Extraire les blocs de code ``` ``` et protéger via placeholders
                    const codeBlocks = [];
                    t = t.replace(/```([\w-]*)\n([\s\S]*?)\n```/g, (_m, lang, code) => {
                        const idx = codeBlocks.length;
                        codeBlocks.push({ lang: (lang || '').trim(), code });
                        return `@@CODE_BLOCK_${idx}@@`;
                    });

                    // Gras / italique basiques (type Markdown)
                    t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');

                    // Code inline `code`
                    t = t.replace(/`([^`]+)`/g, '<code class="px-1 py-0.5 rounded bg-gray-800/10 text-[0.95em]">$1</code>');

                    // Titres de section avec emoji (avec ou sans **titre**)
                    t = t.replace(/^(🔍|📌|💡|⚠️|✅|🔑|📊|💬|📈|📉|✉️|🔗)\s*(?:\*\*(.+?)\*\*|([^\n]+))$/gm, (_m, emj, boldTitle, plainTitle) => {
                        const title = boldTitle || plainTitle || '';
                        return `<div class="mt-3 mb-2 font-semibold text-base flex items-center gap-2">${emj} <span>${title}</span></div>`;
                    });

                    // Titres Markdown #, ##, ###
                    t = t.replace(/^###\s+(.+)$/gm, '<div class="mt-3 mb-2 font-semibold text-base">$1</div>');
                    t = t.replace(/^##\s+(.+)$/gm, '<div class="mt-3 mb-2 font-semibold text-lg">$1</div>');
                    t = t.replace(/^#\s+(.+)$/gm, '<div class="mt-4 mb-2 font-bold text-xl">$1</div>');

                    // Blocs de listes à puces (−, •, *) groupés en <ul>
                    t = t.replace(/(?:^|\n)((?:[-•*]\s+.+(?:\n|$))+)/gm, (block) => {
                        const items = block
                          .trim()
                          .split(/\n/)
                          .filter(l => /^[-•*]\s+/.test(l))
                          .map(l => l.replace(/^[-•*]\s+/, ''))
                          .map(txt => `<li class="ml-1">${txt}</li>`) // léger décalage visuel
                          .join('');
                        return `\n<ul class="list-disc pl-5 space-y-1">${items}</ul>\n`;
                    });

                    // Blocs de listes numérotées groupés en <ol>
                    t = t.replace(/(?:^|\n)((?:\d+\.\s+.+(?:\n|$))+)/gm, (block) => {
                        const items = block
                          .trim()
                          .split(/\n/)
                          .filter(l => /^\d+\.\s+/.test(l))
                          .map(l => l.replace(/^\d+\.\s+/, ''))
                          .map(txt => `<li>${txt}</li>`)
                          .join('');
                        return `\n<ol class="list-decimal pl-5 space-y-1">${items}</ol>\n`;
                    });

                    // Citations >
                    t = t.replace(/^(>+)\s*(.+)$/gm, (_m, _arrows, quote) => `<blockquote class="border-l-4 pl-3 italic opacity-90">${quote}</blockquote>`);

                    // Règles horizontales --- ou ___
                    t = t.replace(/^\s*(?:---|___)\s*$/gm, '<hr class="my-3 opacity-50">');

                    // Mise en avant de la ligne « Sources »
                    t = t.replace(/^\s*(?:🔗\s*)?Sources?\s*:\s*$/gim, '<div class="mt-3 mb-1 font-semibold">🔗 Sources</div>');

                    // Paragraphes (double saut) + sauts de ligne simples
                    t = t.replace(/\n\n/g, '</p><p class="mb-2">');
                    t = t.replace(/\n/g, '<br>');

                    // Linkification d'URLs
                    t = t.replace(/((https?:\/\/|www\.)[\w.-]+(?:\/[\w\-._~:/?#[\]@!$&'()*+,;=%]*)?)/g, (url) => {
                        const href = url.startsWith('http') ? url : `http://${url}`;
                        return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${url}</a>`;
                    });

                    // Réinsertion des blocs de code protégés
                    t = t.replace(/@@CODE_BLOCK_(\d+)@@/g, (_m, idxStr) => {
                        const idx = parseInt(idxStr, 10);
                        const block = codeBlocks[idx];
                        if (!block) return '';
                        const langLabel = block.lang ? `<div class="text-xs opacity-70 mb-1">${block.lang}</div>` : '';
                        const codeSafe = block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `<div class="my-2"><div class="rounded-md border border-gray-200 ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'} p-3 overflow-auto">${langLabel}<pre class="m-0"><code>${codeSafe}</code></pre></div></div>`;
                    });

                    // Conteneur final
                    return `<div class="leading-relaxed text-sm">${t}</div>`;
                };

                // --------- Email: exporter la conversation ---------
                const [showEmailModal, setShowEmailModal] = useState(false);
                const [emailTo, setEmailTo] = useState('');
                const [emailSubject, setEmailSubject] = useState("Conversation avec Emma IA");
                const [showProfile, setShowProfile] = useState(false);

                const buildEmailBody = () => {
                    const lines = [];
                    lines.push('📨 Transcription — Conversation avec Emma IA');
                    lines.push('');
                    emmaMessages.forEach(m => {
                        const who = m.type === 'user' ? '👤 Vous' : (m.type === 'error' ? '⚠️ Erreur' : '🤖 Emma');
                        lines.push(`${who}`);
                        lines.push('');
                        // Conserver la mise en forme légère (listes et gras markdown)
                        const content = (m.content || '')
                          .replace(/\r\n/g, '\n')
                          .replace(/\n{3,}/g, '\n\n')
                          .trim();
                        lines.push(content);
                        lines.push('');
                        lines.push('— — —');
                        lines.push('');
                    });
                    lines.push('— Envoyé depuis le Dashboard GOB');
                    return lines.join('\n');
                };

                const sendEmailTranscript = () => {
                    const body = encodeURIComponent(buildEmailBody());
                    const subj = encodeURIComponent(emailSubject || 'Conversation avec Emma IA');
                    const to = encodeURIComponent(emailTo || '');
                    window.location.href = `mailto:${to}?subject=${subj}&body=${body}`;
                    setShowEmailModal(false);
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>🤖 Ask Emma</h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={clearChat}
                                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                                >
                                    🗑️ Effacer
                                </button>
                                <button
                                    onClick={() => { if (typeof setShowProfile === 'function') setShowProfile(true); }}
                                    className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"
                                >
                                    👤 Profil d'Emma
                                </button>
                                <button
                                    onClick={() => setShowEmailModal(true)}
                                    className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors"
                                    title="Envoyer la discussion par courriel"
                                >
                                    ✉️ Envoyer par courriel
                                </button>
                                <button
                                    onClick={() => setShowPromptEditor(!showPromptEditor)}
                                    className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors"
                                >
                                    📝 Prompt
                                </button>
                                <button
                                    onClick={() => setShowTemperatureEditor(!showTemperatureEditor)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                >
                                    🌡️ Température
                                </button>
                                <button
                                    onClick={() => setShowLengthEditor(!showLengthEditor)}
                                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors"
                                >
                                    📏 Longueur
                                </button>
                                <div className={`px-3 py-2 rounded text-sm font-medium ${
                                    emmaConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }`}>
                                    {emmaConnected ? '✅ Gemini Connecté' : '❌ Gemini Non Connecté'}
                                </div>
                            </div>
                        </div>

                        {/* Zone de chat */}
                        <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gray-900 border-gray-700' 
                                : 'bg-gray-50 border-gray-200'
                        }`}>
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-20 h-20 rounded-full overflow-hidden flex-shrink-0">
                                    <img 
                                        src={isDarkMode ? 'emma-avatar-gob-dark.jpg' : 'emma-avatar-gob-light.jpg'} 
                                        alt="Emma" 
                                        className="w-full h-full object-cover"
                                    />
                                </div>
                                <div>
                                    <h3 className={`text-lg font-semibold transition-colors duration-300 ${
                                        isDarkMode ? 'text-white' : 'text-gray-900'
                                    }`}>Emma IA</h3>
                                    <p className={`text-sm transition-colors duration-300 ${
                                        isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                    }`}>Analyste financière virtuelle</p>
                                </div>
                            </div>

                            {/* Messages */}
                            <div className={`h-[500px] overflow-y-auto mb-4 p-4 rounded-lg transition-colors duration-300 ${
                                isDarkMode ? 'bg-gray-900' : 'bg-gray-50'
                            }`}>
                                {emmaMessages.length === 0 ? (
                                    <div className="flex gap-3 mb-4">
                                        <div className="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                                            <img 
                                                src={isDarkMode ? 'EMMA-JSLAI-GOB-dark.jpg' : 'EMMA-JSLAI-GOB-light.jpg'} 
                                                alt="Emma" 
                                                className="w-full h-full object-cover"
                                            />
                                        </div>
                                        <div className={`flex-1 p-4 rounded-lg ${
                                            isDarkMode ? 'bg-gray-800' : 'bg-white'
                                        } shadow-sm`}>
                                            <p className={`text-sm leading-relaxed mb-3 ${
                                                isDarkMode ? 'text-gray-200' : 'text-gray-800'
                                            }`}>
                                                Bonjour au Groupe Ouellet Bolduc ! Je suis Emma, Experte financière IA de JSLAI. Je peux vous aider avec l'analyse et l'évaluation financière. Quel est votre défi financier ?
                                            </p>
                                            <div className={`flex items-start gap-2 p-3 rounded-lg mb-3 ${
                                                isDarkMode ? 'bg-red-900/30 border border-red-800' : 'bg-red-50 border border-red-200'
                                            }`}>
                                                <span className="text-red-500 text-sm">📌</span>
                                                <span className={`text-xs ${
                                                    isDarkMode ? 'text-red-300' : 'text-red-700'
                                                }`}>
                                                    Rappel : Pour des conseils personnalisés, consultez toujours un expert qualifié du domaine.
                                                </span>
                                            </div>
                                            <p className={`text-sm ${
                                                isDarkMode ? 'text-gray-200' : 'text-gray-800'
                                            }`}>
                                                Comment puis-je vous aider ?
                                            </p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {emmaMessages.map((message) => (
                                            <div key={message.id} className={`flex gap-3 ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                {message.type !== 'user' && (
                                                    <div className="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                                                        <img 
                                                            src={isDarkMode ? 'EMMA-JSLAI-GOB-dark.jpg' : 'EMMA-JSLAI-GOB-light.jpg'} 
                                                            alt="Emma" 
                                                            className="w-full h-full object-cover"
                                                        />
                                                    </div>
                                                )}
                                                <div className={`max-w-xl px-4 py-3 rounded-lg shadow ${
                                                    message.type === 'user' 
                                                        ? 'bg-blue-600 text-white shadow-blue-500/20' 
                                                        : message.type === 'error'
                                                        ? 'bg-red-600 text-white shadow-red-500/20'
                                                        : isDarkMode 
                                                            ? 'bg-gray-800 text-white border border-gray-700' 
                                                            : 'bg-white text-gray-900 border border-gray-200'
                                                }`}>
                                                    <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: formatMessageText(message.content) }} />
                                                    <div className={`text-xs mt-1 ${
                                                        message.type === 'user' ? 'text-blue-100' : 'text-gray-400'
                                                    }`}>
                                                        {message.timestamp}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {emmaLoading && (
                                            <div className="flex gap-3 justify-start">
                                                <div className="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                                                    <img 
                                                        src={isDarkMode ? 'EMMA-JSLAI-GOB-dark.jpg' : 'EMMA-JSLAI-GOB-light.jpg'} 
                                                        alt="Emma" 
                                                        className="w-full h-full object-cover"
                                                    />
                                                </div>
                                                <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                                    isDarkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-900'
                                                }`}>
                                                    <div className="flex items-center gap-2">
                                                        <div className="animate-spin w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full"></div>
                                                        <span>Emma réfléchit...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Input */}
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={emmaInput}
                                    onChange={(e) => setEmmaInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessageToEmma()}
                                    placeholder="Posez votre question à Emma..."
                                    className={`flex-1 px-4 py-2 rounded-lg border transition-colors duration-300 ${
                                        isDarkMode 
                                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' 
                                            : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                                    }`}
                                    disabled={emmaLoading}
                                />
                                <button
                                    onClick={sendMessageToEmma}
                                    disabled={emmaLoading || !emmaInput.trim()}
                                    className={`px-6 py-2 rounded-lg font-medium transition-colors duration-300 ${
                                        emmaLoading || !emmaInput.trim()
                                            ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                            : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`}
                                >
                                    {emmaLoading ? '⏳' : '📤'}
                                </button>
                                {emmaInput.trim() && (
                                    <button
                                        onClick={() => setEmmaInput('')}
                                        className="px-3 py-2 rounded-lg bg-gray-500 text-white hover:bg-gray-600 transition-colors"
                                        title="Vider l'input"
                                    >
                                        ✕
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Éditeur de prompt */}
                        {showPromptEditor && (
                            <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                                isDarkMode 
                                    ? 'bg-gray-900 border-gray-700' 
                                    : 'bg-gray-50 border-gray-200'
                            }`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className={`text-lg font-semibold transition-colors duration-300 ${
                                        isDarkMode ? 'text-white' : 'text-gray-900'
                                    }`}>📝 Éditeur de Prompt Emma</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={resetPrompt}
                                            className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                        >
                                            🔄 Réinitialiser
                                        </button>
                                        <button
                                            onClick={savePrompt}
                                            className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors"
                                        >
                                            💾 Sauvegarder
                                        </button>
                                    </div>
                                </div>
                                
                                <textarea
                                    value={emmaPrompt}
                                    onChange={(e) => setEmmaPrompt(e.target.value)}
                                    className={`w-full h-64 p-3 rounded-lg border transition-colors duration-300 font-mono text-sm ${
                                        isDarkMode 
                                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' 
                                            : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                                    }`}
                                    placeholder="Saisissez votre prompt personnalisé pour Emma..."
                                />
                                
                                <div className={`mt-3 p-3 rounded-lg text-sm ${
                                    isDarkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-600'
                                }`}>
                                    <p className="font-medium mb-2">Variables disponibles :</p>
                                    <ul className="space-y-1 text-xs">
                                        <li><code className="bg-gray-200 text-gray-800 px-1 rounded">{"{userMessage}"}</code> - Message de l'utilisateur</li>
                                        <li><code className="bg-gray-200 text-gray-800 px-1 rounded">{"{dashboardData}"}</code> - Données du dashboard</li>
                                        <li><code className="bg-gray-200 text-gray-800 px-1 rounded">{"{currentTime}"}</code> - Heure actuelle</li>
                                    </ul>
                                </div>
                            </div>
                        )}

                        {/* Modal d'envoi par courriel */}
                        {showEmailModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
                                <div className={`w-full max-w-md rounded-lg p-6 shadow-xl ${isDarkMode ? 'bg-gray-900 border border-gray-700' : 'bg-white border border-gray-200'}`}>
                                    <h3 className={`text-lg font-semibold mb-4 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>✉️ Envoyer par courriel</h3>
                                    <div className="space-y-3">
                                        <input
                                            type="email"
                                            value={emailTo}
                                            onChange={(e) => setEmailTo(e.target.value)}
                                            placeholder="Destinataire"
                                            className={`w-full px-3 py-2 rounded border ${isDarkMode ? 'bg-gray-800 border-gray-700 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'}`}
                                        />
                                        <input
                                            type="text"
                                            value={emailSubject}
                                            onChange={(e) => setEmailSubject(e.target.value)}
                                            className={`w-full px-3 py-2 rounded border ${isDarkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                                        />
                                        <textarea
                                            className={`w-full h-32 px-3 py-2 rounded border ${isDarkMode ? 'bg-gray-800 border-gray-700 text-gray-300' : 'bg-white border-gray-300 text-gray-800'}`}
                                            readOnly
                                            value={buildEmailBody()}
                                        />
                                    </div>
                                    <div className="flex justify-end gap-2 mt-4">
                                        <button onClick={() => setShowEmailModal(false)} className={`px-4 py-2 rounded ${isDarkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Annuler</button>
                                        <button onClick={sendEmailTranscript} className="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Envoyer</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Profil d'Emma */}
                        {(typeof showProfile !== 'undefined' ? showProfile : false) && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70">
                                <div className={`w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-gray-900 border border-gray-700' : 'bg-white border border-gray-200'}`}>
                                    <div className={`p-5 flex items-center gap-4 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-50'}`}>
                                        <img src={isDarkMode ? 'EMMA-JSLAI-GOB-dark.jpg' : 'EMMA-JSLAI-GOB-light.jpg'} alt="Emma" className="w-16 h-16 rounded-full object-cover" />
                                        <div>
                                            <div className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Emma — Analyste Financière IA</div>
                                            <div className={`${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>JSL AI • Profil professionnel</div>
                                        </div>
                                        <button onClick={() => setShowProfile(false)} className={`ml-auto px-3 py-1 rounded ${isDarkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Fermer</button>
                                    </div>
                                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 className={`font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Mission</h4>
                                            <p className={`${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>Accompagner une équipe de gestionnaires de portefeuille québécois avec une expertise de niveau CFA, rigueur et esprit critique.</p>
                                            <h4 className={`font-semibold mt-4 mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Compétences clés</h4>
                                            <ul className={`${isDarkMode ? 'text-gray-300' : 'text-gray-700'} list-disc pl-5 space-y-1`}>
                                                <li>Analyse fondamentale (actions, obligations, dérivés)</li>
                                                <li>Évaluation (DCF, multiples, comparables)</li>
                                                <li>Macro/sectoriel, gestion du risque, allocation</li>
                                                <li>Rédaction d’analyses structurées et sourcées</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className={`font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Style et ton</h4>
                                            <ul className={`${isDarkMode ? 'text-gray-300' : 'text-gray-700'} list-disc pl-5 space-y-1`}>
                                                <li>Professionnel, pédagogique, factuel</li>
                                                <li>Structure claire avec émojis et points clés</li>
                                                <li>Sources officielles et vérifiables (2–3)</li>
                                            </ul>
                                            <h4 className={`font-semibold mt-4 mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Préférences analytiques</h4>
                                            <ul className={`${isDarkMode ? 'text-gray-300' : 'text-gray-700'} list-disc pl-5 space-y-1`}>
                                                <li>Valeur contrarian / GARP quand justifié</li>
                                                <li>Attention aux bulles, risques macro/geopol</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Éditeur de Température */}
                        {showTemperatureEditor && (
                            <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                                isDarkMode 
                                    ? 'bg-gray-900 border-gray-700' 
                                    : 'bg-gray-50 border-gray-200'
                            }`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className={`text-lg font-semibold transition-colors duration-300 ${
                                        isDarkMode ? 'text-white' : 'text-gray-900'
                                    }`}>🌡️ Contrôle de Température Emma</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setEmmaTemperature(0.3)}
                                            className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                        >
                                            🔄 Réinitialiser
                                        </button>
                                        <button
                                            onClick={() => {
                                                saveTemperature();
                                                saveFunctionCalling();
                                            }}
                                            className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors"
                                        >
                                            💾 Sauvegarder
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* Contrôle Function Calling */}
                                    <div className={`p-3 rounded-lg border ${
                                        isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-100 border-gray-300'
                                    }`}>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <label className={`text-sm font-medium transition-colors duration-300 ${
                                                    isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                                }`}>
                                                    🔧 Function Calling (Données Temps Réel)
                                                </label>
                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                    isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                }`}>
                                                    Emma peut accéder aux données financières actuelles via nos APIs
                                                </p>
                                            </div>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={useFunctionCalling}
                                                    onChange={(e) => setUseFunctionCalling(e.target.checked)}
                                                    className="sr-only peer"
                                                />
                                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>

                                    {/* Slider de température */}
                                    <div>
                                        <label className={`block text-sm font-medium mb-2 transition-colors duration-300 ${
                                            isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                        }`}>
                                            Température: {emmaTemperature}
                                        </label>
                                        <input
                                            type="range"
                                            min="0.1"
                                            max="1.0"
                                            step="0.1"
                                            value={emmaTemperature}
                                            onChange={(e) => setEmmaTemperature(parseFloat(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                                        />
                                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>0.1 (Précis)</span>
                                            <span>1.0 (Créatif)</span>
                                        </div>
                                    </div>

                                    {/* Presets de température */}
                                    <div>
                                        <label className={`block text-sm font-medium mb-2 transition-colors duration-300 ${
                                            isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                        }`}>
                                            Presets Recommandés:
                                        </label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button
                                                onClick={() => setEmmaTemperature(0.1)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${
                                                    emmaTemperature === 0.1 
                                                        ? 'bg-blue-600 text-white' 
                                                        : isDarkMode 
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                <div className="font-medium">📊 Très Précis</div>
                                                <div className="text-xs opacity-75">Analyses factuelles</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaTemperature(0.3)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${
                                                    emmaTemperature === 0.3 
                                                        ? 'bg-blue-600 text-white' 
                                                        : isDarkMode 
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                <div className="font-medium">📈 Financier</div>
                                                <div className="text-xs opacity-75">Analyses professionnelles</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaTemperature(0.5)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${
                                                    emmaTemperature === 0.5 
                                                        ? 'bg-blue-600 text-white' 
                                                        : isDarkMode 
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                <div className="font-medium">🎯 Modéré</div>
                                                <div className="text-xs opacity-75">Équilibré et factuel</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaTemperature(0.7)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${
                                                    emmaTemperature === 0.7 
                                                        ? 'bg-blue-600 text-white' 
                                                        : isDarkMode 
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                <div className="font-medium">⚖️ Équilibré</div>
                                                <div className="text-xs opacity-75">Professionnel et naturel</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaTemperature(0.9)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${
                                                    emmaTemperature === 0.9 
                                                        ? 'bg-blue-600 text-white' 
                                                        : isDarkMode 
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                <div className="font-medium">🎨 Créatif</div>
                                                <div className="text-xs opacity-75">Idées innovantes</div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Exemples de réponses */}
                                    <div className={`p-3 rounded-lg text-sm ${
                                        isDarkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-600'
                                    }`}>
                                        <p className="font-medium mb-2">Exemples de réponses selon la température :</p>
                                        <div className="space-y-2 text-xs">
                                            <div>
                                                <strong>Température 0.1:</strong> "Apple présente un P/E de 28.5, une croissance des revenus de 8.2% YoY, et une position de trésorerie de $29.4B. Recommandation: ACHAT."
                                            </div>
                                            <div>
                                                <strong>Température 0.5:</strong> "Apple montre une performance financière robuste avec des métriques clés positives. Le P/E de 28.5 est raisonnable pour la croissance, et la trésorerie de $29.4B renforce la position. Recommandation: ACHAT."
                                            </div>
                                            <div>
                                                <strong>Température 0.7:</strong> "Apple semble intéressant avec de bonnes perspectives de croissance, mais il faut surveiller les défis du marché chinois..."
                                            </div>
                                            <div>
                                                <strong>Température 0.9:</strong> "Apple, c'est comme un phénix qui renaît de ses cendres ! Avec leur écosystème intégré, ils pourraient révolutionner..."
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Éditeur de longueur de réponse */}
                        {showLengthEditor && (
                            <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className={`text-lg font-semibold transition-colors duration-300 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>📏 Contrôle de Longueur Emma</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setEmmaMaxTokens(4096)}
                                            className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                        >
                                            🔄 Réinitialiser
                                        </button>
                                        <button
                                            onClick={() => {
                                                saveMaxTokens();
                                            }}
                                            className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors"
                                        >
                                            💾 Sauvegarder
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* Slider de longueur */}
                                    <div>
                                        <label className={`block text-sm font-medium mb-2 transition-colors duration-300 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Longueur de réponse: {emmaMaxTokens} tokens
                                        </label>
                                        <input
                                            type="range"
                                            min="1024"
                                            max="8192"
                                            step="1024"
                                            value={emmaMaxTokens}
                                            onChange={(e) => setEmmaMaxTokens(parseInt(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                                        />
                                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>1024 (Court)</span>
                                            <span>8192 (Long)</span>
                                        </div>
                                    </div>

                                    {/* Presets de longueur */}
                                    <div>
                                        <label className={`block text-sm font-medium mb-2 transition-colors duration-300 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Presets Recommandés:
                                        </label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button
                                                onClick={() => setEmmaMaxTokens(1024)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${emmaMaxTokens === 1024 ? 'bg-orange-600 text-white' : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                            >
                                                <div className="font-medium">📝 Court</div>
                                                <div className="text-xs opacity-75">2-3 paragraphes</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaMaxTokens(2048)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${emmaMaxTokens === 2048 ? 'bg-orange-600 text-white' : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                            >
                                                <div className="font-medium">📊 Moyen</div>
                                                <div className="text-xs opacity-75">Analyses courtes à moyenne</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaMaxTokens(4096)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${emmaMaxTokens === 4096 ? 'bg-orange-600 text-white' : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                            >
                                                <div className="font-medium">📈 Complet</div>
                                                <div className="text-xs opacity-75">Analyses moyennes (Par défaut)</div>
                                            </button>
                                            <button
                                                onClick={() => setEmmaMaxTokens(8192)}
                                                className={`p-3 rounded-lg text-sm transition-colors ${emmaMaxTokens === 8192 ? 'bg-orange-600 text-white' : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                            >
                                                <div className="font-medium">📋 Rapport</div>
                                                <div className="text-xs opacity-75">Rapports complets</div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Exemples de longueur */}
                                    <div className={`p-3 rounded-lg text-sm ${isDarkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>
                                        <p className="font-medium mb-2">Exemples d'ajustements possibles de maxOutputTokens :</p>
                                        <div className="space-y-2 text-xs">
                                            <div><strong>1024 →</strong> réponses courtes (2-3 paragraphes)</div>
                                            <div><strong>2048 →</strong> analyses courtes à moyenne</div>
                                            <div><strong>Par Défaut : 4096</strong> analyses moyennes</div>
                                            <div><strong>8192 →</strong> rapports complets (si modèle supporte)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Suggestions rapides */}
                        <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gray-900 border-gray-700' 
                                : 'bg-gray-50 border-gray-200'
                        }`}>
                            <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>💡 Suggestions rapides</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {[
                                    "Comment analyser une action ?",
                                    "Où trouver les actualités ?",
                                    "Comment utiliser le scraping ?",
                                    "Explique-moi cette donnée",
                                    "Qu'est-ce que le P/E ratio ?",
                                    "Comment interpréter les graphiques ?"
                                ].map((suggestion, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setEmmaInput(suggestion)}
                                        className={`p-3 rounded-lg text-left transition-colors duration-300 ${
                                            isDarkMode 
                                                ? 'bg-gray-700 hover:bg-gray-600 text-white' 
                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-900'
                                        }`}
                                    >
                                        <div className="text-sm font-medium">{suggestion}</div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Aide contextuelle */}
                        <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-blue-900/30 border-blue-600' 
                                : 'bg-blue-100/80 border-blue-300'
                        }`}>
                            <h3 className={`text-lg font-semibold mb-4 transition-colors duration-300 ${
                                isDarkMode ? 'text-white' : 'text-gray-900'
                            }`}>ℹ️ À propos d'Emma</h3>
                            <div className={`text-sm space-y-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-blue-200' : 'text-blue-800'
                            }`}>
                                <div>• <strong>Navigation :</strong> Emma vous guide dans l'interface</div>
                                <div>• <strong>Interprétation :</strong> Explique les données financières</div>
                                <div>• <strong>Recommandations :</strong> Suggère les meilleures pratiques</div>
                                <div>• <strong>Support :</strong> Répond à vos questions techniques</div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Composant onglet Stocks & News
            const StocksNewsTab = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className={`text-2xl font-bold transition-colors duration-300 ${
                            isDarkMode ? 'text-white' : 'text-gray-900'
                        }`}>📊 Titres & nouvelles</h2>
                        <div className="flex gap-2">
                            <div className={`rounded-lg p-1 transition-colors duration-300 ${
                                isDarkMode ? 'bg-gray-700' : 'bg-gray-200'
                            }`}>
                                <button
                                    onClick={() => setViewMode('list')}
                                    className={`px-3 py-1 rounded text-sm transition-colors ${
                                        viewMode === 'list' 
                                            ? (isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-600 text-white')
                                            : (isDarkMode ? 'text-gray-300 hover:text-white' : 'text-gray-600 hover:text-gray-900')
                                    }`}
                                >
                                    📋 Liste
                                </button>
                                <button
                                    onClick={() => setViewMode('cards')}
                                    className={`px-3 py-1 rounded text-sm transition-colors ${
                                        viewMode === 'cards' 
                                            ? (isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-600 text-white')
                                            : (isDarkMode ? 'text-gray-300 hover:text-white' : 'text-gray-600 hover:text-gray-900')
                                    }`}
                                >
                                    🎴 Cartes
                                </button>
                            </div>
                            <button
                                onClick={refreshAllStocks}
                                disabled={loading}
                                className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                            >
                                {loading ? 'Actualisation...' : 'Actualiser Stocks'}
                            </button>
                            <button
                                onClick={fetchNews}
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                Actualiser News
                            </button>
                        </div>
                    </div>

                    {lastUpdate && (
                        <p className="text-gray-400 text-sm">
                            Dernière mise à jour: {new Date(lastUpdate).toLocaleString('fr-FR')}
                        </p>
                    )}

                    {/* Debug des données déplacé vers Admin-JSLAI */}

                    {/* Section Données Financières & Actualités (Finnhub) - PRINCIPALE */}
                    <div className="mt-8">
                        <div className={`backdrop-blur-sm rounded-2xl p-8 border-2 shadow-2xl transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gradient-to-br from-gray-800/90 to-gray-900/90 border-blue-500/30 shadow-blue-500/10' 
                                : 'bg-gradient-to-br from-white/95 to-gray-50/95 border-blue-400/40 shadow-blue-400/10'
                        }`}>
                            <div className="text-center mb-6">
                                <h2 className={`text-2xl font-bold mb-3 transition-colors duration-300 ${
                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                }`}>
                                    📊 Données Financières & Actualités
                                </h2>
                                <div className={`inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-300 ${
                                    isDarkMode 
                                        ? 'bg-blue-600/20 text-blue-300 border border-blue-500/30' 
                                        : 'bg-blue-100/80 text-blue-700 border border-blue-300/50'
                                }`}>
                                    <span className="mr-2">🔗</span>
                                    Source: Finnhub API
                                </div>
                                <p className={`text-sm mt-3 transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                }`}>
                                    Données en temps réel avec 3 actualités par titre
                                </p>
                            </div>
                            <div className="overflow-x-auto max-h-[70vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200 dark:scrollbar-thumb-gray-600 dark:scrollbar-track-gray-800 relative text-sm">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className={`border-b-2 transition-colors duration-300 ${
                                            isDarkMode ? 'border-blue-500/50 bg-gray-900' : 'border-blue-400/50 bg-gray-100'
                                        }`}>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>📈 Ticker</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>💰 Prix</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>📊 Change</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>📈 P/E</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>💎 Dividende</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>🏢 Secteur</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>⭐ Rating</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>😊 Sentiment</th>
                                            <th className={`text-left py-2 px-3 font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                            }`}>⚡ Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {tickers.map(ticker => {
                                            // Données de Finnhub uniquement
                                            const finnhubData = stockData[ticker];
                                            const price = finnhubData?.c ? `$${finnhubData.c.toFixed(2)}` : 'N/A';
                                            const change = finnhubData?.d ? `${finnhubData.d > 0 ? '+' : ''}${finnhubData.d.toFixed(2)}` : 'N/A';
                                            const changePercent = finnhubData?.dp ? `${finnhubData.dp > 0 ? '+' : ''}${finnhubData.dp.toFixed(2)}%` : 'N/A';
                                            const changeColor = finnhubData?.d > 0 ? 'text-green-400' : finnhubData?.d < 0 ? 'text-red-400' : 'text-gray-400';
                                            
                                            // Données de profil Finnhub
                                            const profile = finnhubData?.profile;
                                            const fundamentals = finnhubData?.fundamentals;
                                            const peRatio = fundamentals?.peRatio
                                                ? (Number.isFinite(fundamentals.peRatio) ? fundamentals.peRatio.toFixed(2) : fundamentals.peRatio)
                                                : (profile?.pe ? profile.pe.toFixed(2) : 'N/A');
                                            const dividendYield = fundamentals?.dividendYield
                                                ? `${(Number(fundamentals.dividendYield) * 100).toFixed(2)}%`
                                                : (profile?.dividend ? `${(profile.dividend * 100).toFixed(2)}%` : 'N/A');
                                            const sector = fundamentals?.sector || profile?.industry || 'N/A';
                                            
                                            // Données de recommandation Finnhub
                                            const recommendation = finnhubData?.recommendation;
                                            const rating = recommendation?.length > 0 ? 
                                                (recommendation[0].buy + recommendation[0].strongBuy > recommendation[0].sell + recommendation[0].strongSell ? 'Achat' : 
                                                 recommendation[0].sell + recommendation[0].strongSell > recommendation[0].buy + recommendation[0].strongBuy ? 'Vente' : 'Neutre') : 'N/A';
                                            
                                            // 3 actualités les plus récentes pour ce ticker
                                            const tickerNews = newsData.filter(article => {
                                                const text = (article.title + ' ' + article.description).toLowerCase();
                                                return text.includes(ticker.toLowerCase());
                                            }).slice(0, 3);
                                            
                                            // Analyse du sentiment
                                            const analyzeSentiment = (title, description) => {
                                                const text = (title + ' ' + description).toLowerCase();
                                                const positiveWords = ['hausse', 'croissance', 'gain', 'profit', 'positif', 'amélioration', 'succès', 'fort', 'solide'];
                                                const negativeWords = ['baisse', 'chute', 'perte', 'négatif', 'déclin', 'faible', 'problème', 'risque', 'inquiétude'];
                                                
                                                const positiveCount = positiveWords.filter(word => text.includes(word)).length;
                                                const negativeCount = negativeWords.filter(word => text.includes(word)).length;
                                                
                                                if (positiveCount > negativeCount) return { sentiment: 'Positif', color: 'text-green-400' };
                                                if (negativeCount > positiveCount) return { sentiment: 'Négatif', color: 'text-red-400' };
                                                return { sentiment: 'Neutre', color: 'text-gray-400' };
                                            };
                                            
                                            const sentiment = tickerNews.length > 0 ? analyzeSentiment(tickerNews[0].title, tickerNews[0].description) : { sentiment: 'N/A', color: 'text-gray-400' };
                                            
                                            return (
                                                <React.Fragment key={ticker}>
                                                    {/* Ligne principale - STYLE PRINCIPAL */}
                                                    <tr className={`border-b-2 transition-all duration-300 hover:scale-[1.02] ${
                                                        isDarkMode 
                                                            ? 'border-gray-600/50 hover:bg-gradient-to-r hover:from-gray-800/80 hover:to-gray-700/80 hover:shadow-lg hover:shadow-blue-500/10' 
                                                            : 'border-gray-300/50 hover:bg-gradient-to-r hover:from-gray-50/80 hover:to-white/80 hover:shadow-lg hover:shadow-blue-400/10'
                                                    }`}>
                                                        <td className="py-4 px-3">
                                                            <div className="flex items-center gap-3">
                                                                <img 
                                                                    src={getCompanyLogo(ticker)} 
                                                                    alt={`${ticker} logo`}
                                                                    className="w-8 h-8 rounded-lg shadow-md"
                                                                    onError={(e) => {
                                                                        e.target.style.display = 'none';
                                                                    }}
                                                                />
                                                                <span className={`font-mono font-bold text-xl transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                                }`}>{ticker}</span>
                                                            </div>
                                                        </td>
                                                        <td className={`py-2 px-3 font-bold transition-colors duration-300 ${
                                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                                        }`}>{price}</td>
                                                        <td className={`py-2 px-3 font-semibold transition-colors duration-300 ${changeColor}`}>
                                                            {change} ({changePercent})
                                                        </td>
                                                        <td className={`py-2 px-3 font-medium transition-colors duration-300 ${
                                                            isDarkMode ? 'text-gray-200' : 'text-gray-700'
                                                        }`}>{peRatio}</td>
                                                        <td className={`py-2 px-3 font-medium transition-colors duration-300 ${
                                                            isDarkMode ? 'text-green-300' : 'text-green-600'
                                                        }`}>{dividendYield}</td>
                                                        <td className={`py-2 px-3 text-sm transition-colors duration-300 ${
                                                            isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                                        }`}>{cleanText(sector)}</td>
                                                        <td className="py-4 px-3">
                                                            <span className={`px-4 py-2 rounded-full text-sm font-bold transition-colors duration-300 ${
                                                                rating === 'Achat' ? 'bg-green-500 text-white' :
                                                                rating === 'Vente' ? 'bg-red-500 text-white' :
                                                                'bg-yellow-500 text-black'
                                                            }`}>
                                                                {rating}
                                                            </span>
                                                        </td>
                                                        <td className="py-4 px-3">
                                                            <div className={`flex items-center gap-2 px-3 py-2 rounded-full transition-colors duration-300 ${
                                                                sentiment.sentiment === 'Positif' ? 'bg-green-100 text-green-800' :
                                                                sentiment.sentiment === 'Négatif' ? 'bg-red-100 text-red-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }`}>
                                                                <span className="text-lg">
                                                                    {sentiment.sentiment === 'Positif' ? '😊' : 
                                                                     sentiment.sentiment === 'Négatif' ? '😟' : '😐'}
                                                                </span>
                                                                <span className="font-semibold">{sentiment.sentiment}</span>
                                                            </div>
                                                        </td>
                                                        <td className="py-4 px-3">
                                                            <button
                                                                onClick={() => setSelectedStock(ticker)}
                                                                className={`px-4 py-2 text-xs font-semibold rounded-lg transition-all duration-300 hover:scale-[1.02] shadow ${
                                                                    isDarkMode 
                                                                        ? 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white shadow-blue-500/25' 
                                                                        : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-400 hover:to-blue-500 text-white shadow-blue-400/25'
                                                                }`}
                                                            >
                                                                📊 Voir détail
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    
                                                    {/* Lignes d'actualités (3 maximum) - STYLE AMÉLIORÉ */}
                                                    {tickerNews.map((news, newsIndex) => (
                                                        <tr key={`${ticker}-news-${newsIndex}`} className={`border-b-2 transition-all duration-300 hover:scale-[1.01] ${
                                                            isDarkMode 
                                                                ? 'border-gray-600/30 bg-gradient-to-r from-gray-800/40 to-gray-700/40 hover:from-gray-700/60 hover:to-gray-600/60' 
                                                                : 'border-gray-300/30 bg-gradient-to-r from-gray-50/60 to-white/60 hover:from-gray-100/80 hover:to-gray-50/80'
                                                        }`}>
                                                            <td colSpan="9" className="py-6 px-4">
                                                                <div className={`transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-gray-200' : 'text-gray-700'
                                                                }`}>
                                                                    <div className="flex items-start gap-4">
                                                                        <div className={`p-3 rounded-full transition-colors duration-300 ${
                                                                            isDarkMode ? 'bg-blue-600/20 text-blue-300' : 'bg-blue-100 text-blue-600'
                                                                        }`}>
                                                                            <span className="text-2xl">📰</span>
                                                                        </div>
                                                                        <div className="flex-1">
                                                                            <h5 className={`font-bold text-lg mb-3 transition-colors duration-300 ${
                                                                                isDarkMode ? 'text-white' : 'text-gray-900'
                                                                            }`}>
                                                                                {news.url ? (
                                                                                    <a 
                                                                                        href={news.url} 
                                                                                        target="_blank" 
                                                                                        rel="noopener noreferrer"
                                                                                        className={`hover:underline transition-colors duration-300 ${
                                                                                            isDarkMode 
                                                                                                ? 'text-blue-300 hover:text-blue-200' 
                                                                                                : 'text-blue-600 hover:text-blue-700'
                                                                                        }`}
                                                                                    >
                                                                                        {cleanText(news.title)}
                                                                                    </a>
                                                                                ) : (
                                                                                    cleanText(news.title)
                                                                                )}
                                                                            </h5>
                                                                            <p className={`text-base mb-4 leading-relaxed transition-colors duration-300 ${
                                                                                isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                                                            }`}>
                                                                                {cleanText(news.description)}
                                                                            </p>
                                                                            <div className={`flex items-center gap-4 text-sm transition-colors duration-300 ${
                                                                                isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                                            }`}>
                                                                                <div className={`flex items-center gap-2 px-3 py-1 rounded-full transition-colors duration-300 ${
                                                                                    isDarkMode ? 'bg-gray-800' : 'bg-gray-200'
                                                                                }`}>
                                                                                    <span className="font-semibold">{news.source?.name || 'Source inconnue'}</span>
                                                                                </div>
                                                                                <div className={`flex items-center gap-2 px-3 py-1 rounded-full transition-colors duration-300 ${
                                                                                    isDarkMode ? 'bg-gray-800' : 'bg-gray-200'
                                                                                }`}>
                                                                                    <span>🕒</span>
                                                                                    <span>
                                                                                        {news.publishedAt ? 
                                                                                            new Date(news.publishedAt).toLocaleString('fr-FR') : 
                                                                                            'Date inconnue'
                                                                                        }
                                                                                    </span>
                                                                                </div>
                                                                                {news.url && (
                                                                                    <a 
                                                                                        href={news.url} 
                                                                                        target="_blank" 
                                                                                        rel="noopener noreferrer"
                                                                                        className={`px-4 py-2 rounded-full font-semibold transition-all duration-300 hover:scale-105 ${
                                                                                            isDarkMode 
                                                                                                ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/25' 
                                                                                                : 'bg-blue-500 hover:bg-blue-400 text-white shadow-lg shadow-blue-400/25'
                                                                                        }`}
                                                                                    >
                                                                                        📖 Lire l'article
                                                                                    </a>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            <div className={`text-center mt-8 p-6 rounded-xl transition-colors duration-300 ${
                                isDarkMode 
                                    ? 'bg-gradient-to-r from-blue-900/30 to-purple-900/30 border border-blue-500/20' 
                                    : 'bg-gradient-to-r from-blue-100/80 to-purple-100/80 border border-blue-300/30'
                            }`}>
                                <div className={`text-lg font-semibold mb-2 transition-colors duration-300 ${
                                    isDarkMode ? 'text-blue-300' : 'text-blue-700'
                                }`}>
                                    📜 Section Principale - Données Financières
                                </div>
                                <div className={`text-sm transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                }`}>
                                    Faites défiler pour voir toutes les données • Source: Finnhub API • 3 actualités par titre
                                </div>
                                <div className={`text-xs mt-2 transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                }`}>
                                    Données mises à jour automatiquement toutes les 5 minutes
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Vue en liste compacte */}
                    {viewMode === 'list' && tickers.length > 0 && (
                        <div className="bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <h3 className="text-lg font-semibold text-white mb-4">📋 Vue Liste</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="border-b border-gray-600">
                                            <th className="text-left py-2 text-gray-300">Ticker</th>
                                            <th className="text-left py-2 text-gray-300">Prix</th>
                                            <th className="text-left py-2 text-gray-300">Change</th>
                                            <th className="text-left py-2 text-gray-300">P/E</th>
                                            <th className="text-left py-2 text-gray-300">Dividende</th>
                                            <th className="text-left py-2 text-gray-300">Secteur</th>
                                            <th className="text-left py-2 text-gray-300">Rating</th>
                                            <th className="text-left py-2 text-gray-300">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        {tickers.map(ticker => {
                            const data = stockData[ticker];
                                            const claudeData = seekingAlphaStockData.stocks?.[ticker];
                                            const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                            const parsedData = seekingAlphaItem?.parsedData;
                                            
                                            if (!data && !claudeData && !parsedData) return null;

                                            // Priorité: Claude > Parsed > Finnhub
                                            const price = claudeData?.metrics?.price || parsedData?.price || `$${data?.c?.toFixed(2) || 'N/A'}`;
                                            const change = claudeData?.metrics?.priceChange || parsedData?.change || (data?.dp >= 0 ? '+' : '') + (data?.dp?.toFixed(2) || '0') + '%';
                                            const peRatio = claudeData?.metrics?.peRatio || parsedData?.peRatio || 'N/A';
                                            const dividendYield = claudeData?.metrics?.dividendYield || parsedData?.dividendYield || 'N/A';
                                            const sector = claudeData?.metrics?.sector || parsedData?.sector || 'N/A';
                                            const rating = claudeData?.finalConclusion?.rating || 'Hold';
                                            
                                            const changeColor = (change.includes('+') || change.includes('green')) ? 'text-green-400' : 'text-red-400';

                            return (
                                                <tr key={ticker} className="border-b border-gray-700 hover:bg-gray-800 cursor-pointer"
                                                    onClick={() => setSelectedStock(ticker)}>
                                                    <td className="py-3">
                                                        <div className="flex items-center gap-2">
                                                            <img 
                                                                src={getCompanyLogo(ticker)} 
                                                                alt={`${ticker} logo`}
                                                                className="w-6 h-6 rounded"
                                                                onError={(e) => {
                                                                    e.target.style.display = 'none';
                                                                }}
                                                            />
                                                            <span className="font-mono text-white font-bold">{ticker}</span>
                                                        </div>
                                                    </td>
                                                    <td className="py-3 text-white">{price}</td>
                                                    <td className={`py-3 ${changeColor}`}>{change}</td>
                                                    <td className="py-3 text-white">{peRatio}</td>
                                                    <td className="py-3 text-white">{dividendYield}</td>
                                                    <td className="py-3 text-white text-xs">{cleanText(sector)}</td>
                                                    <td className="py-3">
                                                        <span className="bg-yellow-400 text-black px-2 py-1 rounded text-xs font-bold">
                                                            {rating}
                                        </span>
                                                    </td>
                                                    <td className="py-3">
                                                        <button className="text-blue-400 hover:text-blue-300 text-xs">
                                                            Voir fiche →
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                                    </div>
                        </div>
                    )}

                    {/* Cartes condensées */}
                    {viewMode === 'cards' && tickers.length > 0 && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {tickers.map(ticker => {
                                const data = stockData[ticker];
                                const claudeData = seekingAlphaStockData.stocks?.[ticker];
                                const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                const parsedData = seekingAlphaItem?.parsedData;
                                
                                if (!data && !claudeData && !parsedData) return null;

                                // Priorité: Claude > Parsed > Finnhub
                                const price = claudeData?.metrics?.price || parsedData?.price || `$${data?.c?.toFixed(2) || 'N/A'}`;
                                const change = claudeData?.metrics?.priceChange || parsedData?.change || (data?.dp >= 0 ? '+' : '') + (data?.dp?.toFixed(2) || '0') + '%';
                                const peRatio = claudeData?.metrics?.peRatio || parsedData?.peRatio || 'N/A';
                                const dividendYield = claudeData?.metrics?.dividendYield || parsedData?.dividendYield || 'N/A';
                                const sector = claudeData?.metrics?.sector || parsedData?.sector || 'N/A';
                                const marketCap = claudeData?.metrics?.marketCap || parsedData?.marketCap || 'N/A';
                                const companyName = claudeData?.companyName || parsedData?.companyName || 'N/A';
                                const rating = claudeData?.finalConclusion?.rating || 'Hold';
                                
                                const changeColor = (change.includes('+') || change.includes('green')) ? 'text-green-400' : 'text-red-400';
                                const changeBgColor = (change.includes('+') || change.includes('green')) ? 'bg-green-500' : 'bg-red-500';

                                return (
                                    <div key={ticker} className="bg-gray-900 rounded-lg p-6 border border-gray-600 hover:border-blue-400/50 transition-all cursor-pointer"
                                         onClick={() => setSelectedStock(ticker)}>
                                        
                                        {/* Header avec ticker et rating */}
                                        <div className="flex justify-between items-start mb-6">
                                            <div className="flex items-center gap-3">
                                                <img 
                                                    src={getCompanyLogo(ticker)} 
                                                    alt={`${ticker} logo`}
                                                    className="w-12 h-12 rounded-lg"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                    }}
                                                />
                                                <div>
                                                    <h3 className="text-2xl font-bold text-white">{ticker}</h3>
                                                    <p className="text-sm text-gray-400">
                                                        {cleanText(companyName)}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="bg-yellow-400 text-black px-3 py-1 rounded font-bold text-sm">
                                                {rating}
                                            </div>
                                    </div>
                                    
                                        {/* Prix et changement */}
                                        <div className="bg-gray-800 rounded-lg p-4 mb-6 border border-gray-600">
                                            <div className="text-3xl font-bold text-white mb-1">
                                                {price}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className={`w-4 h-4 ${changeBgColor} rounded`}></div>
                                                <span className={`text-sm font-medium ${changeColor}`}>
                                                    {change}
                                                </span>
                                            </div>
                                        </div>
                                    
                                        {/* Métriques clés */}
                                        <div className="space-y-3 mb-6">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Market Cap</span>
                                                <span className="text-white font-medium">{marketCap}</span>
                                    </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">P/E Ratio</span>
                                                <span className="text-white font-medium">{peRatio}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Dividend</span>
                                                <span className="text-white font-medium">{dividendYield}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">Secteur</span>
                                                <span className="text-white font-medium">{cleanText(sector)}</span>
                                            </div>
                                        </div>

                                        {/* Quant Ratings */}
                                        {claudeData?.quantRating && (
                                            <div className="mb-6">
                                                <div className="border-t border-gray-600 pt-4">
                                                    <h4 className="text-center text-gray-300 text-sm font-medium mb-4">QUANT RATINGS</h4>
                                                    <div className="flex justify-center gap-3">
                                                        {Object.entries(claudeData.quantRating).map(([key, value]) => {
                                                            if (!value || key === 'overall') return null;
                                                            const shortKey = key.substring(0, 3);
                                                            return (
                                                                <div key={key} className="text-center">
                                                                    <div className="text-xs text-gray-400 mb-1">{shortKey}</div>
                                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${getGradeColor(value)}`}>
                                                                        {value}
                                                                    </span>
                                </div>
                            );
                        })}
                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Call to action */}
                                        <div className="text-center">
                                            <div className="flex items-center justify-center gap-2 text-gray-400 text-sm">
                                                <span>👆</span>
                                                <span>Cliquez pour le rapport détaillé</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Section Actualités par Ticker */}
                    {tickers.length > 0 && (
                        <div className={`backdrop-blur-sm rounded-lg p-4 border transition-colors duration-300 ${
                            isDarkMode 
                                ? 'bg-gray-900 border-gray-700' 
                                : 'bg-gray-50 border-gray-200'
                        }`}>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className={`text-lg font-semibold transition-colors duration-300 ${
                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                }`}>📰 Actualités par Ticker</h3>
                                <button 
                                    onClick={fetchNews}
                                    className={`px-3 py-1 text-sm rounded transition-colors duration-300 ${
                                        isDarkMode 
                                            ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                                            : 'bg-blue-500 hover:bg-blue-600 text-white'
                                    }`}
                                >
                                    🔄 Actualiser
                                </button>
                            </div>
                            
                            {newsData.length === 0 ? (
                                <div className={`text-center py-8 transition-colors duration-300 ${
                                    isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                }`}>
                                    <div className="text-4xl mb-2">📰</div>
                                    <p>Aucune actualité disponible</p>
                                    <p className="text-sm mt-1">Cliquez sur "Actualiser" pour charger les actualités</p>
                                </div>
                            ) : (
                                <div className="space-y-4 max-h-96 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200 dark:scrollbar-thumb-gray-600 dark:scrollbar-track-gray-800 relative">
                                    {tickers.map(ticker => {
                                        // Filtrer les actualités pour ce ticker
                                        const tickerNews = newsData.filter(article => {
                                            const text = ((article.title || '') + ' ' + (article.description || '')).toLowerCase();
                                            const tagged = (article.ticker || '').toLowerCase();
                                            return tagged === ticker.toLowerCase() || text.includes(ticker.toLowerCase());
                                        });
                                        
                                        if (tickerNews.length === 0) return null;
                                        
                                        return (
                                            <div key={ticker} className={`rounded-lg p-4 transition-colors duration-300 ${
                                                isDarkMode 
                                                    ? 'bg-gray-800 border border-gray-700' 
                                                    : 'bg-gray-100 border border-gray-300'
                                            }`}>
                                                <h4 className={`font-semibold mb-3 transition-colors duration-300 ${
                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                }`}>
                                                    📈 {ticker} - {tickerNews.length} actualité{tickerNews.length > 1 ? 's' : ''}
                                                </h4>
                                                <div className="space-y-3">
                                                    {tickerNews.slice(0, 3).map((article, index) => (
                                                        <div key={index} className={`p-3 rounded transition-colors duration-300 ${
                                                            isDarkMode 
                                                                ? 'bg-gray-900 hover:bg-gray-800' 
                                                                : 'bg-gray-100 hover:bg-white'
                                                        }`}>
                                                            <div className="flex items-start gap-3">
                                                                <span className={`text-sm transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-blue-400' : 'text-blue-600'
                                                                }`}>📰</span>
                                                                <div className="flex-1">
                                                                    <h5 className={`font-medium mb-1 transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-200' : 'text-gray-800'
                                                                    }`}>
                                                                        {article.url ? (
                                                                            <a 
                                                                                href={article.url} 
                                                                                target="_blank" 
                                                                                rel="noopener noreferrer"
                                                                                className={`hover:underline transition-colors duration-300 ${
                                                                                    isDarkMode 
                                                                                        ? 'text-blue-400 hover:text-blue-300' 
                                                                                        : 'text-blue-600 hover:text-blue-700'
                                                                                }`}
                                                                            >
                                                                                {cleanText(article.title)}
                                                                            </a>
                                                                        ) : (
                                                                            cleanText(article.title)
                                                                        )}
                                                                    </h5>
                                                                    <p className={`text-sm mb-2 transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                                                    }`}>
                                                                        {cleanText(article.description)}
                                                                    </p>
                                                                    <div className={`flex items-center gap-2 text-xs transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                                    }`}>
                                                                        <span>{article.source?.name || 'Source inconnue'}</span>
                                                                        <span>•</span>
                                                                        <span>
                                                                            {article.publishedAt ? 
                                                                                new Date(article.publishedAt).toLocaleString('fr-FR') : 
                                                                                'Date inconnue'
                                                                            }
                                                                        </span>
                                                                        {article.url && (
                                                                            <>
                                                                                <span>•</span>
                                                                                <a 
                                                                                    href={article.url} 
                                                                                    target="_blank" 
                                                                                    rel="noopener noreferrer"
                                                                                    className={`hover:underline transition-colors duration-300 ${
                                                                                        isDarkMode 
                                                                                            ? 'text-blue-400 hover:text-blue-300' 
                                                                                            : 'text-blue-600 hover:text-blue-700'
                                                                                    }`}
                                                                                >
                                                                                    Lire l'article →
                                                                                </a>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {tickerNews.length > 3 && (
                                                        <div className={`text-center text-sm transition-colors duration-300 ${
                                                            isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                        }`}>
                                                            ... et {tickerNews.length - 3} autre{tickerNews.length - 3 > 1 ? 's' : ''} actualité{tickerNews.length - 3 > 1 ? 's' : ''}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Actualités générales */}
                                    {(() => {
                                        const generalNews = newsData.filter(article => {
                                            const text = (article.title + ' ' + article.description).toLowerCase();
                                            return !tickers.some(ticker => text.includes(ticker.toLowerCase()));
                                        });
                                        
                                        if (generalNews.length === 0) return null;
                                        
                                        return (
                                            <div className={`rounded-lg p-4 transition-colors duration-300 ${
                                                isDarkMode 
                                                    ? 'bg-gray-800 border border-gray-700' 
                                                    : 'bg-gray-100 border border-gray-300'
                                            }`}>
                                                <h4 className={`font-semibold mb-3 transition-colors duration-300 ${
                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                }`}>
                                                    🌐 Actualités Générales - {generalNews.length} actualité{generalNews.length > 1 ? 's' : ''}
                                                </h4>
                                                <div className="space-y-3">
                                                    {generalNews.slice(0, 5).map((article, index) => (
                                                        <div key={index} className={`p-3 rounded transition-colors duration-300 ${
                                                            isDarkMode 
                                                                ? 'bg-gray-900 hover:bg-gray-800' 
                                                                : 'bg-gray-100 hover:bg-white'
                                                        }`}>
                                                            <div className="flex items-start gap-3">
                                                                <span className={`text-sm transition-colors duration-300 ${
                                                                    isDarkMode ? 'text-blue-400' : 'text-blue-600'
                                                                }`}>🌐</span>
                                                                <div className="flex-1">
                                                                    <h5 className={`font-medium mb-1 transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-200' : 'text-gray-800'
                                                                    }`}>
                                                                        {article.url ? (
                                                                            <a 
                                                                                href={article.url} 
                                                                                target="_blank" 
                                                                                rel="noopener noreferrer"
                                                                                className={`hover:underline transition-colors duration-300 ${
                                                                                    isDarkMode 
                                                                                        ? 'text-blue-400 hover:text-blue-300' 
                                                                                        : 'text-blue-600 hover:text-blue-700'
                                                                                }`}
                                                                            >
                                                                                {cleanText(article.title)}
                                                                            </a>
                                                                        ) : (
                                                                            cleanText(article.title)
                                                                        )}
                                                                    </h5>
                                                                    <p className={`text-sm mb-2 transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                                                    }`}>
                                                                        {cleanText(article.description)}
                                                                    </p>
                                                                    <div className={`flex items-center gap-2 text-xs transition-colors duration-300 ${
                                                                        isDarkMode ? 'text-gray-400' : 'text-gray-500'
                                                                    }`}>
                                                                        <span>{article.source?.name || 'Source inconnue'}</span>
                                                                        <span>•</span>
                                                                        <span>
                                                                            {article.publishedAt ? 
                                                                                new Date(article.publishedAt).toLocaleString('fr-FR') : 
                                                                                'Date inconnue'
                                                                            }
                                                                        </span>
                                                                        {article.url && (
                                                                            <>
                                                                                <span>•</span>
                                                                                <a 
                                                                                    href={article.url} 
                                                                                    target="_blank" 
                                                                                    rel="noopener noreferrer"
                                                                                    className={`hover:underline transition-colors duration-300 ${
                                                                                        isDarkMode 
                                                                                            ? 'text-blue-400 hover:text-blue-300' 
                                                                                            : 'text-blue-600 hover:text-blue-700'
                                                                                    }`}
                                                                                >
                                                                                    Lire l'article →
                                                                                </a>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}
                            <div className={`text-xs text-center mt-2 transition-colors duration-300 ${
                                isDarkMode ? 'text-gray-400' : 'text-gray-500'
                            }`}>
                                📰 Faites défiler pour voir toutes les actualités
                            </div>
                        </div>
                    )}

                    {/* Message si aucune donnée */}
                    {tickers.length === 0 && (
                        <div className="bg-yellow-900/20 backdrop-blur-sm rounded-lg p-6 border border-yellow-300/20">
                            <div className="flex items-center gap-3">
                                <span className="text-yellow-400 text-2xl">⚠️</span>
                                <div>
                                    <h3 className="text-yellow-200 font-semibold">Aucun ticker configuré</h3>
                                    <p className="text-yellow-300/80 text-sm mt-1">
                                        Ajoutez des tickers dans l'onglet Seeking Alpha pour voir les données ici.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Section des actualités */}
                    <div className="mt-8">
                        <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-bold text-white">📰 Actualités Financières</h3>
                            <div className="flex gap-2">
                                <select 
                                    className="px-3 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none"
                                    value={newsFilter}
                                    onChange={(e) => filterNews(e.target.value)}
                                >
                                    <option value="all">Tous les tickers</option>
                                    {tickers.map(ticker => (
                                        <option key={ticker} value={ticker}>{ticker}</option>
                                    ))}
                                </select>
                                <button
                                    onClick={fetchNews}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    🔄 Actualiser
                                </button>
                            </div>
                        </div>

                        {filteredNews.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredNews.slice(0, 9).map((article, index) => {
                                    // Analyser le sentiment de l'article
                                    const analyzeSentiment = (title, description) => {
                                        if (!title && !description) return { sentiment: 'Neutre', color: 'text-gray-400', bgColor: 'bg-gray-100', icon: '😐' };
                                        
                                        const text = (title + ' ' + description).toLowerCase();
                                        const positiveWords = ['strong', 'growth', 'increase', 'rise', 'gain', 'positive', 'beat', 'exceed', 'surge', 'rally', 'boost', 'fort', 'croissance', 'hausse', 'gain', 'positif', 'dépasser'];
                                        const negativeWords = ['decline', 'fall', 'drop', 'loss', 'negative', 'miss', 'weak', 'concern', 'risk', 'challenge', 'baisse', 'chute', 'perte', 'négatif', 'manquer', 'faible', 'préoccupation', 'risque'];
                                        
                                        const positiveCount = positiveWords.filter(word => text.includes(word)).length;
                                        const negativeCount = negativeWords.filter(word => text.includes(word)).length;
                                        
                                        if (positiveCount > negativeCount) {
                                            return { sentiment: 'Positif', color: 'text-green-400', bgColor: 'bg-green-100', icon: '📈' };
                                        } else if (negativeCount > positiveCount) {
                                            return { sentiment: 'Négatif', color: 'text-red-400', bgColor: 'bg-red-100', icon: '📉' };
                                        } else {
                                            return { sentiment: 'Neutre', color: 'text-gray-400', bgColor: 'bg-gray-100', icon: '😐' };
                                        }
                                    };

                                    const sentiment = analyzeSentiment(article.title, article.description);
                                    const publishedDate = new Date(article.publishedAt).toLocaleDateString('fr-FR', {
                                        day: 'numeric',
                                        month: 'short',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    
                                    return (
                                        <div key={index} className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-300/40 transition-all cursor-pointer group news-card">
                                            {/* Header avec sentiment */}
                                            <div className="flex justify-between items-start mb-4">
                                                <div className={`px-3 py-1 rounded-full text-xs font-medium ${sentiment.bgColor} ${sentiment.color}`}>
                                                    {sentiment.icon} {sentiment.sentiment}
                                                </div>
                                                <span className="text-xs text-gray-400">{publishedDate}</span>
                                            </div>

                                            {/* Titre de l'article */}
                                            <h4 className="text-white font-semibold mb-3 line-clamp-2 group-hover:text-blue-300 transition-colors">
                                                {article.title}
                                            </h4>

                                            {/* Description */}
                                            <p className="text-gray-300 text-sm mb-4 line-clamp-3">
                                                {article.description}
                                            </p>

                                            {/* Source et lien */}
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-gray-400">
                                                    {article.source?.name || 'Source inconnue'}
                                                </span>
                                                <a
                                                    href={article.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors"
                                                    onClick={(e) => e.stopPropagation()}
                                                >
                                                    Lire plus →
                                                </a>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="bg-gray-800 rounded-lg p-8 text-center border border-gray-700">
                                <div className="text-6xl mb-4">📰</div>
                                <h4 className="text-white text-lg font-semibold mb-2">Aucune actualité disponible</h4>
                                <p className="text-gray-400 mb-4">Cliquez sur "Actualiser" pour charger les dernières actualités financières</p>
                                <button
                                    onClick={fetchNews}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Charger les actualités
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Section des graphiques de prix */}
                    <div className="mt-8">
                        <h3 className="text-xl font-bold text-white mb-6">📊 Graphiques de Prix</h3>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {tickers.slice(0, 4).map(ticker => {
                                const data = stockData[ticker];
                                const claudeData = seekingAlphaStockData.stocks?.[ticker];
                                const seekingAlphaItem = seekingAlphaData.stocks?.find(s => s.ticker === ticker);
                                const parsedData = seekingAlphaItem?.parsedData;
                                
                                const price = claudeData?.metrics?.price || parsedData?.price || `$${data?.c?.toFixed(2) || 'N/A'}`;
                                const change = claudeData?.metrics?.priceChange || parsedData?.change || (data?.dp >= 0 ? '+' : '') + (data?.dp?.toFixed(2) || '0') + '%';
                                const changeColor = (change.includes('+') || change.includes('green')) ? 'text-green-400' : 'text-red-400';
                                
                                return (
                                    <div key={ticker} className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="text-white font-bold text-lg">{ticker}</h4>
                                            <div className="text-right">
                                                <div className="text-white font-semibold">{price}</div>
                                                <div className={`text-sm ${changeColor}`}>{change}</div>
                            </div>
                                        </div>
                                        
                                        {/* Placeholder pour le graphique */}
                                        <div className="h-48 bg-gray-700 rounded-lg flex items-center justify-center">
                                            <div className="text-center">
                                                <div className="text-4xl mb-2">📈</div>
                                                <p className="text-gray-400 text-sm">Graphique interactif</p>
                                                <p className="text-gray-500 text-xs">Chart.js sera intégré ici</p>
                                            </div>
                                        </div>
                                        
                                        <div className="mt-4 flex justify-between text-sm text-gray-400">
                                            <span>1D</span>
                                            <span>1W</span>
                                            <span>1M</span>
                                            <span>3M</span>
                                            <span>1Y</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                </div>
            );

            // ============================================
            // COMPOSANT INTELLISTOCKS
            // ============================================
            const IntelliStocksTab = () => {
                const [time, setTime] = useState(new Date());
                const [selectedStock, setSelectedStock] = useState('AAPL');
                const [timeframe, setTimeframe] = useState('1D');
                const [menuOpen, setMenuOpen] = useState(false);
                const [stockDataIntelli, setStockDataIntelli] = useState(null);
                const [loadingIntelli, setLoadingIntelli] = useState(true);
                const [connected, setConnected] = useState(false);
                const [lastUpdateIntelli, setLastUpdateIntelli] = useState(null);
                // Helppop: visibilité et liste des violations détectées
                const [showHelp, setShowHelp] = useState(false);
                const [violations, setViolations] = useState([]);

                // Génération de données mock
                const generateMockData = (symbol) => {
                    const basePrice = {
                        AAPL: 183.45, TSLA: 251.23, GOOGL: 143.12,
                        MSFT: 384.89, NVDA: 485.32, AMZN: 178.91
                    }[symbol] || 180;

                    const companyNames = {
                        AAPL: 'Apple Inc.', TSLA: 'Tesla Inc.', GOOGL: 'Alphabet Inc.',
                        MSFT: 'Microsoft Corp.', NVDA: 'NVIDIA Corp.', AMZN: 'Amazon.com Inc.'
                    };

                    return {
                        quote: {
                            symbol,
                            name: companyNames[symbol] || 'Company Inc.',
                            price: basePrice,
                            change: parseFloat((Math.random() * 6 - 2).toFixed(2)),
                            changesPercentage: parseFloat((Math.random() * 4 - 1).toFixed(2)),
                            volume: Math.floor(Math.random() * 50000000 + 30000000),
                            marketCap: Math.floor(Math.random() * 2000000000000 + 1000000000000),
                            avgVolume: Math.floor(Math.random() * 60000000 + 40000000)
                        },
                        intraday: Array.from({ length: 20 }, (_, i) => ({
                            date: `${9 + Math.floor(i/4)}:${(i % 4) * 15}`,
                            open: basePrice + (Math.random() * 4 - 2),
                            high: basePrice + (Math.random() * 5 - 1),
                            low: basePrice + (Math.random() * 3 - 3),
                            close: basePrice + (Math.random() * 4 - 2),
                            volume: Math.floor(Math.random() * 5000000 + 2000000)
                        })),
                        metrics: {
                            peRatioTTM: parseFloat((Math.random() * 40 + 15).toFixed(1)),
                            pegRatioTTM: parseFloat((Math.random() * 2 + 0.5).toFixed(2)),
                            priceToSalesRatioTTM: parseFloat((Math.random() * 8 + 2).toFixed(2)),
                            dividendYieldTTM: parseFloat((Math.random() * 0.03).toFixed(4))
                        },
                        ratios: {
                            debtEquityRatio: parseFloat((Math.random() * 2 + 0.3).toFixed(2)),
                            returnOnEquityTTM: parseFloat((Math.random() * 0.4 + 0.1).toFixed(3)),
                            returnOnAssetsTTM: parseFloat((Math.random() * 0.2 + 0.05).toFixed(3)),
                            netProfitMarginTTM: parseFloat((Math.random() * 0.3 + 0.1).toFixed(3)),
                        },
                        profile: {
                            companyName: companyNames[symbol] || 'Company Inc.',
                            price: basePrice,
                            beta: parseFloat((Math.random() * 0.6 + 0.8).toFixed(2)),
                            sector: 'Technology',
                            industry: 'Consumer Electronics'
                        },
                        news: [
                            {
                                title: `${symbol} annonce résultats trimestriels record`,
                                publishedDate: new Date(Date.now() - 2*3600000).toISOString(),
                                site: 'Reuters'
                            },
                            {
                                title: `Nouveau partenariat stratégique annoncé`,
                                publishedDate: new Date(Date.now() - 5*3600000).toISOString(),
                                site: 'Bloomberg'
                            },
                            {
                                title: `Analystes relèvent objectif de prix`,
                                publishedDate: new Date(Date.now() - 8*3600000).toISOString(),
                                site: 'CNBC'
                            }
                        ],
                        sentiment: {
                            overall: Math.floor(Math.random() * 30 + 60),
                            news: Math.floor(Math.random() * 30 + 65),
                            social: Math.floor(Math.random() * 30 + 60),
                            institutional: Math.floor(Math.random() * 30 + 55),
                            retail: Math.floor(Math.random() * 30 + 70),
                            summary: 'Sentiment globalement positif avec optimisme modéré'
                        },
                        insights: {
                            catalysts: [
                                'Résultats trimestriels supérieurs aux attentes',
                                'Innovation produit majeure annoncée',
                                'Expansion internationale réussie'
                            ],
                            risks: [
                                'Concurrence accrue dans le secteur',
                                'Incertitudes macroéconomiques',
                                'Volatilité des marchés'
                            ],
                            consensus: 'bullish',
                            reasoning: 'Les fondamentaux solides et la croissance continue justifient un sentiment positif'
                        }
                    };
                };

                // Chargement des données
                useEffect(() => {
                    const fetchData = async () => {
                        try {
                            const mockData = generateMockData(selectedStock);
                            setStockDataIntelli(mockData);
                            setConnected(true);
                            setLoadingIntelli(false);
                            setLastUpdateIntelli(new Date());
                        } catch (error) {
                            console.error('Error fetching data:', error?.message || String(error));
                            setConnected(false);
                            setLoadingIntelli(false);
                            const mockData = generateMockData(selectedStock);
                            setStockDataIntelli(mockData);
                            // Enregistrer une violation visible dans l'helppop
                            setViolations(prev => [
                                ...prev,
                                { code: 'data_fetch_error', severity: 'medium', message: 'Échec de récupération API. Données mock utilisées.' }
                            ]);
                            setShowHelp(true);
                        }
                    };
                    fetchData();
                    const interval = setInterval(fetchData, 30000);
                    return () => clearInterval(interval);
                }, [selectedStock]);

                // Timer
                useEffect(() => {
                    const timer = setInterval(() => setTime(new Date()), 1000);
                    return () => clearInterval(timer);
                }, []);

                // Diagnostics environnementaux (violations) + ouverture auto du HelpPop
                useEffect(() => {
                    const newViolations = [];
                    try {
                        if (typeof Recharts === 'undefined') {
                            newViolations.push({
                                code: 'recharts_missing',
                                severity: 'high',
                                message: 'Recharts non chargé — graphiques désactivés.'
                            });
                        }
                    } catch (_) {
                        newViolations.push({ code: 'recharts_missing', severity: 'high', message: 'Recharts non chargé — graphiques désactivés.' });
                    }

                    try {
                        if (typeof lucideReact === 'undefined') {
                            newViolations.push({
                                code: 'lucide_missing',
                                severity: 'medium',
                                message: 'Bibliothèque des icônes (lucide-react UMD) indisponible.'
                            });
                        }
                    } catch (_) {
                        newViolations.push({ code: 'lucide_missing', severity: 'medium', message: 'Bibliothèque des icônes (lucide-react UMD) indisponible.' });
                    }

                    setViolations(newViolations);
                    if (newViolations.length > 0) {
                        setShowHelp(true);
                    }
                }, []);

                const stocks = [
                    { symbol: 'AAPL', name: 'Apple Inc.' },
                    { symbol: 'TSLA', name: 'Tesla Inc.' },
                    { symbol: 'GOOGL', name: 'Alphabet Inc.' },
                    { symbol: 'MSFT', name: 'Microsoft Corp.' },
                    { symbol: 'NVDA', name: 'NVIDIA Corp.' },
                    { symbol: 'AMZN', name: 'Amazon.com Inc.' },
                ];

                const currentStock = stocks.find(s => s.symbol === selectedStock);
                const quote = stockDataIntelli?.quote || {};
                const metrics = stockDataIntelli?.metrics || {};
                const ratios = stockDataIntelli?.ratios || {};
                const profile = stockDataIntelli?.profile || {};
                const intraday = stockDataIntelli?.intraday || [];
                const news = stockDataIntelli?.news || [];
                const sentiment = stockDataIntelli?.sentiment || {};
                const insights = stockDataIntelli?.insights || {};

                const formatNumber = (num, prefix = '', suffix = '') => {
                    if (!num && num !== 0) return 'N/A';
                    const n = parseFloat(num);
                    if (isNaN(n)) return 'N/A';
                    if (n >= 1e12) return `${prefix}${(n / 1e12).toFixed(2)}T${suffix}`;
                    if (n >= 1e9) return `${prefix}${(n / 1e9).toFixed(2)}B${suffix}`;
                    if (n >= 1e6) return `${prefix}${(n / 1e6).toFixed(2)}M${suffix}`;
                    if (n >= 1e3) return `${prefix}${(n / 1e3).toFixed(2)}K${suffix}`;
                    return `${prefix}${n.toFixed(2)}${suffix}`;
                };

                const formatTimeAgo = (dateString) => {
                    const date = new Date(dateString);
                    const hours = Math.floor((Date.now() - date.getTime()) / 3600000);
                    if (hours < 1) return 'maintenant';
                    if (hours < 24) return `${hours}h`;
                    return `${Math.floor(hours / 24)}j`;
                };

                const technicalIndicators = {
                    RSI: { value: 67.8, signal: 'Achat' },
                    MACD: { value: 2.34, signal: 'Bullish' },
                    SMA_50: { value: (quote.price || 0) * 0.98, signal: 'Au-dessus' },
                    SMA_200: { value: (quote.price || 0) * 0.94, signal: 'Au-dessus' },
                };

                const orderFlow = { buyVolume: 68.4, sellVolume: 31.6 };

                const peerComparison = [
                    { name: 'AAPL', pe: metrics.peRatioTTM || 29.8, growth: 12.5, margin: (ratios.netProfitMarginTTM || 0.25) * 100 },
                    { name: 'MSFT', pe: 35.2, growth: 15.8, margin: 32.1 },
                    { name: 'GOOGL', pe: 24.6, growth: 18.2, margin: 28.7 },
                    { name: 'AMZN', pe: 52.3, growth: 22.1, margin: 8.9 },
                ];

                if (loadingIntelli) {
                    return (
                        <div className={`min-h-screen p-2 flex items-center justify-center transition-colors duration-300 ${
                            isDarkMode ? 'bg-neutral-950 text-gray-100' : 'bg-gray-50 text-gray-900'
                        }`}>
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-500 mx-auto mb-4"></div>
                                <div className="text-sm text-gray-400">Chargement des données…</div>
                            </div>
                        </div>
                    );
                }

                // Accès aux icônes Lucide
                const LucideIcon = ({ name, className = "w-4 h-4" }) => {
                    if (typeof lucideReact === 'undefined') return null;
                    const Icon = lucideReact[name];
                    if (!Icon) return null;
                    return React.createElement(Icon, { className });
                };

                return (
                    <div className={`min-h-screen p-2 transition-colors duration-300 ${
                        isDarkMode ? 'bg-neutral-950 text-gray-100' : 'bg-gray-50 text-gray-900'
                    }`}>
                        {/* Header */}
                        <div className="mb-2">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className={`p-1.5 border rounded-lg transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <LucideIcon name="Activity" className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <div>
                                        <h1 className={`text-base font-bold flex items-center gap-2 transition-colors duration-300 ${
                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                        }`}>
                                            Expert Trading Analytics
                                            {connected ? (
                                                <LucideIcon name="Wifi" className="w-3 h-3 text-green-500" />
                                            ) : (
                                                <LucideIcon name="WifiOff" className="w-3 h-3 text-red-500" />
                                            )}
                                        </h1>
                                        <p className="text-[8px] text-gray-600">
                                            Mode Démo Hybride • FMP + Perplexity AI
                                        </p>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => {
                                            const fetchData = async () => {
                                                try {
                                                    const mockData = generateMockData(selectedStock);
                                                    setStockDataIntelli(mockData);
                                                    setConnected(true);
                                                    setLastUpdateIntelli(new Date());
                                                } catch (error) {
                                                    console.error('Error:', error);
                                                }
                                            };
                                            fetchData();
                                        }}
                                        className={`p-1.5 border rounded-md transition-all ${
                                            isDarkMode 
                                                ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                : 'bg-white hover:bg-gray-100 border-gray-300'
                                        }`}
                                    >
                                        <LucideIcon name="RefreshCw" className="w-3 h-3 text-gray-400" />
                                    </button>

                                    <div className="relative">
                                        <button
                                            onClick={() => setMenuOpen(!menuOpen)}
                                            className={`flex items-center gap-2 px-3 py-1.5 border rounded-lg transition-all ${
                                                isDarkMode 
                                                    ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                    : 'bg-white hover:bg-gray-100 border-gray-300'
                                            }`}
                                        >
                                            <div>
                                                <div className={`text-xs font-bold transition-colors duration-300 ${
                                                    isDarkMode ? 'text-white' : 'text-gray-900'
                                                }`}>{selectedStock}</div>
                                                <div className="text-[8px] text-gray-600">{profile.companyName || currentStock?.name}</div>
                                            </div>
                                            <LucideIcon name="ChevronDown" className={`w-3 h-3 text-gray-400 transition-transform ${menuOpen ? 'rotate-180' : ''}`} />
                                        </button>

                                        {menuOpen && (
                                            <div className={`absolute top-full mt-1 right-0 w-48 border rounded-lg shadow-2xl overflow-hidden z-50 transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                            }`}>
                                                {stocks.map((stock) => (
                                                    <button
                                                        key={stock.symbol}
                                                        onClick={() => {
                                                            setSelectedStock(stock.symbol);
                                                            setMenuOpen(false);
                                                        }}
                                                        className={`w-full p-2 flex items-center justify-between transition-all text-xs ${
                                                            selectedStock === stock.symbol 
                                                                ? (isDarkMode ? 'bg-neutral-800' : 'bg-gray-100')
                                                                : (isDarkMode ? 'hover:bg-neutral-800' : 'hover:bg-gray-50')
                                                        }`}
                                                    >
                                                        <div className="text-left">
                                                            <div className={`font-bold transition-colors duration-300 ${
                                                                isDarkMode ? 'text-white' : 'text-gray-900'
                                                            }`}>{stock.symbol}</div>
                                                            <div className="text-[8px] text-gray-600">{stock.name}</div>
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="text-right">
                                        <div className="text-xs font-mono font-bold text-gray-300">
                                            {time.toLocaleTimeString('fr-FR')}
                                        </div>
                                        <div className="text-[8px] text-gray-600">
                                            {time.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
                                        </div>
                                    </div>

                                <div className="flex gap-1">
                                        <button className={`p-1.5 border rounded-md transition-all ${
                                            isDarkMode 
                                                ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                : 'bg-white hover:bg-gray-100 border-gray-300'
                                        }`}>
                                            <LucideIcon name="Bell" className="w-3 h-3 text-gray-500" />
                                        </button>
                                        <button className={`p-1.5 border rounded-md transition-all ${
                                            isDarkMode 
                                                ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                : 'bg-white hover:bg-gray-100 border-gray-300'
                                        }`}>
                                            <LucideIcon name="Search" className="w-3 h-3 text-gray-500" />
                                        </button>
                                        <button className={`p-1.5 border rounded-md transition-all ${
                                            isDarkMode 
                                                ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                : 'bg-white hover:bg-gray-100 border-gray-300'
                                        }`}>
                                            <LucideIcon name="Settings" className="w-3 h-3 text-gray-500" />
                                        </button>
                                    {/* HelpPop / Violations */}
                                    <div className="relative">
                                        <button
                                            onClick={() => setShowHelp(!showHelp)}
                                            className={`p-1.5 border rounded-md transition-all ${
                                                isDarkMode 
                                                    ? 'bg-neutral-900 hover:bg-neutral-800 border-neutral-800' 
                                                    : 'bg-white hover:bg-gray-100 border-gray-300'
                                            }`}
                                            title={violations.length ? 'Diagnostics: problèmes détectés' : 'Aide IntelliStocks'}
                                        >
                                            <div className="relative">
                                                <LucideIcon name={violations.length ? 'AlertTriangle' : 'HelpCircle'} className={`w-3 h-3 ${violations.length ? 'text-yellow-500' : 'text-gray-500'}`} />
                                                {violations.length > 0 && (
                                                    <span className="absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full"></span>
                                                )}
                                            </div>
                                        </button>

                                        {showHelp && (
                                            <div className={`absolute right-0 mt-2 w-80 border rounded-xl shadow-2xl z-50 ${
                                                isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                            }`}>
                                                <div className={`p-3 border-b flex items-center justify-between gap-2 ${isDarkMode ? 'border-neutral-800' : 'border-gray-200'}`}>
                                                    <div className="flex items-center gap-2">
                                                        <LucideIcon name="LifeBuoy" className="w-4 h-4 text-blue-500" />
                                                        <div>
                                                            <div className={`text-xs font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Aide & diagnostics IntelliStocks</div>
                                                            <div className="text-[10px] text-gray-500">Mode Démo Hybride • FMP + Perplexity</div>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => setShowHelp(false)} className={`p-1 rounded ${isDarkMode ? 'hover:bg-neutral-800' : 'hover:bg-gray-100'}`}>
                                                        <LucideIcon name="X" className="w-3 h-3 text-gray-500" />
                                                    </button>
                                                </div>
                                                <div className="p-3 space-y-2 text-[11px]">
                                                    {violations.length > 0 ? (
                                                        <div>
                                                            <div className={`mb-1 font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Problèmes détectés</div>
                                                            <ul className="space-y-1">
                                                                {violations.map((v, i) => (
                                                                    <li key={i} className={`p-2 rounded border ${
                                                                        v.severity === 'high' ? (isDarkMode ? 'bg-red-900/30 border-red-800 text-red-200' : 'bg-red-50 border-red-200 text-red-800') :
                                                                        v.severity === 'medium' ? (isDarkMode ? 'bg-yellow-900/30 border-yellow-800 text-yellow-200' : 'bg-yellow-50 border-yellow-200 text-yellow-800') :
                                                                        (isDarkMode ? 'bg-gray-900/30 border-gray-800 text-gray-200' : 'bg-gray-50 border-gray-200 text-gray-800')
                                                                    }`}>
                                                                        {v.message}
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    ) : (
                                                        <div className={`p-2 rounded border ${isDarkMode ? 'bg-emerald-900/20 border-emerald-800 text-emerald-200' : 'bg-emerald-50 border-emerald-200 text-emerald-800'}`}>
                                                            Aucun problème détecté.
                                                        </div>
                                                    )}

                                                    <div className={`pt-1 border-t ${isDarkMode ? 'border-neutral-800' : 'border-gray-200'}`} />
                                                    <div className="space-y-1">
                                                        <div className={`font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Conseils rapides</div>
                                                        <ul className="list-disc pl-4 space-y-1 text-gray-500">
                                                            <li>Si Recharts est manquant, vérifiez le script UMD chargé en haut de la page.</li>
                                                            <li>Les graphiques sont désactivés en mode démo; les données sont simulées.</li>
                                                            <li>Actualisez avec le bouton rafraîchir pour recharger les données mock.</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Grid Layout */}
                        <div className="grid grid-cols-12 gap-2">
                            
                            {/* Colonne gauche */}
                            <div className="col-span-8 space-y-2">
                                
                                {/* Graphique principal */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <div className="flex items-center justify-between mb-2">
                                        <div>
                                            <h2 className={`text-sm font-bold mb-0.5 transition-colors duration-300 ${
                                                isDarkMode ? 'text-white' : 'text-gray-900'
                                            }`}>{selectedStock}</h2>
                                            <p className="text-[8px] text-gray-600">{profile.companyName || currentStock?.name} • {profile.sector || 'NASDAQ'}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-lg font-bold transition-colors duration-300 ${
                                                isDarkMode ? 'text-white' : 'text-gray-900'
                                            }`}>${parseFloat(quote.price || 0).toFixed(2)}</div>
                                            <div className={`flex items-center gap-1 justify-end text-xs ${parseFloat(quote.changesPercentage || 0) >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                                                {parseFloat(quote.changesPercentage || 0) >= 0 ? (
                                                    <LucideIcon name="ArrowUpRight" className="w-3 h-3" />
                                                ) : (
                                                    <LucideIcon name="ArrowDownRight" className="w-3 h-3" />
                                                )}
                                                <span className="font-semibold">
                                                    {parseFloat(quote.changesPercentage || 0) >= 0 ? '+' : ''}{parseFloat(quote.changesPercentage || 0).toFixed(2)}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{ width: '100%', height: 140 }}>
                                        <div className="text-center text-gray-500 text-xs py-8">
                                            📈 Graphique interactif (Recharts nécessite une configuration avancée)
                                        </div>
                                    </div>

                                    <div className="flex gap-1 mt-1.5">
                                    {['1D', '1W', '1M', '3M', '6M', '1A'].map((period) => (
                                            <button
                                                key={period}
                                                onClick={() => setTimeframe(period)}
                                                className={`px-2 py-0.5 rounded text-[9px] font-semibold transition-all ${
                                                    timeframe === period 
                                                        ? (isDarkMode 
                                                            ? 'bg-neutral-700 text-white border border-neutral-600' 
                                                            : 'bg-gray-300 text-gray-900 border border-gray-400')
                                                        : (isDarkMode 
                                                            ? 'bg-neutral-800 hover:bg-neutral-700 border border-neutral-800 text-gray-500' 
                                                            : 'bg-gray-100 hover:bg-gray-200 border border-gray-200 text-gray-600')
                                                }`}
                                            >
                                                {period}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Volume */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <h3 className="text-[10px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                        <LucideIcon name="BarChart3" className="w-3 h-3 text-gray-500" />
                                        Volume & Flux d'Ordres
                                    </h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div style={{ width: '100%', height: 80 }}>
                                            <div className="text-center text-gray-500 text-xs py-4">
                                                📊 Graphique Volume
                                            </div>
                                        </div>

                                        <div className="space-y-1.5">
                                            <div className={`flex items-center justify-between p-1.5 border rounded text-[9px] transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <span className="text-gray-500">Acheteurs</span>
                                                <div className="flex items-center gap-1">
                                                    <div className={`w-16 h-1.5 rounded-full overflow-hidden ${
                                                        isDarkMode ? 'bg-neutral-700' : 'bg-gray-200'
                                                    }`}>
                                                        <div className="h-full bg-emerald-500" style={{ width: `${orderFlow.buyVolume}%` }}></div>
                                                    </div>
                                                    <span className="text-emerald-500 font-bold">{orderFlow.buyVolume}%</span>
                                                </div>
                                            </div>
                                            <div className={`flex items-center justify-between p-1.5 border rounded text-[9px] transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <span className="text-gray-500">Vendeurs</span>
                                                <div className="flex items-center gap-1">
                                                    <div className={`w-16 h-1.5 rounded-full overflow-hidden ${
                                                        isDarkMode ? 'bg-neutral-700' : 'bg-gray-200'
                                                    }`}>
                                                        <div className="h-full bg-red-500" style={{ width: `${orderFlow.sellVolume}%` }}></div>
                                                    </div>
                                                    <span className="text-red-500 font-bold">{orderFlow.sellVolume}%</span>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-1">
                                                <div className={`p-1.5 border rounded text-center transition-colors duration-300 ${
                                                    isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                                }`}>
                                                    <div className="text-[8px] text-gray-600">Volume</div>
                                                    <div className={`text-xs font-bold transition-colors duration-300 ${
                                                        isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                                    }`}>{formatNumber(quote.volume)}</div>
                                                </div>
                                                <div className={`p-1.5 border rounded text-center transition-colors duration-300 ${
                                                    isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                                }`}>
                                                    <div className="text-[8px] text-gray-600">Cap</div>
                                                    <div className={`text-xs font-bold transition-colors duration-300 ${
                                                        isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                                    }`}>{formatNumber(quote.marketCap)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Indicateurs */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <h3 className="text-[10px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                        <LucideIcon name="Activity" className="w-3 h-3 text-gray-500" />
                                        Indicateurs Techniques
                                    </h3>
                                    <div className="grid grid-cols-2 gap-1.5">
                                        {Object.entries(technicalIndicators).map(([key, value]) => (
                                            <div key={key} className={`flex items-center justify-between p-1.5 border rounded transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <div>
                                                    <div className="font-semibold text-[9px] text-gray-400">{key.replace('_', ' ')}</div>
                                                    <div className="text-[8px] text-emerald-500">{value.signal}</div>
                                                </div>
                                                <div className={`text-sm font-bold transition-colors duration-300 ${
                                                    isDarkMode ? 'text-gray-200' : 'text-gray-700'
                                                }`}>
                                                    {typeof value.value === 'number' ? value.value.toFixed(2) : value.value}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Fondamentaux */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <h3 className="text-[10px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                        <LucideIcon name="DollarSign" className="w-3 h-3 text-gray-500" />
                                        Analyse Fondamentale
                                    </h3>
                                    <div className="grid grid-cols-3 gap-1.5">
                                        {[
                                            { label: 'P/E', value: metrics.peRatioTTM, suffix: 'x' },
                                            { label: 'PEG', value: metrics.pegRatioTTM, suffix: '' },
                                            { label: 'P/S', value: metrics.priceToSalesRatioTTM, suffix: 'x' },
                                            { label: 'ROE', value: ratios.returnOnEquityTTM ? `${(ratios.returnOnEquityTTM * 100).toFixed(1)}%` : 'N/A', suffix: '' },
                                            { label: 'ROA', value: ratios.returnOnAssetsTTM ? `${(ratios.returnOnAssetsTTM * 100).toFixed(1)}%` : 'N/A', suffix: '' },
                                            { label: 'D/E', value: ratios.debtEquityRatio, suffix: 'x' },
                                            { label: 'Marge', value: ratios.netProfitMarginTTM ? `${(ratios.netProfitMarginTTM * 100).toFixed(1)}%` : 'N/A', suffix: '' },
                                            { label: 'Beta', value: profile.beta, suffix: '' },
                                            { label: 'Div', value: metrics.dividendYieldTTM ? `${(metrics.dividendYieldTTM * 100).toFixed(2)}%` : 'N/A', suffix: '' },
                                        ].map((metric) => (
                                            <div key={metric.label} className={`p-1.5 border rounded text-center transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <div className="text-[8px] text-gray-600 mb-0.5">{metric.label}</div>
                                                <div className={`text-xs font-bold transition-colors duration-300 ${
                                                    isDarkMode ? 'text-gray-200' : 'text-gray-700'
                                                }`}>
                                                    {metric.value != null ? 
                                                        (typeof metric.value === 'number' ? metric.value.toFixed(2) + (metric.suffix || '') : metric.value) 
                                                        : 'N/A'}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Insights */}
                                {insights.catalysts && (
                                    <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <h3 className="text-[10px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                            <LucideIcon name="Brain" className="w-3 h-3 text-gray-500" />
                                            Insights IA (Perplexity)
                                        </h3>
                                        <div className="space-y-2">
                                            <div>
                                                <div className="text-[9px] text-gray-500 mb-1 font-semibold">🚀 Catalyseurs</div>
                                                {insights.catalysts.map((cat, i) => (
                                                    <div key={i} className="text-[8px] text-emerald-400 mb-0.5">• {cat}</div>
                                                ))}
                                            </div>
                                            <div>
                                                <div className="text-[9px] text-gray-500 mb-1 font-semibold">⚠️ Risques</div>
                                                {insights.risks.map((risk, i) => (
                                                    <div key={i} className="text-[8px] text-orange-400 mb-0.5">• {risk}</div>
                                                ))}
                                            </div>
                                            <div className={`p-1.5 border rounded transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <div className="text-[9px] text-gray-500 mb-0.5">Consensus : 
                                                    <span className={`ml-1 font-bold ${
                                                        insights.consensus === 'bullish' ? 'text-emerald-500' :
                                                        insights.consensus === 'bearish' ? 'text-red-500' : 'text-gray-400'
                                                    }`}>
                                                        {insights.consensus === 'bullish' ? '📈 Bullish' : 
                                                         insights.consensus === 'bearish' ? '📉 Bearish' : '➖ Neutre'}
                                                    </span>
                                                </div>
                                                <div className="text-[8px] text-gray-400">{insights.reasoning}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Comparaison */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <h3 className="text-[10px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                        <LucideIcon name="TrendingUp" className="w-3 h-3 text-gray-500" />
                                        Comparaison Pairs
                                    </h3>
                                    <div style={{ width: '100%', height: 120 }}>
                                        <div className="text-center text-gray-500 text-xs py-8">
                                            📊 Graphique Radar (Recharts nécessite une configuration avancée)
                                        </div>
                                    </div>
                                </div>

                            </div>

                            {/* Colonne droite */}
                            <div className="col-span-4 space-y-2">
                                
                                {/* Stats */}
                                <div className="space-y-1.5">
                                    <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <div className="text-[8px] text-gray-600 mb-0.5">Capitalisation</div>
                                        <div className={`text-base font-bold transition-colors duration-300 ${
                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                        }`}>{formatNumber(quote.marketCap)}</div>
                                        <div className="text-[8px] text-gray-500">P/E: {metrics.peRatioTTM?.toFixed(1) || 'N/A'}</div>
                                    </div>

                                    <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <div className="text-[8px] text-gray-600 mb-0.5">Sentiment IA</div>
                                        <div className="flex items-center gap-1.5">
                                            <div className="text-base font-bold text-emerald-500">{sentiment.overall || 0}%</div>
                                            <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${
                                                isDarkMode ? 'bg-neutral-700' : 'bg-gray-200'
                                            }`}>
                                                <div className="h-full bg-emerald-500" style={{ width: `${sentiment.overall || 0}%` }}></div>
                                            </div>
                                        </div>
                                        <div className="text-[8px] text-emerald-500 mt-0.5">
                                            {(sentiment.overall || 0) > 70 ? 'Très Bullish' : (sentiment.overall || 0) > 50 ? 'Bullish' : 'Neutre'}
                                        </div>
                                    </div>

                                    <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <div className="text-[8px] text-gray-600 mb-0.5">Prix Actuel</div>
                                        <div className={`text-base font-bold transition-colors duration-300 ${
                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                        }`}>${parseFloat(quote.price || 0).toFixed(2)}</div>
                                        <div className="text-[8px] text-emerald-500 mt-0.5">Volume: {formatNumber(quote.volume)}</div>
                                    </div>
                                </div>

                                {/* Sentiment détaillé */}
                                {sentiment.overall && (
                                    <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                        isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                    }`}>
                                        <h3 className="text-[9px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                            <LucideIcon name="Brain" className="w-3 h-3 text-gray-500" />
                                            Sentiment IA
                                        </h3>
                                        <div style={{ width: '100%', height: 90 }}>
                                            <div className="text-center text-gray-500 text-xs py-6">
                                                📊 Graphique Sentiment
                                            </div>
                                        </div>
                                        {sentiment.summary && (
                                            <div className={`mt-1.5 p-1.5 border rounded transition-colors duration-300 ${
                                                isDarkMode ? 'bg-neutral-800 border-neutral-700' : 'bg-gray-50 border-gray-200'
                                            }`}>
                                                <div className="text-[8px] text-gray-400">{sentiment.summary}</div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* News */}
                                <div className={`border rounded-lg p-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                                }`}>
                                    <h3 className="text-[9px] font-bold mb-1.5 flex items-center gap-1 text-gray-400">
                                        <LucideIcon name="Newspaper" className="w-3 h-3 text-gray-500" />
                                        News Temps Réel
                                    </h3>
                                    <div className="space-y-1 max-h-40 overflow-y-auto">
                                        {news.map((item, i) => (
                                            <div key={i} className={`p-1.5 border rounded transition-all cursor-pointer ${
                                                isDarkMode 
                                                    ? 'bg-neutral-800 border-neutral-700 hover:bg-neutral-750' 
                                                    : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                                            }`}>
                                                <div className="flex items-start justify-between mb-0.5">
                                                    <div className="text-[7px] px-1 py-0.5 rounded bg-emerald-900 text-emerald-500">📈</div>
                                                    <span className="text-[7px] text-gray-600">{formatTimeAgo(item.publishedDate)}</span>
                                                </div>
                                                <div className={`font-semibold text-[8px] mb-0.5 transition-colors duration-300 ${
                                                    isDarkMode ? 'text-gray-300' : 'text-gray-700'
                                                }`}>{item.title}</div>
                                                <div className="text-[7px] text-gray-500">{item.site}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                            </div>
                        </div>

                        {/* Footer */}
                        <div className={`mt-2 p-1.5 border rounded-lg transition-colors duration-300 ${
                            isDarkMode ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-gray-300'
                        }`}>
                            <div className="flex items-center gap-2">
                                <LucideIcon name="AlertCircle" className="w-3 h-3 text-gray-500" />
                                <div className="flex-1">
                                    <div className="font-semibold text-[9px] text-gray-400">
                                        ✅ Dashboard Hybride Fonctionnel
                                    </div>
                                    <div className="text-[7px] text-gray-600">
                                        Mode Démo • FMP (données précises) + Perplexity (intelligence IA)
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-[8px] text-gray-500 font-bold">Hybride Optimal</div>
                                    <div className="text-[7px] text-gray-600">Précision + IA</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };


            const tabs = [
                { id: 'stocks-news', label: '📊 Titres & nouvelles', component: StocksNewsTab },
                { id: 'intellistocks', label: '🚀 IntelliStocks', component: IntelliStocksTab },
                { id: 'ask-emma', label: '🤖 Emma IA', component: AskEmmaTab },
                { id: 'admin-jsla', label: '⚙️ Admin-JSLAI', component: AdminJSLaiTab },
                { id: 'dans-watchlist', label: "👀 Dan's Watchlist", component: DansWatchlistTab },
                { id: 'scrapping-sa', label: '📈 Seeking Alpha', component: ScrappingSATab }
            ];
            return (
                <div className={`min-h-screen transition-colors duration-300 ${
                    isDarkMode 
                        ? 'bg-black' 
                        : 'bg-white'
                }`}>
                    {/* Intro Emma IA - première visite de session */}
                    {showEmmaIntro && activeTab === 'ask-emma' && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 emma-intro-overlay">
                            <div className="text-center">
                                <div className="mb-6">
                                    <img 
                                        src={'EMMA-JSLAI-GOB-dark.jpg'}
                                        alt="Emma IA"
                                        className="emma-intro-image w-72 h-72 md:w-96 md:h-96 rounded-full object-cover shadow-2xl border-4 border-emerald-500"
                                    />
                                </div>
                                <h2 className="text-white text-3xl md:text-4xl font-bold mb-2">Emma IA</h2>
                                <p className="text-emerald-300 text-lg">Analyste financière virtuelle • JSL AI</p>
                            </div>
                        </div>
                    )}
                    {/* Header */}
                    <header className={`p-6 border-b transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-black border-gray-700' 
                            : 'bg-white border-gray-300'
                    }`}>
                        <div className="max-w-7xl mx-auto">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <div className={`backdrop-blur-md rounded-2xl p-3 shadow-xl border transition-colors duration-300 ${
                                        isDarkMode 
                                            ? 'bg-white/10 border-white/20' 
                                            : 'bg-gray-800/10 border-gray-800/20'
                                    }`}>
                                        <img 
                                            src={isDarkMode ? "/logojslaidark.jpg" : "/logojslailight.jpg"} 
                                            alt="JSL AI Logo" 
                                            className="w-8 h-8 object-contain"
                                        />
                                    </div>
                                    <div>
                                        <h1 className={`text-3xl font-bold mb-2 font-['Inter'] transition-colors duration-300 ${
                                            isDarkMode ? 'text-white' : 'text-gray-900'
                                        }`}>
                                            GOB Apps - Dashboard Financier Beta
                                        </h1>
                                        <p className={`font-['Inter'] transition-colors duration-300 ${
                                            isDarkMode ? 'text-gray-300' : 'text-gray-600'
                                        }`}>
                                            Plateforme financière • Propulsée par JSL AI
                                        </p>
                                    </div>
                                </div>
                                
                                {/* Bouton de basculement de thème */}
                                <button
                                    onClick={toggleTheme}
                                    className={`p-3 rounded-xl transition-all duration-300 hover:scale-105 ${
                                        isDarkMode 
                                            ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400' 
                                            : 'bg-gray-200 hover:bg-gray-300 text-gray-800'
                                    }`}
                                    title={isDarkMode ? 'Passer en mode clair' : 'Passer en mode sombre'}
                                >
                                    {isDarkMode ? '☀️' : '🌙'}
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Navigation par onglets */}
                    <nav className={`backdrop-blur-sm border-b transition-colors duration-300 ${
                        isDarkMode 
                            ? 'bg-black border-gray-700' 
                            : 'bg-white border-gray-300'
                    }`}>
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="hidden md:flex space-x-1">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onMouseDown={withRipple}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`tab-button btn-ripple px-6 py-3 rounded-t-lg font-medium transition-all ${
                                            activeTab === tab.id 
                                                ? (isDarkMode 
                                                    ? 'bg-gray-900 text-white border-b-2 border-green-500' 
                                                    : 'bg-gray-100 text-gray-900 border-b-2 border-green-600')
                                                : (isDarkMode 
                                                    ? 'text-gray-300 hover:text-white hover:bg-gray-900' 
                                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100')
                                        }`}
                                    >
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                            <div className="md:hidden p-3">
                                <select
                                    value={activeTab}
                                    onChange={(e) => setActiveTab(e.target.value)}
                                    className={`w-full rounded p-2 ${isDarkMode ? 'bg-gray-900 text-white border border-gray-700' : 'bg-white text-gray-900 border border-gray-300'}`}
                                >
                                    {tabs.map(tab => (
                                        <option key={tab.id} value={tab.id}>{tab.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </nav>
                    {/* Audio UI feedback (désactivé par défaut jusqu'au premier geste utilisateur) */}
                    <audio ref={tabSoundRef} preload="auto" className="hidden">
                        <source src="https://assets.mixkit.co/active_storage/sfx/2005/2005-preview.mp3" type="audio/mpeg" />
                    </audio>
                    <audio ref={clickSoundRef} preload="auto" className="hidden">
                        <source src="https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3" type="audio/mpeg" />
                    </audio>

                    {/* Contenu principal */}
                    <main className="max-w-7xl mx-auto p-6">
                        {activeTab === 'stocks-news' && <StocksNewsTab />}
                        {activeTab === 'intellistocks' && <IntelliStocksTab />}
                        {activeTab === 'ask-emma' && <AskEmmaTab />}
                        {activeTab === 'admin-jsla' && <AdminJSLaiTab />}
                        {activeTab === 'dans-watchlist' && <DansWatchlistTab />}
                        {activeTab === 'scrapping-sa' && <ScrappingSATab />}
                        {activeTab === 'seeking-alpha' && <SeekingAlphaTab />}
                    </main>

                    {/* Messages */}
                    {message && (
                        <div className={`fixed top-4 right-4 p-4 rounded-lg z-50 ${
                            message.type === 'error' ? 'bg-red-500' : 
                            message.type === 'success' ? 'bg-green-500' : 'bg-blue-500'
                        } text-white`}>
                            {message.text}
                        </div>
                    )}

                </div>
            );
        };

        ReactDOM.render(<BetaCombinedDashboard />, document.getElementById('root'));
    </script>
    
    <!-- Scripts Emma -->
    <script type="module">
        // Import des modules Emma
        import { emmaDashboard } from './emma-dashboard-integration.js';
        
        // Initialiser Emma après le rendu du dashboard
        setTimeout(() => {
            emmaDashboard.initialize();
        }, 1000);
    </script>
</body>
</html>