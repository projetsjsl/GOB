<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Perplexity Labs - GOB</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/themes.css">
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2"> Perplexity Labs - Test Suite</h1>
            <p class="text-gray-600">Testez les capacites avancees de Perplexity pour donnees financieres</p>
        </div>

        <!-- Test Selector -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Selectionnez un test</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Test 1: Availability -->
                <button onclick="runTest('availability')" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 text-left transition-colors">
                    <div class="font-bold text-lg mb-2"> Test de disponibilite</div>
                    <div class="text-sm text-gray-600">Verifie quels modeles sont disponibles (sonar, sonar-pro, sonar-reasoning)</div>
                </button>

                <!-- Test 2: Financial Query -->
                <button onclick="runTest('financial')" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 text-left transition-colors">
                    <div class="font-bold text-lg mb-2"> Requete financiere</div>
                    <div class="text-sm text-gray-600">Teste une requete simple pour obtenir des donnees de marche</div>
                </button>

                <!-- Test 3: Image Tags -->
                <button onclick="runTest('images')" class="p-4 border-2 border-purple-500 rounded-lg hover:bg-purple-50 text-left transition-colors">
                    <div class="font-bold text-lg mb-2"> Tags d'images</div>
                    <div class="text-sm text-gray-600">Teste la generation de tags [CHART:...], [LOGO:...] dans les reponses</div>
                </button>

                <!-- Test 4: Model Comparison -->
                <button onclick="runTest('compare')" class="p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 text-left transition-colors">
                    <div class="font-bold text-lg mb-2"> Comparaison modeles</div>
                    <div class="text-sm text-gray-600">Compare sonar vs sonar-pro en qualite et vitesse</div>
                </button>
            </div>

            <!-- Ticker Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Ticker (pour tests financiers)
                </label>
                <input
                    type="text"
                    id="ticker"
                    value="AAPL"
                    placeholder="AAPL"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
            </div>

            <!-- Model Selector -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Modele (pour tests individuels)
                </label>
                <select
                    id="model"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                    <option value="sonar">sonar (base)</option>
                    <option value="sonar-pro" selected>sonar-pro (recommande)</option>
                    <option value="sonar-reasoning">sonar-reasoning (experimental)</option>
                </select>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-lg">
            <div class="flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="font-medium">Test en cours...</span>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results" class="hidden">
            <!-- Results will be inserted here -->
        </div>
    </div>

    <script>
        let currentTest = null;

        async function runTest(testType) {
            const ticker = document.getElementById('ticker').value || 'AAPL';
            const model = document.getElementById('model').value || 'sonar-pro';

            currentTest = testType;

            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                let url = `/api/test-perplexity-labs?test=${testType}`;

                if (testType === 'financial' || testType === 'images' || testType === 'compare') {
                    url += `&ticker=${ticker}`;
                }

                if (testType === 'financial' || testType === 'images') {
                    url += `&model=${model}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                displayResults(testType, data);
            } catch (error) {
                displayError(error);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayResults(testType, data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');

            let html = '';

            // Header
            html += `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Resultats du test: ${testType}</h2>
                        <span class="text-sm text-gray-500">${data.timestamp}</span>
                    </div>
            `;

            if (testType === 'availability') {
                html += '<div class="space-y-2">';
                data.results.forEach(result => {
                    const statusColor = result.available ? 'green' : 'red';
                    const statusIcon = result.available ? '' : '';
                    html += `
                        <div class="flex items-center justify-between p-3 border rounded-lg">
                            <span class="font-medium">${result.model}</span>
                            <span class="text-${statusColor}-600">${statusIcon} ${result.status}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (testType === 'financial') {
                html += `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Ticker</div>
                                <div class="font-bold text-lg">${data.ticker}</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Modele</div>
                                <div class="font-bold text-lg">${data.model}</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Temps de reponse</div>
                                <div class="font-bold text-lg">${data.responseTime}ms</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Citations</div>
                                <div class="font-bold text-lg">${data.citations?.length || 0}</div>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <h3 class="font-bold text-lg mb-2">Reponse:</h3>
                            <div class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap">${data.content}</div>
                        </div>

                        ${data.citations?.length > 0 ? `
                            <div class="border-t pt-4">
                                <h3 class="font-bold text-lg mb-2">Citations:</h3>
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.citations.map(c => `<li class="text-sm text-blue-600">${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${data.usage ? `
                            <div class="border-t pt-4">
                                <h3 class="font-bold text-lg mb-2">Usage:</h3>
                                <div class="text-sm text-gray-600">
                                    Prompt: ${data.usage.prompt_tokens || 'N/A'} tokens,
                                    Completion: ${data.usage.completion_tokens || 'N/A'} tokens,
                                    Total: ${data.usage.total_tokens || 'N/A'} tokens
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (testType === 'images') {
                html += `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Ticker</div>
                                <div class="font-bold text-lg">${data.ticker}</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Tags d'images detectes</div>
                                <div class="font-bold text-lg">${data.imageTags?.length || 0}</div>
                            </div>
                        </div>

                        ${data.imageTags?.length > 0 ? `
                            <div class="border-t pt-4">
                                <h3 class="font-bold text-lg mb-2"> Tags d'images detectes:</h3>
                                <div class="space-y-2">
                                    ${data.imageTags.map(tag => `
                                        <div class="p-2 bg-purple-50 border border-purple-200 rounded font-mono text-sm">
                                            ${tag}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="border-t pt-4">
                            <h3 class="font-bold text-lg mb-2">Reponse:</h3>
                            <div class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap">${data.content}</div>
                        </div>

                        ${data.citations?.length > 0 ? `
                            <div class="border-t pt-4">
                                <h3 class="font-bold text-lg mb-2">Citations:</h3>
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.citations.map(c => `<li class="text-sm text-blue-600">${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (testType === 'compare') {
                html += `
                    <div class="space-y-4">
                        <div class="text-sm text-gray-600 mb-4">Ticker: ${data.ticker}</div>

                        ${data.results.map(result => `
                            <div class="border rounded-lg p-4 ${result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-bold text-lg">${result.model}</h3>
                                    <span class="text-sm ${result.success ? 'text-green-600' : 'text-red-600'}">
                                        ${result.success ? ' Succes' : ' Echec'}
                                    </span>
                                </div>

                                ${result.success ? `
                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                        <div class="text-sm">
                                            <span class="text-gray-600">Temps:</span>
                                            <span class="font-medium ml-1">${result.responseTime}ms</span>
                                        </div>
                                        <div class="text-sm">
                                            <span class="text-gray-600">Citations:</span>
                                            <span class="font-medium ml-1">${result.citations}</span>
                                        </div>
                                        <div class="text-sm">
                                            <span class="text-gray-600">Tokens:</span>
                                            <span class="font-medium ml-1">${result.tokens}</span>
                                        </div>
                                    </div>

                                    <div class="p-3 bg-white rounded border text-sm whitespace-pre-wrap">
                                        ${result.content}
                                    </div>
                                ` : `
                                    <div class="text-sm text-red-600">
                                        Erreur: ${result.error}
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Erreur lors du test</h3>
                            <div class="mt-2 text-sm text-red-700">
                                ${error.message || error}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
