<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ğŸ”‡ INTERCEPTION ULTRA-AGGRESSIVE -->
    <script>
        (function() {
            'use strict';
            const originalWarn = console.warn;
            const originalError = console.error;
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('cdn.tailwindcss.com') || message.includes('should not be used in production')) return;
                originalWarn.apply(console, args);
            };
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('share-modal') || message.includes('chrome-extension') || message.includes('extension://') || message.includes('Cannot read properties of null') || message.includes('Uncaught TypeError')) return;
                originalError.apply(console, args);
            };
            window.onerror = function(message, source, lineno, colno, error) {
                if (!source) return true;
                const sourceStr = String(source);
                const messageStr = String(message);
                if (sourceStr.includes('share-modal') || sourceStr.includes('chrome-extension') || sourceStr.includes('extension://') || messageStr.includes('Cannot read properties of null')) return true;
                return false;
            };
            window.addEventListener('error', function(event) {
                if (!event.filename) { event.stopImmediatePropagation(); event.preventDefault(); return true; }
                const filename = String(event.filename);
                const message = String(event.message || '');
                if (filename.includes('share-modal') || filename.includes('chrome-extension') || filename.includes('extension://') || message.includes('Cannot read properties of null')) {
                    event.stopImmediatePropagation(); event.preventDefault(); return true;
                }
            }, true);
            window.addEventListener('unhandledrejection', function(event) {
                const reason = String(event.reason || '');
                const reasonMsg = event.reason ? (event.reason.message || String(event.reason)) : '';
                if (reason.includes('share-modal') || reason.includes('chrome-extension') || reason.includes('extension://') || reason.includes('Access to storage') || reason.includes('storage is not allowed') || reasonMsg.includes('Access to storage') || reasonMsg.includes('storage is not allowed')) {
                    console.warn('âš ï¸ Erreur storage/extension interceptÃ©e:', reasonMsg || reason);
                    event.stopImmediatePropagation(); event.preventDefault();
                }
            }, true);
            const originalAddEventListener = EventTarget.prototype.addEventListener;
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                if (this === null || this === undefined) return;
                try { return originalAddEventListener.call(this, type, listener, options); } catch (e) { return; }
            };
        })();
    </script>

    <!-- ğŸ’¾ SAFE STORAGE WRAPPER -->
    <script>
        (function() {
            'use strict';
            const storageAvailable = (type) => {
                try {
                    const storage = window[type];
                    const test = '__test__';
                    storage.setItem(test, test);
                    storage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            };
            const localAvail = storageAvailable('localStorage');
            const sessionAvail = storageAvailable('sessionStorage');
            const mem = {};
            const safeLocal = {
                getItem: (k) => { try { return localAvail ? localStorage.getItem(k) : (mem['l_'+k]||null); } catch(e) { return mem['l_'+k]||null; }},
                setItem: (k,v) => { try { localAvail ? localStorage.setItem(k,v) : (mem['l_'+k]=String(v)); } catch(e) { mem['l_'+k]=String(v); }},
                removeItem: (k) => { try { localAvail ? localStorage.removeItem(k) : delete mem['l_'+k]; } catch(e) { delete mem['l_'+k]; }},
                clear: () => { try { localAvail ? localStorage.clear() : Object.keys(mem).forEach(k=>{if(k.startsWith('l_'))delete mem[k]}); } catch(e) { Object.keys(mem).forEach(k=>{if(k.startsWith('l_'))delete mem[k]}); }}
            };
            const safeSession = {
                getItem: (k) => { try { return sessionAvail ? sessionStorage.getItem(k) : (mem['s_'+k]||null); } catch(e) { return mem['s_'+k]||null; }},
                setItem: (k,v) => { try { sessionAvail ? sessionStorage.setItem(k,v) : (mem['s_'+k]=String(v)); } catch(e) { mem['s_'+k]=String(v); }},
                removeItem: (k) => { try { sessionAvail ? sessionStorage.removeItem(k) : delete mem['s_'+k]; } catch(e) { delete mem['s_'+k]; }},
                clear: () => { try { sessionAvail ? sessionStorage.clear() : Object.keys(mem).forEach(k=>{if(k.startsWith('s_'))delete mem[k]}); } catch(e) { Object.keys(mem).forEach(k=>{if(k.startsWith('s_'))delete mem[k]}); }}
            };
            try { Object.defineProperty(window, 'localStorage', {value: safeLocal, writable: false, configurable: true}); } catch(e) { window.safeLocalStorage = safeLocal; }
            try { Object.defineProperty(window, 'sessionStorage', {value: safeSession, writable: false, configurable: true}); } catch(e) { window.safeSessionStorage = safeSession; }
            console.log('ğŸ’¾ Storage:', localAvail?'âœ…':'âš ï¸', '/', sessionAvail?'âœ…':'âš ï¸');
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin JSLai - Gestion Emma IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .section-card {
            transition: all 0.3s ease;
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold">ğŸ”§ Admin JSLai</h1>
                        <p class="text-blue-100 mt-1">Gestion de la configuration systÃ¨me d'Emma IA</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="saveAllBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-semibold transition">
                            ğŸ’¾ Sauvegarder Tout
                        </button>
                        <button id="reloadBtn" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold transition">
                            ğŸ”„ Recharger
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Status Bar -->
            <div id="statusBar" class="mb-6 p-4 rounded-lg bg-white shadow hidden">
                <p id="statusMessage" class="text-sm"></p>
            </div>

            <!-- Tabs -->
            <div class="mb-6 bg-white rounded-lg shadow p-4">
                <div class="flex flex-wrap gap-2 border-b">
                    <button class="tab-btn px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600" data-tab="prompts-cfa">
                        ğŸ“ Prompts CFA
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="prompts-intentions">
                        ğŸ¯ Intentions
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="prompts-briefings">
                        ğŸ“§ Briefings
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="variables">
                        âš™ï¸ Variables
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="directives">
                        ğŸ¯ Directives
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="routing">
                        ğŸ§­ Routage
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div id="tabContent" class="space-y-6">
                <!-- Prompts CFA Tab -->
                <div id="prompts-cfa-tab" class="tab-content">
                    <div class="grid grid-cols-1 gap-6">
                        <!-- CFA Identity -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“ IdentitÃ© CFA</h3>
                            <p class="text-sm text-gray-600 mb-4">IdentitÃ© et qualifications d'Emma (CFA Charterholder, 15 ans d'expÃ©rience)</p>
                            <textarea
                                id="prompt-cfa_identity"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt CFA Identity..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_identity', 'prompt-cfa_identity')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA Standards -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š Standards d'Excellence CFA</h3>
                            <p class="text-sm text-gray-600 mb-4">Standards de qualitÃ© et d'Ã©thique CFA Institute</p>
                            <textarea
                                id="prompt-cfa_standards"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Standards d'excellence CFAÂ®..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_standards', 'prompt-cfa_standards')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA Output Format -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“ Format de Sortie Bloomberg</h3>
                            <p class="text-sm text-gray-600 mb-4">Format structurÃ© style Bloomberg Terminal</p>
                            <textarea
                                id="prompt-cfa_output_format"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Format Bloomberg Terminal..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_output_format', 'prompt-cfa_output_format')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA Product Guidance -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ¦ Guidance par Type de Produit</h3>
                            <p class="text-sm text-gray-600 mb-4">Directives spÃ©cifiques par classe d'actifs (actions, obligations, ETF, etc.)</p>
                            <textarea
                                id="prompt-cfa_product_guidance"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Guidance par type de produit financier..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_product_guidance', 'prompt-cfa_product_guidance')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA Perplexity Priority -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ” PrioritÃ© Perplexity</h3>
                            <p class="text-sm text-gray-600 mb-4">Consignes d'utilisation de Perplexity pour recherche en temps rÃ©el</p>
                            <textarea
                                id="prompt-cfa_perplexity_priority"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="PrioritÃ© d'utilisation Perplexity..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_perplexity_priority', 'prompt-cfa_perplexity_priority')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA SMS Format -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“± Format SMS OptimisÃ©</h3>
                            <p class="text-sm text-gray-600 mb-4">Format ultra-concis pour SMS (max 300 caractÃ¨res)</p>
                            <textarea
                                id="prompt-cfa_sms_format"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Format SMS optimisÃ©..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_sms_format', 'prompt-cfa_sms_format')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- CFA Quality Checklist -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">âœ… Checklist QualitÃ©</h3>
                            <p class="text-sm text-gray-600 mb-4">VÃ©rifications avant envoi de rÃ©ponse</p>
                            <textarea
                                id="prompt-cfa_quality_checklist"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Checklist qualitÃ© avant envoi..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_quality_checklist', 'prompt-cfa_quality_checklist')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Prompts Intentions Tab -->
                <div id="prompts-intentions-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Comprehensive Analysis -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ”¬ Analyse ComplÃ¨te</h3>
                            <p class="text-sm text-gray-600 mb-4">Prompt pour analyses dÃ©taillÃ©es et rapports complets</p>
                            <textarea
                                id="prompt-intent_comprehensive_analysis"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt analyse complÃ¨te..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'intent_comprehensive_analysis', 'prompt-intent_comprehensive_analysis')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- Stock Price -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ’° Prix d'Action</h3>
                            <p class="text-sm text-gray-600 mb-4">Prompt pour demandes de prix et cotations rapides</p>
                            <textarea
                                id="prompt-intent_stock_price"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt demandes de prix..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'intent_stock_price', 'prompt-intent_stock_price')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- Fundamentals -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ Fondamentaux</h3>
                            <p class="text-sm text-gray-600 mb-4">Prompt pour analyses fondamentales (ratios, bilans, etc.)</p>
                            <textarea
                                id="prompt-intent_fundamentals"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt fondamentaux..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'intent_fundamentals', 'prompt-intent_fundamentals')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- News -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“° ActualitÃ©s</h3>
                            <p class="text-sm text-gray-600 mb-4">Prompt pour rÃ©sumÃ©s d'actualitÃ©s et Ã©vÃ©nements rÃ©cents</p>
                            <textarea
                                id="prompt-intent_news"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt actualitÃ©s..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'intent_news', 'prompt-intent_news')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- Comparative Analysis -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">âš–ï¸ Analyse Comparative</h3>
                            <p class="text-sm text-gray-600 mb-4">Prompt pour comparaisons entre actions/ETF/secteurs</p>
                            <textarea
                                id="prompt-intent_comparative_analysis"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt analyses comparatives..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'intent_comparative_analysis', 'prompt-intent_comparative_analysis')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Prompts Briefings Tab -->
                <div id="prompts-briefings-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Morning Briefing -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸŒ… Briefing Matinal</h3>
                            <p class="text-sm text-gray-600 mb-4">Configuration JSON pour briefing du matin (11:20 UTC)</p>
                            <textarea
                                id="prompt-briefing_morning"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y font-mono text-xs"
                                placeholder='{"title": "...", "sections": [...], ...}'
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'briefing_morning', 'prompt-briefing_morning', 'json')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- Midday Briefing -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸŒ¤ï¸ Briefing Midi</h3>
                            <p class="text-sm text-gray-600 mb-4">Configuration JSON pour briefing de midi (15:50 UTC)</p>
                            <textarea
                                id="prompt-briefing_midday"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y font-mono text-xs"
                                placeholder='{"title": "...", "sections": [...], ...}'
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'briefing_midday', 'prompt-briefing_midday', 'json')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- Evening Briefing -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸŒ™ Briefing Soir</h3>
                            <p class="text-sm text-gray-600 mb-4">Configuration JSON pour briefing du soir (20:20 UTC)</p>
                            <textarea
                                id="prompt-briefing_evening"
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y font-mono text-xs"
                                placeholder='{"title": "...", "sections": [...], ...}'
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'briefing_evening', 'prompt-briefing_evening', 'json')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Variables Tab -->
                <div id="variables-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Max Tokens (DÃ©faut)</h3>
                            <p class="text-xs text-gray-500 mb-2">Limite de tokens pour rÃ©ponses normales</p>
                            <input type="number" id="var-max_tokens_default" class="w-full p-3 border rounded-lg" value="4000">
                            <button onclick="saveConfig('variables', 'max_tokens_default', 'var-max_tokens_default', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Max Tokens (Briefing)</h3>
                            <p class="text-xs text-gray-500 mb-2">Limite pour briefings quotidiens</p>
                            <input type="number" id="var-max_tokens_briefing" class="w-full p-3 border rounded-lg" value="10000">
                            <button onclick="saveConfig('variables', 'max_tokens_briefing', 'var-max_tokens_briefing', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">TempÃ©rature</h3>
                            <p class="text-xs text-gray-500 mb-2">CrÃ©ativitÃ© IA (0.0-1.0)</p>
                            <input type="number" step="0.1" min="0" max="1" id="var-temperature" class="w-full p-3 border rounded-lg" value="0.1">
                            <button onclick="saveConfig('variables', 'temperature', 'var-temperature', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">RÃ©cence (DÃ©faut)</h3>
                            <p class="text-xs text-gray-500 mb-2">Filtre temporel par dÃ©faut</p>
                            <select id="var-recency_default" class="w-full p-3 border rounded-lg">
                                <option value="day">Jour</option>
                                <option value="week">Semaine</option>
                                <option value="month" selected>Mois</option>
                                <option value="year">AnnÃ©e</option>
                            </select>
                            <button onclick="saveConfig('variables', 'recency_default', 'var-recency_default')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">DurÃ©e Cache (min)</h3>
                            <p class="text-xs text-gray-500 mb-2">Cache configs Supabase</p>
                            <input type="number" id="var-cache_duration_minutes" class="w-full p-3 border rounded-lg" value="5">
                            <button onclick="saveConfig('variables', 'cache_duration_minutes', 'var-cache_duration_minutes', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Directives Tab -->
                <div id="directives-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Autoriser Clarifications</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dir-allow_clarifications" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-600">Permettre Ã  Emma de poser des questions de clarification</p>
                            <button onclick="saveConfig('directives', 'allow_clarifications', 'dir-allow_clarifications', 'boolean')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Longueur Adaptative</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dir-adaptive_length" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-600">Adapter la longueur selon la complexitÃ© de la question</p>
                            <button onclick="saveConfig('directives', 'adaptive_length', 'dir-adaptive_length', 'boolean')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Exiger Sources</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dir-require_sources" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-600">Exiger citations de sources pour donnÃ©es factuelles</p>
                            <button onclick="saveConfig('directives', 'require_sources', 'dir-require_sources', 'boolean')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Ratios Min (Simple)</h3>
                            <p class="text-xs text-gray-500 mb-2">Pour questions simples de prix</p>
                            <input type="number" id="dir-min_ratios_simple" class="w-full p-3 border rounded-lg" value="1">
                            <button onclick="saveConfig('directives', 'min_ratios_simple', 'dir-min_ratios_simple', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Ratios Min (Complet)</h3>
                            <p class="text-xs text-gray-500 mb-2">Pour analyses complÃ¨tes</p>
                            <input type="number" id="dir-min_ratios_comprehensive" class="w-full p-3 border rounded-lg" value="8">
                            <button onclick="saveConfig('directives', 'min_ratios_comprehensive', 'dir-min_ratios_comprehensive', 'number')"
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Routing Tab -->
                <div id="routing-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-4">ğŸ” Perplexity Seul (Keywords)</h3>
                            <p class="text-sm text-gray-600 mb-4">Mots-clÃ©s dÃ©clenchant Perplexity seul (sans APIs)</p>
                            <textarea
                                id="routing-use_perplexity_only_keywords"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y font-mono text-xs"
                                placeholder='["fonds", "quartile", "macro", ...]'
                            ></textarea>
                            <button onclick="saveConfig('routing', 'use_perplexity_only_keywords', 'routing-use_perplexity_only_keywords', 'json')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-4">ğŸ”Œ APIs Requises (Keywords)</h3>
                            <p class="text-sm text-gray-600 mb-4">Mots-clÃ©s nÃ©cessitant des APIs complÃ©mentaires</p>
                            <textarea
                                id="routing-require_apis_keywords"
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y font-mono text-xs"
                                placeholder='["prix actuel", "ratio exact", ...]'
                            ></textarea>
                            <button onclick="saveConfig('routing', 'require_apis_keywords', 'routing-require_apis_keywords', 'json')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-4">ğŸ¯ Seuil de Confiance (Intent)</h3>
                            <p class="text-sm text-gray-600 mb-4">Seuil minimal de confiance pour dÃ©tection d'intention (0.0-1.0)</p>
                            <input type="number" step="0.1" min="0" max="1" id="routing-intent_confidence_threshold" class="w-full p-3 border rounded-lg" value="0.7">
                            <button onclick="saveConfig('routing', 'intent_confidence_threshold', 'routing-intent_confidence_threshold', 'number')"
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api/admin/emma-config';

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    b.classList.add('text-gray-600');
                });
                btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.remove('text-gray-600');

                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tab}-tab`).classList.remove('hidden');
            });
        });

        // Load configuration
        async function loadConfig() {
            try {
                showStatus('Chargement de la configuration...', 'info');

                const response = await fetch(`${API_BASE}`);

                const data = await response.json();
                
                if (data.config) {
                    populateForm(data.config);
                    showStatus('Configuration chargÃ©e avec succÃ¨s', 'success');
                } else {
                    showStatus('Erreur lors du chargement', 'error');
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                showStatus('Erreur: ' + error.message, 'error');
            }
        }

        // Populate form with config
        function populateForm(config) {
            // Prompts CFA (7 items)
            if (config.prompts) {
                const promptFields = [
                    'cfa_identity', 'cfa_standards', 'cfa_output_format', 'cfa_product_guidance',
                    'cfa_perplexity_priority', 'cfa_sms_format', 'cfa_quality_checklist',
                    'intent_comprehensive_analysis', 'intent_stock_price', 'intent_fundamentals',
                    'intent_news', 'intent_comparative_analysis',
                    'briefing_morning', 'briefing_midday', 'briefing_evening'
                ];

                promptFields.forEach(key => {
                    const elem = document.getElementById(`prompt-${key}`);
                    if (elem && config.prompts[key]?.value) {
                        if (typeof config.prompts[key].value === 'object') {
                            elem.value = JSON.stringify(config.prompts[key].value, null, 2);
                        } else {
                            elem.value = config.prompts[key].value;
                        }
                    }
                });
            }

            // Variables (5 items)
            if (config.variables) {
                Object.keys(config.variables).forEach(key => {
                    const elem = document.getElementById(`var-${key}`);
                    if (elem && config.variables[key]?.value !== undefined) {
                        elem.value = config.variables[key].value;
                    }
                });
            }

            // Directives (5 items)
            if (config.directives) {
                Object.keys(config.directives).forEach(key => {
                    const elem = document.getElementById(`dir-${key}`);
                    if (elem) {
                        if (elem.type === 'checkbox') {
                            elem.checked = config.directives[key]?.value === true;
                        } else {
                            elem.value = config.directives[key]?.value || '';
                        }
                    }
                });
            }

            // Routing (3 items)
            if (config.routing) {
                Object.keys(config.routing).forEach(key => {
                    const elem = document.getElementById(`routing-${key}`);
                    if (elem && config.routing[key]?.value !== undefined) {
                        if (Array.isArray(config.routing[key].value)) {
                            elem.value = JSON.stringify(config.routing[key].value, null, 2);
                        } else {
                            elem.value = config.routing[key].value;
                        }
                    }
                });
            }
        }

        // Save configuration
        async function saveConfig(section, key, elementId, type = 'string') {
            try {
                const element = document.getElementById(elementId);
                let value = element.value;

                // Parse selon type
                if (type === 'number') {
                    value = parseFloat(value);
                } else if (type === 'boolean') {
                    value = element.checked;
                } else if (type === 'json') {
                    value = JSON.parse(value);
                }

                showStatus('Sauvegarde en cours...', 'info');

                const response = await fetch(`${API_BASE}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'set',
                        section,
                        key,
                        value
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus(`âœ… ${section}.${key} sauvegardÃ© avec succÃ¨s`, 'success');
                } else {
                    showStatus('Erreur: ' + (data.error || 'Inconnue'), 'error');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showStatus('Erreur: ' + error.message, 'error');
            }
        }

        // Save all
        document.getElementById('saveAllBtn').addEventListener('click', async () => {
            const configs = [];

            // Prompts CFA (7)
            const cfaPrompts = ['cfa_identity', 'cfa_standards', 'cfa_output_format', 'cfa_product_guidance', 'cfa_perplexity_priority', 'cfa_sms_format', 'cfa_quality_checklist'];
            cfaPrompts.forEach(key => {
                const elem = document.getElementById(`prompt-${key}`);
                if (elem && elem.value) {
                    configs.push({ section: 'prompts', key, value: elem.value });
                }
            });

            // Prompts Intentions (5)
            const intentPrompts = ['intent_comprehensive_analysis', 'intent_stock_price', 'intent_fundamentals', 'intent_news', 'intent_comparative_analysis'];
            intentPrompts.forEach(key => {
                const elem = document.getElementById(`prompt-${key}`);
                if (elem && elem.value) {
                    configs.push({ section: 'prompts', key, value: elem.value });
                }
            });

            // Prompts Briefings (3)
            const briefingPrompts = ['briefing_morning', 'briefing_midday', 'briefing_evening'];
            briefingPrompts.forEach(key => {
                const elem = document.getElementById(`prompt-${key}`);
                if (elem && elem.value) {
                    try {
                        configs.push({ section: 'prompts', key, value: JSON.parse(elem.value), type: 'json' });
                    } catch (e) {
                        showStatus(`Erreur JSON dans ${key}`, 'error');
                    }
                }
            });

            // Variables (5)
            configs.push({ section: 'variables', key: 'max_tokens_default', value: parseFloat(document.getElementById('var-max_tokens_default').value), type: 'number' });
            configs.push({ section: 'variables', key: 'max_tokens_briefing', value: parseFloat(document.getElementById('var-max_tokens_briefing').value), type: 'number' });
            configs.push({ section: 'variables', key: 'temperature', value: parseFloat(document.getElementById('var-temperature').value), type: 'number' });
            configs.push({ section: 'variables', key: 'recency_default', value: document.getElementById('var-recency_default').value });
            configs.push({ section: 'variables', key: 'cache_duration_minutes', value: parseFloat(document.getElementById('var-cache_duration_minutes').value), type: 'number' });

            // Directives (5)
            configs.push({ section: 'directives', key: 'allow_clarifications', value: document.getElementById('dir-allow_clarifications').checked, type: 'boolean' });
            configs.push({ section: 'directives', key: 'adaptive_length', value: document.getElementById('dir-adaptive_length').checked, type: 'boolean' });
            configs.push({ section: 'directives', key: 'require_sources', value: document.getElementById('dir-require_sources').checked, type: 'boolean' });
            configs.push({ section: 'directives', key: 'min_ratios_simple', value: parseFloat(document.getElementById('dir-min_ratios_simple').value), type: 'number' });
            configs.push({ section: 'directives', key: 'min_ratios_comprehensive', value: parseFloat(document.getElementById('dir-min_ratios_comprehensive').value), type: 'number' });

            // Routing (3)
            try {
                configs.push({ section: 'routing', key: 'use_perplexity_only_keywords', value: JSON.parse(document.getElementById('routing-use_perplexity_only_keywords').value), type: 'json' });
                configs.push({ section: 'routing', key: 'require_apis_keywords', value: JSON.parse(document.getElementById('routing-require_apis_keywords').value), type: 'json' });
                configs.push({ section: 'routing', key: 'intent_confidence_threshold', value: parseFloat(document.getElementById('routing-intent_confidence_threshold').value), type: 'number' });
            } catch (e) {
                showStatus('Erreur parsing JSON routing: ' + e.message, 'error');
                return;
            }

            // Save all
            showStatus(`Sauvegarde de ${configs.length} configurations...`, 'info');
            let successCount = 0;

            for (const config of configs) {
                try {
                    const response = await fetch(`${API_BASE}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'set',
                            ...config
                        })
                    });

                    if (response.ok) successCount++;
                } catch (e) {
                    console.error('Erreur sauvegarde', config, e);
                }
            }

            showStatus(`âœ… ${successCount}/${configs.length} configurations sauvegardÃ©es`, 'success');
        });

        // Reload
        document.getElementById('reloadBtn').addEventListener('click', loadConfig);

        // Status bar
        function showStatus(message, type = 'info') {
            const bar = document.getElementById('statusBar');
            const msg = document.getElementById('statusMessage');
            
            bar.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100');
            
            if (type === 'success') {
                bar.classList.add('bg-green-100');
                msg.className = 'text-green-800';
            } else if (type === 'error') {
                bar.classList.add('bg-red-100');
                msg.className = 'text-red-800';
            } else {
                bar.classList.add('bg-blue-100');
                msg.className = 'text-blue-800';
            }
            
            msg.textContent = message;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => bar.classList.add('hidden'), 5000);
            }
        }

        // Load on init
        loadConfig();
    </script>
</body>
</html>
