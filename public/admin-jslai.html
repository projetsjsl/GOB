<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ğŸ”‡ INTERCEPTION ERREURS: DOIT ÃŠTRE LA TOUTE PREMIÃˆRE CHOSE -->
    <script>
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('cdn.tailwindcss.com') || message.includes('should not be used in production')) return;
                originalWarn.apply(console, args);
            };
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('share-modal') || message.includes('chrome-extension') || message.includes('extension://')) return;
                originalError.apply(console, args);
            };
            window.onerror = function(message, source, lineno, colno, error) {
                if (source && (source.includes('share-modal') || source.includes('chrome-extension') || source.includes('extension://'))) return true;
                return false;
            };
            window.addEventListener('error', function(event) {
                if (event.filename && (event.filename.includes('share-modal') || event.filename.includes('chrome-extension') || event.filename.includes('extension://'))) {
                    event.stopImmediatePropagation();
                    event.preventDefault();
                    return true;
                }
                if (event.message === 'Script error.' || !event.filename) {
                    event.stopImmediatePropagation();
                    event.preventDefault();
                    return true;
                }
            }, true);
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin JSLai - Gestion Emma IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .section-card {
            transition: all 0.3s ease;
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold">ğŸ”§ Admin JSLai</h1>
                        <p class="text-blue-100 mt-1">Gestion de la configuration systÃ¨me d'Emma IA</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="saveAllBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-semibold transition">
                            ğŸ’¾ Sauvegarder Tout
                        </button>
                        <button id="reloadBtn" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold transition">
                            ğŸ”„ Recharger
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Status Bar -->
            <div id="statusBar" class="mb-6 p-4 rounded-lg bg-white shadow hidden">
                <p id="statusMessage" class="text-sm"></p>
            </div>

            <!-- Tabs -->
            <div class="mb-6 bg-white rounded-lg shadow p-4">
                <div class="flex space-x-4 border-b">
                    <button class="tab-btn px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600" data-tab="prompts">
                        ğŸ“ Prompts SystÃ¨me
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="variables">
                        âš™ï¸ Variables
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="directives">
                        ğŸ¯ Directives
                    </button>
                    <button class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" data-tab="routing">
                        ğŸ§­ Routage
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div id="tabContent" class="space-y-6">
                <!-- Prompts Tab -->
                <div id="prompts-tab" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- CFA Identity -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">IdentitÃ© CFA</h3>
                            <p class="text-sm text-gray-600 mb-4">IdentitÃ© et qualifications d'Emma pour analyses financiÃ¨res</p>
                            <textarea 
                                id="prompt-cfa_identity" 
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt CFA Identity..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'cfa_identity', 'prompt-cfa_identity')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- General Identity -->
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">IdentitÃ© GÃ©nÃ©rale</h3>
                            <p class="text-sm text-gray-600 mb-4">IdentitÃ© d'Emma pour questions non-financiÃ¨res</p>
                            <textarea 
                                id="prompt-general_identity" 
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Prompt General Identity..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'general_identity', 'prompt-general_identity')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <!-- System Instructions -->
                        <div class="section-card bg-white rounded-lg shadow p-6 lg:col-span-2">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">Instructions SystÃ¨me</h3>
                            <p class="text-sm text-gray-600 mb-4">Directives gÃ©nÃ©rales pour toutes les rÃ©ponses d'Emma</p>
                            <textarea 
                                id="prompt-system_instructions" 
                                class="w-full h-64 p-3 border rounded-lg code-editor resize-y"
                                placeholder="Instructions systÃ¨me..."
                            ></textarea>
                            <button onclick="saveConfig('prompts', 'system_instructions', 'prompt-system_instructions')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Variables Tab -->
                <div id="variables-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Max Tokens (DÃ©faut)</h3>
                            <input type="number" id="var-max_tokens_default" class="w-full p-3 border rounded-lg" value="4000">
                            <button onclick="saveConfig('variables', 'max_tokens_default', 'var-max_tokens_default', 'number')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Max Tokens (Briefing)</h3>
                            <input type="number" id="var-max_tokens_briefing" class="w-full p-3 border rounded-lg" value="10000">
                            <button onclick="saveConfig('variables', 'max_tokens_briefing', 'var-max_tokens_briefing', 'number')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">TempÃ©rature</h3>
                            <input type="number" step="0.1" min="0" max="1" id="var-temperature" class="w-full p-3 border rounded-lg" value="0.1">
                            <button onclick="saveConfig('variables', 'temperature', 'var-temperature', 'number')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">RÃ©cence (DÃ©faut)</h3>
                            <select id="var-recency_default" class="w-full p-3 border rounded-lg">
                                <option value="day">Jour</option>
                                <option value="week">Semaine</option>
                                <option value="month" selected>Mois</option>
                                <option value="year">AnnÃ©e</option>
                            </select>
                            <button onclick="saveConfig('variables', 'recency_default', 'var-recency_default')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Directives Tab -->
                <div id="directives-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Autoriser Clarifications</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dir-allow_clarifications" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-600">Permettre Ã  Emma de poser des questions de clarification</p>
                            <button onclick="saveConfig('directives', 'allow_clarifications', 'dir-allow_clarifications', 'boolean')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Longueur Adaptative</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dir-adaptive_length" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-600">Adapter la longueur selon la complexitÃ© de la question</p>
                            <button onclick="saveConfig('directives', 'adaptive_length', 'dir-adaptive_length', 'boolean')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Ratios Min (Simple)</h3>
                            <input type="number" id="dir-min_ratios_simple" class="w-full p-3 border rounded-lg" value="1">
                            <button onclick="saveConfig('directives', 'min_ratios_simple', 'dir-min_ratios_simple', 'number')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-2">Ratios Min (Complet)</h3>
                            <input type="number" id="dir-min_ratios_comprehensive" class="w-full p-3 border rounded-lg" value="8">
                            <button onclick="saveConfig('directives', 'min_ratios_comprehensive', 'dir-min_ratios_comprehensive', 'number')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Routing Tab -->
                <div id="routing-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-4">Perplexity Seul (Keywords)</h3>
                            <p class="text-sm text-gray-600 mb-4">Mots-clÃ©s dÃ©clenchant Perplexity seul (sans APIs)</p>
                            <textarea 
                                id="routing-use_perplexity_only_keywords" 
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder='["fonds", "quartile", "macro", ...]'
                            ></textarea>
                            <button onclick="saveConfig('routing', 'use_perplexity_only_keywords', 'routing-use_perplexity_only_keywords', 'json')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>

                        <div class="section-card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold mb-4">APIs Requises (Keywords)</h3>
                            <p class="text-sm text-gray-600 mb-4">Mots-clÃ©s nÃ©cessitant des APIs complÃ©mentaires</p>
                            <textarea 
                                id="routing-require_apis_keywords" 
                                class="w-full h-48 p-3 border rounded-lg code-editor resize-y"
                                placeholder='["prix actuel", "ratio exact", ...]'
                            ></textarea>
                            <button onclick="saveConfig('routing', 'require_apis_keywords', 'routing-require_apis_keywords', 'json')" 
                                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition w-full">
                                ğŸ’¾ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api/admin/emma-config';
        const ADMIN_TOKEN = localStorage.getItem('admin_token') || prompt('Token admin:');

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    b.classList.add('text-gray-600');
                });
                btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.remove('text-gray-600');

                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tab}-tab`).classList.remove('hidden');
            });
        });

        // Load configuration
        async function loadConfig() {
            try {
                showStatus('Chargement de la configuration...', 'info');
                
                const response = await fetch(`${API_BASE}`, {
                    headers: {
                        'Authorization': `Bearer ${ADMIN_TOKEN}`
                    }
                });

                const data = await response.json();
                
                if (data.config) {
                    populateForm(data.config);
                    showStatus('Configuration chargÃ©e avec succÃ¨s', 'success');
                } else {
                    showStatus('Erreur lors du chargement', 'error');
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                showStatus('Erreur: ' + error.message, 'error');
            }
        }

        // Populate form with config
        function populateForm(config) {
            // Prompts
            if (config.prompts) {
                if (config.prompts.cfa_identity?.value) {
                    document.getElementById('prompt-cfa_identity').value = config.prompts.cfa_identity.value;
                }
                if (config.prompts.general_identity?.value) {
                    document.getElementById('prompt-general_identity').value = config.prompts.general_identity.value;
                }
                if (config.prompts.system_instructions?.value) {
                    document.getElementById('prompt-system_instructions').value = config.prompts.system_instructions.value;
                }
            }

            // Variables
            if (config.variables) {
                Object.keys(config.variables).forEach(key => {
                    const elem = document.getElementById(`var-${key}`);
                    if (elem && config.variables[key]?.value !== undefined) {
                        elem.value = config.variables[key].value;
                    }
                });
            }

            // Directives
            if (config.directives) {
                Object.keys(config.directives).forEach(key => {
                    const elem = document.getElementById(`dir-${key}`);
                    if (elem) {
                        if (elem.type === 'checkbox') {
                            elem.checked = config.directives[key]?.value === true;
                        } else {
                            elem.value = config.directives[key]?.value || '';
                        }
                    }
                });
            }

            // Routing
            if (config.routing) {
                Object.keys(config.routing).forEach(key => {
                    const elem = document.getElementById(`routing-${key}`);
                    if (elem && config.routing[key]?.value) {
                        if (Array.isArray(config.routing[key].value)) {
                            elem.value = JSON.stringify(config.routing[key].value, null, 2);
                        } else {
                            elem.value = config.routing[key].value;
                        }
                    }
                });
            }
        }

        // Save configuration
        async function saveConfig(section, key, elementId, type = 'string') {
            try {
                const element = document.getElementById(elementId);
                let value = element.value;

                // Parse selon type
                if (type === 'number') {
                    value = parseFloat(value);
                } else if (type === 'boolean') {
                    value = element.checked;
                } else if (type === 'json') {
                    value = JSON.parse(value);
                }

                showStatus('Sauvegarde en cours...', 'info');

                const response = await fetch(`${API_BASE}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'set',
                        section,
                        key,
                        value
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus(`âœ… ${section}.${key} sauvegardÃ© avec succÃ¨s`, 'success');
                } else {
                    showStatus('Erreur: ' + (data.error || 'Inconnue'), 'error');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showStatus('Erreur: ' + error.message, 'error');
            }
        }

        // Save all
        document.getElementById('saveAllBtn').addEventListener('click', async () => {
            // Collect all values and save
            const configs = [];
            
            // Prompts
            configs.push({ section: 'prompts', key: 'cfa_identity', value: document.getElementById('prompt-cfa_identity').value });
            configs.push({ section: 'prompts', key: 'general_identity', value: document.getElementById('prompt-general_identity').value });
            configs.push({ section: 'prompts', key: 'system_instructions', value: document.getElementById('prompt-system_instructions').value });

            // Variables
            configs.push({ section: 'variables', key: 'max_tokens_default', value: parseFloat(document.getElementById('var-max_tokens_default').value), type: 'number' });
            configs.push({ section: 'variables', key: 'max_tokens_briefing', value: parseFloat(document.getElementById('var-max_tokens_briefing').value), type: 'number' });
            configs.push({ section: 'variables', key: 'temperature', value: parseFloat(document.getElementById('var-temperature').value), type: 'number' });
            configs.push({ section: 'variables', key: 'recency_default', value: document.getElementById('var-recency_default').value });

            // Directives
            configs.push({ section: 'directives', key: 'allow_clarifications', value: document.getElementById('dir-allow_clarifications').checked, type: 'boolean' });
            configs.push({ section: 'directives', key: 'adaptive_length', value: document.getElementById('dir-adaptive_length').checked, type: 'boolean' });
            configs.push({ section: 'directives', key: 'min_ratios_simple', value: parseFloat(document.getElementById('dir-min_ratios_simple').value), type: 'number' });
            configs.push({ section: 'directives', key: 'min_ratios_comprehensive', value: parseFloat(document.getElementById('dir-min_ratios_comprehensive').value), type: 'number' });

            // Routing
            try {
                configs.push({ section: 'routing', key: 'use_perplexity_only_keywords', value: JSON.parse(document.getElementById('routing-use_perplexity_only_keywords').value), type: 'json' });
                configs.push({ section: 'routing', key: 'require_apis_keywords', value: JSON.parse(document.getElementById('routing-require_apis_keywords').value), type: 'json' });
            } catch (e) {
                showStatus('Erreur parsing JSON routing', 'error');
                return;
            }

            // Save all
            showStatus('Sauvegarde de toutes les configurations...', 'info');
            let successCount = 0;
            
            for (const config of configs) {
                try {
                    const response = await fetch(`${API_BASE}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ADMIN_TOKEN}`
                        },
                        body: JSON.stringify({
                            action: 'set',
                            ...config
                        })
                    });
                    
                    if (response.ok) successCount++;
                } catch (e) {
                    console.error('Erreur sauvegarde', config, e);
                }
            }

            showStatus(`âœ… ${successCount}/${configs.length} configurations sauvegardÃ©es`, 'success');
        });

        // Reload
        document.getElementById('reloadBtn').addEventListener('click', loadConfig);

        // Status bar
        function showStatus(message, type = 'info') {
            const bar = document.getElementById('statusBar');
            const msg = document.getElementById('statusMessage');
            
            bar.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100');
            
            if (type === 'success') {
                bar.classList.add('bg-green-100');
                msg.className = 'text-green-800';
            } else if (type === 'error') {
                bar.classList.add('bg-red-100');
                msg.className = 'text-red-800';
            } else {
                bar.classList.add('bg-blue-100');
                msg.className = 'text-blue-800';
            }
            
            msg.textContent = message;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => bar.classList.add('hidden'), 5000);
            }
        }

        // Load on init
        loadConfig();
    </script>
</body>
</html>
