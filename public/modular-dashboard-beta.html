<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOB Canvas - Beta Modular</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel 7 Standalone (Modern JS Support) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- React Grid Layout MUST load BEFORE polyfills -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/react-grid-layout@1.4.4/css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/react-resizable@3.0.5/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/react-grid-layout@1.4.4/dist/react-grid-layout.min.js"></script>

    <!-- Fix for "exports is not defined" error when Babel transpiles modules -->
    <script>
        // Polyfill for CommonJS to prevent Babel errors
        // MUST run before any Babel transpilation
        (function() {
            if (typeof window.exports === 'undefined') {
                window.exports = {};
            }
            if (typeof window.module === 'undefined') {
                window.module = { exports: window.exports };
            }

            // Make available in global scope for Babel
            self.exports = window.exports;
            self.module = window.module;
        })();
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .react-grid-item.react-grid-placeholder {
            background: rgba(255, 255, 255, 0.05) !important;
            border-radius: 12px;
            opacity: 0.5;
        }
        
        .react-resizable-handle {
            background-image: none;
            width: 15px;
            height: 15px;
            bottom: 5px;
            right: 5px;
            border-right: 2px solid rgba(128,128,128,0.5);
            border-bottom: 2px solid rgba(128,128,128,0.5);
            cursor: se-resize;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    <div id="root"></div>

    <!-- UTILS & ICONS -->
    <script type="text/babel">
        // Lucide Icon Wrapper
        window.LucideIcon = ({ name, className, ...props }) => {
            const [iconNode, setIconNode] = React.useState(null);
            const ref = React.useRef(null);

            React.useEffect(() => {
                if (ref.current) {
                    const iconName = name || 'HelpCircle';
                    const lucideIcon = lucide.icons[iconName];
                    if (lucideIcon) {
                        const svg = lucide.createIcons({
                            icons: { [iconName]: lucideIcon },
                            attrs: { class: className, ...props },
                            nameAttr: 'data-lucide'
                        });
                        // Lucide processes the DOM directly based on data attributes or classes
                        // But since we are in React, we manually create SVG if needed or just use lucide.icons[name]
                        // Simple approach: Render an 'i' tag and let lucide replace it
                    }
                }
            }, [name, className]);

            // Plus simple pour React : utiliser les composants Lucide React si dispos, sinon :
            const Icon = lucide.icons[name] || lucide.icons.HelpCircle;
            // On convertit le SVG string ou node en JSX n'est pas trivial sans parser.
            // Approche SVG direct:
            
            return (
                <i data-lucide={name} className={className} {...props}></i>
            );
        };
        
        // Initialization Lucide apr√®s render
        setInterval(() => {
            if(window.lucide) window.lucide.createIcons();
        }, 500);
    </script>
    
    <!-- === DEPENDANCIES === -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Recharts pour JLabTab (via unpkg UMD) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <!-- Supabase Client (si n√©cessaire) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

    <!-- === UTILS === -->
    <script>
        // CRITICAL POLYFILLS FOR GOD MODE
        // Defines missing globals before any component loads
        window.showCommandsHelp = function() {
            alert("‚ÑπÔ∏è Aide Commandes :\n\n- /reset : R√©initialiser le chat\n- /clear : Effacer l'historique\n- /help : Afficher ce message");
        };
        // CommonJS compatibility
        if (typeof exports === 'undefined') window.exports = {};
        if (typeof module === 'undefined') window.module = { exports: {} };
        
        // Exposer Recharts globalement pour compatibilit√©
        if (typeof window.Recharts === 'undefined' && typeof Recharts !== 'undefined') {
            window.Recharts = Recharts;
        }
        
        // Exposer Supabase globalement
        if (typeof window.supabase === 'undefined' && typeof supabase !== 'undefined') {
            window.supabase = supabase;
        }
    </script>
    <script src="/js/dashboard/utils-shared.js"></script>
    <script src="/js/dashboard/constants.js"></script>
    
    <!-- === COMPONENTS === -->
    <!-- RGL Components (Widgets Ready) -->
    <script type="text/babel" src="js/dashboard/components/tabs/TitresTabRGL.js"></script>
    <script type="text/babel" src="js/dashboard/components/tabs/MarketsEconomyTabRGL.js"></script>
    
    <!-- Core Tabs -->
    <script type="text/babel" src="js/dashboard/components/tabs/JLabTab.js"></script>
    <script type="text/babel" src="js/dashboard/components/tabs/AskEmmaTab.js"></script>
    <script type="text/babel" src="js/dashboard/components/tabs/VoiceAssistantTab.js"></script>
    
    <!-- DASHBOARD MANAGER - Charg√© en dernier -->
    <script type="text/babel" src="js/dashboard/components/grid-layout/FullModularDashboard.js"></script>
    
    <!-- Script de v√©rification du chargement -->
    <script>
        // V√©rifier que tous les composants sont charg√©s
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('üìä V√©rification des composants:');
                console.log('  React:', typeof React !== 'undefined');
                console.log('  ReactDOM:', typeof ReactDOM !== 'undefined');
                console.log('  ReactGridLayout:', typeof window.ReactGridLayout !== 'undefined');
                console.log('  FullModularDashboard:', typeof window.FullModularDashboard !== 'undefined');
                console.log('  MarketsEconomyTabRGL:', typeof window.MarketsEconomyTabRGL !== 'undefined');
                console.log('  TitresTabRGL:', typeof window.TitresTabRGL !== 'undefined');
                console.log('  JLabTab:', typeof window.JLabTab !== 'undefined');
                console.log('  AskEmmaTab:', typeof window.AskEmmaTab !== 'undefined');
            }, 2000);
        });
    </script>

    <!-- BOOTSTRAP -->
    <script type="text/babel">
        // Fonction de montage avec retry
        let retryCount = 0;
        const MAX_RETRIES = 20;
        
        function mountDashboard() {
            retryCount++;
            const rootElement = document.getElementById('root');
            
            if (!rootElement) {
                console.error(`‚ùå [Tentative ${retryCount}] √âl√©ment root non trouv√©`);
                if (retryCount < MAX_RETRIES) {
                    setTimeout(mountDashboard, 200);
                } else {
                    document.body.innerHTML = '<div style="padding: 40px; text-align: center; color: #c00;"><h2>‚ùå Erreur: √âl√©ment root non trouv√©</h2></div>';
                }
                return;
            }

            // V√©rifier que React et ReactDOM sont disponibles
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.warn(`‚ö†Ô∏è [Tentative ${retryCount}] React ou ReactDOM non charg√©s`);
                if (retryCount < MAX_RETRIES) {
                    setTimeout(mountDashboard, 200);
                } else {
                    rootElement.innerHTML = '<div style="padding: 40px; text-align: center; color: #c00;"><h2>‚ùå React non charg√©</h2><p>V√©rifiez votre connexion internet</p></div>';
                }
                return;
            }

            // V√©rifier que FullModularDashboard est disponible
            if (typeof window.FullModularDashboard === 'undefined') {
                console.warn(`‚ö†Ô∏è [Tentative ${retryCount}] FullModularDashboard non charg√©, attente...`);
                if (retryCount < MAX_RETRIES) {
                    setTimeout(mountDashboard, 300);
                } else {
                    rootElement.innerHTML = `
                        <div style="padding: 40px; text-align: center; background: #fee; border: 2px solid #fcc; margin: 20px; border-radius: 8px; color: #c00;">
                            <h2>‚ö†Ô∏è FullModularDashboard non charg√©</h2>
                            <p>Le script n'a pas pu se charger apr√®s ${MAX_RETRIES} tentatives.</p>
                            <p style="margin-top: 20px;">V√©rifiez la console pour plus de d√©tails.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #c00; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Rafra√Æchir la page
                            </button>
                        </div>
                    `;
                }
                return;
            }

            console.log('‚úÖ Montage de FullModularDashboard...');
            console.log('üìä √âtat:', {
                React: typeof React !== 'undefined',
                ReactDOM: typeof ReactDOM !== 'undefined',
                FullModularDashboard: typeof window.FullModularDashboard !== 'undefined',
                ReactGridLayout: typeof window.ReactGridLayout !== 'undefined'
            });
            
            try {
                // Utiliser ReactDOM.render pour compatibilit√© avec Babel standalone
                ReactDOM.render(<window.FullModularDashboard />, rootElement);
                console.log('‚úÖ Dashboard mont√© avec succ√®s!');
                
                // V√©rifier le rendu apr√®s un court d√©lai
                setTimeout(() => {
                    if (rootElement.children.length === 0) {
                        console.warn('‚ö†Ô∏è Aucun contenu rendu apr√®s montage');
                    } else {
                        console.log(`‚úÖ Contenu rendu: ${rootElement.children.length} √©l√©ment(s)`);
                    }
                }, 1000);
            } catch (error) {
                console.error('‚ùå Erreur lors du montage:', error);
                console.error('Stack:', error.stack);
                rootElement.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fee; border: 2px solid #fcc; margin: 20px; border-radius: 8px; color: #c00; font-family: system-ui;">
                        <h2>‚ö†Ô∏è Erreur de Chargement</h2>
                        <p><strong>Erreur:</strong> ${error.message}</p>
                        <pre style="text-align: left; margin: 20px 0; padding: 10px; background: #000; color: #0f0; overflow-x: auto; font-size: 12px;">${error.stack || 'Stack trace non disponible'}</pre>
                        <p style="margin-top: 20px;">Veuillez rafra√Æchir la page ou v√©rifier la console.</p>
                        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #c00; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Rafra√Æchir la page
                        </button>
                    </div>
                `;
            }
        }

        // D√©marrer le montage
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM charg√©, d√©marrage du montage...');
                setTimeout(mountDashboard, 500);
            });
        } else {
            console.log('üìÑ DOM d√©j√† charg√©, d√©marrage du montage...');
            setTimeout(mountDashboard, 500);
        }
    </script>
</body>
</html>
