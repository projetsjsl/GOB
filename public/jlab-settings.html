<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLAB Settings - Complete Control Center</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/themes.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #050510 0%, #0a0a1a 50%, #0f0520 100%); min-height: 100vh; }
        
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(20px); }
        .glass:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); }
        
        .tab-active { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .glow-blue { box-shadow: 0 0 30px rgba(99,102,241,0.3); }
        .glow-green { box-shadow: 0 0 20px rgba(34,197,94,0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239,68,68,0.3); }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-ok { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-error { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .status-warn { background: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
        
        .input-field { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; }
        .input-field:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
        
        .chart-bar { transition: height 0.5s ease; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="border-b border-white/10 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/jlab.html" class="text-2xl"></a>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">JLAB Settings</h1>
                    <p class="text-gray-500 text-sm">Complete Control Center</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="/jlab.html" class="px-4 py-2 glass rounded-xl hover:bg-white/10"> Hub</a>
                <a href="/jlab-dashboard.html" class="px-4 py-2 glass rounded-xl hover:bg-white/10"> Dashboard</a>
                <a href="/emma-config.html" class="px-4 py-2 glass rounded-xl hover:bg-white/10"> Emma</a>
                <button onclick="refreshAll()" class="px-4 py-2 bg-indigo-600 rounded-xl hover:bg-indigo-500"> Refresh</button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button onclick="switchTab('architecture')" id="tab-architecture" class="px-4 py-2 rounded-xl font-medium tab-active"> Architecture</button>
            <button onclick="switchTab('apis')" id="tab-apis" class="px-4 py-2 rounded-xl font-medium glass"> API Keys</button>
            <button onclick="switchTab('mcp')" id="tab-mcp" class="px-4 py-2 rounded-xl font-medium glass"> MCP</button>
            <button onclick="switchTab('orchestrator')" id="tab-orchestrator" class="px-4 py-2 rounded-xl font-medium glass"> Orchestrator</button>
            <button onclick="switchTab('prompts')" id="tab-prompts" class="px-4 py-2 rounded-xl font-medium glass"> Prompts</button>
            <button onclick="switchTab('models')" id="tab-models" class="px-4 py-2 rounded-xl font-medium glass"> Models</button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="px-4 py-2 rounded-xl font-medium glass"> Analytics</button>
            <button onclick="switchTab('scheduler')" id="tab-scheduler" class="px-4 py-2 rounded-xl font-medium glass"> Scheduler</button>
            <button onclick="switchTab('alerts')" id="tab-alerts" class="px-4 py-2 rounded-xl font-medium glass"> Alerts</button>
            <button onclick="switchTab('cache')" id="tab-cache" class="px-4 py-2 rounded-xl font-medium glass"> Cache</button>
            <button onclick="switchTab('lab')" id="tab-lab" class="px-4 py-2 rounded-xl font-medium glass"> Lab</button>
        </div>

        <!-- Architecture Panel -->
        <div id="panel-architecture" class="space-y-6">
            <div class="glass rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-6 text-center"> GOB Multi-Agent Architecture</h2>
                
                <!-- Entry Points -->
                <div class="text-center mb-4">
                    <div class="text-gray-400 text-sm mb-2">ENTRY POINTS</div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <a href="https://gobapps.com" target="_blank" class="glass rounded-xl p-4 hover:border-indigo-500 transition">
                            <div class="text-2xl"></div>
                            <div class="text-sm font-medium">gobapps.com</div>
                        </a>
                        <a href="https://jlab.jslai.app" target="_blank" class="glass rounded-xl p-4 hover:border-indigo-500 transition">
                            <div class="text-2xl"></div>
                            <div class="text-sm font-medium">jlab.jslai.app</div>
                        </a>
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-sm font-medium">/api/*</div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-sm font-medium">Webhooks</div>
                        </div>
                    </div>
                </div>

                <div class="text-center text-2xl text-indigo-400 my-3"></div>

                <!-- Orchestrator -->
                <div class="glass rounded-2xl p-6 border-2 border-indigo-500/50 bg-indigo-500/10 max-w-2xl mx-auto mb-4">
                    <div class="text-center">
                        <div class="text-3xl mb-2"></div>
                        <div class="text-lg font-bold">MASTER ORCHESTRATOR</div>
                        <div class="text-gray-400 text-sm mt-2">Parse -> Classify -> Route -> Execute -> Synthesize</div>
                        <div class="flex justify-center gap-2 mt-3 flex-wrap">
                            <span class="px-2 py-1 bg-purple-500/30 rounded text-xs">8 Personas</span>
                            <span class="px-2 py-1 bg-blue-500/30 rounded text-xs">16 Agents</span>
                            <span class="px-2 py-1 bg-green-500/30 rounded text-xs">4 Models</span>
                        </div>
                    </div>
                </div>

                <div class="text-center text-2xl text-indigo-400 my-3"></div>

                <!-- Agents Grid -->
                <div class="text-center mb-4">
                    <div class="text-gray-400 text-sm mb-3">AGENT REGISTRY</div>
                    <div class="grid grid-cols-4 gap-3 max-w-3xl mx-auto">
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-blue-500">
                            <div class="text-lg"></div><div class="text-xs">Model</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-blue-500">
                            <div class="text-lg"></div><div class="text-xs">Workflow</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-blue-500">
                            <div class="text-lg"></div><div class="text-xs">Context</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-blue-500">
                            <div class="text-lg"></div><div class="text-xs">Analytics</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-green-500">
                            <div class="text-lg"></div><div class="text-xs">Data</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-green-500">
                            <div class="text-lg"></div><div class="text-xs">Tools</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-green-500">
                            <div class="text-lg"></div><div class="text-xs">Research</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-green-500">
                            <div class="text-lg"></div><div class="text-xs">MCP</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-orange-500">
                            <div class="text-lg"></div><div class="text-xs">Portfolio</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-orange-500">
                            <div class="text-lg"></div><div class="text-xs">Alert</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-orange-500">
                            <div class="text-lg"></div><div class="text-xs">Briefing</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-orange-500">
                            <div class="text-lg"></div><div class="text-xs">SMS</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-purple-500">
                            <div class="text-lg"></div><div class="text-xs">News</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-purple-500">
                            <div class="text-lg"></div><div class="text-xs">Earnings</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-purple-500">
                            <div class="text-lg"></div><div class="text-xs">Scheduler</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border-l-2 border-purple-500">
                            <div class="text-lg"></div><div class="text-xs">Cache</div>
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 mt-3 text-xs text-gray-500">
                        <span><span class="inline-block w-3 h-3 bg-blue-500 rounded mr-1"></span>Core</span>
                        <span><span class="inline-block w-3 h-3 bg-green-500 rounded mr-1"></span>Data</span>
                        <span><span class="inline-block w-3 h-3 bg-orange-500 rounded mr-1"></span>Action</span>
                        <span><span class="inline-block w-3 h-3 bg-purple-500 rounded mr-1"></span>Utility</span>
                    </div>
                </div>

                <div class="text-center text-2xl text-indigo-400 my-3"></div>

                <!-- External Services -->
                <div class="text-center">
                    <div class="text-gray-400 text-sm mb-2">EXTERNAL SERVICES</div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-xs">GPT-4 / Claude</div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-xs">FMP / Finnhub</div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-xs">Supabase</div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-2xl"></div>
                            <div class="text-xs">Perplexity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Keys Panel -->
        <div id="panel-apis" class="hidden space-y-6">
            <div class="grid grid-cols-4 gap-4">
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-green-400" id="stat-ok">0</div>
                    <div class="text-gray-500 text-sm">Connected</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-red-400" id="stat-missing">0</div>
                    <div class="text-gray-500 text-sm">Missing</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-yellow-400" id="stat-untested">0</div>
                    <div class="text-gray-500 text-sm">Untested</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-purple-400" id="stat-total">0</div>
                    <div class="text-gray-500 text-sm">Total</div>
                </div>
            </div>
            <div class="flex gap-3 mb-4">
                <button onclick="testAllAPIs()" class="px-4 py-2 bg-green-600 rounded-xl hover:bg-green-500"> Test All APIs</button>
                <button onclick="exportConfig()" class="px-4 py-2 glass rounded-xl"> Export</button>
                <button onclick="importConfig()" class="px-4 py-2 glass rounded-xl"> Import</button>
            </div>
            <div id="api-keys-container" class="space-y-4"></div>
        </div>

        <!-- MCP Panel -->
        <div id="panel-mcp" class="hidden space-y-6">
            <div class="glass rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4"> Model Context Protocol Servers</h2>
                <div id="mcp-container" class="grid grid-cols-2 gap-4">
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-2xl"></div>
                            <div>
                                <div class="font-semibold">Perplexity</div>
                                <div class="text-gray-500 text-sm">perplexity-ask</div>
                            </div>
                            <div class="ml-auto status-dot status-ok"></div>
                        </div>
                        <div class="text-sm text-gray-400">Web search and real-time information</div>
                        <button onclick="testMCP('perplexity')" class="mt-3 px-3 py-1 text-sm glass rounded-lg">Test</button>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-2xl"></div>
                            <div>
                                <div class="font-semibold">Supabase</div>
                                <div class="text-gray-500 text-sm">supabase-mcp-server</div>
                            </div>
                            <div class="ml-auto status-dot status-ok"></div>
                        </div>
                        <div class="text-sm text-gray-400">Database queries and migrations</div>
                        <button onclick="testMCP('supabase')" class="mt-3 px-3 py-1 text-sm glass rounded-lg">Test</button>
                    </div>
                </div>
                <p class="text-gray-500 text-sm mt-4">MCP servers provide external tool integration. Configure in Antigravity settings.</p>
            </div>
        </div>

        <!-- Orchestrator Panel -->
        <div id="panel-orchestrator" class="hidden space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> General Settings</h3>
                    <div class="space-y-4">
                        <label class="flex items-center justify-between p-3 bg-black/20 rounded-xl">
                            <span>Enable Orchestrator</span>
                            <input type="checkbox" id="orch-enabled" onchange="saveOrchSettings()" class="w-5 h-5" checked>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-black/20 rounded-xl">
                            <span>Streaming Responses</span>
                            <input type="checkbox" id="orch-streaming" onchange="saveOrchSettings()" class="w-5 h-5" checked>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-black/20 rounded-xl">
                            <span>Enable Caching</span>
                            <input type="checkbox" id="orch-cache" onchange="saveOrchSettings()" class="w-5 h-5" checked>
                        </label>
                        <div class="p-3 bg-black/20 rounded-xl">
                            <label class="block mb-2">Default Persona</label>
                            <select id="orch-persona" onchange="saveOrchSettings()" class="w-full input-field rounded-lg p-2">
                                <option value="finance"> Finance</option>
                                <option value="critic"> Critic</option>
                                <option value="researcher"> Researcher</option>
                                <option value="writer"> Writer</option>
                                <option value="ceo"> CEO</option>
                                <option value="macro"> Macro</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Agent Status</h3>
                    <div id="agent-status" class="space-y-2 max-h-80 overflow-auto scrollbar-thin"></div>
                </div>
            </div>
        </div>

        <!-- Prompts Panel (emma-config) -->
        <div id="panel-prompts" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold"> System Prompts</h2>
                <div class="flex gap-3">
                    <button onclick="loadPrompts()" class="px-4 py-2 glass rounded-xl"> Refresh</button>
                    <a href="/emma-config.html" target="_blank" class="px-4 py-2 bg-indigo-600 rounded-xl">Open Emma Config -></a>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Personas</h3>
                    <div id="personas-list" class="space-y-2 max-h-96 overflow-auto scrollbar-thin"></div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Intent Prompts</h3>
                    <div id="intents-list" class="space-y-2 max-h-96 overflow-auto scrollbar-thin"></div>
                </div>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> System Base Prompt</h3>
                <textarea id="system-prompt" class="w-full h-40 input-field rounded-xl p-4 font-mono text-sm" placeholder="Loading..."></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="saveSystemPrompt()" class="px-4 py-2 bg-green-600 rounded-xl"> Save</button>
                    <button onclick="resetSystemPrompt()" class="px-4 py-2 glass rounded-xl"> Reset Default</button>
                </div>
            </div>
        </div>

        <!-- Models Panel (emma-config) -->
        <div id="panel-models" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold"> LLM Models</h2>
                <a href="/emma-config.html#models" target="_blank" class="px-4 py-2 bg-indigo-600 rounded-xl">Advanced Config -></a>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Model Priority</h3>
                    <div id="models-priority" class="space-y-2"></div>
                    <p class="text-gray-500 text-sm mt-4">Drag to reorder. First available model is used.</p>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Model Parameters</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 text-sm mb-1">Temperature</label>
                            <input type="range" id="model-temp" min="0" max="100" value="70" class="w-full" onchange="updateModelParam('temp')">
                            <div class="flex justify-between text-xs text-gray-500"><span>Precise</span><span id="temp-val">0.7</span><span>Creative</span></div>
                        </div>
                        <div>
                            <label class="block text-gray-400 text-sm mb-1">Max Tokens</label>
                            <input type="number" id="model-tokens" value="4096" class="w-full input-field rounded-lg p-2">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-sm mb-1">Top P</label>
                            <input type="range" id="model-top-p" min="0" max="100" value="95" class="w-full" onchange="updateModelParam('topP')">
                            <div class="flex justify-between text-xs text-gray-500"><span>Focused</span><span id="top-p-val">0.95</span><span>Diverse</span></div>
                        </div>
                        <button onclick="saveModelParams()" class="w-full py-2 bg-green-600 rounded-xl mt-4"> Save Parameters</button>
                    </div>
                </div>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> Model Usage (Last 24h)</h3>
                <div id="model-usage-chart" class="grid grid-cols-4 gap-4"></div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div id="panel-analytics" class="hidden space-y-6">
            <div class="grid grid-cols-4 gap-4">
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-blue-400" id="ana-requests">0</div>
                    <div class="text-gray-500 text-sm">Total Requests</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-green-400" id="ana-success">0%</div>
                    <div class="text-gray-500 text-sm">Success Rate</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-yellow-400" id="ana-latency">0ms</div>
                    <div class="text-gray-500 text-sm">Avg Latency</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-purple-400" id="ana-cache">0%</div>
                    <div class="text-gray-500 text-sm">Cache Hit Rate</div>
                </div>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> Request History (24h)</h3>
                <div id="analytics-chart" class="h-40 flex items-end gap-1"></div>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Model Usage</h3>
                    <div id="model-usage" class="space-y-2"></div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Persona Usage</h3>
                    <div id="persona-usage" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Scheduler Panel -->
        <div id="panel-scheduler" class="hidden space-y-6">
            <div class="flex gap-3 mb-4">
                <button onclick="showNewScheduleModal()" class="px-4 py-2 bg-indigo-600 rounded-xl hover:bg-indigo-500"> New Schedule</button>
                <button onclick="loadSchedules()" class="px-4 py-2 glass rounded-xl"> Refresh</button>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> Active Schedules</h3>
                <div id="schedules-list" class="space-y-3"></div>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> Execution History</h3>
                <div id="schedule-history" class="space-y-2 max-h-60 overflow-auto scrollbar-thin"></div>
            </div>
        </div>

        <!-- Alerts Panel -->
        <div id="panel-alerts" class="hidden space-y-6">
            <div class="flex gap-3 mb-4">
                <button onclick="showNewAlertModal()" class="px-4 py-2 bg-indigo-600 rounded-xl hover:bg-indigo-500"> New Alert</button>
                <button onclick="checkAllAlerts()" class="px-4 py-2 bg-green-600 rounded-xl hover:bg-green-500"> Check Now</button>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Active Alerts</h3>
                    <div id="alerts-list" class="space-y-2 max-h-80 overflow-auto scrollbar-thin"></div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4"> Notification Channels</h3>
                    <div class="space-y-3">
                        <div class="p-3 bg-black/20 rounded-xl">
                            <label class="block text-sm text-gray-400 mb-1">Email</label>
                            <input type="email" id="alert-email" class="w-full input-field rounded-lg p-2" placeholder="your@email.com">
                        </div>
                        <div class="p-3 bg-black/20 rounded-xl">
                            <label class="block text-sm text-gray-400 mb-1">SMS</label>
                            <input type="tel" id="alert-sms" class="w-full input-field rounded-lg p-2" placeholder="+1234567890">
                        </div>
                        <button onclick="saveAlertChannels()" class="w-full py-2 bg-indigo-600 rounded-xl">Save Channels</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache Panel -->
        <div id="panel-cache" class="hidden space-y-6">
            <div class="grid grid-cols-4 gap-4">
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-blue-400" id="cache-entries">0</div>
                    <div class="text-gray-500 text-sm">Entries</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-green-400" id="cache-hits">0</div>
                    <div class="text-gray-500 text-sm">Hits</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-red-400" id="cache-misses">0</div>
                    <div class="text-gray-500 text-sm">Misses</div>
                </div>
                <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-purple-400" id="cache-rate">0%</div>
                    <div class="text-gray-500 text-sm">Hit Rate</div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="clearCache('all')" class="px-4 py-2 bg-red-600 rounded-xl hover:bg-red-500"> Clear All</button>
                <button onclick="clearCache('quote')" class="px-4 py-2 glass rounded-xl">Clear Quotes</button>
                <button onclick="clearCache('llm')" class="px-4 py-2 glass rounded-xl">Clear LLM</button>
                <button onclick="warmCache()" class="px-4 py-2 bg-green-600 rounded-xl"> Warm Cache</button>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> Cache by Category</h3>
                <div id="cache-categories" class="space-y-2"></div>
            </div>
        </div>

        <!-- Lab Panel -->
        <div id="panel-lab" class="hidden space-y-6">
            <div class="glass rounded-2xl p-6">
                <h3 class="font-semibold mb-4"> API Laboratory</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <div class="flex gap-3 mb-4">
                            <select id="lab-agent" class="flex-1 input-field rounded-xl p-3" onchange="loadAgentActions()">
                                <option value="">Select Agent...</option>
                            </select>
                            <select id="lab-action" class="flex-1 input-field rounded-xl p-3">
                                <option value="">Select Action...</option>
                            </select>
                        </div>
                        <textarea id="lab-params" class="w-full h-40 input-field rounded-xl p-4 font-mono text-sm" placeholder='{"ticker": "AAPL"}'></textarea>
                        <div class="flex gap-3 mt-4">
                            <button onclick="runLabTest()" class="flex-1 py-3 bg-indigo-600 rounded-xl hover:bg-indigo-500 font-medium"> Execute</button>
                            <button onclick="clearLabOutput()" class="px-4 py-3 glass rounded-xl">Clear</button>
                        </div>
                        <div class="flex gap-2 mt-4 flex-wrap">
                            <button onclick="loadLabPreset('chat')" class="px-3 py-1 glass rounded-lg text-sm"> Chat</button>
                            <button onclick="loadLabPreset('quote')" class="px-3 py-1 glass rounded-lg text-sm"> Quote</button>
                            <button onclick="loadLabPreset('research')" class="px-3 py-1 glass rounded-lg text-sm"> Research</button>
                            <button onclick="loadLabPreset('dcf')" class="px-3 py-1 glass rounded-lg text-sm"> DCF</button>
                        </div>
                    </div>
                    <div>
                        <div class="bg-black/40 rounded-xl p-4 h-80 overflow-auto font-mono text-sm scrollbar-thin" id="lab-output">
                            <span class="text-gray-500">// Output will appear here...</span>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <span class="text-gray-500 text-sm" id="lab-timing"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div id="modal-content" class="glass rounded-2xl p-6 w-full max-w-md mx-4"></div>
    </div>

    <script src="/js/orchestrator-client.js"></script>
    <script src="/js/credentials-manager.js"></script>
    <script>
        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('glass');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('glass');
            document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            
            // Load tab-specific data
            if (tab === 'analytics') loadAnalytics();
            if (tab === 'scheduler') loadSchedules();
            if (tab === 'alerts') loadAlerts();
            if (tab === 'cache') loadCacheStats();
            if (tab === 'lab') loadAgentList();
            if (tab === 'prompts') loadPrompts();
            if (tab === 'models') loadModels();
        }

        // API Keys
        async function loadAPIKeys() {
            const container = document.getElementById('api-keys-container');
            container.innerHTML = '<div class="text-gray-500 text-center py-8">Loading...</div>';
            
            const apis = [
                { key: 'OPENAI_API_KEY', name: 'OpenAI', icon: '', cat: 'LLM' },
                { key: 'ANTHROPIC_API_KEY', name: 'Anthropic', icon: '', cat: 'LLM' },
                { key: 'PERPLEXITY_API_KEY', name: 'Perplexity', icon: '', cat: 'LLM' },
                { key: 'GEMINI_API_KEY', name: 'Google Gemini', icon: '', cat: 'LLM' },
                { key: 'FMP_API_KEY', name: 'Financial Modeling Prep', icon: '', cat: 'Finance' },
                { key: 'FINNHUB_API_KEY', name: 'Finnhub', icon: '', cat: 'Finance' },
                { key: 'SUPABASE_URL', name: 'Supabase URL', icon: '', cat: 'Database' },
                { key: 'SUPABASE_KEY', name: 'Supabase Key', icon: '', cat: 'Database' },
            ];
            
            let ok = 0, missing = 0, untested = 0;
            let html = '<div class="space-y-3">';
            
            for (const api of apis) {
                let status = 'untested';
                try {
                    const resp = await fetch(`/api/credentials?key=${api.key}`);
                    const data = await resp.json();
                    status = data.hasValue ? 'ok' : 'missing';
                } catch { status = 'untested'; }
                
                if (status === 'ok') ok++;
                else if (status === 'missing') missing++;
                else untested++;
                
                const statusClass = status === 'ok' ? 'status-ok' : status === 'missing' ? 'status-error' : 'status-warn';
                html += `
                    <div class="glass rounded-xl p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="status-dot ${statusClass}"></div>
                            <span class="text-xl">${api.icon}</span>
                            <div>
                                <div class="font-medium">${api.name}</div>
                                <div class="text-gray-500 text-sm">${api.cat}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="testAPI('${api.key}')" class="px-3 py-1 glass rounded-lg text-sm">Test</button>
                            <button onclick="editAPI('${api.key}')" class="px-3 py-1 glass rounded-lg text-sm">Edit</button>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('stat-ok').textContent = ok;
            document.getElementById('stat-missing').textContent = missing;
            document.getElementById('stat-untested').textContent = untested;
            document.getElementById('stat-total').textContent = apis.length;
        }

        async function testAPI(key) {
            try {
                const resp = await fetch('/api/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test', key })
                });
                const data = await resp.json();
                alert(data.success ? ` ${key} is working!` : ` ${key} failed: ${data.error}`);
            } catch (e) { alert('Test failed: ' + e.message); }
        }

        function editAPI(key) {
            showModal(`
                <h3 class="text-xl font-semibold mb-4">Edit ${key}</h3>
                <input type="password" id="modal-value" class="w-full input-field rounded-xl p-3 mb-4" placeholder="Enter API key...">
                <p class="text-gray-500 text-sm mb-4">For Vercel env vars, set in Vercel Dashboard.</p>
                <div class="flex gap-3 justify-end">
                    <button onclick="hideModal()" class="px-4 py-2 glass rounded-xl">Cancel</button>
                    <button onclick="saveAPIKey('${key}')" class="px-4 py-2 bg-indigo-600 rounded-xl">Save</button>
                </div>
            `);
        }

        async function saveAPIKey(key) {
            const value = document.getElementById('modal-value').value;
            localStorage.setItem(`jlab_${key}`, value);
            hideModal();
            loadAPIKeys();
        }

        // Analytics
        async function loadAnalytics() {
            try {
                const data = await emma?.getAnalytics?.('24h') || {};
                if (data.success && data.stats) {
                    document.getElementById('ana-requests').textContent = data.stats.totalRequests || 0;
                    document.getElementById('ana-success').textContent = data.stats.successRate || '0%';
                    document.getElementById('ana-latency').textContent = (data.stats.avgLatency || 0) + 'ms';
                    document.getElementById('ana-cache').textContent = data.stats.cacheHitRate || '0%';
                }
            } catch (e) { console.log('Analytics not available'); }
            
            // Mock chart
            const chart = document.getElementById('analytics-chart');
            chart.innerHTML = Array(24).fill(0).map((_, i) => {
                const h = Math.random() * 100 + 20;
                return `<div class="flex-1 bg-indigo-500/50 rounded-t chart-bar" style="height:${h}px" title="Hour ${i}"></div>`;
            }).join('');
        }

        // Scheduler
        async function loadSchedules() {
            const list = document.getElementById('schedules-list');
            try {
                const data = await emma?.getSchedules?.() || { schedules: [] };
                if (data.schedules?.length) {
                    list.innerHTML = data.schedules.map(s => `
                        <div class="glass rounded-xl p-4 flex items-center justify-between">
                            <div>
                                <div class="font-medium">${s.name}</div>
                                <div class="text-gray-500 text-sm">${s.cron} -> ${s.taskAgent}.${s.taskAction}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="runScheduleNow('${s.id}')" class="px-3 py-1 bg-green-600 rounded-lg text-sm">Run</button>
                                <button onclick="deleteSchedule('${s.id}')" class="px-3 py-1 bg-red-600 rounded-lg text-sm">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="text-gray-500 text-center py-4">No schedules configured</div>';
                }
            } catch { list.innerHTML = '<div class="text-gray-500">Could not load schedules</div>'; }
        }

        // Alerts
        async function loadAlerts() {
            const list = document.getElementById('alerts-list');
            try {
                const data = await emma?.getAlerts?.() || { alerts: [] };
                if (data.alerts?.length) {
                    list.innerHTML = data.alerts.map(a => `
                        <div class="glass rounded-xl p-3 flex items-center justify-between">
                            <div>
                                <div class="font-medium">${a.ticker} ${a.type}</div>
                                <div class="text-gray-500 text-sm">Target: ${a.value}</div>
                            </div>
                            <button onclick="deleteAlert('${a.id}')" class="px-2 py-1 text-red-400"></button>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="text-gray-500 text-center py-4">No active alerts</div>';
                }
            } catch { list.innerHTML = '<div class="text-gray-500">Could not load alerts</div>'; }
        }

        // Cache
        async function loadCacheStats() {
            try {
                const data = await emma?.agent?.('cache', 'get_stats', {}) || {};
                if (data.stats) {
                    document.getElementById('cache-entries').textContent = data.stats.entries || 0;
                    document.getElementById('cache-hits').textContent = data.stats.hits || 0;
                    document.getElementById('cache-misses').textContent = data.stats.misses || 0;
                    document.getElementById('cache-rate').textContent = data.stats.hitRate || '0%';
                }
            } catch { console.log('Cache stats not available'); }
        }

        async function clearCache(category) {
            await emma?.agent?.('cache', 'clear', { category: category === 'all' ? null : category });
            loadCacheStats();
        }

        // Lab
        async function loadAgentList() {
            const select = document.getElementById('lab-agent');
            const agents = ['data', 'research', 'tools', 'portfolio', 'alert', 'scheduler', 'analytics', 'cache', 'mcp', 'context'];
            select.innerHTML = '<option value="">Select Agent...</option>' + 
                agents.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function loadAgentActions() {
            const agent = document.getElementById('lab-agent').value;
            const actionSelect = document.getElementById('lab-action');
            const actions = {
                data: ['get_stock_quote', 'get_company_data'],
                research: ['analyze_stock', 'deep_dive', 'generate_bull_bear', 'assess_risk'],
                tools: ['get_stock_price', 'calculate_dcf', 'compare_stocks', 'get_yield_curve'],
                portfolio: ['create_portfolio', 'analyze_portfolio', 'get_dividends'],
                alert: ['create_alert', 'get_alerts', 'check_alerts'],
                scheduler: ['get_schedules', 'create_schedule', 'get_next_runs'],
                analytics: ['get_stats', 'get_latency_report'],
                cache: ['get_stats', 'clear', 'warm_cache'],
                mcp: ['list_mcp_tools', 'perplexity_ask'],
                context: ['get_history', 'clear_history']
            };
            actionSelect.innerHTML = '<option value="">Select Action...</option>' + 
                (actions[agent] || []).map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function loadLabPreset(type) {
            const presets = {
                chat: { agent: '', action: '', params: '{"message": "Analyse AAPL", "persona": "finance"}' },
                quote: { agent: 'tools', action: 'get_stock_price', params: '{"ticker": "AAPL"}' },
                research: { agent: 'research', action: 'analyze_stock', params: '{"ticker": "MSFT"}' },
                dcf: { agent: 'tools', action: 'calculate_dcf', params: '{"ticker": "NVDA", "growthRate": 10, "discountRate": 12}' }
            };
            const p = presets[type];
            document.getElementById('lab-agent').value = p.agent;
            loadAgentActions();
            setTimeout(() => document.getElementById('lab-action').value = p.action, 100);
            document.getElementById('lab-params').value = p.params;
        }

        async function runLabTest() {
            const agent = document.getElementById('lab-agent').value;
            const action = document.getElementById('lab-action').value;
            const params = document.getElementById('lab-params').value;
            const output = document.getElementById('lab-output');
            
            output.innerHTML = '<span class="text-yellow-400"> Executing...</span>';
            const start = Date.now();
            
            try {
                let result;
                const body = JSON.parse(params || '{}');
                
                if (agent && action) {
                    result = await emma?.agent?.(agent, action, body);
                } else {
                    const resp = await fetch('/api/orchestrator', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    result = await resp.json();
                }
                
                output.innerHTML = `<pre class="text-green-400">${JSON.stringify(result, null, 2)}</pre>`;
                document.getElementById('lab-timing').textContent = ` ${Date.now() - start}ms`;
            } catch (e) {
                output.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
            }
        }

        function clearLabOutput() {
            document.getElementById('lab-output').innerHTML = '<span class="text-gray-500">// Output cleared</span>';
        }

        // Modal helpers
        function showModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function hideModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // Orchestrator settings
        function loadOrchSettings() {
            // Default to enabled if not set
            document.getElementById('orch-enabled').checked = localStorage.getItem('orch-enabled') !== 'false';
            document.getElementById('orch-streaming').checked = localStorage.getItem('orch-streaming') !== 'false';
            document.getElementById('orch-cache').checked = localStorage.getItem('orch-cache') !== 'false';
            document.getElementById('orch-persona').value = localStorage.getItem('orch-persona') || 'finance';
            
            // Load agent status
            const agents = ['modelSelector', 'workflow', 'context', 'analytics', 'mcp', 'data', 'tools', 'research', 'news', 'earnings', 'portfolio', 'alert', 'briefing', 'sms', 'scheduler', 'cache'];
            document.getElementById('agent-status').innerHTML = agents.map(a => `
                <div class="flex items-center justify-between p-2 bg-black/20 rounded-lg">
                    <span>${a}</span>
                    <div class="status-dot status-ok"></div>
                </div>
            `).join('');
        }

        function saveOrchSettings() {
            localStorage.setItem('orch-enabled', document.getElementById('orch-enabled').checked);
            localStorage.setItem('orch-streaming', document.getElementById('orch-streaming').checked);
            localStorage.setItem('orch-cache', document.getElementById('orch-cache').checked);
            localStorage.setItem('orch-persona', document.getElementById('orch-persona').value);
        }

        function refreshAll() { loadAPIKeys(); }

        // MCP test function
        async function testMCP(server) {
            alert(`Testing ${server} MCP connection... Check console for details.`);
            try {
                if (server === 'perplexity') {
                    const result = await emma?.perplexityAsk?.('What is the current date?');
                    console.log('Perplexity MCP test:', result);
                    alert(result?.success ? ' Perplexity MCP working!' : ' Perplexity MCP failed');
                } else if (server === 'supabase') {
                    const result = await emma?.agent?.('mcp', 'list_mcp_tools', {});
                    console.log('Supabase MCP test:', result);
                    alert(result?.success ? ' Supabase MCP working!' : ' Supabase MCP failed');
                }
            } catch (e) {
                alert(` MCP test failed: ${e.message}`);
            }
        }

        // Prompts functions (emma-config integration)
        async function loadPrompts() {
            try {
                const resp = await fetch('/api/admin/emma-config?section=personas');
                const data = await resp.json();
                const personas = data.personas || ['finance', 'critic', 'researcher', 'writer', 'ceo', 'macro', 'geek', 'politics'];
                document.getElementById('personas-list').innerHTML = personas.map(p => `
                    <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg">
                        <span>${p}</span>
                        <button onclick="editPersona('${p}')" class="text-indigo-400 text-sm">Edit</button>
                    </div>
                `).join('');
            } catch { 
                document.getElementById('personas-list').innerHTML = '<div class="text-gray-500">Could not load personas</div>'; 
            }
            
            try {
                const resp = await fetch('/api/admin/emma-config?section=prompts');
                const data = await resp.json();
                const intents = Object.keys(data.prompts || {}).slice(0, 10);
                document.getElementById('intents-list').innerHTML = intents.map(i => `
                    <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg">
                        <span>${i}</span>
                        <button onclick="editIntent('${i}')" class="text-indigo-400 text-sm">Edit</button>
                    </div>
                `).join('') || '<div class="text-gray-500">No intents configured</div>';
            } catch { 
                document.getElementById('intents-list').innerHTML = '<div class="text-gray-500">Could not load intents</div>'; 
            }
            
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const resp = await fetch('/api/admin/emma-config?key=system_base', { signal: controller.signal });
                clearTimeout(timeout);
                const data = await resp.json();
                document.getElementById('system-prompt').value = data.value || DEFAULT_SYSTEM_PROMPT;
            } catch {
                document.getElementById('system-prompt').value = DEFAULT_SYSTEM_PROMPT;
            }
        }

        const DEFAULT_SYSTEM_PROMPT = `Tu es Emma, une experte en analyse financiere et en investissement.
Tu travailles pour JSLAI Wealth Management.
Tu fournis des analyses professionnelles, objectives et basees sur les donnees.
Tu parles francais par defaut sauf si l'utilisateur parle anglais.`;

        async function saveSystemPrompt() {
            const value = document.getElementById('system-prompt').value;
            await fetch('/api/admin/emma-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'set', key: 'system_base', value })
            });
            alert('System prompt saved!');
        }

        function resetSystemPrompt() {
            document.getElementById('system-prompt').value = '';
        }

        // Models functions
        async function loadModels() {
            const models = [
                { id: 'perplexity', name: 'Perplexity', icon: '', status: 'ok' },
                { id: 'openai', name: 'OpenAI GPT-4', icon: '', status: 'ok' },
                { id: 'anthropic', name: 'Claude', icon: '', status: 'ok' },
                { id: 'google', name: 'Gemini', icon: '', status: 'warn' }
            ];
            document.getElementById('models-priority').innerHTML = models.map((m, i) => `
                <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg cursor-move" draggable="true">
                    <div class="flex items-center gap-3">
                        <span class="text-gray-500">${i + 1}</span>
                        <span class="text-xl">${m.icon}</span>
                        <span>${m.name}</span>
                    </div>
                    <div class="status-dot status-${m.status}"></div>
                </div>
            `).join('');
            
            document.getElementById('model-usage-chart').innerHTML = models.map(m => `
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-2xl">${m.icon}</div>
                    <div class="text-lg font-bold mt-2">${Math.floor(Math.random() * 100)}</div>
                    <div class="text-gray-500 text-sm">${m.name}</div>
                </div>
            `).join('');
        }

        function updateModelParam(type) {
            if (type === 'temp') {
                document.getElementById('temp-val').textContent = (document.getElementById('model-temp').value / 100).toFixed(2);
            } else if (type === 'topP') {
                document.getElementById('top-p-val').textContent = (document.getElementById('model-top-p').value / 100).toFixed(2);
            }
        }

        function saveModelParams() {
            localStorage.setItem('model-temp', document.getElementById('model-temp').value);
            localStorage.setItem('model-tokens', document.getElementById('model-tokens').value);
            localStorage.setItem('model-top-p', document.getElementById('model-top-p').value);
            alert('Model parameters saved!');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadAPIKeys();
            loadOrchSettings();
        });
    </script>
</body>
</html>
