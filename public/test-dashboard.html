<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard GOB Apps</title>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin: 0.5rem 0;
            font-weight: 600;
        }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .warning { background: #fef3c7; color: #d97706; }
        .info { background: #dbeafe; color: #1e40af; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
        }
        button:hover { background: #2563eb; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        .metric {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e40af;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Dashboard GOB Apps - Version Optimis√©e</h1>
    
    <div class="test-section">
        <h2>üìä M√©triques de Performance</h2>
        <div class="grid">
            <div class="metric">
                <div class="metric-value" id="load-time">-</div>
                <div class="metric-label">Temps de chargement (ms)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="memory-usage">-</div>
                <div class="metric-label">M√©moire utilis√©e (MB)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="api-response">-</div>
                <div class="metric-label">Temps r√©ponse API (ms)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="cache-hit-rate">-</div>
                <div class="metric-label">Taux de cache (%)</div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üîß Tests Fonctionnels</h2>
        <button onclick="testAPIs()">Test APIs</button>
        <button onclick="testCache()">Test Cache</button>
        <button onclick="testErrorHandling()">Test Gestion d'Erreurs</button>
        <button onclick="testPerformance()">Test Performance</button>
        <button onclick="testUI()">Test Interface</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>üìà Tests de Donn√©es</h2>
        <button onclick="testStockData()">Test Donn√©es Stocks</button>
        <button onclick="testNewsData()">Test Actualit√©s</button>
        <button onclick="testSeekingAlpha()">Test Seeking Alpha</button>
        <div id="data-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>üéØ Tests d'Int√©gration</h2>
        <button onclick="testFullWorkflow()">Test Workflow Complet</button>
        <button onclick="testResponsive()">Test Responsive</button>
        <button onclick="testAccessibility()">Test Accessibilit√©</button>
        <div id="integration-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>üìã Rapport de Test</h2>
        <div id="test-report"></div>
        <button onclick="generateReport()">G√©n√©rer Rapport</button>
        <button onclick="exportResults()">Exporter R√©sultats</button>
    </div>

    <script>
        const testResults = {
            performance: {},
            functional: {},
            data: {},
            integration: {}
        };
        
        let testCount = 0;
        let passedTests = 0;
        let failedTests = 0;
        
        // M√©triques de performance
        function updateMetrics() {
            const loadTime = performance.now();
            document.getElementById('load-time').textContent = Math.round(loadTime);
            
            if (performance.memory) {
                const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = memoryMB;
            }
        }
        
        // Test des APIs
        async function testAPIs() {
            addTestResult('functional', 'Test APIs', 'info', 'D√©marrage des tests API...');
            
            const apis = ['finnhub', 'newsapi', 'seekingAlpha', 'gemini', 'github', 'claude', 'vercel'];
            const results = [];
            
            for (const api of apis) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(`/api/${api}?test=true`);
                    const responseTime = Math.round(performance.now() - startTime);
                    
                    if (response.ok) {
                        results.push({ api, status: 'success', responseTime });
                        addTestResult('functional', `API ${api}`, 'success', `OK - ${responseTime}ms`);
                    } else {
                        results.push({ api, status: 'error', responseTime, error: response.status });
                        addTestResult('functional', `API ${api}`, 'error', `Erreur ${response.status} - ${responseTime}ms`);
                    }
                } catch (error) {
                    results.push({ api, status: 'error', responseTime: 0, error: error.message });
                    addTestResult('functional', `API ${api}`, 'error', `Erreur: ${error.message}`);
                }
            }
            
            const successCount = results.filter(r => r.status === 'success').length;
            const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
            
            document.getElementById('api-response').textContent = Math.round(avgResponseTime);
            
            testResults.functional.apis = {
                total: apis.length,
                success: successCount,
                failed: apis.length - successCount,
                avgResponseTime: Math.round(avgResponseTime),
                results
            };
            
            addTestResult('functional', 'R√©sum√© APIs', successCount === apis.length ? 'success' : 'warning', 
                `${successCount}/${apis.length} APIs fonctionnelles (${Math.round(avgResponseTime)}ms moy.)`);
        }
        
        // Test du cache
        async function testCache() {
            addTestResult('functional', 'Test Cache', 'info', 'Test du syst√®me de cache...');
            
            const testKey = 'test-cache-key';
            const testData = { test: 'data', timestamp: Date.now() };
            
            // Simulation du cache
            const cache = new Map();
            const cacheTimestamps = new Map();
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
            
            // Test set cache
            cache.set(testKey, testData);
            cacheTimestamps.set(testKey, Date.now());
            
            // Test get cache
            const cached = cache.get(testKey);
            const timestamp = cacheTimestamps.get(testKey);
            
            if (cached && timestamp && Date.now() - timestamp < CACHE_DURATION) {
                addTestResult('functional', 'Cache Set/Get', 'success', 'Cache fonctionnel');
                
                // Test expiration
                cacheTimestamps.set(testKey, Date.now() - CACHE_DURATION - 1000);
                const expired = cache.get(testKey);
                if (!expired) {
                    addTestResult('functional', 'Cache Expiration', 'success', 'Expiration fonctionnelle');
                } else {
                    addTestResult('functional', 'Cache Expiration', 'error', 'Expiration non fonctionnelle');
                }
            } else {
                addTestResult('functional', 'Cache Set/Get', 'error', 'Cache non fonctionnel');
            }
        }
        
        // Test de gestion d'erreurs
        function testErrorHandling() {
            addTestResult('functional', 'Test Gestion d\'Erreurs', 'info', 'Test de la gestion d\'erreurs...');
            
            try {
                // Test erreur simul√©e
                throw new Error('Test error handling');
            } catch (error) {
                if (error.message === 'Test error handling') {
                    addTestResult('functional', 'Capture d\'Erreur', 'success', 'Erreur captur√©e correctement');
                } else {
                    addTestResult('functional', 'Capture d\'Erreur', 'error', 'Erreur non captur√©e');
                }
            }
            
            // Test retry mechanism
            let retryCount = 0;
            const maxRetries = 3;
            
            function testRetry() {
                return new Promise((resolve, reject) => {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        reject(new Error('Retry test'));
                    } else {
                        resolve('Success after retries');
                    }
                });
            }
            
            async function retryTest() {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const result = await testRetry();
                        addTestResult('functional', 'M√©canisme Retry', 'success', `Succ√®s apr√®s ${retryCount} tentatives`);
                        return;
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            addTestResult('functional', 'M√©canisme Retry', 'error', '√âchec apr√®s toutes les tentatives');
                        }
                    }
                }
            }
            
            retryTest();
        }
        
        // Test de performance
        function testPerformance() {
            addTestResult('functional', 'Test Performance', 'info', 'Test des performances...');
            
            // Test de rendu
            const startTime = performance.now();
            const testElement = document.createElement('div');
            testElement.innerHTML = '<div>Test</div>'.repeat(1000);
            document.body.appendChild(testElement);
            const renderTime = performance.now() - startTime;
            document.body.removeChild(testElement);
            
            if (renderTime < 100) {
                addTestResult('functional', 'Performance Rendu', 'success', `Rendu rapide: ${Math.round(renderTime)}ms`);
            } else {
                addTestResult('functional', 'Performance Rendu', 'warning', `Rendu lent: ${Math.round(renderTime)}ms`);
            }
            
            // Test de m√©moire
            if (performance.memory) {
                const memoryBefore = performance.memory.usedJSHeapSize;
                
                // Cr√©er des objets pour tester la m√©moire
                const testObjects = [];
                for (let i = 0; i < 1000; i++) {
                    testObjects.push({ id: i, data: 'test' });
                }
                
                const memoryAfter = performance.memory.usedJSHeapSize;
                const memoryIncrease = memoryAfter - memoryBefore;
                
                if (memoryIncrease < 1024 * 1024) { // Moins de 1MB
                    addTestResult('functional', 'Performance M√©moire', 'success', `Utilisation m√©moire acceptable: ${Math.round(memoryIncrease / 1024)}KB`);
                } else {
                    addTestResult('functional', 'Performance M√©moire', 'warning', `Utilisation m√©moire √©lev√©e: ${Math.round(memoryIncrease / 1024)}KB`);
                }
            }
        }
        
        // Test de l'interface
        function testUI() {
            addTestResult('functional', 'Test Interface', 'info', 'Test de l\'interface utilisateur...');
            
            // Test des √©l√©ments DOM
            const requiredElements = ['root'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            
            if (missingElements.length === 0) {
                addTestResult('functional', '√âl√©ments DOM', 'success', 'Tous les √©l√©ments requis pr√©sents');
            } else {
                addTestResult('functional', '√âl√©ments DOM', 'error', `√âl√©ments manquants: ${missingElements.join(', ')}`);
            }
            
            // Test des styles CSS
            const testDiv = document.createElement('div');
            testDiv.className = 'test-element';
            testDiv.style.cssText = 'position: absolute; top: -9999px;';
            document.body.appendChild(testDiv);
            
            const computedStyle = window.getComputedStyle(testDiv);
            if (computedStyle.position === 'absolute') {
                addTestResult('functional', 'Styles CSS', 'success', 'Styles CSS fonctionnels');
            } else {
                addTestResult('functional', 'Styles CSS', 'error', 'Styles CSS non fonctionnels');
            }
            
            document.body.removeChild(testDiv);
        }
        
        // Test des donn√©es stocks
        async function testStockData() {
            addTestResult('data', 'Test Donn√©es Stocks', 'info', 'Test des donn√©es de march√©...');
            
            const testTickers = ['AAPL', 'MSFT', 'GOOGL'];
            const results = [];
            
            for (const ticker of testTickers) {
                try {
                    const response = await fetch(`/api/finnhub?endpoint=quote&symbol=${ticker}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && typeof data.c === 'number') {
                            results.push({ ticker, status: 'success', price: data.c });
                            addTestResult('data', `Stock ${ticker}`, 'success', `Prix: $${data.c}`);
                        } else {
                            results.push({ ticker, status: 'error', error: 'Donn√©es invalides' });
                            addTestResult('data', `Stock ${ticker}`, 'error', 'Donn√©es invalides');
                        }
                    } else {
                        results.push({ ticker, status: 'error', error: `HTTP ${response.status}` });
                        addTestResult('data', `Stock ${ticker}`, 'error', `HTTP ${response.status}`);
                    }
                } catch (error) {
                    results.push({ ticker, status: 'error', error: error.message });
                    addTestResult('data', `Stock ${ticker}`, 'error', error.message);
                }
            }
            
            const successCount = results.filter(r => r.status === 'success').length;
            addTestResult('data', 'R√©sum√© Stocks', successCount === testTickers.length ? 'success' : 'warning', 
                `${successCount}/${testTickers.length} stocks r√©cup√©r√©s`);
        }
        
        // Test des actualit√©s
        async function testNewsData() {
            addTestResult('data', 'Test Actualit√©s', 'info', 'Test des actualit√©s...');
            
            try {
                const response = await fetch('/api/news?tickers=AAPL,MSFT');
                if (response.ok) {
                    const data = await response.json();
                    if (data.articles && Array.isArray(data.articles)) {
                        addTestResult('data', 'Actualit√©s', 'success', `${data.articles.length} articles r√©cup√©r√©s`);
                    } else {
                        addTestResult('data', 'Actualit√©s', 'error', 'Format de donn√©es invalide');
                    }
                } else {
                    addTestResult('data', 'Actualit√©s', 'error', `HTTP ${response.status}`);
                }
            } catch (error) {
                addTestResult('data', 'Actualit√©s', 'error', error.message);
            }
        }
        
        // Test Seeking Alpha
        async function testSeekingAlpha() {
            addTestResult('data', 'Test Seeking Alpha', 'info', 'Test des donn√©es Seeking Alpha...');
            
            try {
                const response = await fetch('/api/seeking-alpha');
                if (response.ok) {
                    const data = await response.json();
                    if (data.stocks && Array.isArray(data.stocks)) {
                        addTestResult('data', 'Seeking Alpha', 'success', `${data.stocks.length} analyses r√©cup√©r√©es`);
                    } else {
                        addTestResult('data', 'Seeking Alpha', 'error', 'Format de donn√©es invalide');
                    }
                } else {
                    addTestResult('data', 'Seeking Alpha', 'error', `HTTP ${response.status}`);
                }
            } catch (error) {
                addTestResult('data', 'Seeking Alpha', 'error', error.message);
            }
        }
        
        // Test workflow complet
        async function testFullWorkflow() {
            addTestResult('integration', 'Test Workflow Complet', 'info', 'Test du workflow complet...');
            
            const startTime = performance.now();
            
            try {
                // 1. Chargement des donn√©es
                await testStockData();
                await testNewsData();
                await testSeekingAlpha();
                
                // 2. Test des APIs
                await testAPIs();
                
                // 3. Test de performance
                testPerformance();
                
                const totalTime = performance.now() - startTime;
                
                if (totalTime < 5000) {
                    addTestResult('integration', 'Workflow Complet', 'success', `Workflow termin√© en ${Math.round(totalTime)}ms`);
                } else {
                    addTestResult('integration', 'Workflow Complet', 'warning', `Workflow lent: ${Math.round(totalTime)}ms`);
                }
            } catch (error) {
                addTestResult('integration', 'Workflow Complet', 'error', `Erreur: ${error.message}`);
            }
        }
        
        // Test responsive
        function testResponsive() {
            addTestResult('integration', 'Test Responsive', 'info', 'Test du design responsive...');
            
            const breakpoints = [
                { name: 'Mobile', width: 375 },
                { name: 'Tablet', width: 768 },
                { name: 'Desktop', width: 1024 },
                { name: 'Large', width: 1440 }
            ];
            
            let responsiveTests = 0;
            
            breakpoints.forEach(bp => {
                // Simulation de la largeur d'√©cran
                const originalWidth = window.innerWidth;
                Object.defineProperty(window, 'innerWidth', {
                    writable: true,
                    configurable: true,
                    value: bp.width
                });
                
                // D√©clencher l'√©v√©nement resize
                window.dispatchEvent(new Event('resize'));
                
                // V√©rifier que la page s'adapte
                const bodyWidth = document.body.offsetWidth;
                if (bodyWidth <= bp.width + 50) { // Tol√©rance de 50px
                    responsiveTests++;
                    addTestResult('integration', `Responsive ${bp.name}`, 'success', `OK (${bp.width}px)`);
                } else {
                    addTestResult('integration', `Responsive ${bp.name}`, 'warning', `Probl√®me (${bp.width}px)`);
                }
                
                // Restaurer la largeur originale
                Object.defineProperty(window, 'innerWidth', {
                    writable: true,
                    configurable: true,
                    value: originalWidth
                });
            });
            
            addTestResult('integration', 'R√©sum√© Responsive', 
                responsiveTests === breakpoints.length ? 'success' : 'warning',
                `${responsiveTests}/${breakpoints.length} breakpoints test√©s`);
        }
        
        // Test d'accessibilit√©
        function testAccessibility() {
            addTestResult('integration', 'Test Accessibilit√©', 'info', 'Test de l\'accessibilit√©...');
            
            let accessibilityScore = 0;
            const totalTests = 5;
            
            // Test 1: Alt text sur les images
            const images = document.querySelectorAll('img');
            const imagesWithAlt = Array.from(images).filter(img => img.alt);
            if (imagesWithAlt.length === images.length) {
                accessibilityScore++;
                addTestResult('integration', 'Alt Text Images', 'success', 'Toutes les images ont un alt text');
            } else {
                addTestResult('integration', 'Alt Text Images', 'warning', `${imagesWithAlt.length}/${images.length} images avec alt text`);
            }
            
            // Test 2: Boutons avec aria-label
            const buttons = document.querySelectorAll('button');
            const buttonsWithAria = Array.from(buttons).filter(btn => btn.getAttribute('aria-label') || btn.textContent.trim());
            if (buttonsWithAria.length === buttons.length) {
                accessibilityScore++;
                addTestResult('integration', 'Aria Labels Boutons', 'success', 'Tous les boutons ont un label');
            } else {
                addTestResult('integration', 'Aria Labels Boutons', 'warning', `${buttonsWithAria.length}/${buttons.length} boutons avec label`);
            }
            
            // Test 3: Contraste des couleurs (simulation)
            const hasGoodContrast = true; // Simulation - en r√©alit√©, il faudrait tester les couleurs
            if (hasGoodContrast) {
                accessibilityScore++;
                addTestResult('integration', 'Contraste Couleurs', 'success', 'Contraste acceptable');
            } else {
                addTestResult('integration', 'Contraste Couleurs', 'warning', 'Contraste insuffisant');
            }
            
            // Test 4: Navigation au clavier
            const focusableElements = document.querySelectorAll('button, input, select, textarea, a[href]');
            if (focusableElements.length > 0) {
                accessibilityScore++;
                addTestResult('integration', 'Navigation Clavier', 'success', `${focusableElements.length} √©l√©ments focusables`);
            } else {
                addTestResult('integration', 'Navigation Clavier', 'error', 'Aucun √©l√©ment focusable');
            }
            
            // Test 5: Structure s√©mantique
            const semanticElements = document.querySelectorAll('header, main, nav, section, article, aside, footer');
            if (semanticElements.length > 0) {
                accessibilityScore++;
                addTestResult('integration', 'Structure S√©mantique', 'success', `${semanticElements.length} √©l√©ments s√©mantiques`);
            } else {
                addTestResult('integration', 'Structure S√©mantique', 'warning', 'Peu d\'√©l√©ments s√©mantiques');
            }
            
            const score = Math.round((accessibilityScore / totalTests) * 100);
            addTestResult('integration', 'Score Accessibilit√©', 
                score >= 80 ? 'success' : score >= 60 ? 'warning' : 'error',
                `${score}% (${accessibilityScore}/${totalTests})`);
        }
        
        // Fonction utilitaire pour ajouter des r√©sultats de test
        function addTestResult(category, test, type, message) {
            testCount++;
            if (type === 'success') passedTests++;
            if (type === 'error') failedTests++;
            
            const container = document.getElementById(`${category}-test-results`);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${test}:</strong> ${message}`;
            container.appendChild(resultDiv);
            
            // Stocker dans les r√©sultats
            if (!testResults[category]) testResults[category] = {};
            testResults[category][test] = { type, message, timestamp: new Date().toISOString() };
        }
        
        // G√©n√©rer le rapport
        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalTests: testCount,
                    passed: passedTests,
                    failed: failedTests,
                    successRate: Math.round((passedTests / testCount) * 100)
                },
                performance: {
                    loadTime: document.getElementById('load-time').textContent,
                    memoryUsage: document.getElementById('memory-usage').textContent,
                    apiResponse: document.getElementById('api-response').textContent
                },
                results: testResults
            };
            
            const reportDiv = document.getElementById('test-report');
            reportDiv.innerHTML = `
                <h3>üìä Rapport de Test</h3>
                <div class="grid">
                    <div class="metric">
                        <div class="metric-value">${report.summary.totalTests}</div>
                        <div class="metric-label">Tests Totaux</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${report.summary.passed}</div>
                        <div class="metric-label">Tests R√©ussis</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${report.summary.failed}</div>
                        <div class="metric-label">Tests √âchou√©s</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${report.summary.successRate}%</div>
                        <div class="metric-label">Taux de R√©ussite</div>
                    </div>
                </div>
                <pre style="background: #f1f5f9; padding: 1rem; border-radius: 5px; overflow-x: auto; margin-top: 1rem;">
${JSON.stringify(report, null, 2)}
                </pre>
            `;
        }
        
        // Exporter les r√©sultats
        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalTests: testCount,
                    passed: passedTests,
                    failed: failedTests,
                    successRate: Math.round((passedTests / testCount) * 100)
                },
                performance: {
                    loadTime: document.getElementById('load-time').textContent,
                    memoryUsage: document.getElementById('memory-usage').textContent,
                    apiResponse: document.getElementById('api-response').textContent
                },
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-test-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialisation
        window.addEventListener('load', () => {
            updateMetrics();
            addTestResult('functional', 'Initialisation', 'success', 'Page de test charg√©e');
        });
    </script>
</body>
</html>