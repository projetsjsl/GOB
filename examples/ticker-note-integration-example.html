<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exemple d'Int√©gration - Mode TICKER_NOTE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
        }

        .metadata-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metadata-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .metadata-value.success {
            color: #28a745;
        }

        .metadata-value.warning {
            color: #ffc107;
        }

        .metadata-value.error {
            color: #dc3545;
        }

        .note-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            line-height: 1.8;
        }

        .note-content h2 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .note-content h3 {
            color: #764ba2;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .note-content ul, .note-content ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        .note-content li {
            margin-bottom: 8px;
        }

        .note-content strong {
            color: #333;
        }

        .note-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .tag-indicator {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #cc0000;
        }

        .success-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .success-indicator.yes {
            background: #28a745;
        }

        .success-indicator.no {
            background: #dc3545;
        }

        .code-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .code-example pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Mode TICKER_NOTE</h1>
            <p>G√©n√©ration de notes professionnelles par ticker avec Emma IA‚Ñ¢</p>
        </div>

        <div class="card">
            <h2>üöÄ Testez le nouveau mode</h2>
            <div class="input-section">
                <input
                    type="text"
                    id="tickerInput"
                    placeholder="Entrez un ticker (ex: AAPL, MSFT, GOOGL...)"
                    value="AAPL"
                />
                <button id="generateBtn" onclick="generateTickerNote()">
                    G√©n√©rer la note
                </button>
            </div>

            <div id="loadingSection" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>G√©n√©ration de la note professionnelle en cours...</p>
                    <small>Cela peut prendre 3-5 secondes</small>
                </div>
            </div>

            <div id="resultSection" style="display: none;">
                <h3>üìä M√©tadonn√©es</h3>
                <div class="metadata" id="metadata"></div>

                <h3>üìù Note Professionnelle</h3>
                <div class="note-content" id="noteContent"></div>
            </div>

            <div id="errorSection" style="display: none;">
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>

        <div class="card">
            <h2>üíª Exemple de code d'int√©gration</h2>
            <div class="code-example">
                <pre>// Appel API pour g√©n√©rer une note professionnelle
const response = await fetch('/api/emma-agent', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    message: "G√©n√®re une note professionnelle compl√®te pour AAPL",
    context: {
      output_mode: 'ticker_note',  // üîë Mode sp√©cifique
      ticker: 'AAPL'
    }
  })
});

const data = await response.json();

// Structure de la r√©ponse
{
  "success": true,
  "response": "## [AAPL] - Analyse Professionnelle...",
  "model": "perplexity",
  "confidence": 0.92,
  "has_sources": true,
  "tools_used": ["fmp-quote", "fmp-fundamentals", ...],
  "is_reliable": true
}</pre>
            </div>
        </div>

        <div class="card">
            <h2>üé® Tags multim√©dias support√©s</h2>
            <p style="margin-bottom: 15px;">Le mode g√©n√®re automatiquement ces tags pour l'affichage visuel :</p>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <span class="tag-indicator">[STOCKCARD:TICKER]</span>
                <span class="tag-indicator">[RATIO_CHART:TICKER:METRIC]</span>
                <span class="tag-indicator">[CHART:FINVIZ:TICKER]</span>
                <span class="tag-indicator">[CHART:TRADINGVIEW:EXCHANGE:TICKER]</span>
                <span class="tag-indicator">[TABLE:NOM|Cols|Rows]</span>
                <span class="tag-indicator">[LOGO:TICKER]</span>
                <span class="tag-indicator">[SOURCE:NOM|URL]</span>
            </div>
        </div>
    </div>

    <script>
        async function generateTickerNote() {
            const ticker = document.getElementById('tickerInput').value.toUpperCase().trim();

            if (!ticker) {
                alert('Veuillez entrer un ticker');
                return;
            }

            // Reset UI
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;

            try {
                const response = await fetch('/api/emma-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `G√©n√®re une note professionnelle compl√®te pour ${ticker}`,
                        context: {
                            output_mode: 'ticker_note',
                            ticker: ticker
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Afficher les m√©tadonn√©es
                displayMetadata(data);

                // Afficher la note (avec conversion Markdown basique)
                displayNote(data.response);

                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('errorMessage').textContent =
                    `Erreur lors de la g√©n√©ration de la note: ${error.message}`;
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('errorSection').style.display = 'block';
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function displayMetadata(data) {
            const metadata = document.getElementById('metadata');
            metadata.innerHTML = `
                <div class="metadata-item">
                    <span class="metadata-label">Succ√®s</span>
                    <span class="metadata-value ${data.success ? 'success' : 'error'}">
                        <span class="success-indicator ${data.success ? 'yes' : 'no'}"></span>
                        ${data.success ? 'Oui' : 'Non'}
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Mod√®le utilis√©</span>
                    <span class="metadata-value">${data.model || 'N/A'}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Confiance</span>
                    <span class="metadata-value ${data.confidence >= 0.8 ? 'success' : data.confidence >= 0.6 ? 'warning' : 'error'}">
                        ${(data.confidence * 100).toFixed(1)}%
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Sources</span>
                    <span class="metadata-value ${data.has_sources ? 'success' : 'warning'}">
                        <span class="success-indicator ${data.has_sources ? 'yes' : 'no'}"></span>
                        ${data.has_sources ? `${data.source_types} types` : 'Aucune'}
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Outils utilis√©s</span>
                    <span class="metadata-value">${data.tools_used?.length || 0} outils</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Temps d'ex√©cution</span>
                    <span class="metadata-value">${data.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Fiabilit√©</span>
                    <span class="metadata-value ${data.is_reliable ? 'success' : 'warning'}">
                        <span class="success-indicator ${data.is_reliable ? 'yes' : 'no'}"></span>
                        ${data.is_reliable ? 'Fiable' : 'Partielle'}
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Outils √©chou√©s</span>
                    <span class="metadata-value ${data.failed_tools?.length > 0 ? 'warning' : 'success'}">
                        ${data.failed_tools?.length || 0}
                    </span>
                </div>
            `;
        }

        function displayNote(markdown) {
            const noteContent = document.getElementById('noteContent');

            // Conversion Markdown basique en HTML
            let html = markdown
                .replace(/### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[STOCKCARD:(.*?)\]/g, '<span class="tag-indicator">üìä STOCKCARD: $1</span>')
                .replace(/\[RATIO_CHART:(.*?):(.*?)\]/g, '<span class="tag-indicator">üìà RATIO_CHART: $1 - $2</span>')
                .replace(/\[CHART:FINVIZ:(.*?)\]/g, '<span class="tag-indicator">üìä CHART: $1</span>')
                .replace(/\[CHART:TRADINGVIEW:(.*?):(.*?)\]/g, '<span class="tag-indicator">üìà TradingView: $2</span>')
                .replace(/\[TABLE:(.*?)\]/g, '<span class="tag-indicator">üìã TABLE: $1</span>')
                .replace(/\[LOGO:(.*?)\]/g, '<span class="tag-indicator">üè¢ LOGO: $1</span>')
                .replace(/\[SOURCE:(.*?)\|(.*?)\]/g, '<a href="$2" target="_blank" style="color: #667eea;">üìé $1</a>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            noteContent.innerHTML = '<p>' + html + '</p>';
        }

        // Permettre Enter pour lancer la g√©n√©ration
        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generateTickerNote();
            }
        });
    </script>
</body>
</html>
