# Migration 008: Safe Improvements

## (Views, Approval Workflow, Audit Logs)

Cette migration ajoute des fonctionnalités "sûres" (additives) pour améliorer la performance et le workflow.

### ⚠️ Instructions

1. **Allez sur** : <https://supabase.com/dashboard>
2. **Sélectionnez** votre projet "gob-watchlist"
3. **Cliquez** sur "SQL Editor"
4. **Créez** une nouvelle query "Migration 008"
5. **Copiez-collez** le SQL ci-dessous et exécutez

```sql
-- 1. Add Approval Workflow Columns
ALTER TABLE public.finance_pro_snapshots 
ADD COLUMN IF NOT EXISTS is_approved BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS approved_by VARCHAR(100),
ADD COLUMN IF NOT EXISTS approved_at TIMESTAMPTZ;

-- 2. Create View for Latest Snapshots (Simpler Queries)
CREATE OR REPLACE VIEW public.latest_snapshots AS
SELECT DISTINCT ON (ticker) *
FROM public.finance_pro_snapshots
WHERE is_current = true
ORDER BY ticker, created_at DESC;

-- 3. Create Audit Log Table
CREATE TABLE IF NOT EXISTS public.snapshot_audit_log (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL,
    action VARCHAR(20) NOT NULL, -- 'create', 'update', 'delete', 'approve'
    profile_id UUID,
    user_id VARCHAR(100),
    details JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.snapshot_audit_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow read access to audit log"
ON public.snapshot_audit_log FOR SELECT
USING (auth.role() = 'authenticated');

CREATE POLICY "Allow insert access to audit log"
ON public.snapshot_audit_log FOR INSERT
WITH CHECK (true);

-- 4. Create Materialized View for KPI Performance
CREATE MATERIALIZED VIEW IF NOT EXISTS public.ticker_kpis AS
SELECT 
    s.ticker,
    s.id as snapshot_id,
    (s.assumptions->>'currentPrice')::numeric as current_price,
    (s.assumptions->>'growthRateEPS')::numeric as growth_rate_eps,
    (s.company_info->>'sector')::text as sector,
    (s.company_info->>'securityRank')::text as security_rank,
    s.updated_at
FROM public.finance_pro_snapshots s
WHERE s.is_current = true;

CREATE UNIQUE INDEX IF NOT EXISTS idx_ticker_kpis_ticker ON public.ticker_kpis(ticker);
CREATE INDEX IF NOT EXISTS idx_ticker_kpis_sector ON public.ticker_kpis(sector);
```

### Vérification

Après exécution, vérifiez que la vue existe :

```sql
SELECT count(*) FROM public.latest_snapshots;
```
